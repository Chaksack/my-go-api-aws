"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Api = exports.ApiPayloadFormatVersion = exports.ApiAuthorizationType = void 0;
const constructs_1 = require("constructs");
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations-alpha"));
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const apigV2Domain = __importStar(require("./util/apiGatewayV2Domain"));
const apigV2AccessLog = __importStar(require("./util/apiGatewayV2AccessLog"));
const allowedMethods = [
    apig.HttpMethod.ANY,
    apig.HttpMethod.GET,
    apig.HttpMethod.PUT,
    apig.HttpMethod.POST,
    apig.HttpMethod.HEAD,
    apig.HttpMethod.PATCH,
    apig.HttpMethod.DELETE,
    apig.HttpMethod.OPTIONS,
];
var ApiAuthorizationType;
(function (ApiAuthorizationType) {
    ApiAuthorizationType["JWT"] = "JWT";
    ApiAuthorizationType["NONE"] = "NONE";
    ApiAuthorizationType["CUSTOM"] = "CUSTOM";
    ApiAuthorizationType["AWS_IAM"] = "AWS_IAM";
})(ApiAuthorizationType = exports.ApiAuthorizationType || (exports.ApiAuthorizationType = {}));
var ApiPayloadFormatVersion;
(function (ApiPayloadFormatVersion) {
    ApiPayloadFormatVersion["V1"] = "1.0";
    ApiPayloadFormatVersion["V2"] = "2.0";
})(ApiPayloadFormatVersion = exports.ApiPayloadFormatVersion || (exports.ApiPayloadFormatVersion = {}));
/////////////////////
// Construct
/////////////////////
class Api extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        props = props || {};
        const { httpApi, routes, cors, accessLog, customDomain, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, defaultPayloadFormatVersion, defaultThrottlingBurstLimit, defaultThrottlingRateLimit, } = props;
        this.routesData = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        this.defaultPayloadFormatVersion = defaultPayloadFormatVersion;
        ////////////////////
        // Create Api
        ////////////////////
        if ((0, Construct_1.isCDKConstruct)(httpApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when "httpApi" is a construct`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "httpApi" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "httpApi" is a construct`);
            }
            if (props.stages !== undefined) {
                throw new Error(`Cannot configure the "stages" when "httpApi" is a construct`);
            }
            this.httpApi = httpApi;
        }
        else {
            const httpApiProps = (httpApi || {});
            // Validate input
            if (httpApiProps.corsPreflight !== undefined) {
                throw new Error(`Cannot configure the "httpApi.corsPreflight" in the Api`);
            }
            if (httpApiProps.defaultDomainMapping !== undefined) {
                throw new Error(`Cannot configure the "httpApi.defaultDomainMapping" in the Api`);
            }
            // Handle CORS
            const corsPreflight = this.buildCorsConfig(cors);
            // Handle Custom Domain
            const customDomainData = apigV2Domain.buildCustomDomainData(this, customDomain);
            let defaultDomainMapping;
            if (customDomainData) {
                if (customDomainData.isApigDomainCreated) {
                    this.apiGatewayDomain =
                        customDomainData.apigDomain;
                }
                if (customDomainData.isCertificatedCreated) {
                    this.acmCertificate = customDomainData.certificate;
                }
                defaultDomainMapping = {
                    domainName: customDomainData.apigDomain,
                    mappingKey: customDomainData.mappingKey,
                };
                this._customDomainUrl = `https://${customDomainData.url}`;
            }
            this.httpApi = new apig.HttpApi(this, "Api", Object.assign({ apiName: root.logicalPrefixedName(id), corsPreflight,
                defaultDomainMapping }, httpApiProps));
            const httpStage = this.httpApi.defaultStage;
            // Configure throttling
            if (defaultThrottlingBurstLimit &&
                defaultThrottlingRateLimit &&
                httpStage.node.defaultChild) {
                const cfnStage = httpStage.node.defaultChild;
                cfnStage.defaultRouteSettings = Object.assign(Object.assign({}, (cfnStage.routeSettings || {})), { throttlingBurstLimit: defaultThrottlingBurstLimit, throttlingRateLimit: defaultThrottlingRateLimit });
                this.defaultThrottlingBurstLimit = defaultThrottlingBurstLimit;
                this.defaultThrottlingRateLimit = defaultThrottlingRateLimit;
            }
            // Configure access log
            for (const def of props.stages || []) {
                const stage = new apig.HttpStage(this, "Stage" + def.stageName, Object.assign(Object.assign({}, def), { httpApi: this.httpApi }));
                apigV2AccessLog.buildAccessLogData(this, accessLog, stage, false);
            }
            if (this.httpApi.defaultStage)
                this.accessLogGroup = apigV2AccessLog.buildAccessLogData(this, accessLog, this.httpApi.defaultStage, true);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        this.addRoutes(this, routes || {});
    }
    get url() {
        return this.httpApi.apiEndpoint;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.routesData);
    }
    get httpApiArn() {
        const stack = Stack_1.Stack.of(this);
        return `arn:${stack.partition}:apigateway:${stack.region}::/apis/${this.httpApi.apiId}`;
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            this.addRoute(scope, routeKey, routes[routeKey]);
        });
    }
    getFunction(routeKey) {
        const route = this.routesData[this.normalizeRouteKey(routeKey)];
        return route instanceof Function_1.Function ? route : undefined;
    }
    attachPermissions(permissions) {
        Object.values(this.routesData)
            .filter((route) => route instanceof Function_1.Function)
            .forEach((route) => route.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "Api",
            data: {
                graphql: false,
                url: this.httpApi.url,
                httpApiId: this.httpApi.apiId,
                customDomainUrl: this._customDomainUrl,
                routes: Object.entries(this.routesData).map(([key, data]) => {
                    return {
                        route: key,
                        fn: (0, Construct_1.getFunctionRef)(data),
                    };
                }),
            },
        };
    }
    buildCorsConfig(cors) {
        // Handle cors: false
        if (cors === false) {
            return;
        }
        // Handle cors: true | undefined
        else if (cors === undefined || cors === true) {
            return {
                allowHeaders: ["*"],
                allowMethods: [apig.CorsHttpMethod.ANY],
                allowOrigins: ["*"],
            };
        }
        // Handle cors: apig.CorsPreflightOptions
        else {
            return cors;
        }
    }
    addRoute(scope, routeKey, routeValue) {
        ///////////////////
        // Normalize routeProps
        ///////////////////
        let routeProps;
        if (routeValue.albListener) {
            routeProps = routeValue;
        }
        else if (routeValue.url) {
            routeProps = routeValue;
        }
        else if (routeValue.function) {
            routeProps = routeValue;
        }
        else {
            routeProps = {
                function: routeValue,
            };
        }
        ///////////////////
        // Normalize routeKey
        ///////////////////
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.routesData[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Get path and method
        ///////////////////
        let postfixName;
        let httpRouteKey;
        let methodStr;
        let path;
        if (routeKey === "$default") {
            postfixName = "default";
            httpRouteKey = apig.HttpRouteKey.DEFAULT;
            methodStr = "ANY";
            path = routeKey;
        }
        else {
            const routeKeyParts = routeKey.split(" ");
            if (routeKeyParts.length !== 2) {
                throw new Error(`Invalid route ${routeKey}`);
            }
            methodStr = routeKeyParts[0].toUpperCase();
            path = routeKeyParts[1];
            const method = allowedMethods.find((per) => per === methodStr);
            if (!method) {
                throw new Error(`Invalid method defined for "${routeKey}"`);
            }
            if (path.length === 0) {
                throw new Error(`Invalid path defined for "${routeKey}"`);
            }
            postfixName = `${methodStr}_${path}`;
            httpRouteKey = apig.HttpRouteKey.with(path, method);
        }
        ///////////////////
        // Get authorization
        ///////////////////
        const { authorizationType, authorizer, authorizationScopes } = this.buildRouteAuth(routeKey, routeProps);
        ///////////////////
        // Create route
        ///////////////////
        let integration;
        if (routeProps.albListener) {
            routeProps = routeProps;
            integration = this.createAlbIntegration(scope, routeKey, routeProps, postfixName);
        }
        else if (routeProps.url) {
            routeProps = routeProps;
            integration = this.createHttpIntegration(scope, routeKey, routeProps, postfixName);
        }
        else {
            routeProps = routeProps;
            integration = this.createFunctionIntegration(scope, routeKey, routeProps, postfixName);
        }
        const route = new apig.HttpRoute(scope, `Route_${postfixName}`, {
            httpApi: this.httpApi,
            routeKey: httpRouteKey,
            integration,
            authorizer,
            authorizationScopes,
        });
        ////////////////////
        // Configure route authorization type
        ////////////////////
        // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE`
        //       because if it were set to `AWS_IAM`, and then it is removed from
        //       the CloudFormation template (ie. set to undefined), CloudFormation
        //       doesn't updates the route. The route's authorizationType would still
        //       be `AWS_IAM`.
        if (authorizationType === ApiAuthorizationType.AWS_IAM ||
            authorizationType === ApiAuthorizationType.NONE) {
            if (!route.node.defaultChild) {
                throw new Error(`Failed to define the default route for "${routeKey}"`);
            }
            const cfnRoute = route.node.defaultChild;
            cfnRoute.authorizationType = authorizationType;
        }
    }
    createHttpIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Create integration
        ///////////////////
        const errorMessage = `Invalid HTTP integration method defined for "${routeKey}"`;
        const integration = new apigIntegrations.HttpUrlIntegration(`Integration_${postfixName}`, routeProps.url, {
            method: this.buildHttpMethod(routeProps.method, errorMessage),
        });
        // Store route
        this.routesData[routeKey] = routeProps.url;
        return integration;
    }
    createAlbIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Create integration
        ///////////////////
        const errorMessage = `Invalid ALB integration method defined for "${routeKey}"`;
        const integration = new apigIntegrations.HttpAlbIntegration(`Integration_${postfixName}`, routeProps.albListener, {
            method: this.buildHttpMethod(routeProps.method, errorMessage),
            vpcLink: routeProps.vpcLink,
        });
        // Store route
        this.routesData[routeKey] = routeProps.albListener;
        return integration;
    }
    createFunctionIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Get payload format
        ///////////////////
        const payloadFormatVersion = routeProps.payloadFormatVersion ||
            this.defaultPayloadFormatVersion ||
            ApiPayloadFormatVersion.V2;
        if (!Object.values(ApiPayloadFormatVersion).includes(payloadFormatVersion)) {
            throw new Error(`sst.Api does not currently support ${payloadFormatVersion} payload format version. Only "V1" and "V2" are currently supported.`);
        }
        const integrationPayloadFormatVersion = payloadFormatVersion === ApiPayloadFormatVersion.V1
            ? apig.PayloadFormatVersion.VERSION_1_0
            : apig.PayloadFormatVersion.VERSION_2_0;
        ///////////////////
        // Create Function
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${postfixName}`, routeProps.function, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        // Add an environment variable to determine if the function is an Api route.
        // If it is, when "sst start" is not connected, we want to return an 500
        // status code and a descriptive error message.
        const root = scope.node.root;
        if (root.local) {
            lambda.addEnvironment("SST_DEBUG_IS_API_ROUTE", "1", {
                removeInEdge: true,
            });
        }
        ///////////////////
        // Create integration
        ///////////////////
        const integration = new apigIntegrations.HttpLambdaIntegration(`Integration_${postfixName}`, lambda, {
            payloadFormatVersion: integrationPayloadFormatVersion,
        });
        // Store route
        this.routesData[routeKey] = lambda;
        // Attached existing permissions
        this.permissionsAttachedForAllRoutes.forEach((permissions) => lambda.attachPermissions(permissions));
        return integration;
    }
    buildRouteAuth(routeKey, routeProps) {
        let authorizer, authorizationScopes;
        const authorizationType = routeProps.authorizationType ||
            this.defaultAuthorizationType ||
            ApiAuthorizationType.NONE;
        if (!Object.values(ApiAuthorizationType).includes(authorizationType)) {
            throw new Error(`sst.Api does not currently support ${authorizationType}. Only "AWS_IAM", "JWT" and "CUSTOM" are currently supported.`);
        }
        // Handle JWT Auth
        if (authorizationType === ApiAuthorizationType.JWT) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            authorizationScopes =
                routeProps.authorizationScopes || this.defaultAuthorizationScopes;
            if (!authorizer) {
                throw new Error(`Missing JWT authorizer for "${routeKey}"`);
            }
        }
        // Handle CUSTOM Auth
        else if (authorizationType === ApiAuthorizationType.CUSTOM) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            if (!authorizer) {
                throw new Error(`Missing custom Lambda authorizer for "${routeKey}"`);
            }
        }
        return { authorizationType, authorizer, authorizationScopes };
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    buildHttpMethod(method, errorMessage) {
        if (method === undefined) {
            return undefined;
        }
        if (typeof method === "string") {
            method = method.toUpperCase();
            method = allowedMethods.find((per) => per === method);
            if (!method) {
                throw new Error(errorMessage);
            }
        }
        return method;
    }
}
exports.Api = Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUd2QyxzRUFBd0Q7QUFFeEQsK0ZBQWlGO0FBS2pGLG1DQUFnQztBQUNoQywyQ0FBMkU7QUFDM0UseUNBQStFO0FBRS9FLHdFQUEwRDtBQUMxRCw4RUFBZ0U7QUFFaEUsTUFBTSxjQUFjLEdBQUc7SUFDckIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO0lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRztJQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7SUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJO0lBQ3BCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSTtJQUNwQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUs7SUFDckIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNO0lBQ3RCLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTztDQUN4QixDQUFDO0FBRUYsSUFBWSxvQkFLWDtBQUxELFdBQVksb0JBQW9CO0lBQzlCLG1DQUFXLENBQUE7SUFDWCxxQ0FBYSxDQUFBO0lBQ2IseUNBQWlCLENBQUE7SUFDakIsMkNBQW1CLENBQUE7QUFDckIsQ0FBQyxFQUxXLG9CQUFvQixHQUFwQiw0QkFBb0IsS0FBcEIsNEJBQW9CLFFBSy9CO0FBRUQsSUFBWSx1QkFHWDtBQUhELFdBQVksdUJBQXVCO0lBQ2pDLHFDQUFVLENBQUE7SUFDVixxQ0FBVSxDQUFBO0FBQ1osQ0FBQyxFQUhXLHVCQUF1QixHQUF2QiwrQkFBdUIsS0FBdkIsK0JBQXVCLFFBR2xDO0FBcUVELHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsR0FBSSxTQUFRLHNCQUFTO0lBcUJoQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWdCO1FBQ3hELEtBQUssQ0FBQyxL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LE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDOUIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM5QixNQUFNLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLE1BQU0sQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUMvQjtTQUNGO1FBRUQsT0FBTyxNQUF5QixDQUFDO0lBQ25DLENBQUM7Q0FDRjtBQXJqQkQsa0JBcWpCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCAqIGFzIGNmbkFwaWcgZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCAqIGFzIGFwaWcgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYWxwaGFcIjtcbmltcG9ydCAqIGFzIGFwaWdBdXRob3JpemVycyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hdXRob3JpemVycy1hbHBoYVwiO1xuaW1wb3J0ICogYXMgYXBpZ0ludGVncmF0aW9ucyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1pbnRlZ3JhdGlvbnMtYWxwaGFcIjtcbmltcG9ydCAqIGFzIGVsYiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVsYXN0aWNsb2FkYmFsYW5jaW5ndjJcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCAqIGFzIGFwaWdWMkRvbWFpbiBmcm9tIFwiLi91dGlsL2FwaUdhdGV3YXlWMkRvbWFpblwiO1xuaW1wb3J0ICogYXMgYXBpZ1YyQWNjZXNzTG9nIGZyb20gXCIuL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nXCI7XG5cbmNvbnN0IGFsbG93ZWRNZXRob2RzID0gW1xuICBhcGlnLkh0dHBNZXRob2QuQU5ZLFxuICBhcGlnLkh0dHBNZXRob2QuR0VULFxuICBhcGlnLkh0dHBNZXRob2QuUFVULFxuICBhcGlnLkh0dHBNZXRob2QuUE9TVCxcbiAgYXBpZy5IdHRwTWV0aG9kLkhFQUQsXG4gIGFwaWcuSHR0cE1ldGhvZC5QQVRDSCxcbiAgYXBpZy5IdHRwTWV0aG9kLkRFTEVURSxcbiAgYXBpZy5IdHRwTWV0aG9kLk9QVElPTlMsXG5dO1xuXG5leHBvcnQgZW51bSBBcGlBdXRob3JpemF0aW9uVHlwZSB7XG4gIEpXVCA9IFwiSldUXCIsXG4gIE5PTkUgPSBcIk5PTkVcIixcbiAgQ1VTVE9NID0gXCJDVVNUT01cIixcbiAgQVdTX0lBTSA9IFwiQVdTX0lBTVwiLFxufVxuXG5leHBvcnQgZW51bSBBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbiB7XG4gIFYxID0gXCIxLjBcIixcbiAgVjIgPSBcIjIuMFwiLFxufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEludGVyZmFjZXNcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwaVByb3BzIHtcbiAgcmVhZG9ubHkgaHR0cEFwaT86IGFwaWcuSUh0dHBBcGkgfCBhcGlnLkh0dHBBcGlQcm9wcztcbiAgcmVhZG9ubHkgcm91dGVzPzoge1xuICAgIFtrZXk6IHN0cmluZ106XG4gICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgfCBBcGlGdW5jdGlvblJvdXRlUHJvcHNcbiAgICAgIHwgQXBpSHR0cFJvdXRlUHJvcHNcbiAgICAgIHwgQXBpQWxiUm91dGVQcm9wcztcbiAgfTtcbiAgcmVhZG9ubHkgY29ycz86IGJvb2xlYW4gfCBhcGlnLkNvcnNQcmVmbGlnaHRPcHRpb25zO1xuICByZWFkb25seSBhY2Nlc3NMb2c/OiBib29sZWFuIHwgc3RyaW5nIHwgQXBpQWNjZXNzTG9nUHJvcHM7XG4gIHJlYWRvbmx5IGN1c3RvbURvbWFpbj86IHN0cmluZyB8IEFwaUN1c3RvbURvbWFpblByb3BzO1xuXG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbiAgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBMYW1iZGFBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM/OiBzdHJpbmdbXTtcbiAgcmVhZG9ubHkgZGVmYXVsdFBheWxvYWRGb3JtYXRWZXJzaW9uPzogQXBpUGF5bG9hZEZvcm1hdFZlcnNpb247XG4gIHJlYWRvbmx5IGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdD86IG51bWJlcjtcbiAgcmVhZG9ubHkgZGVmYXVsdFRocm90dGxpbmdSYXRlTGltaXQ/OiBudW1iZXI7XG4gIHJlYWRvbmx5IHN0YWdlcz86IE9taXQ8YXBpZy5IdHRwU3RhZ2VQcm9wcywgXCJodHRwQXBpXCI+W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzIHtcbiAgcmVhZG9ubHkgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcGF5bG9hZEZvcm1hdFZlcnNpb24/OiBBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbjtcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblR5cGU/OiBBcGlBdXRob3JpemF0aW9uVHlwZTtcbiAgcmVhZG9ubHkgYXV0aG9yaXplcj86XG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cEp3dEF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwTGFtYmRhQXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBVc2VyUG9vbEF1dGhvcml6ZXI7XG4gIHJlYWRvbmx5IGF1dGhvcml6YXRpb25TY29wZXM/OiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcGlIdHRwUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IHVybDogc3RyaW5nO1xuICByZWFkb25seSBtZXRob2Q/OiBzdHJpbmcgfCBhcGlnLkh0dHBNZXRob2Q7XG4gIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cExhbWJkYUF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwVXNlclBvb2xBdXRob3JpemVyO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpQWxiUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IGFsYkxpc3RlbmVyOiBlbGIuSUFwcGxpY2F0aW9uTGlzdGVuZXI7XG4gIHJlYWRvbmx5IG1ldGhvZD86IHN0cmluZyB8IGFwaWcuSHR0cE1ldGhvZDtcbiAgcmVhZG9ubHkgdnBjTGluaz86IGFwaWcuSVZwY0xpbms7XG4gIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cExhbWJkYUF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwVXNlclBvb2xBdXRob3JpemVyO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCB0eXBlIEFwaUN1c3RvbURvbWFpblByb3BzID0gYXBpZ1YyRG9tYWluLkN1c3RvbURvbWFpblByb3BzO1xuZXhwb3J0IHR5cGUgQXBpQWNjZXNzTG9nUHJvcHMgPSBhcGlnVjJBY2Nlc3NMb2cuQWNjZXNzTG9nUHJvcHM7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGNsYXNzIEFwaSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBodHRwQXBpOiBhcGlnLkh0dHBBcGk7XG4gIHB1YmxpYyByZWFkb25seSBhY2Nlc3NMb2dHcm91cD86IGxvZ3MuTG9nR3JvdXA7XG4gIHB1YmxpYyByZWFkb25seSBhcGlHYXRld2F5RG9tYWluPzogYXBpZy5Eb21haW5OYW1lO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNtQ2VydGlmaWNhdGU/OiBhY20uQ2VydGlmaWNhdGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2N1c3RvbURvbWFpblVybD86IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSByb3V0ZXNEYXRhOiB7XG4gICAgW2tleTogc3RyaW5nXTogRm4gfCBzdHJpbmcgfCBlbGIuSUFwcGxpY2F0aW9uTGlzdGVuZXI7XG4gIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlczogUGVybWlzc2lvbnNbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cExhbWJkYUF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwVXNlclBvb2xBdXRob3JpemVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFBheWxvYWRGb3JtYXRWZXJzaW9uPzogQXBpUGF5bG9hZEZvcm1hdFZlcnNpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFRocm90dGxpbmdCdXJzdExpbWl0PzogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0PzogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogQXBpUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcHJvcHMgPSBwcm9wcyB8fCB7fTtcbiAgICBjb25zdCB7XG4gICAgICBodHRwQXBpLFxuICAgICAgcm91dGVzLFxuICAgICAgY29ycyxcbiAgICAgIGFjY2Vzc0xvZyxcbiAgICAgIGN1c3RvbURvbWFpbixcbiAgICAgIGRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgZGVmYXVsdEF1dGhvcml6ZXIsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblR5cGUsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcyxcbiAgICAgIGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbixcbiAgICAgIGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdCxcbiAgICAgIGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0LFxuICAgIH0gPSBwcm9wcztcbiAgICB0aGlzLnJvdXRlc0RhdGEgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG4gICAgdGhpcy5kZWZhdWx0QXV0aG9yaXplciA9IGRlZmF1bHRBdXRob3JpemVyO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlID0gZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXMgPSBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcbiAgICB0aGlzLmRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbiA9IGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbjtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEFwaVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoaXNDREtDb25zdHJ1Y3QoaHR0cEFwaSkpIHtcbiAgICAgIGlmIChjb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNvcnNcIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFjY2Vzc0xvZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJhY2Nlc3NMb2dcIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjdXN0b21Eb21haW5cIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKHByb3BzLnN0YWdlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJzdGFnZXNcIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5odHRwQXBpID0gaHR0cEFwaSBhcyBhcGlnLkh0dHBBcGk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGh0dHBBcGlQcm9wcyA9IChodHRwQXBpIHx8IHt9KSBhcyBhcGlnLkh0dHBBcGlQcm9wcztcblxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGlmIChodHRwQXBpUHJvcHMuY29yc1ByZWZsaWdodCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJodHRwQXBpLmNvcnNQcmVmbGlnaHRcIiBpbiB0aGUgQXBpYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGh0dHBBcGlQcm9wcy5kZWZhdWx0RG9tYWluTWFwcGluZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJodHRwQXBpLmRlZmF1bHREb21haW5NYXBwaW5nXCIgaW4gdGhlIEFwaWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gSGFuZGxlIENPUlNcbiAgICAgIGNvbnN0IGNvcnNQcmVmbGlnaHQgPSB0aGlzLmJ1aWxkQ29yc0NvbmZpZyhjb3JzKTtcblxuICAgICAgLy8gSGFuZGxlIEN1c3RvbSBEb21haW5cbiAgICAgIGNvbnN0IGN1c3RvbURvbWFpbkRhdGEgPSBhcGlnVjJEb21haW4uYnVpbGRDdXN0b21Eb21haW5EYXRhKFxuICAgICAgICB0aGlzLFxuICAgICAgICBjdXN0b21Eb21haW5cbiAgICAgICk7XG4gICAgICBsZXQgZGVmYXVsdERvbWFpbk1hcHBpbmc7XG4gICAgICBpZiAoY3VzdG9tRG9tYWluRGF0YSkge1xuICAgICAgICBpZiAoY3VzdG9tRG9tYWluRGF0YS5pc0FwaWdEb21haW5DcmVhdGVkKSB7XG4gICAgICAgICAgdGhpcy5hcGlHYXRld2F5RG9tYWluID1cbiAgICAgICAgICAgIGN1c3RvbURvbWFpbkRhdGEuYXBpZ0RvbWFpbiBhcyBhcGlnLkRvbWFpbk5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEuaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkKSB7XG4gICAgICAgICAgdGhpcy5hY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbkRhdGEuY2VydGlmaWNhdGUgYXMgYWNtLkNlcnRpZmljYXRlO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHREb21haW5NYXBwaW5nID0ge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbkRhdGEuYXBpZ0RvbWFpbixcbiAgICAgICAgICBtYXBwaW5nS2V5OiBjdXN0b21Eb21haW5EYXRhLm1hcHBpbmdLZXksXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2N1c3RvbURvbWFpblVybCA9IGBodHRwczovLyR7Y3VzdG9tRG9tYWluRGF0YS51cmx9YDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5odHRwQXBpID0gbmV3IGFwaWcuSHR0cEFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICAgIGFwaU5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIGNvcnNQcmVmbGlnaHQsXG4gICAgICAgIGRlZmF1bHREb21haW5NYXBwaW5nLFxuICAgICAgICAuLi5odHRwQXBpUHJvcHMsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgaHR0cFN0YWdlID0gdGhpcy5odHRwQXBpLmRlZmF1bHRTdGFnZSBhcyBhcGlnLkh0dHBTdGFnZTtcblxuICAgICAgLy8gQ29uZmlndXJlIHRocm90dGxpbmdcbiAgICAgIGlmIChcbiAgICAgICAgZGVmYXVsdFRocm90dGxpbmdCdXJzdExpbWl0ICYmXG4gICAgICAgIGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0ICYmXG4gICAgICAgIGh0dHBTdGFnZS5ub2RlLmRlZmF1bHRDaGlsZFxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IGNmblN0YWdlID0gaHR0cFN0YWdlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGNmbkFwaWcuQ2ZuU3RhZ2U7XG4gICAgICAgIGNmblN0YWdlLmRlZmF1bHRSb3V0ZVNldHRpbmdzID0ge1xuICAgICAgICAgIC4uLihjZm5TdGFnZS5yb3V0ZVNldHRpbmdzIHx8IHt9KSxcbiAgICAgICAgICB0aHJvdHRsaW5nQnVyc3RMaW1pdDogZGVmYXVsdFRocm90dGxpbmdCdXJzdExpbWl0LFxuICAgICAgICAgIHRocm90dGxpbmdSYXRlTGltaXQ6IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0LFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdCA9IGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdDtcbiAgICAgICAgdGhpcy5kZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdCA9IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0O1xuICAgICAgfVxuXG4gICAgICAvLyBDb25maWd1cmUgYWNjZXNzIGxvZ1xuICAgICAgZm9yIChjb25zdCBkZWYgb2YgcHJvcHMuc3RhZ2VzIHx8IFtdKSB7XG4gICAgICAgIGNvbnN0IHN0YWdlID0gbmV3IGFwaWcuSHR0cFN0YWdlKHRoaXMsIFwiU3RhZ2VcIiArIGRlZi5zdGFnZU5hbWUsIHtcbiAgICAgICAgICAuLi5kZWYsXG4gICAgICAgICAgaHR0cEFwaTogdGhpcy5odHRwQXBpLFxuICAgICAgICB9KTtcbiAgICAgICAgYXBpZ1YyQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YSh0aGlzLCBhY2Nlc3NMb2csIHN0YWdlLCBmYWxzZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmh0dHBBcGkuZGVmYXVsdFN0YWdlKVxuICAgICAgICB0aGlzLmFjY2Vzc0xvZ0dyb3VwID0gYXBpZ1YyQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YShcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIGFjY2Vzc0xvZyxcbiAgICAgICAgICB0aGlzLmh0dHBBcGkuZGVmYXVsdFN0YWdlIGFzIGFwaWcuSHR0cFN0YWdlLFxuICAgICAgICAgIHRydWVcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDb25maWd1cmUgcm91dGVzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICB0aGlzLmFkZFJvdXRlcyh0aGlzLCByb3V0ZXMgfHwge30pO1xuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5odHRwQXBpLmFwaUVuZHBvaW50O1xuICB9XG5cbiAgcHVibGljIGdldCBjdXN0b21Eb21haW5VcmwoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fY3VzdG9tRG9tYWluVXJsO1xuICB9XG5cbiAgcHVibGljIGdldCByb3V0ZXMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnJvdXRlc0RhdGEpO1xuICB9XG5cbiAgcHVibGljIGdldCBodHRwQXBpQXJuKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZih0aGlzKTtcbiAgICByZXR1cm4gYGFybjoke3N0YWNrLnBhcnRpdGlvbn06YXBpZ2F0ZXdheToke3N0YWNrLnJlZ2lvbn06Oi9hcGlzLyR7dGhpcy5odHRwQXBpLmFwaUlkfWA7XG4gIH1cblxuICBwdWJsaWMgYWRkUm91dGVzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcm91dGVzOiB7XG4gICAgICBba2V5OiBzdHJpbmddOlxuICAgICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgICB8IEFwaUZ1bmN0aW9uUm91dGVQcm9wc1xuICAgICAgICB8IEFwaUh0dHBSb3V0ZVByb3BzXG4gICAgICAgIHwgQXBpQWxiUm91dGVQcm9wcztcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHJvdXRlcykuZm9yRWFjaCgocm91dGVLZXk6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5hZGRSb3V0ZShzY29wZSwgcm91dGVLZXksIHJvdXRlc1tyb3V0ZUtleV0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEZ1bmN0aW9uKHJvdXRlS2V5OiBzdHJpbmcpOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgcm91dGUgPSB0aGlzLnJvdXRlc0RhdGFbdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSldO1xuICAgIHJldHVybiByb3V0ZSBpbnN0YW5jZW9mIEZuID8gcm91dGUgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLnJvdXRlc0RhdGEpXG4gICAgICAuZmlsdGVyKChyb3V0ZSkgPT4gcm91dGUgaW5zdGFuY2VvZiBGbilcbiAgICAgIC5mb3JFYWNoKChyb3V0ZSkgPT4gKHJvdXRlIGFzIEZuKS5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucykpO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc1RvUm91dGUoXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgZm4gPSB0aGlzLmdldEZ1bmN0aW9uKHJvdXRlS2V5KTtcbiAgICBpZiAoIWZuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gYXR0YWNoIHBlcm1pc3Npb25zLiBSb3V0ZSBcIiR7cm91dGVLZXl9XCIgZG9lcyBub3QgZXhpc3QuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiQXBpXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGdyYXBocWw6IGZhbHNlLFxuICAgICAgICB1cmw6IHRoaXMuaHR0cEFwaS51cmwsXG4gICAgICAgIGh0dHBBcGlJZDogdGhpcy5odHRwQXBpLmFwaUlkLFxuICAgICAgICBjdXN0b21Eb21haW5Vcmw6IHRoaXMuX2N1c3RvbURvbWFpblVybCxcbiAgICAgICAgcm91dGVzOiBPYmplY3QuZW50cmllcyh0aGlzLnJvdXRlc0RhdGEpLm1hcCgoW2tleSwgZGF0YV0pID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcm91dGU6IGtleSxcbiAgICAgICAgICAgIGZuOiBnZXRGdW5jdGlvblJlZihkYXRhKSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDb3JzQ29uZmlnKFxuICAgIGNvcnM6IGJvb2xlYW4gfCBhcGlnLkNvcnNQcmVmbGlnaHRPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IGFwaWcuQ29yc1ByZWZsaWdodE9wdGlvbnMgfCB1bmRlZmluZWQge1xuICAgIC8vIEhhbmRsZSBjb3JzOiBmYWxzZVxuICAgIGlmIChjb3JzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBjb3JzOiB0cnVlIHwgdW5kZWZpbmVkXG4gICAgZWxzZSBpZiAoY29ycyA9PT0gdW5kZWZpbmVkIHx8IGNvcnMgPT09IHRydWUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGFsbG93SGVhZGVyczogW1wiKlwiXSxcbiAgICAgICAgYWxsb3dNZXRob2RzOiBbYXBpZy5Db3JzSHR0cE1ldGhvZC5BTlldLFxuICAgICAgICBhbGxvd09yaWdpbnM6IFtcIipcIl0sXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBjb3JzOiBhcGlnLkNvcnNQcmVmbGlnaHRPcHRpb25zXG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gY29ycztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFJvdXRlKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICByb3V0ZVZhbHVlOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzXG4gICAgICB8IEFwaUh0dHBSb3V0ZVByb3BzXG4gICAgICB8IEFwaUFsYlJvdXRlUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIE5vcm1hbGl6ZSByb3V0ZVByb3BzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGxldCByb3V0ZVByb3BzO1xuICAgIGlmICgocm91dGVWYWx1ZSBhcyBBcGlBbGJSb3V0ZVByb3BzKS5hbGJMaXN0ZW5lcikge1xuICAgICAgcm91dGVQcm9wcyA9IHJvdXRlVmFsdWUgYXMgQXBpQWxiUm91dGVQcm9wcztcbiAgICB9IGVsc2UgaWYgKChyb3V0ZVZhbHVlIGFzIEFwaUh0dHBSb3V0ZVByb3BzKS51cmwpIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVZhbHVlIGFzIEFwaUh0dHBSb3V0ZVByb3BzO1xuICAgIH0gZWxzZSBpZiAoKHJvdXRlVmFsdWUgYXMgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzKS5mdW5jdGlvbikge1xuICAgICAgcm91dGVQcm9wcyA9IHJvdXRlVmFsdWUgYXMgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzO1xuICAgIH0gZWxzZSB7XG4gICAgICByb3V0ZVByb3BzID0ge1xuICAgICAgICBmdW5jdGlvbjogcm91dGVWYWx1ZSBhcyBGdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICB9IGFzIEFwaUZ1bmN0aW9uUm91dGVQcm9wcztcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gTm9ybWFsaXplIHJvdXRlS2V5XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvdXRlS2V5ID0gdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSk7XG4gICAgaWYgKHRoaXMucm91dGVzRGF0YVtyb3V0ZUtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSByb3V0ZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEdldCBwYXRoIGFuZCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgbGV0IHBvc3RmaXhOYW1lO1xuICAgIGxldCBodHRwUm91dGVLZXk7XG4gICAgbGV0IG1ldGhvZFN0cjogc3RyaW5nO1xuICAgIGxldCBwYXRoO1xuICAgIGlmIChyb3V0ZUtleSA9PT0gXCIkZGVmYXVsdFwiKSB7XG4gICAgICBwb3N0Zml4TmFtZSA9IFwiZGVmYXVsdFwiO1xuICAgICAgaHR0cFJvdXRlS2V5ID0gYXBpZy5IdHRwUm91dGVLZXkuREVGQVVMVDtcbiAgICAgIG1ldGhvZFN0ciA9IFwiQU5ZXCI7XG4gICAgICBwYXRoID0gcm91dGVLZXk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJvdXRlS2V5UGFydHMgPSByb3V0ZUtleS5zcGxpdChcIiBcIik7XG4gICAgICBpZiAocm91dGVLZXlQYXJ0cy5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJvdXRlICR7cm91dGVLZXl9YCk7XG4gICAgICB9XG4gICAgICBtZXRob2RTdHIgPSByb3V0ZUtleVBhcnRzWzBdLnRvVXBwZXJDYXNlKCk7XG4gICAgICBwYXRoID0gcm91dGVLZXlQYXJ0c1sxXTtcbiAgICAgIGNvbnN0IG1ldGhvZCA9IGFsbG93ZWRNZXRob2RzLmZpbmQoKHBlcikgPT4gcGVyID09PSBtZXRob2RTdHIpO1xuICAgICAgaWYgKCFtZXRob2QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG1ldGhvZCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cbiAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cblxuICAgICAgcG9zdGZpeE5hbWUgPSBgJHttZXRob2RTdHJ9XyR7cGF0aH1gO1xuICAgICAgaHR0cFJvdXRlS2V5ID0gYXBpZy5IdHRwUm91dGVLZXkud2l0aChwYXRoLCBtZXRob2QpO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgYXV0aG9yaXphdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCB7IGF1dGhvcml6YXRpb25UeXBlLCBhdXRob3JpemVyLCBhdXRob3JpemF0aW9uU2NvcGVzIH0gPVxuICAgICAgdGhpcy5idWlsZFJvdXRlQXV0aChyb3V0ZUtleSwgcm91dGVQcm9wcyk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIHJvdXRlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGxldCBpbnRlZ3JhdGlvbjtcbiAgICBpZiAoKHJvdXRlUHJvcHMgYXMgQXBpQWxiUm91dGVQcm9wcykuYWxiTGlzdGVuZXIpIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVByb3BzIGFzIEFwaUFsYlJvdXRlUHJvcHM7XG4gICAgICBpbnRlZ3JhdGlvbiA9IHRoaXMuY3JlYXRlQWxiSW50ZWdyYXRpb24oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICByb3V0ZUtleSxcbiAgICAgICAgcm91dGVQcm9wcyxcbiAgICAgICAgcG9zdGZpeE5hbWVcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICgocm91dGVQcm9wcyBhcyBBcGlIdHRwUm91dGVQcm9wcykudXJsKSB7XG4gICAgICByb3V0ZVByb3BzID0gcm91dGVQcm9wcyBhcyBBcGlIdHRwUm91dGVQcm9wcztcbiAgICAgIGludGVncmF0aW9uID0gdGhpcy5jcmVhdGVIdHRwSW50ZWdyYXRpb24oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICByb3V0ZUtleSxcbiAgICAgICAgcm91dGVQcm9wcyxcbiAgICAgICAgcG9zdGZpeE5hbWVcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVByb3BzIGFzIEFwaUZ1bmN0aW9uUm91dGVQcm9wcztcbiAgICAgIGludGVncmF0aW9uID0gdGhpcy5jcmVhdGVGdW5jdGlvbkludGVncmF0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgcm91dGVLZXksXG4gICAgICAgIHJvdXRlUHJvcHMsXG4gICAgICAgIHBvc3RmaXhOYW1lXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHJvdXRlID0gbmV3IGFwaWcuSHR0cFJvdXRlKHNjb3BlLCBgUm91dGVfJHtwb3N0Zml4TmFtZX1gLCB7XG4gICAgICBodHRwQXBpOiB0aGlzLmh0dHBBcGksXG4gICAgICByb3V0ZUtleTogaHR0cFJvdXRlS2V5LFxuICAgICAgaW50ZWdyYXRpb24sXG4gICAgICBhdXRob3JpemVyLFxuICAgICAgYXV0aG9yaXphdGlvblNjb3BlcyxcbiAgICB9KTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIHJvdXRlIGF1dGhvcml6YXRpb24gdHlwZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gTm90ZTogd2UgbmVlZCB0byBleHBsaWNpdGx5IHNldCBgY2ZuUm91dGUuYXV0aG9yaXphdGlvblR5cGVgIHRvIGBOT05FYFxuICAgIC8vICAgICAgIGJlY2F1c2UgaWYgaXQgd2VyZSBzZXQgdG8gYEFXU19JQU1gLCBhbmQgdGhlbiBpdCBpcyByZW1vdmVkIGZyb21cbiAgICAvLyAgICAgICB0aGUgQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgKGllLiBzZXQgdG8gdW5kZWZpbmVkKSwgQ2xvdWRGb3JtYXRpb25cbiAgICAvLyAgICAgICBkb2Vzbid0IHVwZGF0ZXMgdGhlIHJvdXRlLiBUaGUgcm91dGUncyBhdXRob3JpemF0aW9uVHlwZSB3b3VsZCBzdGlsbFxuICAgIC8vICAgICAgIGJlIGBBV1NfSUFNYC5cbiAgICBpZiAoXG4gICAgICBhdXRob3JpemF0aW9uVHlwZSA9PT0gQXBpQXV0aG9yaXphdGlvblR5cGUuQVdTX0lBTSB8fFxuICAgICAgYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLk5PTkVcbiAgICApIHtcbiAgICAgIGlmICghcm91dGUubm9kZS5kZWZhdWx0Q2hpbGQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVmaW5lIHRoZSBkZWZhdWx0IHJvdXRlIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGNmblJvdXRlID0gcm91dGUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgY2ZuQXBpZy5DZm5Sb3V0ZTtcbiAgICAgIGNmblJvdXRlLmF1dGhvcml6YXRpb25UeXBlID0gYXV0aG9yaXphdGlvblR5cGU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVIdHRwSW50ZWdyYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUh0dHBSb3V0ZVByb3BzLFxuICAgIHBvc3RmaXhOYW1lOiBzdHJpbmdcbiAgKTogYXBpZy5IdHRwUm91dGVJbnRlZ3JhdGlvbiB7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBpbnRlZ3JhdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSW52YWxpZCBIVFRQIGludGVncmF0aW9uIG1ldGhvZCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgO1xuICAgIGNvbnN0IGludGVncmF0aW9uID0gbmV3IGFwaWdJbnRlZ3JhdGlvbnMuSHR0cFVybEludGVncmF0aW9uKFxuICAgICAgYEludGVncmF0aW9uXyR7cG9zdGZpeE5hbWV9YCxcbiAgICAgIHJvdXRlUHJvcHMudXJsLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6IHRoaXMuYnVpbGRIdHRwTWV0aG9kKHJvdXRlUHJvcHMubWV0aG9kLCBlcnJvck1lc3NhZ2UpLFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBTdG9yZSByb3V0ZVxuICAgIHRoaXMucm91dGVzRGF0YVtyb3V0ZUtleV0gPSByb3V0ZVByb3BzLnVybDtcblxuICAgIHJldHVybiBpbnRlZ3JhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQWxiSW50ZWdyYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUFsYlJvdXRlUHJvcHMsXG4gICAgcG9zdGZpeE5hbWU6IHN0cmluZ1xuICApOiBhcGlnLkh0dHBSb3V0ZUludGVncmF0aW9uIHtcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGludGVncmF0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIEFMQiBpbnRlZ3JhdGlvbiBtZXRob2QgZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYDtcbiAgICBjb25zdCBpbnRlZ3JhdGlvbiA9IG5ldyBhcGlnSW50ZWdyYXRpb25zLkh0dHBBbGJJbnRlZ3JhdGlvbihcbiAgICAgIGBJbnRlZ3JhdGlvbl8ke3Bvc3RmaXhOYW1lfWAsXG4gICAgICByb3V0ZVByb3BzLmFsYkxpc3RlbmVyLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6IHRoaXMuYnVpbGRIdHRwTWV0aG9kKHJvdXRlUHJvcHMubWV0aG9kLCBlcnJvck1lc3NhZ2UpLFxuICAgICAgICB2cGNMaW5rOiByb3V0ZVByb3BzLnZwY0xpbmssXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIFN0b3JlIHJvdXRlXG4gICAgdGhpcy5yb3V0ZXNEYXRhW3JvdXRlS2V5XSA9IHJvdXRlUHJvcHMuYWxiTGlzdGVuZXI7XG5cbiAgICByZXR1cm4gaW50ZWdyYXRpb247XG4gIH1cblxuICBwcm90ZWN0ZWQgY3JlYXRlRnVuY3Rpb25JbnRlZ3JhdGlvbihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVQcm9wczogQXBpRnVuY3Rpb25Sb3V0ZVByb3BzLFxuICAgIHBvc3RmaXhOYW1lOiBzdHJpbmdcbiAgKTogYXBpZy5IdHRwUm91dGVJbnRlZ3JhdGlvbiB7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEdldCBwYXlsb2FkIGZvcm1hdFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBwYXlsb2FkRm9ybWF0VmVyc2lvbiA9XG4gICAgICByb3V0ZVByb3BzLnBheWxvYWRGb3JtYXRWZXJzaW9uIHx8XG4gICAgICB0aGlzLmRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbiB8fFxuICAgICAgQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24uVjI7XG4gICAgaWYgKFxuICAgICAgIU9iamVjdC52YWx1ZXMoQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24pLmluY2x1ZGVzKHBheWxvYWRGb3JtYXRWZXJzaW9uKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgc3N0LkFwaSBkb2VzIG5vdCBjdXJyZW50bHkgc3VwcG9ydCAke3BheWxvYWRGb3JtYXRWZXJzaW9ufSBwYXlsb2FkIGZvcm1hdCB2ZXJzaW9uLiBPbmx5IFwiVjFcIiBhbmQgXCJWMlwiIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkLmBcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IGludGVncmF0aW9uUGF5bG9hZEZvcm1hdFZlcnNpb24gPVxuICAgICAgcGF5bG9hZEZvcm1hdFZlcnNpb24gPT09IEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uLlYxXG4gICAgICAgID8gYXBpZy5QYXlsb2FkRm9ybWF0VmVyc2lvbi5WRVJTSU9OXzFfMFxuICAgICAgICA6IGFwaWcuUGF5bG9hZEZvcm1hdFZlcnNpb24uVkVSU0lPTl8yXzA7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEZ1bmN0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgTGFtYmRhXyR7cG9zdGZpeE5hbWV9YCxcbiAgICAgIHJvdXRlUHJvcHMuZnVuY3Rpb24sXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgcm91dGVzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBBcGkgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgLy8gQWRkIGFuIGVudmlyb25tZW50IHZhcmlhYmxlIHRvIGRldGVybWluZSBpZiB0aGUgZnVuY3Rpb24gaXMgYW4gQXBpIHJvdXRlLlxuICAgIC8vIElmIGl0IGlzLCB3aGVuIFwic3N0IHN0YXJ0XCIgaXMgbm90IGNvbm5lY3RlZCwgd2Ugd2FudCB0byByZXR1cm4gYW4gNTAwXG4gICAgLy8gc3RhdHVzIGNvZGUgYW5kIGEgZGVzY3JpcHRpdmUgZXJyb3IgbWVzc2FnZS5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBpZiAocm9vdC5sb2NhbCkge1xuICAgICAgbGFtYmRhLmFkZEVudmlyb25tZW50KFwiU1NUX0RFQlVHX0lTX0FQSV9ST1VURVwiLCBcIjFcIiwge1xuICAgICAgICByZW1vdmVJbkVkZ2U6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGludGVncmF0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGludGVncmF0aW9uID0gbmV3IGFwaWdJbnRlZ3JhdGlvbnMuSHR0cExhbWJkYUludGVncmF0aW9uKFxuICAgICAgYEludGVncmF0aW9uXyR7cG9zdGZpeE5hbWV9YCxcbiAgICAgIGxhbWJkYSxcbiAgICAgIHtcbiAgICAgICAgcGF5bG9hZEZvcm1hdFZlcnNpb246IGludGVncmF0aW9uUGF5bG9hZEZvcm1hdFZlcnNpb24sXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIFN0b3JlIHJvdXRlXG4gICAgdGhpcy5yb3V0ZXNEYXRhW3JvdXRlS2V5XSA9IGxhbWJkYTtcblxuICAgIC8vIEF0dGFjaGVkIGV4aXN0aW5nIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PlxuICAgICAgbGFtYmRhLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG5cbiAgICByZXR1cm4gaW50ZWdyYXRpb247XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkUm91dGVBdXRoKFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVQcm9wczogQXBpRnVuY3Rpb25Sb3V0ZVByb3BzIHwgQXBpSHR0cFJvdXRlUHJvcHMgfCBBcGlBbGJSb3V0ZVByb3BzXG4gICkge1xuICAgIGxldCBhdXRob3JpemVyLCBhdXRob3JpemF0aW9uU2NvcGVzO1xuICAgIGNvbnN0IGF1dGhvcml6YXRpb25UeXBlID1cbiAgICAgIHJvdXRlUHJvcHMuYXV0aG9yaXphdGlvblR5cGUgfHxcbiAgICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlIHx8XG4gICAgICBBcGlBdXRob3JpemF0aW9uVHlwZS5OT05FO1xuXG4gICAgaWYgKCFPYmplY3QudmFsdWVzKEFwaUF1dGhvcml6YXRpb25UeXBlKS5pbmNsdWRlcyhhdXRob3JpemF0aW9uVHlwZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHNzdC5BcGkgZG9lcyBub3QgY3VycmVudGx5IHN1cHBvcnQgJHthdXRob3JpemF0aW9uVHlwZX0uIE9ubHkgXCJBV1NfSUFNXCIsIFwiSldUXCIgYW5kIFwiQ1VTVE9NXCIgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgSldUIEF1dGhcbiAgICBpZiAoYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLkpXVCkge1xuICAgICAgYXV0aG9yaXplciA9IHJvdXRlUHJvcHMuYXV0aG9yaXplciB8fCB0aGlzLmRlZmF1bHRBdXRob3JpemVyO1xuICAgICAgYXV0aG9yaXphdGlvblNjb3BlcyA9XG4gICAgICAgIHJvdXRlUHJvcHMuYXV0aG9yaXphdGlvblNjb3BlcyB8fCB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzO1xuICAgICAgaWYgKCFhdXRob3JpemVyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBKV1QgYXV0aG9yaXplciBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIENVU1RPTSBBdXRoXG4gICAgZWxzZSBpZiAoYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLkNVU1RPTSkge1xuICAgICAgYXV0aG9yaXplciA9IHJvdXRlUHJvcHMuYXV0aG9yaXplciB8fCB0aGlzLmRlZmF1bHRBdXRob3JpemVyO1xuICAgICAgaWYgKCFhdXRob3JpemVyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBjdXN0b20gTGFtYmRhIGF1dGhvcml6ZXIgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IGF1dGhvcml6YXRpb25UeXBlLCBhdXRob3JpemVyLCBhdXRob3JpemF0aW9uU2NvcGVzIH07XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVJvdXRlS2V5KHJvdXRlS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiByb3V0ZUtleS5zcGxpdCgvXFxzKy8pLmpvaW4oXCIgXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEh0dHBNZXRob2QoXG4gICAgbWV0aG9kOiBzdHJpbmcgfCBhcGlnLkh0dHBNZXRob2QgfCB1bmRlZmluZWQsXG4gICAgZXJyb3JNZXNzYWdlOiBzdHJpbmdcbiAgKTogYXBpZy5IdHRwTWV0aG9kIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAobWV0aG9kID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXRob2QgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgICAgbWV0aG9kID0gYWxsb3dlZE1ldGhvZHMuZmluZCgocGVyKSA9PiBwZXIgPT09IG1ldGhvZCk7XG4gICAgICBpZiAoIW1ldGhvZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWV0aG9kIGFzIGFwaWcuSHR0cE1ldGhvZDtcbiAgfVxufVxuIl19