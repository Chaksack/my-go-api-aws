"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RDS = void 0;
const path_1 = __importDefault(require("path"));
const glob_1 = __importDefault(require("glob"));
const fs = __importStar(require("fs-extra"));
const crypto = __importStar(require("crypto"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const ec2 = __importStar(require("aws-cdk-lib/aws-ec2"));
const rds = __importStar(require("aws-cdk-lib/aws-rds"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class RDS extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const app = scope.node.root;
        const { rdsServerlessCluster, engine, defaultDatabaseName, scaling, migrations } = props || {};
        ////////////////////
        // Create Bucket
        ////////////////////
        const rdsServerlessClusterProps = (rdsServerlessCluster || {});
        this.validateRDSServerlessClusterProps(rdsServerlessClusterProps);
        this.validateRequiredProps(props || {});
        this.engine = engine;
        this.defaultDatabaseName = defaultDatabaseName;
        this.rdsServerlessCluster = new rds.ServerlessCluster(this, "Cluster", Object.assign(Object.assign({ clusterIdentifier: app.logicalPrefixedName(id) }, rdsServerlessClusterProps), { defaultDatabaseName, enableDataApi: true, engine: this.getEngine(engine), scaling: this.getScaling(scaling), vpc: this.getVpc(rdsServerlessClusterProps), vpcSubnets: this.getVpcSubnets(rdsServerlessClusterProps) }));
        ///////////////////////////
        // Create Migrations
        ///////////////////////////
        if (migrations) {
            this.validateMigrationsFileExists(migrations);
            this.migratorFunction = this.createMigrationsFunction(engine, defaultDatabaseName, migrations);
            this.createMigrationCustomResource(migrations);
        }
    }
    get clusterArn() {
        return this.rdsServerlessCluster.clusterArn;
    }
    get clusterIdentifier() {
        return this.rdsServerlessCluster.clusterIdentifier;
    }
    get clusterEndpoint() {
        return this.rdsServerlessCluster.clusterEndpoint;
    }
    get secretArn() {
        return this.rdsServerlessCluster.secret.secretArn;
    }
    getConstructMetadata() {
        return {
            type: "RDS",
            data: {
                engine: this.engine,
                secretArn: this.secretArn,
                clusterArn: this.clusterArn,
                clusterIdentifier: this.clusterIdentifier,
                defaultDatabaseName: this.defaultDatabaseName,
                migrator: this.migratorFunction && (0, Construct_1.getFunctionRef)(this.migratorFunction),
            },
        };
    }
    validateRDSServerlessClusterProps(props) {
        // Validate "engine" is passed in from the top level
        if (props.engine) {
            throw new Error(`Use "engine" instead of "rdsServerlessCluster.engine" to configure the RDS database engine.`);
        }
        // Validate "defaultDatabaseName" is passed in from the top level
        if (props.defaultDatabaseName) {
            throw new Error(`Use "defaultDatabaseName" instead of "rdsServerlessCluster.defaultDatabaseName" to configure the RDS database engine.`);
        }
        // Validate "scaling" is passed in from the top level
        if (props.scaling) {
            throw new Error(`Use "scaling" instead of "rdsServerlessCluster.scaling" to configure the RDS database auto-scaling.`);
        }
        // Validate "enableDataApi" is not passed in
        if (props.enableDataApi === false) {
            throw new Error(`Do not configure the "rdsServerlessCluster.enableDataApi". Data API is always enabled for this construct.`);
        }
    }
    validateRequiredProps(props) {
        if (!props.engine) {
            throw new Error(`Missing "engine" in the "${this.node.id}" RDS`);
        }
        if (!props.defaultDatabaseName) {
            throw new Error(`Missing "defaultDatabaseName" in the "${this.node.id}" RDS`);
        }
    }
    validateMigrationsFileExists(migrations) {
        if (!fs.existsSync(migrations))
            throw new Error(`Cannot find the migrations in "${path_1.default.resolve(migrations)}".`);
    }
    getEngine(engine) {
        if (engine === "mysql5.6") {
            return rds.DatabaseClusterEngine.aurora({
                version: rds.AuroraEngineVersion.VER_10A,
            });
        }
        else if (engine === "mysql5.7") {
            return rds.DatabaseClusterEngine.auroraMysql({
                version: rds.AuroraMysqlEngineVersion.VER_2_07_1,
            });
        }
        else if (engine === "postgresql10.14") {
            return rds.DatabaseClusterEngine.auroraPostgres({
                version: rds.AuroraPostgresEngineVersion.VER_10_14,
            });
        }
        throw new Error(`The specified "engine" is not supported for sst.RDS. Only mysql5.6, mysql5.7, and postgresql10.14 engines are currently supported.`);
    }
    getScaling(scaling) {
        return {
            autoPause: (scaling === null || scaling === void 0 ? void 0 : scaling.autoPause) === false
                ? cdk.Duration.minutes(0)
                : ((scaling === null || scaling === void 0 ? void 0 : scaling.autoPause) === true || (scaling === null || scaling === void 0 ? void 0 : scaling.autoPause) === undefined)
                    ? cdk.Duration.minutes(5)
                    : cdk.Duration.minutes(scaling === null || scaling === void 0 ? void 0 : scaling.autoPause),
            minCapacity: rds.AuroraCapacityUnit[(scaling === null || scaling === void 0 ? void 0 : scaling.minCapacity) || "ACU_2"],
            maxCapacity: rds.AuroraCapacityUnit[(scaling === null || scaling === void 0 ? void 0 : scaling.maxCapacity) || "ACU_16"]
        };
    }
    getVpc(props) {
        if (props.vpc) {
            return props.vpc;
        }
        return new ec2.Vpc(this, "vpc", {
            natGateways: 0,
        });
    }
    getVpcSubnets(props) {
        if (props.vpc) {
            return props.vpcSubnets;
        }
        return {
            subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
        };
    }
    createMigrationsFunction(engine, defaultDatabaseName, migrations) {
        const app = this.node.root;
        // path to migration scripts inside the Lambda function
        const migrationsDestination = "sst_rds_migration_scripts";
        // fullpath of the migrator Lambda function
        // Note:
        // - when invoked from `sst build`, __dirname is `resources/dist`
        // - when running resources tests, __dirname is `resources/src`
        // For now we will do `__dirname/../dist` to make both cases work.
        const srcPath = path_1.default.resolve(path_1.default.join(__dirname, "..", "dist", "RDS_migrator"));
        const fn = new Function_1.Function(this, "MigrationFunction", {
            srcPath,
            handler: "index.handler",
            runtime: "nodejs14.x",
            timeout: 900,
            memorySize: 1024,
            environment: {
                RDS_ARN: this.rdsServerlessCluster.clusterArn,
                RDS_SECRET: this.rdsServerlessCluster.secret.secretArn,
                RDS_DATABASE: defaultDatabaseName,
                RDS_ENGINE_MODE: engine === "postgresql10.14" ? "postgres" : "mysql",
                // for live development, perserve the migrations path so the migrator
                // can locate the migration files
                RDS_MIGRATIONS_PATH: app.local
                    ? migrations
                    : migrationsDestination,
            },
            bundle: {
                // Note that we need to generate a relative path of the migrations off the
                // srcPath because sst.Function internally builds the copy "from" path by
                // joining the srcPath and the from path.
                copyFiles: [{
                        from: path_1.default.relative(path_1.default.resolve(srcPath), path_1.default.resolve(migrations)),
                        to: migrationsDestination,
                    }],
            },
        });
        fn.attachPermissions([this.rdsServerlessCluster]);
        return fn;
    }
    createMigrationCustomResource(migrations) {
        var _a, _b, _c;
        const app = this.node.root;
        // Create custom resource handler
        const handler = new lambda.Function(this, "MigrationHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_14_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.migratorFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        // Note: "MigrationsHash" is generated to ensure the Custom Resource function
        //       is only run when migration files change.
        //
        //       Do not use the hash in Live mode, b/c we want the custom resource
        //       to remain the same in CloudFormation template when rebuilding
        //       infrastructure. Otherwise, there will always be a change when
        //       rebuilding infrastructure b/c the "BuildAt" property changes on
        //       each build.
        const hash = app.local ? 0 : this.generateMigrationsHash(migrations);
        new cdk.CustomResource(this, "MigrationResource", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: app.local ? undefined : (_b = this.migratorFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserUpdateFunction: app.local ? undefined : (_c = this.migratorFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify({}),
                MigrationsHash: hash,
            },
        });
    }
    generateMigrationsHash(migrations) {
        // Get all files inside the migrations folder
        const files = glob_1.default.sync("**", {
            dot: true,
            nodir: true,
            follow: true,
            cwd: migrations,
        });
        // Calculate hash of all files content
        return crypto
            .createHash("md5")
            .update(files.map((file) => fs.readFileSync(path_1.default.join(migrations, file))).join(""))
            .digest("hex");
    }
}
exports.RDS = RDS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUkRTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1JEUy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF3QjtBQUN4QixnREFBd0I7QUFDeEIsNkNBQStCO0FBQy9CLCtDQUFpQztBQUNqQywyQ0FBdUM7QUFDdkMsaURBQW1DO0FBQ25DLHlEQUEyQztBQUMzQyx5REFBMkM7QUFDM0MsK0RBQWlEO0FBRWpELDJDQUEyRDtBQUMzRCx5Q0FBNEM7QUF5RTVDLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsR0FBSSxTQUFRLHNCQUFTO0lBTWhDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBZTtRQUN2RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ25DLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFFL0Ysb0JBQW9CO1FBQ3BCLGdCQUFnQjtRQUNoQixvQkFBb0I7UUFFcEIsTUFBTSx5QkFBeUIsR0FBRyxDQUFDLG9CQUFvQixJQUFJLEVBQUUsQ0FBaUMsQ0FBQztRQUUvRixJQUFJLENBQUMsaUNBQWlDLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXhDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxtQkFBbUIsQ0FBQztRQUMvQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxHQUFHLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLFNBQVMsZ0NBQ25F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VixrQkFBa0IsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQUEsSUFBSSxDQUFDLGdCQUFnQiwwQ0FBRSxZQUFZO2dCQUMvRSxrQkFBa0IsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQUEsSUFBSSxDQUFDLGdCQUFnQiwwQ0FBRSxZQUFZO2dCQUMvRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7Z0JBQzlCLGNBQWMsRUFBRSxJQUFJO2FBQ3JCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLHNCQUFzQixDQUFDLFVBQWtCO1FBQy9DLDZDQUE2QztRQUM3QyxNQUFNLEtBQUssR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUM1QixHQUFHLEVBQUUsSUFBSTtZQUNULEtBQUssRUFBRSxJQUFJO1lBQ1gsTUFBTSxFQUFFLElBQUk7WUFDWixHQUFHLEVBQUUsVUFBVTtTQUNoQixDQUFDLENBQUM7UUFFSCxzQ0FBc0M7UUFDdEMsT0FBTyxNQUFNO2FBQ1YsVUFBVSxDQUFDLEtBQUssQ0FBQzthQUNqQixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQ3pCLEVBQUUsQ0FBQyxZQUFZLENBQUMsY0FBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FDN0MsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDVixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBbFJELGtCQWtSQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgZ2xvYiBmcm9tIFwiZ2xvYlwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lYzJcIjtcbmltcG9ydCAqIGFzIHJkcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJkc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IGdldEZ1bmN0aW9uUmVmLCBTU1RDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBSRFNQcm9wcyB7XG4gIC8qKlxuICAgKiBBZGRpdGlvbmFsIHByb3BlcnRpZXMgZm9yIHRoZSBjbHVzdGVyLlxuICAgKi9cbiAgcmRzU2VydmVybGVzc0NsdXN0ZXI/OiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzO1xuXG4gIC8qKlxuICAgKiBEYXRhYmFzZSBlbmdpbmUgb2YgdGhlIGNsdXN0ZXIuXG4gICAqL1xuICBlbmdpbmU6IFJEU0VuZ2luZVR5cGU7XG5cbiAgLyoqXG4gICAqIE5hbWUgb2YgYSBkYXRhYmFzZSB3aGljaCBpcyBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQgaW5zaWRlIHRoZSBjbHVzdGVyXG4gICAqL1xuICBkZWZhdWx0RGF0YWJhc2VOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFNjYWxpbmcgY29uZmlndXJhdGlvbiBvZiB0aGUgY2x1c3Rlci5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBUaGUgY2x1c3RlciBpcyBhdXRvbWF0aWNhbGx5IHBhdXNlZCBhZnRlciA1IG1pbnV0ZXMgb2YgYmVpbmcgaWRsZS5cbiAgICogbWluaW11bSBjYXBhY2l0eTogMiBBQ1VcbiAgICogbWF4aW11bSBjYXBhY2l0eTogMTYgQUNVXG4gICAqL1xuICBzY2FsaW5nPzogUkRTU2NhbGluZ1Byb3BzO1xuXG4gIC8qKlxuICAgKiBQYXRoIHRvIHRoZSBkaXJlY3RvcnkgdGhhdCBjb250YWlucyB0aGUgbWlncmF0aW9uIHNjcmlwdHMuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTWlncmF0aW9ucyBub3QgYXV0b21hdGljYWxseSBydW4gb24gZGVwbG95LlxuICAgKi9cbiAgbWlncmF0aW9ucz86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSRFNTY2FsaW5nUHJvcHMge1xuICAvKipcbiAgICogVGhlIHRpbWUgYmVmb3JlIHRoZSBjbHVzdGVyIGlzIHBhdXNlZC5cbiAgICpcbiAgICogUGFzcyBpbiB0cnVlIHRvIHBhdXNlIGFmdGVyIDUgbWludXRlcyBvZiBpbmFjdGl2ZS4gQW5kIHBhc3MgaW4gZmFsc2UgdG9cbiAgICogZGlzYWJsZSBwYXVzaW5nLlxuICAgKlxuICAgKiBPciBwYXNzIGluIHRoZSBudW1iZXIgb2YgbWludXRlcyB0byB3YWl0IGJlZm9yZSB0aGUgY2x1c3RlciBpcyBwYXVzZWQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gdHJ1ZVxuICAgKi9cbiAgYXV0b1BhdXNlPzogYm9vbGVhbiB8IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIG1pbmltdW0gY2FwYWNpdHkgZm9yIHRoZSBjbHVzdGVyLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEFDVV8yXG4gICAqL1xuICBtaW5DYXBhY2l0eT86IGtleW9mIHR5cGVvZiByZHMuQXVyb3JhQ2FwYWNpdHlVbml0O1xuXG4gIC8qKlxuICAgKiBUaGUgbWF4aW11bSBjYXBhY2l0eSBmb3IgdGhlIGNsdXN0ZXIuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQUNVXzE2XG4gICAqL1xuICBtYXhDYXBhY2l0eT86IGtleW9mIHR5cGVvZiByZHMuQXVyb3JhQ2FwYWNpdHlVbml0O1xufVxuXG5leHBvcnQgdHlwZSBSRFNFbmdpbmVUeXBlID0gXCJteXNxbDUuNlwiIHwgXCJteXNxbDUuN1wiIHwgXCJwb3N0Z3Jlc3FsMTAuMTRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzIGV4dGVuZHMgT21pdDxyZHMuU2VydmVybGVzc0NsdXN0ZXJQcm9wcywgXCJ2cGNcIiB8IFwiZW5naW5lXCIgfCBcImRlZmF1bHREYXRhYmFzZU5hbWVcIiB8IFwic2NhbGluZ1wiID4ge1xuICByZWFkb25seSB2cGM/OiBlYzIuSVZwYztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgUkRTIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IHJkc1NlcnZlcmxlc3NDbHVzdGVyOiByZHMuU2VydmVybGVzc0NsdXN0ZXI7XG4gIHB1YmxpYyByZWFkb25seSBtaWdyYXRvckZ1bmN0aW9uPzogRm47XG4gIHByaXZhdGUgcmVhZG9ubHkgZW5naW5lOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdERhdGFiYXNlTmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBSRFNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBhcHAgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHsgcmRzU2VydmVybGVzc0NsdXN0ZXIsIGVuZ2luZSwgZGVmYXVsdERhdGFiYXNlTmFtZSwgc2NhbGluZywgbWlncmF0aW9ucyB9ID0gcHJvcHMgfHwge307XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBCdWNrZXRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgY29uc3QgcmRzU2VydmVybGVzc0NsdXN0ZXJQcm9wcyA9IChyZHNTZXJ2ZXJsZXNzQ2x1c3RlciB8fCB7fSkgYXMgUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcztcblxuICAgIHRoaXMudmFsaWRhdGVSRFNTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpO1xuICAgIHRoaXMudmFsaWRhdGVSZXF1aXJlZFByb3BzKHByb3BzIHx8IHt9KTtcblxuICAgIHRoaXMuZW5naW5lID0gZW5naW5lO1xuICAgIHRoaXMuZGVmYXVsdERhdGFiYXNlTmFtZSA9IGRlZmF1bHREYXRhYmFzZU5hbWU7XG4gICAgdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3RlciA9IG5ldyByZHMuU2VydmVybGVzc0NsdXN0ZXIodGhpcywgXCJDbHVzdGVyXCIsIHtcbiAgICAgIGNsdXN0ZXJJZGVudGlmaWVyOiBhcHAubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAuLi5yZHNTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzLFxuICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZSxcbiAgICAgIGVuYWJsZURhdGFBcGk6IHRydWUsXG4gICAgICBlbmdpbmU6IHRoaXMuZ2V0RW5naW5lKGVuZ2luZSksXG4gICAgICBzY2FsaW5nOiB0aGlzLmdldFNjYWxpbmcoc2NhbGluZyksXG4gICAgICB2cGM6IHRoaXMuZ2V0VnBjKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpLFxuICAgICAgdnBjU3VibmV0czogdGhpcy5nZXRWcGNTdWJuZXRzKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpLFxuICAgIH0pO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIE1pZ3JhdGlvbnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChtaWdyYXRpb25zKSB7XG4gICAgICB0aGlzLnZhbGlkYXRlTWlncmF0aW9uc0ZpbGVFeGlzdHMobWlncmF0aW9ucyk7XG5cbiAgICAgIHRoaXMubWlncmF0b3JGdW5jdGlvbiA9IHRoaXMuY3JlYXRlTWlncmF0aW9uc0Z1bmN0aW9uKGVuZ2luZSwgZGVmYXVsdERhdGFiYXNlTmFtZSwgbWlncmF0aW9ucyk7XG4gICAgICB0aGlzLmNyZWF0ZU1pZ3JhdGlvbkN1c3RvbVJlc291cmNlKG1pZ3JhdGlvbnMpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2x1c3RlckFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJkc1NlcnZlcmxlc3NDbHVzdGVyLmNsdXN0ZXJBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGNsdXN0ZXJJZGVudGlmaWVyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucmRzU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlcklkZW50aWZpZXI7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGNsdXN0ZXJFbmRwb2ludCgpOiByZHMuRW5kcG9pbnQge1xuICAgIHJldHVybiB0aGlzLnJkc1NlcnZlcmxlc3NDbHVzdGVyLmNsdXN0ZXJFbmRwb2ludDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc2VjcmV0QXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucmRzU2VydmVybGVzc0NsdXN0ZXIuc2VjcmV0IS5zZWNyZXRBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiUkRTXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGVuZ2luZTogdGhpcy5lbmdpbmUsXG4gICAgICAgIHNlY3JldEFybjogdGhpcy5zZWNyZXRBcm4sXG4gICAgICAgIGNsdXN0ZXJBcm46IHRoaXMuY2x1c3RlckFybixcbiAgICAgICAgY2x1c3RlcklkZW50aWZpZXI6IHRoaXMuY2x1c3RlcklkZW50aWZpZXIsXG4gICAgICAgIGRlZmF1bHREYXRhYmFzZU5hbWU6IHRoaXMuZGVmYXVsdERhdGFiYXNlTmFtZSxcbiAgICAgICAgbWlncmF0b3I6IHRoaXMubWlncmF0b3JGdW5jdGlvbiAmJiBnZXRGdW5jdGlvblJlZih0aGlzLm1pZ3JhdG9yRnVuY3Rpb24pLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJEU1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMocHJvcHM6IFJEU0Nka1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpIHtcbiAgICAvLyBWYWxpZGF0ZSBcImVuZ2luZVwiIGlzIHBhc3NlZCBpbiBmcm9tIHRoZSB0b3AgbGV2ZWxcbiAgICBpZiAoKHByb3BzIGFzIGFueSkuZW5naW5lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBVc2UgXCJlbmdpbmVcIiBpbnN0ZWFkIG9mIFwicmRzU2VydmVybGVzc0NsdXN0ZXIuZW5naW5lXCIgdG8gY29uZmlndXJlIHRoZSBSRFMgZGF0YWJhc2UgZW5naW5lLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgXCJkZWZhdWx0RGF0YWJhc2VOYW1lXCIgaXMgcGFzc2VkIGluIGZyb20gdGhlIHRvcCBsZXZlbFxuICAgIGlmICgocHJvcHMgYXMgYW55KS5kZWZhdWx0RGF0YWJhc2VOYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBVc2UgXCJkZWZhdWx0RGF0YWJhc2VOYW1lXCIgaW5zdGVhZCBvZiBcInJkc1NlcnZlcmxlc3NDbHVzdGVyLmRlZmF1bHREYXRhYmFzZU5hbWVcIiB0byBjb25maWd1cmUgdGhlIFJEUyBkYXRhYmFzZSBlbmdpbmUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBcInNjYWxpbmdcIiBpcyBwYXNzZWQgaW4gZnJvbSB0aGUgdG9wIGxldmVsXG4gICAgaWYgKChwcm9wcyBhcyBhbnkpLnNjYWxpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFVzZSBcInNjYWxpbmdcIiBpbnN0ZWFkIG9mIFwicmRzU2VydmVybGVzc0NsdXN0ZXIuc2NhbGluZ1wiIHRvIGNvbmZpZ3VyZSB0aGUgUkRTIGRhdGFiYXNlIGF1dG8tc2NhbGluZy5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIFwiZW5hYmxlRGF0YUFwaVwiIGlzIG5vdCBwYXNzZWQgaW5cbiAgICBpZiAocHJvcHMuZW5hYmxlRGF0YUFwaSA9PT0gZmFsc2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwicmRzU2VydmVybGVzc0NsdXN0ZXIuZW5hYmxlRGF0YUFwaVwiLiBEYXRhIEFQSSBpcyBhbHdheXMgZW5hYmxlZCBmb3IgdGhpcyBjb25zdHJ1Y3QuYFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUmVxdWlyZWRQcm9wcyhwcm9wczogUkRTUHJvcHMpIHtcbiAgICBpZiAoIXByb3BzLmVuZ2luZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFwiZW5naW5lXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgUkRTYCk7XG4gICAgfVxuXG4gICAgaWYgKCFwcm9wcy5kZWZhdWx0RGF0YWJhc2VOYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkZWZhdWx0RGF0YWJhc2VOYW1lXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgUkRTYCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZU1pZ3JhdGlvbnNGaWxlRXhpc3RzKG1pZ3JhdGlvbnM6IHN0cmluZykge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhtaWdyYXRpb25zKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBmaW5kIHRoZSBtaWdyYXRpb25zIGluIFwiJHtwYXRoLnJlc29sdmUobWlncmF0aW9ucyl9XCIuYFxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RW5naW5lKGVuZ2luZTogUkRTRW5naW5lVHlwZSk6IHJkcy5JQ2x1c3RlckVuZ2luZSB7XG4gICAgaWYgKGVuZ2luZSA9PT0gXCJteXNxbDUuNlwiKSB7XG4gICAgICByZXR1cm4gcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5hdXJvcmEoe1xuICAgICAgICB2ZXJzaW9uOiByZHMuQXVyb3JhRW5naW5lVmVyc2lvbi5WRVJfMTBBLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGVuZ2luZSA9PT0gXCJteXNxbDUuN1wiKSB7XG4gICAgICByZXR1cm4gcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5hdXJvcmFNeXNxbCh7XG4gICAgICAgIHZlcnNpb246IHJkcy5BdXJvcmFNeXNxbEVuZ2luZVZlcnNpb24uVkVSXzJfMDdfMSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIGlmIChlbmdpbmUgPT09IFwicG9zdGdyZXNxbDEwLjE0XCIpIHtcbiAgICAgIHJldHVybiByZHMuRGF0YWJhc2VDbHVzdGVyRW5naW5lLmF1cm9yYVBvc3RncmVzKHtcbiAgICAgICAgdmVyc2lvbjogcmRzLkF1cm9yYVBvc3RncmVzRW5naW5lVmVyc2lvbi5WRVJfMTBfMTQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIHNwZWNpZmllZCBcImVuZ2luZVwiIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIHNzdC5SRFMuIE9ubHkgbXlzcWw1LjYsIG15c3FsNS43LCBhbmQgcG9zdGdyZXNxbDEwLjE0IGVuZ2luZXMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQuYFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFNjYWxpbmcoc2NhbGluZz86IFJEU1NjYWxpbmdQcm9wcyk6IHJkcy5TZXJ2ZXJsZXNzU2NhbGluZ09wdGlvbnMge1xuICAgIHJldHVybiB7XG4gICAgICBhdXRvUGF1c2U6IHNjYWxpbmc/LmF1dG9QYXVzZSA9PT0gZmFsc2VcbiAgICAgICAgPyBjZGsuRHVyYXRpb24ubWludXRlcygwKVxuICAgICAgICA6IChzY2FsaW5nPy5hdXRvUGF1c2UgPT09IHRydWUgfHwgc2NhbGluZz8uYXV0b1BhdXNlID09PSB1bmRlZmluZWQpXG4gICAgICAgICAgPyBjZGsuRHVyYXRpb24ubWludXRlcyg1KVxuICAgICAgICAgIDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoc2NhbGluZz8uYXV0b1BhdXNlKSxcbiAgICAgIG1pbkNhcGFjaXR5OiByZHMuQXVyb3JhQ2FwYWNpdHlVbml0W3NjYWxpbmc/Lm1pbkNhcGFjaXR5IHx8IFwiQUNVXzJcIl0sXG4gICAgICBtYXhDYXBhY2l0eTogcmRzLkF1cm9yYUNhcGFjaXR5VW5pdFtzY2FsaW5nPy5tYXhDYXBhY2l0eSB8fCBcIkFDVV8xNlwiXVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldFZwYyhwcm9wczogUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcyk6IGVjMi5JVnBjIHtcbiAgICBpZiAocHJvcHMudnBjKSB7XG4gICAgICByZXR1cm4gcHJvcHMudnBjO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgZWMyLlZwYyh0aGlzLCBcInZwY1wiLCB7XG4gICAgICBuYXRHYXRld2F5czogMCxcbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRWcGNTdWJuZXRzKHByb3BzOiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKTogZWMyLlN1Ym5ldFNlbGVjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHByb3BzLnZwYykge1xuICAgICAgcmV0dXJuIHByb3BzLnZwY1N1Ym5ldHM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfSVNPTEFURUQsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWlncmF0aW9uc0Z1bmN0aW9uKGVuZ2luZTogc3RyaW5nLCBkZWZhdWx0RGF0YWJhc2VOYW1lOiBzdHJpbmcsIG1pZ3JhdGlvbnM6IHN0cmluZykge1xuICAgIGNvbnN0IGFwcCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcblxuICAgIC8vIHBhdGggdG8gbWlncmF0aW9uIHNjcmlwdHMgaW5zaWRlIHRoZSBMYW1iZGEgZnVuY3Rpb25cbiAgICBjb25zdCBtaWdyYXRpb25zRGVzdGluYXRpb24gPSBcInNzdF9yZHNfbWlncmF0aW9uX3NjcmlwdHNcIjtcblxuICAgIC8vIGZ1bGxwYXRoIG9mIHRoZSBtaWdyYXRvciBMYW1iZGEgZnVuY3Rpb25cbiAgICAvLyBOb3RlOlxuICAgIC8vIC0gd2hlbiBpbnZva2VkIGZyb20gYHNzdCBidWlsZGAsIF9fZGlybmFtZSBpcyBgcmVzb3VyY2VzL2Rpc3RgXG4gICAgLy8gLSB3aGVuIHJ1bm5pbmcgcmVzb3VyY2VzIHRlc3RzLCBfX2Rpcm5hbWUgaXMgYHJlc291cmNlcy9zcmNgXG4gICAgLy8gRm9yIG5vdyB3ZSB3aWxsIGRvIGBfX2Rpcm5hbWUvLi4vZGlzdGAgdG8gbWFrZSBib3RoIGNhc2VzIHdvcmsuXG4gICAgY29uc3Qgc3JjUGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwiZGlzdFwiLCBcIlJEU19taWdyYXRvclwiKSk7XG5cbiAgICBjb25zdCBmbiA9IG5ldyBGbih0aGlzLCBcIk1pZ3JhdGlvbkZ1bmN0aW9uXCIsIHtcbiAgICAgIHNyY1BhdGgsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IFwibm9kZWpzMTQueFwiLFxuICAgICAgdGltZW91dDogOTAwLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFJEU19BUk46IHRoaXMucmRzU2VydmVybGVzc0NsdXN0ZXIuY2x1c3RlckFybixcbiAgICAgICAgUkRTX1NFQ1JFVDogdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3Rlci5zZWNyZXQhLnNlY3JldEFybixcbiAgICAgICAgUkRTX0RBVEFCQVNFOiBkZWZhdWx0RGF0YWJhc2VOYW1lLFxuICAgICAgICBSRFNfRU5HSU5FX01PREU6IGVuZ2luZSA9PT0gXCJwb3N0Z3Jlc3FsMTAuMTRcIiA/IFwicG9zdGdyZXNcIiA6IFwibXlzcWxcIixcbiAgICAgICAgLy8gZm9yIGxpdmUgZGV2ZWxvcG1lbnQsIHBlcnNlcnZlIHRoZSBtaWdyYXRpb25zIHBhdGggc28gdGhlIG1pZ3JhdG9yXG4gICAgICAgIC8vIGNhbiBsb2NhdGUgdGhlIG1pZ3JhdGlvbiBmaWxlc1xuICAgICAgICBSRFNfTUlHUkFUSU9OU19QQVRIOiBhcHAubG9jYWxcbiAgICAgICAgICA/IG1pZ3JhdGlvbnNcbiAgICAgICAgICA6IG1pZ3JhdGlvbnNEZXN0aW5hdGlvbixcbiAgICAgIH0sXG4gICAgICBidW5kbGU6IHtcbiAgICAgICAgLy8gTm90ZSB0aGF0IHdlIG5lZWQgdG8gZ2VuZXJhdGUgYSByZWxhdGl2ZSBwYXRoIG9mIHRoZSBtaWdyYXRpb25zIG9mZiB0aGVcbiAgICAgICAgLy8gc3JjUGF0aCBiZWNhdXNlIHNzdC5GdW5jdGlvbiBpbnRlcm5hbGx5IGJ1aWxkcyB0aGUgY29weSBcImZyb21cIiBwYXRoIGJ5XG4gICAgICAgIC8vIGpvaW5pbmcgdGhlIHNyY1BhdGggYW5kIHRoZSBmcm9tIHBhdGguXG4gICAgICAgIGNvcHlGaWxlczogW3tcbiAgICAgICAgICBmcm9tOiBwYXRoLnJlbGF0aXZlKHBhdGgucmVzb2x2ZShzcmNQYXRoKSwgcGF0aC5yZXNvbHZlKG1pZ3JhdGlvbnMpKSxcbiAgICAgICAgICB0bzogbWlncmF0aW9uc0Rlc3RpbmF0aW9uLFxuICAgICAgICB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhbdGhpcy5yZHNTZXJ2ZXJsZXNzQ2x1c3Rlcl0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNaWdyYXRpb25DdXN0b21SZXNvdXJjZShtaWdyYXRpb25zOiBzdHJpbmcpIHtcbiAgICBjb25zdCBhcHAgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlIGhhbmRsZXJcbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIk1pZ3JhdGlvbkhhbmRsZXJcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsIFwiU2NyaXB0XCIpKSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgIH0pO1xuICAgIHRoaXMubWlncmF0b3JGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICAvLyBOb3RlOiBcIk1pZ3JhdGlvbnNIYXNoXCIgaXMgZ2VuZXJhdGVkIHRvIGVuc3VyZSB0aGUgQ3VzdG9tIFJlc291cmNlIGZ1bmN0aW9uXG4gICAgLy8gICAgICAgaXMgb25seSBydW4gd2hlbiBtaWdyYXRpb24gZmlsZXMgY2hhbmdlLlxuICAgIC8vXG4gICAgLy8gICAgICAgRG8gbm90IHVzZSB0aGUgaGFzaCBpbiBMaXZlIG1vZGUsIGIvYyB3ZSB3YW50IHRoZSBjdXN0b20gcmVzb3VyY2VcbiAgICAvLyAgICAgICB0byByZW1haW4gdGhlIHNhbWUgaW4gQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgd2hlbiByZWJ1aWxkaW5nXG4gICAgLy8gICAgICAgaW5mcmFzdHJ1Y3R1cmUuIE90aGVyd2lzZSwgdGhlcmUgd2lsbCBhbHdheXMgYmUgYSBjaGFuZ2Ugd2hlblxuICAgIC8vICAgICAgIHJlYnVpbGRpbmcgaW5mcmFzdHJ1Y3R1cmUgYi9jIHRoZSBcIkJ1aWxkQXRcIiBwcm9wZXJ0eSBjaGFuZ2VzIG9uXG4gICAgLy8gICAgICAgZWFjaCBidWlsZC5cbiAgICBjb25zdCBoYXNoID0gYXBwLmxvY2FsID8gMCA6IHRoaXMuZ2VuZXJhdGVNaWdyYXRpb25zSGFzaChtaWdyYXRpb25zKTtcbiAgICBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiTWlncmF0aW9uUmVzb3VyY2VcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUU2NyaXB0XCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFVzZXJDcmVhdGVGdW5jdGlvbjogYXBwLmxvY2FsID8gdW5kZWZpbmVkIDogdGhpcy5taWdyYXRvckZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJVcGRhdGVGdW5jdGlvbjogYXBwLmxvY2FsID8gdW5kZWZpbmVkIDogdGhpcy5taWdyYXRvckZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJQYXJhbXM6IEpTT04uc3RyaW5naWZ5KHt9KSxcbiAgICAgICAgTWlncmF0aW9uc0hhc2g6IGhhc2gsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU1pZ3JhdGlvbnNIYXNoKG1pZ3JhdGlvbnM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gR2V0IGFsbCBmaWxlcyBpbnNpZGUgdGhlIG1pZ3JhdGlvbnMgZm9sZGVyXG4gICAgY29uc3QgZmlsZXMgPSBnbG9iLnN5bmMoXCIqKlwiLCB7XG4gICAgICBkb3Q6IHRydWUsXG4gICAgICBub2RpcjogdHJ1ZSxcbiAgICAgIGZvbGxvdzogdHJ1ZSxcbiAgICAgIGN3ZDogbWlncmF0aW9ucyxcbiAgICB9KTtcblxuICAgIC8vIENhbGN1bGF0ZSBoYXNoIG9mIGFsbCBmaWxlcyBjb250ZW50XG4gICAgcmV0dXJuIGNyeXB0b1xuICAgICAgLmNyZWF0ZUhhc2goXCJtZDVcIilcbiAgICAgIC51cGRhdGUoZmlsZXMubWFwKChmaWxlKSA9PlxuICAgICAgICBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKG1pZ3JhdGlvbnMsIGZpbGUpKVxuICAgICAgKS5qb2luKFwiXCIpKVxuICAgICAgLmRpZ2VzdChcImhleFwiKTtcbiAgfVxufVxuIl19