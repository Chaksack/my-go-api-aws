"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Script = void 0;
const path_1 = __importDefault(require("path"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const Function_1 = require("./Function");
class Script extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Validate deprecated "function" prop
        if (props.function)
            this.checkDeprecatedFunction();
        // Validate at least 1 function is provided
        if (!props.onCreate && !props.onUpdate && !props.onDelete) {
            throw new Error(`Need to provide at least one of "onCreate", "onUpdate", or "onDelete" functions for the "${this.node.id}" Script`);
        }
        const root = scope.node.root;
        this.props = props;
        this.createFunction = this.createUserFunction("onCreate", props.onCreate);
        this.updateFunction = this.createUserFunction("onUpdate", props.onUpdate);
        this.deleteFunction = this.createUserFunction("onDelete", props.onDelete);
        const crFunction = this.createCustomResourceFunction();
        this.createCustomResource(root, crFunction);
    }
    attachPermissions(permissions) {
        var _a, _b, _c;
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.attachPermissions(permissions);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.attachPermissions(permissions);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.attachPermissions(permissions);
    }
    createUserFunction(type, fnDef) {
        if (!fnDef) {
            return;
        }
        // function is construct => return function directly
        if (fnDef instanceof Function_1.Function) {
            // validate live dev is not enabled
            if (fnDef._isLiveDevEnabled) {
                throw new Error(`Live Lambda Dev cannot be enabled for functions in the Script construct. Set the "enableLiveDev" prop for the function to "false".`);
            }
            return Function_1.Function.fromDefinition(this, `${type}Function`, fnDef, this.props.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define the "${type}" function using FunctionProps, so the Script construct can apply the "defaultFunctionProps" to them.`);
        }
        // function is string => create function
        else if (typeof fnDef === "string") {
            return Function_1.Function.fromDefinition(this, `${type}Function`, {
                handler: fnDef,
                enableLiveDev: false,
            }, Object.assign({ timeout: 900 }, this.props.defaultFunctionProps));
        }
        // function is props => create function
        return Function_1.Function.fromDefinition(this, `${type}Function`, Object.assign(Object.assign({}, fnDef), { enableLiveDev: false }), Object.assign({ timeout: 900 }, this.props.defaultFunctionProps));
    }
    createCustomResourceFunction() {
        var _a, _b, _c;
        const handler = new lambda.Function(this, "ScriptHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_14_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.grantInvoke(handler);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.grantInvoke(handler);
        return handler;
    }
    createCustomResource(app, crFunction) {
        var _a, _b, _c;
        // Note: "BuiltAt" is set to current timestamp to ensure the Custom
        //       Resource function is run on every update.
        //
        //       Do not use the current timestamp in Live mode, b/c we want the
        //       this custom resource to remain the same in CloudFormation template
        //       when rebuilding infrastructure. Otherwise, there will always be
        //       a change when rebuilding infrastructure b/c the "BuildAt" property
        //       changes on each build.
        const builtAt = app.local ? app.debugStartedAt : Date.now();
        new cdk.CustomResource(this, "ScriptResource", {
            serviceToken: crFunction.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.functionName,
                UserUpdateFunction: (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserDeleteFunction: (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify(this.props.params || {}),
                BuiltAt: builtAt,
            },
        });
    }
    checkDeprecatedFunction() {
        throw new Error(`The "function" property has been replaced by "onCreate" and "onUpdate". More details on upgrading - https://docs.serverless-stack.com/constructs/Script#upgrading-to-v0460`);
    }
}
exports.Script = Script;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjcmlwdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF3QjtBQUN4QiwyQ0FBdUM7QUFDdkMsaURBQW1DO0FBQ25DLCtEQUFpRDtBQUVqRCx5Q0FBK0U7QUFXL0UsTUFBYSxNQUFPLFNBQVEsc0JBQVM7SUFNbkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUMxRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLHNDQUFzQztRQUN0QyxJQUFLLEtBQWEsQ0FBQyxRQUFRO1lBQUUsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFFNUQsMkNBQTJDO1FBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDekQsTUFBTSxJQUFJLEtBQUssQ0FDYiw0RkFBNEYsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLFVBQVUsQ0FDbkgsQ0FBQztTQUNIO1FBRUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUUsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixFQUFFLENBQUM7UUFDdkQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRU0saUJBQWlCLENBQUMsV0FBd0I7O1FBQy9DLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDcEQsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwRCxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFUyxrQkFBa0IsQ0FDMUIsSUFBWSxFQUNaLEtBQTBCO1FBRTFCLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPO1NBQ1I7UUFFRCxvREFBb0Q7UUFDcEQsSUFBSSxLQUFLLFlBQVksbUJBQUUsRUFBRTtZQUN2QixtQ0FBbUM7WUFDbkMsSUFBSSxLQUFLLENBQUMsaUJBQWlCLEVBQUU7Z0JBQzNCLE1BQU0sSUFBSSxLQUFLLENBQ2Isb0lBQW9JLENBQ3JJLENBQUM7YUFDSDtZQUVELE9BQU8sbUJBQUUsQ0FBQyxjQUFjLENBQ3RCLElBQUksRUFDSixHQUFHLElBQUksVUFBVSxFQUNqQixLQUFLLEVBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFDL0IsOEhBQThILElBQUksdUdBQXVHLENBQzFPLENBQUM7U0FDSDtRQUVELHdDQUF3QzthQUNuQyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUNsQyxPQUFPLG1CQUFFLENBQUMsY0FBYyxDQUN0QixJQUFJLEVBQ0osR0FBRyxJQUFJLFVBQVUsRUFDakI7Z0JBQ0UsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsYUFBYSxFQUFFLEtBQUs7YUFDckIsa0JBRUMsT0FBTyxFQUFFLEdBQUcsSUFDVCxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUVyQyxDQUFDO1NBQ0g7UUFFRCx1Q0FBdUM7UUFDdkMsT0FBTyxtQkFBRSxDQUFDLGNBQWMsQ0FDdEIsSUFBSSxFQUNKLEdBQUcsSUFBSSxVQUFVLGtDQUVaLEtBQUssS0FDUixhQUFhLEVBQUUsS0FBSyxxQkFHcEIsT0FBTyxFQUFFLEdBQUcsSUFDVCxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUVyQyxDQUFDO0lBQ0osQ0FBQztJQUVPLDRCQUE0Qjs7UUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUU7WUFDekQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzNELE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLGVBQWU7WUFDeEIsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDLENBQUM7UUFDSCxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQyxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQyxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUxQyxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRU8sb0JBQW9CLENBQUMsR0FBUSxFQUFFLFVBQTJCOztRQUNoRSxtRUFBbUU7UUFDbkUsa0RBQWtEO1FBQ2xELEVBQUU7UUFDRix1RUFBdUU7UUFDdkUsMkVBQTJFO1FBQzNFLHdFQUF3RTtRQUN4RSwyRUFBMkU7UUFDM0UsK0JBQStCO1FBQy9CLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM1RCxJQUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQzdDLFlBQVksRUFBRSxVQUFVLENBQUMsV0FBVztZQUNwQyxZQUFZLEVBQUUsbUJBQW1CO1lBQ2pDLFVBQVUsRUFBRTtnQkFDVixrQkFBa0IsRUFBRSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFlBQVk7Z0JBQ3JELGtCQUFrQixFQUFFLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsWUFBWTtnQkFDckQsa0JBQWtCLEVBQUUsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxZQUFZO2dCQUNyRCxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7Z0JBQ25ELE9BQU8sRUFBRSxPQUFPO2FBQ2pCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLHVCQUF1QjtRQUM3QixNQUFNLElBQUksS0FBSyxDQUNiLDRLQUE0SyxDQUM3SyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBdklELHdCQXVJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuZXhwb3J0IGludGVyZmFjZSBTY3JpcHRQcm9wcyB7XG4gIHJlYWRvbmx5IG9uQ3JlYXRlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBvblVwZGF0ZT86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgb25EZWxldGU/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHBhcmFtcz86IHsgW2tleTogc3RyaW5nXTogYW55IH07XG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbn1cblxuZXhwb3J0IGNsYXNzIFNjcmlwdCBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBjcmVhdGVGdW5jdGlvbj86IEZuO1xuICBwdWJsaWMgcmVhZG9ubHkgdXBkYXRlRnVuY3Rpb24/OiBGbjtcbiAgcHVibGljIHJlYWRvbmx5IGRlbGV0ZUZ1bmN0aW9uPzogRm47XG4gIHByb3RlY3RlZCByZWFkb25seSBwcm9wczogU2NyaXB0UHJvcHM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFNjcmlwdFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIFZhbGlkYXRlIGRlcHJlY2F0ZWQgXCJmdW5jdGlvblwiIHByb3BcbiAgICBpZiAoKHByb3BzIGFzIGFueSkuZnVuY3Rpb24pIHRoaXMuY2hlY2tEZXByZWNhdGVkRnVuY3Rpb24oKTtcblxuICAgIC8vIFZhbGlkYXRlIGF0IGxlYXN0IDEgZnVuY3Rpb24gaXMgcHJvdmlkZWRcbiAgICBpZiAoIXByb3BzLm9uQ3JlYXRlICYmICFwcm9wcy5vblVwZGF0ZSAmJiAhcHJvcHMub25EZWxldGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5lZWQgdG8gcHJvdmlkZSBhdCBsZWFzdCBvbmUgb2YgXCJvbkNyZWF0ZVwiLCBcIm9uVXBkYXRlXCIsIG9yIFwib25EZWxldGVcIiBmdW5jdGlvbnMgZm9yIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFNjcmlwdGBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgdGhpcy5wcm9wcyA9IHByb3BzO1xuXG4gICAgdGhpcy5jcmVhdGVGdW5jdGlvbiA9IHRoaXMuY3JlYXRlVXNlckZ1bmN0aW9uKFwib25DcmVhdGVcIiwgcHJvcHMub25DcmVhdGUpO1xuICAgIHRoaXMudXBkYXRlRnVuY3Rpb24gPSB0aGlzLmNyZWF0ZVVzZXJGdW5jdGlvbihcIm9uVXBkYXRlXCIsIHByb3BzLm9uVXBkYXRlKTtcbiAgICB0aGlzLmRlbGV0ZUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVVc2VyRnVuY3Rpb24oXCJvbkRlbGV0ZVwiLCBwcm9wcy5vbkRlbGV0ZSk7XG4gICAgY29uc3QgY3JGdW5jdGlvbiA9IHRoaXMuY3JlYXRlQ3VzdG9tUmVzb3VyY2VGdW5jdGlvbigpO1xuICAgIHRoaXMuY3JlYXRlQ3VzdG9tUmVzb3VyY2Uocm9vdCwgY3JGdW5jdGlvbik7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgdGhpcy5jcmVhdGVGdW5jdGlvbj8uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIHRoaXMudXBkYXRlRnVuY3Rpb24/LmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgICB0aGlzLmRlbGV0ZUZ1bmN0aW9uPy5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY3JlYXRlVXNlckZ1bmN0aW9uKFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBmbkRlZj86IEZ1bmN0aW9uRGVmaW5pdGlvblxuICApOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFmbkRlZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGZ1bmN0aW9uIGlzIGNvbnN0cnVjdCA9PiByZXR1cm4gZnVuY3Rpb24gZGlyZWN0bHlcbiAgICBpZiAoZm5EZWYgaW5zdGFuY2VvZiBGbikge1xuICAgICAgLy8gdmFsaWRhdGUgbGl2ZSBkZXYgaXMgbm90IGVuYWJsZWRcbiAgICAgIGlmIChmbkRlZi5faXNMaXZlRGV2RW5hYmxlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYExpdmUgTGFtYmRhIERldiBjYW5ub3QgYmUgZW5hYmxlZCBmb3IgZnVuY3Rpb25zIGluIHRoZSBTY3JpcHQgY29uc3RydWN0LiBTZXQgdGhlIFwiZW5hYmxlTGl2ZURldlwiIHByb3AgZm9yIHRoZSBmdW5jdGlvbiB0byBcImZhbHNlXCIuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAgICBmbkRlZixcbiAgICAgICAgdGhpcy5wcm9wcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIHRoZSBcIiR7dHlwZX1cIiBmdW5jdGlvbiB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgU2NyaXB0IGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gaXMgc3RyaW5nID0+IGNyZWF0ZSBmdW5jdGlvblxuICAgIGVsc2UgaWYgKHR5cGVvZiBmbkRlZiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0eXBlfUZ1bmN0aW9uYCxcbiAgICAgICAge1xuICAgICAgICAgIGhhbmRsZXI6IGZuRGVmLFxuICAgICAgICAgIGVuYWJsZUxpdmVEZXY6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgdGltZW91dDogOTAwLFxuICAgICAgICAgIC4uLnRoaXMucHJvcHMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gaXMgcHJvcHMgPT4gY3JlYXRlIGZ1bmN0aW9uXG4gICAgcmV0dXJuIEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAge1xuICAgICAgICAuLi5mbkRlZixcbiAgICAgICAgZW5hYmxlTGl2ZURldjogZmFsc2UsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0aW1lb3V0OiA5MDAsXG4gICAgICAgIC4uLnRoaXMucHJvcHMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tUmVzb3VyY2VGdW5jdGlvbigpOiBsYW1iZGEuRnVuY3Rpb24ge1xuICAgIGNvbnN0IGhhbmRsZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiU2NyaXB0SGFuZGxlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgXCJTY3JpcHRcIikpLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG4gICAgdGhpcy5jcmVhdGVGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG4gICAgdGhpcy5kZWxldGVGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICByZXR1cm4gaGFuZGxlcjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tUmVzb3VyY2UoYXBwOiBBcHAsIGNyRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbik6IHZvaWQge1xuICAgIC8vIE5vdGU6IFwiQnVpbHRBdFwiIGlzIHNldCB0byBjdXJyZW50IHRpbWVzdGFtcCB0byBlbnN1cmUgdGhlIEN1c3RvbVxuICAgIC8vICAgICAgIFJlc291cmNlIGZ1bmN0aW9uIGlzIHJ1biBvbiBldmVyeSB1cGRhdGUuXG4gICAgLy9cbiAgICAvLyAgICAgICBEbyBub3QgdXNlIHRoZSBjdXJyZW50IHRpbWVzdGFtcCBpbiBMaXZlIG1vZGUsIGIvYyB3ZSB3YW50IHRoZVxuICAgIC8vICAgICAgIHRoaXMgY3VzdG9tIHJlc291cmNlIHRvIHJlbWFpbiB0aGUgc2FtZSBpbiBDbG91ZEZvcm1hdGlvbiB0ZW1wbGF0ZVxuICAgIC8vICAgICAgIHdoZW4gcmVidWlsZGluZyBpbmZyYXN0cnVjdHVyZS4gT3RoZXJ3aXNlLCB0aGVyZSB3aWxsIGFsd2F5cyBiZVxuICAgIC8vICAgICAgIGEgY2hhbmdlIHdoZW4gcmVidWlsZGluZyBpbmZyYXN0cnVjdHVyZSBiL2MgdGhlIFwiQnVpbGRBdFwiIHByb3BlcnR5XG4gICAgLy8gICAgICAgY2hhbmdlcyBvbiBlYWNoIGJ1aWxkLlxuICAgIGNvbnN0IGJ1aWx0QXQgPSBhcHAubG9jYWwgPyBhcHAuZGVidWdTdGFydGVkQXQgOiBEYXRlLm5vdygpO1xuICAgIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJTY3JpcHRSZXNvdXJjZVwiLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGNyRnVuY3Rpb24uZnVuY3Rpb25Bcm4sXG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RTY3JpcHRcIixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgVXNlckNyZWF0ZUZ1bmN0aW9uOiB0aGlzLmNyZWF0ZUZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJVcGRhdGVGdW5jdGlvbjogdGhpcy51cGRhdGVGdW5jdGlvbj8uZnVuY3Rpb25OYW1lLFxuICAgICAgICBVc2VyRGVsZXRlRnVuY3Rpb246IHRoaXMuZGVsZXRlRnVuY3Rpb24/LmZ1bmN0aW9uTmFtZSxcbiAgICAgICAgVXNlclBhcmFtczogSlNPTi5zdHJpbmdpZnkodGhpcy5wcm9wcy5wYXJhbXMgfHwge30pLFxuICAgICAgICBCdWlsdEF0OiBidWlsdEF0LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tEZXByZWNhdGVkRnVuY3Rpb24oKTogdm9pZCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBcImZ1bmN0aW9uXCIgcHJvcGVydHkgaGFzIGJlZW4gcmVwbGFjZWQgYnkgXCJvbkNyZWF0ZVwiIGFuZCBcIm9uVXBkYXRlXCIuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9TY3JpcHQjdXBncmFkaW5nLXRvLXYwNDYwYFxuICAgICk7XG4gIH1cbn1cbiJdfQ==