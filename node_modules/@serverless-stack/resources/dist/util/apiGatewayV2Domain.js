"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildCustomDomainData = void 0;
const cdk = __importStar(require("aws-cdk-lib"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
function buildCustomDomainData(scope, customDomain) {
    if (customDomain === undefined) {
        return;
    }
    // customDomain is a string
    else if (typeof customDomain === "string") {
        return buildDataForStringInput(scope, customDomain);
    }
    // customDomain.domainName not exists
    else if (!customDomain.domainName) {
        throw new Error(`Missing "domainName" in sst.Api's customDomain setting`);
    }
    // customDomain.domainName is a string
    else if (typeof customDomain.domainName === "string") {
        return customDomain.isExternalDomain
            ? buildDataForExternalDomainInput(scope, customDomain)
            : buildDataForInternalDomainInput(scope, customDomain);
    }
    // customDomain.domainName is a construct
    return buildDataForConstructInput(scope, customDomain);
}
exports.buildCustomDomainData = buildCustomDomainData;
function buildDataForStringInput(scope, customDomain) {
    // validate: customDomain is a TOKEN string
    // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
    if (cdk.Token.isUnresolved(customDomain)) {
        throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
    }
    assertDomainNameIsLowerCase(customDomain);
    const domainName = customDomain;
    const hostedZoneDomain = domainName.split(".").slice(1).join(".");
    const hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    const certificate = createCertificate(scope, domainName, hostedZone);
    const apigDomain = createApigDomain(scope, domainName, certificate);
    createARecords(scope, hostedZone, domainName, apigDomain);
    return {
        apigDomain,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated: true,
        url: buildDomainUrl(domainName),
    };
}
function buildDataForInternalDomainInput(scope, customDomain) {
    // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
    // is because "hostedZone" cannot be parsed from a TOKEN value.
    if (cdk.Token.isUnresolved(customDomain.domainName)) {
        if (!customDomain.hostedZone) {
            throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
        }
    }
    else {
        assertDomainNameIsLowerCase(customDomain.domainName);
    }
    const domainName = customDomain.domainName;
    // Lookup hosted zone
    // Note: Allow user passing in `hostedZone` object. The use case is when
    //       there are multiple HostedZones with the same domain, but one is
    //       public, and one is private.
    let hostedZone;
    if (!customDomain.hostedZone) {
        const hostedZoneDomain = domainName.split(".").slice(1).join(".");
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    else if (typeof customDomain.hostedZone === "string") {
        const hostedZoneDomain = customDomain.hostedZone;
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    else {
        hostedZone = customDomain.hostedZone;
    }
    // Create certificate
    // Note: Allow user passing in `certificate` object. The use case is for
    //       user to create wildcard certificate or using an imported certificate.
    let certificate, isCertificatedCreated;
    if (customDomain.certificate) {
        certificate = customDomain.certificate;
        isCertificatedCreated = false;
    }
    else {
        certificate = createCertificate(scope, domainName, hostedZone);
        isCertificatedCreated = true;
    }
    const apigDomain = createApigDomain(scope, domainName, certificate);
    const mappingKey = customDomain.path;
    createARecords(scope, hostedZone, domainName, apigDomain);
    return {
        apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function buildDataForExternalDomainInput(scope, customDomain) {
    // if it is external, then a certificate is required
    if (!customDomain.certificate) {
        throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
    }
    // if it is external, then the hostedZone is not required
    if (customDomain.hostedZone) {
        throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
    }
    const domainName = customDomain.domainName;
    assertDomainNameIsLowerCase(domainName);
    const certificate = customDomain.certificate;
    const apigDomain = createApigDomain(scope, domainName, certificate);
    const mappingKey = customDomain.path;
    return {
        apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated: false,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function buildDataForConstructInput(scope, customDomain) {
    //  Allow user passing in `apigDomain` object. The use case is a user creates
    //  multiple API endpoints, and is mapping them under the same custom domain.
    //  `sst.Api` needs to expose the `apigDomain` construct created in the first
    //  Api, and lets user pass it in when creating the second Api.
    if (customDomain.hostedZone) {
        throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
    }
    if (customDomain.certificate) {
        throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
    }
    const apigDomain = customDomain.domainName;
    const domainName = apigDomain.name;
    const mappingKey = customDomain.path;
    return {
        apigDomain,
        mappingKey,
        certificate: undefined,
        isApigDomainCreated: false,
        isCertificatedCreated: false,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function lookupHostedZone(scope, hostedZoneDomain) {
    return route53.HostedZone.fromLookup(scope, "HostedZone", {
        domainName: hostedZoneDomain,
    });
}
function createCertificate(scope, domainName, hostedZone) {
    return new acm.Certificate(scope, "Certificate", {
        domainName,
        validation: acm.CertificateValidation.fromDns(hostedZone),
    });
}
function createApigDomain(scope, domainName, certificate) {
    return new apig.DomainName(scope, "DomainName", {
        domainName,
        certificate,
    });
}
function createARecords(scope, hostedZone, domainName, apigDomain) {
    // create DNS record
    const recordProps = {
        recordName: domainName,
        zone: hostedZone,
        target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayv2DomainProperties(apigDomain.regionalDomainName, apigDomain.regionalHostedZoneId)),
    };
    const records = [
        new route53.ARecord(scope, "AliasRecord", recordProps),
        new route53.AaaaRecord(scope, "AliasRecordAAAA", recordProps),
    ];
    // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
    //       construct will append ".${hostedZoneName}" to the end of the domain.
    //       This is because the construct tries to check if the record name
    //       ends with the domain name. If not, it will append the domain name.
    //       So, we need remove this behavior.
    if (cdk.Token.isUnresolved(domainName)) {
        records.forEach((record) => {
            const cfnRecord = record.node.defaultChild;
            cfnRecord.name = domainName;
        });
    }
}
function buildDomainUrl(domainName, mappingKey) {
    // Note: If mapping key is set, the URL needs a trailing slash. Without the
    //       trailing slash, the API fails with the error
    //       {"message":"Not Found"}
    return mappingKey ? `${domainName}/${mappingKey}/` : domainName;
}
function assertDomainNameIsLowerCase(domainName) {
    if (domainName !== domainName.toLowerCase()) {
        throw new Error(`The domain name needs to be in lowercase`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyRG9tYWluLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyRG9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsaURBQW1DO0FBQ25DLHNFQUF3RDtBQUN4RCxpRUFBbUQ7QUFDbkQsZ0ZBQWtFO0FBQ2xFLHdFQUEwRDtBQW1CMUQsU0FBZ0IscUJBQXFCLENBQ25DLEtBQWdCLEVBQ2hCLFlBQW9EO0lBRXBELElBQUksWUFBWSxLQUFLLFNBQVMsRUFBRTtRQUM5QixPQUFPO0tBQ1I7SUFDRCwyQkFBMkI7U0FDdEIsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7UUFDekMsT0FBTyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7S0FDckQ7SUFDRCxxQ0FBcUM7U0FDaEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUU7UUFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO0tBQzNFO0lBQ0Qsc0NBQXNDO1NBQ2pDLElBQUksT0FBTyxZQUFZLENBQUMsVUFBVSxLQUFLLFFBQVEsRUFBRTtRQUNwRCxPQUFPLFlBQVksQ0FBQyxnQkFBZ0I7WUFDbEMsQ0FBQyxDQUFDLCtCQUErQixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUM7WUFDdEQsQ0FBQyxDQUFDLCtCQUErQixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztLQUMxRDtJQUNELHlDQUF5QztJQUN6QyxPQUFPLDBCQUEwQixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBdkJELHNEQXVCQztBQUVELFNBQVMsdUJBQXVCLENBQzlCLEtBQWdCLEVBQ2hCLFlBQW9CO0lBRXBCLDJDQUEyQztJQUMzQyx3RUFBd0U7SUFDeEUsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxZ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R0FBRyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7QUFDbEUsQ0FBQztBQUVELFNBQVMsMkJBQTJCLENBQUMsVUFBa0I7SUFDckQsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztLQUM3RDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hbHBoYVwiO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDdXN0b21Eb21haW5Qcm9wcyB7XG4gIHJlYWRvbmx5IGRvbWFpbk5hbWU6IHN0cmluZyB8IGFwaWcuSURvbWFpbk5hbWU7XG4gIHJlYWRvbmx5IGhvc3RlZFpvbmU/OiBzdHJpbmcgfCByb3V0ZTUzLklIb3N0ZWRab25lO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IHBhdGg/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGlzRXh0ZXJuYWxEb21haW4/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEN1c3RvbURvbWFpbkRhdGEge1xuICByZWFkb25seSBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lO1xuICByZWFkb25seSBtYXBwaW5nS2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IGJvb2xlYW47XG4gIHJlYWRvbmx5IGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZEN1c3RvbURvbWFpbkRhdGEoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGN1c3RvbURvbWFpbjogc3RyaW5nIHwgQ3VzdG9tRG9tYWluUHJvcHMgfCB1bmRlZmluZWRcbik6IEN1c3RvbURvbWFpbkRhdGEgfCB1bmRlZmluZWQge1xuICBpZiAoY3VzdG9tRG9tYWluID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluIGlzIGEgc3RyaW5nXG4gIGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gYnVpbGREYXRhRm9yU3RyaW5nSW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbik7XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgbm90IGV4aXN0c1xuICBlbHNlIGlmICghY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkb21haW5OYW1lXCIgaW4gc3N0LkFwaSdzIGN1c3RvbURvbWFpbiBzZXR0aW5nYCk7XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgaXMgYSBzdHJpbmdcbiAgZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5kb21haW5OYW1lID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluXG4gICAgICA/IGJ1aWxkRGF0YUZvckV4dGVybmFsRG9tYWluSW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbilcbiAgICAgIDogYnVpbGREYXRhRm9ySW50ZXJuYWxEb21haW5JbnB1dChzY29wZSwgY3VzdG9tRG9tYWluKTtcbiAgfVxuICAvLyBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBhIGNvbnN0cnVjdFxuICByZXR1cm4gYnVpbGREYXRhRm9yQ29uc3RydWN0SW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbik7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvclN0cmluZ0lucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IHN0cmluZ1xuKTogQ3VzdG9tRG9tYWluRGF0YSB7XG4gIC8vIHZhbGlkYXRlOiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmdcbiAgLy8gaWUuIGltcG9ydGVkIFNTTSB2YWx1ZTogc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZvclN0cmluZ1BhcmFtZXRlcigpXG4gIGlmIChjZGsuVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICApO1xuICB9XG5cbiAgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGN1c3RvbURvbWFpbik7XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGRvbWFpbk5hbWUuc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICBjb25zdCBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gY3JlYXRlQ2VydGlmaWNhdGUoc2NvcGUsIGRvbWFpbk5hbWUsIGhvc3RlZFpvbmUpO1xuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjcmVhdGVBUmVjb3JkcyhzY29wZSwgaG9zdGVkWm9uZSwgZG9tYWluTmFtZSwgYXBpZ0RvbWFpbik7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluLFxuICAgIGNlcnRpZmljYXRlLFxuICAgIGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IHRydWUsXG4gICAgaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkOiB0cnVlLFxuICAgIHVybDogYnVpbGREb21haW5VcmwoZG9tYWluTmFtZSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvckludGVybmFsRG9tYWluSW5wdXQoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGN1c3RvbURvbWFpbjogQ3VzdG9tRG9tYWluUHJvcHNcbik6IEN1c3RvbURvbWFpbkRhdGEge1xuICAvLyBJZiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmcsIFwiaG9zdGVkWm9uZVwiIGhhcyB0byBiZSBwYXNzZWQgaW4uIFRoaXNcbiAgLy8gaXMgYmVjYXVzZSBcImhvc3RlZFpvbmVcIiBjYW5ub3QgYmUgcGFyc2VkIGZyb20gYSBUT0tFTiB2YWx1ZS5cbiAgaWYgKGNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpKSB7XG4gICAgaWYgKCFjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICAgICk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShjdXN0b21Eb21haW4uZG9tYWluTmFtZSBhcyBzdHJpbmcpO1xuICB9XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGFzIHN0cmluZztcblxuICAvLyBMb29rdXAgaG9zdGVkIHpvbmVcbiAgLy8gTm90ZTogQWxsb3cgdXNlciBwYXNzaW5nIGluIGBob3N0ZWRab25lYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyB3aGVuXG4gIC8vICAgICAgIHRoZXJlIGFyZSBtdWx0aXBsZSBIb3N0ZWRab25lcyB3aXRoIHRoZSBzYW1lIGRvbWFpbiwgYnV0IG9uZSBpc1xuICAvLyAgICAgICBwdWJsaWMsIGFuZCBvbmUgaXMgcHJpdmF0ZS5cblxuICBsZXQgaG9zdGVkWm9uZTtcbiAgaWYgKCFjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgIGNvbnN0IGhvc3RlZFpvbmVEb21haW4gPSBkb21haW5OYW1lLnNwbGl0KFwiLlwiKS5zbGljZSgxKS5qb2luKFwiLlwiKTtcbiAgICBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lID09PSBcInN0cmluZ1wiKSB7XG4gICAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lO1xuICAgIGhvc3RlZFpvbmUgPSBsb29rdXBIb3N0ZWRab25lKHNjb3BlLCBob3N0ZWRab25lRG9tYWluKTtcbiAgfSBlbHNlIHtcbiAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gIH1cblxuICAvLyBDcmVhdGUgY2VydGlmaWNhdGVcbiAgLy8gTm90ZTogQWxsb3cgdXNlciBwYXNzaW5nIGluIGBjZXJ0aWZpY2F0ZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgZm9yXG4gIC8vICAgICAgIHVzZXIgdG8gY3JlYXRlIHdpbGRjYXJkIGNlcnRpZmljYXRlIG9yIHVzaW5nIGFuIGltcG9ydGVkIGNlcnRpZmljYXRlLlxuICBsZXQgY2VydGlmaWNhdGUsIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDtcbiAgaWYgKGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgIGNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCA9IGZhbHNlO1xuICB9IGVsc2Uge1xuICAgIGNlcnRpZmljYXRlID0gY3JlYXRlQ2VydGlmaWNhdGUoc2NvcGUsIGRvbWFpbk5hbWUsIGhvc3RlZFpvbmUpO1xuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCA9IHRydWU7XG4gIH1cblxuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjb25zdCBtYXBwaW5nS2V5ID0gY3VzdG9tRG9tYWluLnBhdGg7XG4gIGNyZWF0ZUFSZWNvcmRzKHNjb3BlLCBob3N0ZWRab25lLCBkb21haW5OYW1lLCBhcGlnRG9tYWluKTtcblxuICByZXR1cm4ge1xuICAgIGFwaWdEb21haW4sXG4gICAgbWFwcGluZ0tleSxcbiAgICBjZXJ0aWZpY2F0ZSxcbiAgICBpc0FwaWdEb21haW5DcmVhdGVkOiB0cnVlLFxuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCxcbiAgICB1cmw6IGJ1aWxkRG9tYWluVXJsKGRvbWFpbk5hbWUsIG1hcHBpbmdLZXkpLFxuICB9O1xufVxuXG5mdW5jdGlvbiBidWlsZERhdGFGb3JFeHRlcm5hbERvbWFpbklucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IEN1c3RvbURvbWFpblByb3BzXG4pOiBDdXN0b21Eb21haW5EYXRhIHtcbiAgLy8gaWYgaXQgaXMgZXh0ZXJuYWwsIHRoZW4gYSBjZXJ0aWZpY2F0ZSBpcyByZXF1aXJlZFxuICBpZiAoIWN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBBIHZhbGlkIGNlcnRpZmljYXRlIGlzIHJlcXVpcmVkIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgc2V0IHRvIFwidHJ1ZVwiLmBcbiAgICApO1xuICB9XG4gIC8vIGlmIGl0IGlzIGV4dGVybmFsLCB0aGVuIHRoZSBob3N0ZWRab25lIGlzIG5vdCByZXF1aXJlZFxuICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgSG9zdGVkIHpvbmVzIGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgZm9yIGRvbWFpbnMgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My4gRG8gbm90IHNldCB0aGUgXCJjdXN0b21Eb21haW4uaG9zdGVkWm9uZVwiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC5gXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBhcyBzdHJpbmc7XG4gIGFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShkb21haW5OYW1lKTtcbiAgY29uc3QgY2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gIGNvbnN0IGFwaWdEb21haW4gPSBjcmVhdGVBcGlnRG9tYWluKHNjb3BlLCBkb21haW5OYW1lLCBjZXJ0aWZpY2F0ZSk7XG4gIGNvbnN0IG1hcHBpbmdLZXkgPSBjdXN0b21Eb21haW4ucGF0aDtcblxuICByZXR1cm4ge1xuICAgIGFwaWdEb21haW4sXG4gICAgbWFwcGluZ0tleSxcbiAgICBjZXJ0aWZpY2F0ZSxcbiAgICBpc0FwaWdEb21haW5DcmVhdGVkOiB0cnVlLFxuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogZmFsc2UsXG4gICAgdXJsOiBidWlsZERvbWFpblVybChkb21haW5OYW1lLCBtYXBwaW5nS2V5KSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYnVpbGREYXRhRm9yQ29uc3RydWN0SW5wdXQoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGN1c3RvbURvbWFpbjogQ3VzdG9tRG9tYWluUHJvcHNcbik6IEN1c3RvbURvbWFpbkRhdGEge1xuICAvLyAgQWxsb3cgdXNlciBwYXNzaW5nIGluIGBhcGlnRG9tYWluYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBhIHVzZXIgY3JlYXRlc1xuICAvLyAgbXVsdGlwbGUgQVBJIGVuZHBvaW50cywgYW5kIGlzIG1hcHBpbmcgdGhlbSB1bmRlciB0aGUgc2FtZSBjdXN0b20gZG9tYWluLlxuICAvLyAgYHNzdC5BcGlgIG5lZWRzIHRvIGV4cG9zZSB0aGUgYGFwaWdEb21haW5gIGNvbnN0cnVjdCBjcmVhdGVkIGluIHRoZSBmaXJzdFxuICAvLyAgQXBpLCBhbmQgbGV0cyB1c2VyIHBhc3MgaXQgaW4gd2hlbiBjcmVhdGluZyB0aGUgc2Vjb25kIEFwaS5cblxuICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJob3N0ZWRab25lXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgKTtcbiAgfVxuICBpZiAoY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2VydGlmaWNhdGVcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgYXBpZ0RvbWFpbiA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGFzIGFwaWcuSURvbWFpbk5hbWU7XG4gIGNvbnN0IGRvbWFpbk5hbWUgPSBhcGlnRG9tYWluLm5hbWU7XG4gIGNvbnN0IG1hcHBpbmdLZXkgPSBjdXN0b21Eb21haW4ucGF0aDtcblxuICByZXR1cm4ge1xuICAgIGFwaWdEb21haW4sXG4gICAgbWFwcGluZ0tleSxcbiAgICBjZXJ0aWZpY2F0ZTogdW5kZWZpbmVkLFxuICAgIGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IGZhbHNlLFxuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogZmFsc2UsXG4gICAgdXJsOiBidWlsZERvbWFpblVybChkb21haW5OYW1lLCBtYXBwaW5nS2V5KSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gbG9va3VwSG9zdGVkWm9uZShzY29wZTogQ29uc3RydWN0LCBob3N0ZWRab25lRG9tYWluOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHNjb3BlLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgIGRvbWFpbk5hbWU6IGhvc3RlZFpvbmVEb21haW4sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDZXJ0aWZpY2F0ZShcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBob3N0ZWRab25lOiByb3V0ZTUzLklIb3N0ZWRab25lXG4pIHtcbiAgcmV0dXJuIG5ldyBhY20uQ2VydGlmaWNhdGUoc2NvcGUsIFwiQ2VydGlmaWNhdGVcIiwge1xuICAgIGRvbWFpbk5hbWUsXG4gICAgdmFsaWRhdGlvbjogYWNtLkNlcnRpZmljYXRlVmFsaWRhdGlvbi5mcm9tRG5zKGhvc3RlZFpvbmUpLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQXBpZ0RvbWFpbihcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBjZXJ0aWZpY2F0ZTogYWNtLklDZXJ0aWZpY2F0ZVxuKSB7XG4gIHJldHVybiBuZXcgYXBpZy5Eb21haW5OYW1lKHNjb3BlLCBcIkRvbWFpbk5hbWVcIiwge1xuICAgIGRvbWFpbk5hbWUsXG4gICAgY2VydGlmaWNhdGUsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVBUmVjb3JkcyhcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgaG9zdGVkWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lXG4pIHtcbiAgLy8gY3JlYXRlIEROUyByZWNvcmRcbiAgY29uc3QgcmVjb3JkUHJvcHMgPSB7XG4gICAgcmVjb3JkTmFtZTogZG9tYWluTmFtZSxcbiAgICB6b25lOiBob3N0ZWRab25lLFxuICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgbmV3IHJvdXRlNTNUYXJnZXRzLkFwaUdhdGV3YXl2MkRvbWFpblByb3BlcnRpZXMoXG4gICAgICAgIGFwaWdEb21haW4ucmVnaW9uYWxEb21haW5OYW1lLFxuICAgICAgICBhcGlnRG9tYWluLnJlZ2lvbmFsSG9zdGVkWm9uZUlkXG4gICAgICApXG4gICAgKSxcbiAgfTtcbiAgY29uc3QgcmVjb3JkcyA9IFtcbiAgICBuZXcgcm91dGU1My5BUmVjb3JkKHNjb3BlLCBcIkFsaWFzUmVjb3JkXCIsIHJlY29yZFByb3BzKSxcbiAgICBuZXcgcm91dGU1My5BYWFhUmVjb3JkKHNjb3BlLCBcIkFsaWFzUmVjb3JkQUFBQVwiLCByZWNvcmRQcm9wcyksXG4gIF07XG4gIC8vIG5vdGU6IElmIGRvbWFpbk5hbWUgaXMgYSBUT0tFTiBzdHJpbmcgaWUuICR7VE9LRU4uLn0sIHRoZSByb3V0ZTUzLkFSZWNvcmRcbiAgLy8gICAgICAgY29uc3RydWN0IHdpbGwgYXBwZW5kIFwiLiR7aG9zdGVkWm9uZU5hbWV9XCIgdG8gdGhlIGVuZCBvZiB0aGUgZG9tYWluLlxuICAvLyAgICAgICBUaGlzIGlzIGJlY2F1c2UgdGhlIGNvbnN0cnVjdCB0cmllcyB0byBjaGVjayBpZiB0aGUgcmVjb3JkIG5hbWVcbiAgLy8gICAgICAgZW5kcyB3aXRoIHRoZSBkb21haW4gbmFtZS4gSWYgbm90LCBpdCB3aWxsIGFwcGVuZCB0aGUgZG9tYWluIG5hbWUuXG4gIC8vICAgICAgIFNvLCB3ZSBuZWVkIHJlbW92ZSB0aGlzIGJlaGF2aW9yLlxuICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgIHJlY29yZHMuZm9yRWFjaCgocmVjb3JkKSA9PiB7XG4gICAgICBjb25zdCBjZm5SZWNvcmQgPSByZWNvcmQubm9kZS5kZWZhdWx0Q2hpbGQgYXMgcm91dGU1My5DZm5SZWNvcmRTZXQ7XG4gICAgICBjZm5SZWNvcmQubmFtZSA9IGRvbWFpbk5hbWU7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYnVpbGREb21haW5VcmwoZG9tYWluTmFtZTogc3RyaW5nLCBtYXBwaW5nS2V5Pzogc3RyaW5nKSB7XG4gIC8vIE5vdGU6IElmIG1hcHBpbmcga2V5IGlzIHNldCwgdGhlIFVSTCBuZWVkcyBhIHRyYWlsaW5nIHNsYXNoLiBXaXRob3V0IHRoZVxuICAvLyAgICAgICB0cmFpbGluZyBzbGFzaCwgdGhlIEFQSSBmYWlscyB3aXRoIHRoZSBlcnJvclxuICAvLyAgICAgICB7XCJtZXNzYWdlXCI6XCJOb3QgRm91bmRcIn1cbiAgcmV0dXJuIG1hcHBpbmdLZXkgPyBgJHtkb21haW5OYW1lfS8ke21hcHBpbmdLZXl9L2AgOiBkb21haW5OYW1lO1xufVxuXG5mdW5jdGlvbiBhc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gIGlmIChkb21haW5OYW1lICE9PSBkb21haW5OYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBkb21haW4gbmFtZSBuZWVkcyB0byBiZSBpbiBsb3dlcmNhc2VgKTtcbiAgfVxufVxuIl19