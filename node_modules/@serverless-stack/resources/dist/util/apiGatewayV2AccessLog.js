"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cleanupLogGroupName = exports.buildAccessLogData = void 0;
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const defaultHttpFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"httpMethod":"$context.httpMethod"`,
    `"path":"$context.path"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    `"responseLatency":$context.responseLatency`,
    // integration info
    `"integrationRequestId":"$context.integration.requestId"`,
    `"integrationStatus":"$context.integration.status"`,
    `"integrationLatency":"$context.integration.latency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
];
const defaultWebSocketFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"eventType":"$context.eventType"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    // integration info
    `"integrationRequestId":"$context.awsEndpointRequestId"`,
    `"integrationStatus":"$context.integrationStatus"`,
    `"integrationLatency":"$context.integrationLatency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
    `"connectedAt":"$context.connectedAt"`,
    `"connectionId":"$context.connectionId"`,
];
function buildAccessLogData(scope, accessLog, apiStage, isDefaultStage) {
    if (accessLog === false) {
        return;
    }
    const isWebSocketApi = apiStage instanceof apig.WebSocketStage;
    // note: Access log configuration is not supported by L2 constructs as of CDK v1.85.0. We
    //       need to define it at L1 construct level.
    // create log group
    let logGroup;
    let destinationArn;
    if (accessLog && accessLog.destinationArn) {
        destinationArn = accessLog.destinationArn;
    }
    else {
        const root = scope.node.root;
        const apiName = root.logicalPrefixedName(scope.node.id);
        // Backwards compatibility, only suffix if not default stage
        const logGroupName = "LogGroup" + (isDefaultStage ? "" : apiStage.stageName);
        logGroup = new logs.LogGroup(scope, logGroupName, {
            logGroupName: [
                `/aws/vendedlogs/apis`,
                `/${cleanupLogGroupName(apiName)}-${apiStage.api.apiId}`,
                `/${cleanupLogGroupName(apiStage.stageName)}`,
            ].join(""),
            retention: buildLogGroupRetention(accessLog),
        });
        destinationArn = logGroup.logGroupArn;
    }
    // get log format
    let format;
    if (accessLog && accessLog.format) {
        format = accessLog.format;
    }
    else if (typeof accessLog === "string") {
        format = accessLog;
    }
    else {
        format = isWebSocketApi
            ? "{" + defaultWebSocketFields.join(",") + "}"
            : "{" + defaultHttpFields.join(",") + "}";
    }
    // get L1 cfnStage construct
    if (!(apiStage === null || apiStage === void 0 ? void 0 : apiStage.node.defaultChild)) {
        throw new Error(`Failed to define the default stage for Http API`);
    }
    // set access log settings
    const cfnStage = apiStage.node.defaultChild;
    cfnStage.accessLogSettings = { format, destinationArn };
    return logGroup;
}
exports.buildAccessLogData = buildAccessLogData;
function cleanupLogGroupName(str) {
    return str.replace(/[^.\-_/#A-Za-z0-9]/g, "");
}
exports.cleanupLogGroupName = cleanupLogGroupName;
function buildLogGroupRetention(accessLog) {
    const retention = (accessLog && accessLog.retention);
    if (!retention) {
        return logs.RetentionDays.INFINITE;
    }
    // Case: retention is string
    if (typeof retention === "string") {
        const retentionValue = logs.RetentionDays[retention];
        // validate retention
        if (!retentionValue) {
            throw new Error(`Invalid access log retention value "${retention}".`);
        }
        return retentionValue;
    }
    // Case: retention is logs.RetentionDays
    return retention;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyQWNjZXNzTG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsMkRBQTZDO0FBRTdDLHNFQUF3RDtBQVF4RCxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLGVBQWU7SUFDZixzQ0FBc0M7SUFDdEMsa0NBQWtDO0lBQ2xDLG9DQUFvQztJQUNwQyx3QkFBd0I7SUFDeEIsZ0NBQWdDO0lBQ2hDLDBCQUEwQjtJQUMxQiw0Q0FBNEM7SUFDNUMsbUJBQW1CO0lBQ25CLHlEQUF5RDtJQUN6RCxtREFBbUQ7SUFDbkQscURBQXFEO0lBQ3JELHFFQUFxRTtJQUNyRSxjQUFjO0lBQ2QsbUNBQW1DO0lBQ25DLDJDQUEyQztJQUMzQywyREFBMkQ7Q0FDNUQsQ0FBQztBQUVGLE1BQU0sc0JBQXNCLEdBQUc7SUFDN0IsZUFBZTtJQUNmLHNDQUFzQztJQUN0QyxrQ0FBa0M7SUFDbEMsa0NBQWtDO0lBQ2xDLGdDQUFnQztJQUNoQywwQkFBMEI7SUFDMUIsbUJBQW1CO0lBQ25CLHdEQUF3RDtJQUN4RCxrREFBa0Q7SUFDbEQsb0RBQW9EO0lBQ3BELHFFQUFxRTtJQUNyRSxjQUFjO0lBQ2QsbUNBQW1DO0lBQ25DLDJDQUEyQztJQUMzQywyREFBMkQ7SUFDM0Qsc0NBQXNDO0lBQ3RDLHdDQUF3QztDQUN6QyxDQUFDO0FBRUYsU0FBZ0Isa0JBQWtCLENBQ2hDLEtBQWdCLEVBQ2hCLFNBQXdELEVBQ3hELFFBQThDLEVBQzlDLGNBQXVCO0lBRXZCLElBQUksU0FBUyxLQUFLLEtBQUssRUFBRTtRQUN2QixPQUFPO0tBQ1I7SUFFRCxNQUFNLGNBQWMsR0FBRyxRQUFRLFlBQVksSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUUvRCx5RkFBeUY7SUFDekYsaURBQWlEO0lBRWpELG1CQUFtQjtJQUNuQixJQUFJLFFBQVEsQ0FBQztJQUNiLElBQUksY0FBYyxDQUFDO0lBQ25CLElBQUksU0FBUyxJQUFLLFNBQTRCLENBQUMsY0FBYyxFQUFFO1FBQzdELGNBQWMsR0FBSSxTQUE0QixDQUFDLGNBQWMsQ0FBQztLQUMvRDtTQUFNO1FBQ0wsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDeEQsNERBQTREO1FBQzVELE1BQU0sWUFBWSxHQUNoQixVQUFVLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTFELFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRTtZQUNoRCxZQUFZLEVBQUU7Z0JBQ1osc0JBQXNCO2dCQUN0QixJQUFJLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFO2dCQUN4RCxJQUFJLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRTthQUM5QyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDVixTQUFTLEVBQUUsc0JBQXNCLENBQUMsU0FBUyxDQUFDO1NBQzdDLENBQUMsQ0FBQztRQUNILGNBQWMsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDO0tBQ3ZDO0lBRUQsaUJBQWlCO0lBQ2pCLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSSxTQUFTLElBQUssU0FBNEIsQ0FBQyxNQUFNLEVBQUU7UUFDckQsTUFBTSxHQUFJLFNBQTRCLENBQUMsTUFBTSxDQUFDO0tBQy9DO1NBQU0sSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLEVBQUU7UUFDeEMsTUFBTSxHQUFHLFNBQVMsQ0FBQztLQUNwQjtTQUFNO1FBQ0wsTUFBTSxHQUFHLGNBQWM7WUFDckIsQ0FBQyxDQUFDLEdBQUcsR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRztZQUM5QyxDQUFDLENBQUMsR0FBRyxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7S0FDN0M7SUFFRCw0QkFBNEI7SUFDNUIsSUFBSSxDQUFDLENBQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLElBQUksQ0FBQyxZQUFZLENBQUEsRUFBRTtRQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7S0FDcEU7SUFFRCwwQkFBMEI7SUFDMUIsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFnQyxDQUFDO0lBQ2hFLFFBQVEsQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQztJQUV4RCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBNURELGdEQTREQztBQUVELFNBQWdCLG1CQUFtQixDQUFDLEdBQVc7SUFDN0MsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFGRCxrREFFQztBQUVELFNBQVMsc0JBQXNCLENBQUMsU0FBNkM7SUFDM0UsTUFBTSxTQUFTLEdBQUcsQ0FBQyxTQUFTLElBQUssU0FBNEIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN6RSxJQUFJLENBQUMsU0FBUyxFQUFFO1FBQUUsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQztLQUFFO0lBRXZELDRCQUE0QjtJQUM1QixJQUFJLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRTtRQUNqQyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXJELHFCQUFxQjtRQUNyQixJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLFNBQVMsSUFBSSxDQUFDLENBQUM7U0FDdkU7UUFDRCxPQUFPLGNBQWMsQ0FBQztLQUN2QjtJQUVELHdDQUF3QztJQUN4QyxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBjZm5BcGlnIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyLWFscGhhXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi4vQXBwXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWNjZXNzTG9nUHJvcHNcbiAgZXh0ZW5kcyBjZm5BcGlnLkNmblN0YWdlLkFjY2Vzc0xvZ1NldHRpbmdzUHJvcGVydHkge1xuICByZXRlbnRpb24/OiBrZXlvZiB0eXBlb2YgbG9ncy5SZXRlbnRpb25EYXlzIHwgbG9ncy5SZXRlbnRpb25EYXlzO1xufVxuXG5jb25zdCBkZWZhdWx0SHR0cEZpZWxkcyA9IFtcbiAgLy8gcmVxdWVzdCBpbmZvXG4gIGBcInJlcXVlc3RUaW1lXCI6XCIkY29udGV4dC5yZXF1ZXN0VGltZVwiYCxcbiAgYFwicmVxdWVzdElkXCI6XCIkY29udGV4dC5yZXF1ZXN0SWRcImAsXG4gIGBcImh0dHBNZXRob2RcIjpcIiRjb250ZXh0Lmh0dHBNZXRob2RcImAsXG4gIGBcInBhdGhcIjpcIiRjb250ZXh0LnBhdGhcImAsXG4gIGBcInJvdXRlS2V5XCI6XCIkY29udGV4dC5yb3V0ZUtleVwiYCxcbiAgYFwic3RhdHVzXCI6JGNvbnRleHQuc3RhdHVzYCwgLy8gaW50ZWdlciB2YWx1ZSwgZG8gbm90IHdyYXAgaW4gcXVvdGVzXG4gIGBcInJlc3BvbnNlTGF0ZW5jeVwiOiRjb250ZXh0LnJlc3BvbnNlTGF0ZW5jeWAsIC8vIGludGVnZXIgdmFsdWUsIGRvIG5vdCB3cmFwIGluIHF1b3Rlc1xuICAvLyBpbnRlZ3JhdGlvbiBpbmZvXG4gIGBcImludGVncmF0aW9uUmVxdWVzdElkXCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbi5yZXF1ZXN0SWRcImAsXG4gIGBcImludGVncmF0aW9uU3RhdHVzXCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbi5zdGF0dXNcImAsXG4gIGBcImludGVncmF0aW9uTGF0ZW5jeVwiOlwiJGNvbnRleHQuaW50ZWdyYXRpb24ubGF0ZW5jeVwiYCxcbiAgYFwiaW50ZWdyYXRpb25TZXJ2aWNlU3RhdHVzXCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbi5pbnRlZ3JhdGlvblN0YXR1c1wiYCxcbiAgLy8gY2FsbGVyIGluZm9cbiAgYFwiaXBcIjpcIiRjb250ZXh0LmlkZW50aXR5LnNvdXJjZUlwXCJgLFxuICBgXCJ1c2VyQWdlbnRcIjpcIiRjb250ZXh0LmlkZW50aXR5LnVzZXJBZ2VudFwiYCxcbiAgYFwiY29nbml0b0lkZW50aXR5SWRcIjpcIiRjb250ZXh0LmlkZW50aXR5LmNvZ25pdG9JZGVudGl0eUlkXCJgLFxuXTtcblxuY29uc3QgZGVmYXVsdFdlYlNvY2tldEZpZWxkcyA9IFtcbiAgLy8gcmVxdWVzdCBpbmZvXG4gIGBcInJlcXVlc3RUaW1lXCI6XCIkY29udGV4dC5yZXF1ZXN0VGltZVwiYCxcbiAgYFwicmVxdWVzdElkXCI6XCIkY29udGV4dC5yZXF1ZXN0SWRcImAsXG4gIGBcImV2ZW50VHlwZVwiOlwiJGNvbnRleHQuZXZlbnRUeXBlXCJgLFxuICBgXCJyb3V0ZUtleVwiOlwiJGNvbnRleHQucm91dGVLZXlcImAsXG4gIGBcInN0YXR1c1wiOiRjb250ZXh0LnN0YXR1c2AsIC8vIGludGVnZXIgdmFsdWUsIGRvIG5vdCB3cmFwIGluIHF1b3Rlc1xuICAvLyBpbnRlZ3JhdGlvbiBpbmZvXG4gIGBcImludGVncmF0aW9uUmVxdWVzdElkXCI6XCIkY29udGV4dC5hd3NFbmRwb2ludFJlcXVlc3RJZFwiYCxcbiAgYFwiaW50ZWdyYXRpb25TdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uU3RhdHVzXCJgLFxuICBgXCJpbnRlZ3JhdGlvbkxhdGVuY3lcIjpcIiRjb250ZXh0LmludGVncmF0aW9uTGF0ZW5jeVwiYCxcbiAgYFwiaW50ZWdyYXRpb25TZXJ2aWNlU3RhdHVzXCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbi5pbnRlZ3JhdGlvblN0YXR1c1wiYCxcbiAgLy8gY2FsbGVyIGluZm9cbiAgYFwiaXBcIjpcIiRjb250ZXh0LmlkZW50aXR5LnNvdXJjZUlwXCJgLFxuICBgXCJ1c2VyQWdlbnRcIjpcIiRjb250ZXh0LmlkZW50aXR5LnVzZXJBZ2VudFwiYCxcbiAgYFwiY29nbml0b0lkZW50aXR5SWRcIjpcIiRjb250ZXh0LmlkZW50aXR5LmNvZ25pdG9JZGVudGl0eUlkXCJgLFxuICBgXCJjb25uZWN0ZWRBdFwiOlwiJGNvbnRleHQuY29ubmVjdGVkQXRcImAsXG4gIGBcImNvbm5lY3Rpb25JZFwiOlwiJGNvbnRleHQuY29ubmVjdGlvbklkXCJgLFxuXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkQWNjZXNzTG9nRGF0YShcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgYWNjZXNzTG9nOiBib29sZWFuIHwgc3RyaW5nIHwgQWNjZXNzTG9nUHJvcHMgfCB1bmRlZmluZWQsXG4gIGFwaVN0YWdlOiBhcGlnLldlYlNvY2tldFN0YWdlIHwgYXBpZy5IdHRwU3RhZ2UsXG4gIGlzRGVmYXVsdFN0YWdlOiBib29sZWFuXG4pOiBsb2dzLkxvZ0dyb3VwIHwgdW5kZWZpbmVkIHtcbiAgaWYgKGFjY2Vzc0xvZyA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBpc1dlYlNvY2tldEFwaSA9IGFwaVN0YWdlIGluc3RhbmNlb2YgYXBpZy5XZWJTb2NrZXRTdGFnZTtcblxuICAvLyBub3RlOiBBY2Nlc3MgbG9nIGNvbmZpZ3VyYXRpb24gaXMgbm90IHN1cHBvcnRlZCBieSBMMiBjb25zdHJ1Y3RzIGFzIG9mIENESyB2MS44NS4wLiBXZVxuICAvLyAgICAgICBuZWVkIHRvIGRlZmluZSBpdCBhdCBMMSBjb25zdHJ1Y3QgbGV2ZWwuXG5cbiAgLy8gY3JlYXRlIGxvZyBncm91cFxuICBsZXQgbG9nR3JvdXA7XG4gIGxldCBkZXN0aW5hdGlvbkFybjtcbiAgaWYgKGFjY2Vzc0xvZyAmJiAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5kZXN0aW5hdGlvbkFybikge1xuICAgIGRlc3RpbmF0aW9uQXJuID0gKGFjY2Vzc0xvZyBhcyBBY2Nlc3NMb2dQcm9wcykuZGVzdGluYXRpb25Bcm47XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgYXBpTmFtZSA9IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShzY29wZS5ub2RlLmlkKTtcbiAgICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgb25seSBzdWZmaXggaWYgbm90IGRlZmF1bHQgc3RhZ2VcbiAgICBjb25zdCBsb2dHcm91cE5hbWUgPVxuICAgICAgXCJMb2dHcm91cFwiICsgKGlzRGVmYXVsdFN0YWdlID8gXCJcIiA6IGFwaVN0YWdlLnN0YWdlTmFtZSk7XG5cbiAgICBsb2dHcm91cCA9IG5ldyBsb2dzLkxvZ0dyb3VwKHNjb3BlLCBsb2dHcm91cE5hbWUsIHtcbiAgICAgIGxvZ0dyb3VwTmFtZTogW1xuICAgICAgICBgL2F3cy92ZW5kZWRsb2dzL2FwaXNgLFxuICAgICAgICBgLyR7Y2xlYW51cExvZ0dyb3VwTmFtZShhcGlOYW1lKX0tJHthcGlTdGFnZS5hcGkuYXBpSWR9YCxcbiAgICAgICAgYC8ke2NsZWFudXBMb2dHcm91cE5hbWUoYXBpU3RhZ2Uuc3RhZ2VOYW1lKX1gLFxuICAgICAgXS5qb2luKFwiXCIpLFxuICAgICAgcmV0ZW50aW9uOiBidWlsZExvZ0dyb3VwUmV0ZW50aW9uKGFjY2Vzc0xvZyksXG4gICAgfSk7XG4gICAgZGVzdGluYXRpb25Bcm4gPSBsb2dHcm91cC5sb2dHcm91cEFybjtcbiAgfVxuXG4gIC8vIGdldCBsb2cgZm9ybWF0XG4gIGxldCBmb3JtYXQ7XG4gIGlmIChhY2Nlc3NMb2cgJiYgKGFjY2Vzc0xvZyBhcyBBY2Nlc3NMb2dQcm9wcykuZm9ybWF0KSB7XG4gICAgZm9ybWF0ID0gKGFjY2Vzc0xvZyBhcyBBY2Nlc3NMb2dQcm9wcykuZm9ybWF0O1xuICB9IGVsc2UgaWYgKHR5cGVvZiBhY2Nlc3NMb2cgPT09IFwic3RyaW5nXCIpIHtcbiAgICBmb3JtYXQgPSBhY2Nlc3NMb2c7XG4gIH0gZWxzZSB7XG4gICAgZm9ybWF0ID0gaXNXZWJTb2NrZXRBcGlcbiAgICAgID8gXCJ7XCIgKyBkZWZhdWx0V2ViU29ja2V0RmllbGRzLmpvaW4oXCIsXCIpICsgXCJ9XCJcbiAgICAgIDogXCJ7XCIgKyBkZWZhdWx0SHR0cEZpZWxkcy5qb2luKFwiLFwiKSArIFwifVwiO1xuICB9XG5cbiAgLy8gZ2V0IEwxIGNmblN0YWdlIGNvbnN0cnVjdFxuICBpZiAoIWFwaVN0YWdlPy5ub2RlLmRlZmF1bHRDaGlsZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlZmluZSB0aGUgZGVmYXVsdCBzdGFnZSBmb3IgSHR0cCBBUElgKTtcbiAgfVxuXG4gIC8vIHNldCBhY2Nlc3MgbG9nIHNldHRpbmdzXG4gIGNvbnN0IGNmblN0YWdlID0gYXBpU3RhZ2Uubm9kZS5kZWZhdWx0Q2hpbGQgYXMgY2ZuQXBpZy5DZm5TdGFnZTtcbiAgY2ZuU3RhZ2UuYWNjZXNzTG9nU2V0dGluZ3MgPSB7IGZvcm1hdCwgZGVzdGluYXRpb25Bcm4gfTtcblxuICByZXR1cm4gbG9nR3JvdXA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhbnVwTG9nR3JvdXBOYW1lKHN0cjogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXi5cXC1fLyNBLVphLXowLTldL2csIFwiXCIpO1xufVxuXG5mdW5jdGlvbiBidWlsZExvZ0dyb3VwUmV0ZW50aW9uKGFjY2Vzc0xvZz86IGJvb2xlYW4gfCBzdHJpbmcgfCBBY2Nlc3NMb2dQcm9wcyApOiBsb2dzLlJldGVudGlvbkRheXMge1xuICBjb25zdCByZXRlbnRpb24gPSAoYWNjZXNzTG9nICYmIChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLnJldGVudGlvbik7XG4gIGlmICghcmV0ZW50aW9uKSB7IHJldHVybiBsb2dzLlJldGVudGlvbkRheXMuSU5GSU5JVEU7IH1cblxuICAvLyBDYXNlOiByZXRlbnRpb24gaXMgc3RyaW5nXG4gIGlmICh0eXBlb2YgcmV0ZW50aW9uID09PSBcInN0cmluZ1wiKSB7XG4gICAgY29uc3QgcmV0ZW50aW9uVmFsdWUgPSBsb2dzLlJldGVudGlvbkRheXNbcmV0ZW50aW9uXTtcblxuICAgIC8vIHZhbGlkYXRlIHJldGVudGlvblxuICAgIGlmICghcmV0ZW50aW9uVmFsdWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBhY2Nlc3MgbG9nIHJldGVudGlvbiB2YWx1ZSBcIiR7cmV0ZW50aW9ufVwiLmApO1xuICAgIH1cbiAgICByZXR1cm4gcmV0ZW50aW9uVmFsdWU7XG4gIH1cblxuICAvLyBDYXNlOiByZXRlbnRpb24gaXMgbG9ncy5SZXRlbnRpb25EYXlzXG4gIHJldHVybiByZXRlbnRpb247XG59XG4iXX0=