"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment*/
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachPermissionsToRole = exports.PermissionType = void 0;
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const core_1 = require("@serverless-stack/core");
const index_1 = require("../index");
const Construct_1 = require("../Construct");
const logger = (0, core_1.getChildLogger)("resources");
var PermissionType;
(function (PermissionType) {
    PermissionType["ALL"] = "*";
})(PermissionType = exports.PermissionType || (exports.PermissionType = {}));
function attachPermissionsToRole(role, permissions) {
    // Four patterns
    //
    // attachPermissions(PermissionType.ALL);
    // attachPermissions([ 'sns', 'sqs' ]);
    // attachPermissions([ event, queue ]);
    // attachPermissions([
    //   [ event.snsTopic, 'grantPublish' ],
    //   [ queue.sqsQueue, 'grantSendMessages' ],
    // ]);
    // attachPermissions([
    //   new iam.PolicyStatement({
    //     actions: ["s3:*"],
    //     effect: iam.Effect.ALLOW,
    //     resources: [
    //       bucket.bucketArn + "/private/${cognito-identity.amazonaws.com:sub}/*",
    //     ],
    //   })
    // ]);
    ////////////////////////////////////
    // Case: 'admin' permissions => '*'
    ////////////////////////////////////
    if (typeof permissions === "string") {
        if (permissions === PermissionType.ALL) {
            role.addToPolicy(buildPolicy(permissions, ["*"]));
        }
        else {
            throw new Error(`The specified permissions are not supported.`);
        }
        return;
    }
    if (!Array.isArray(permissions)) {
        throw new Error(`The specified permissions are not supported. They are expected to be PermissionType.ALL or an array.`);
    }
    // Handle array of permissions
    permissions.forEach((permission) => {
        ////////////////////////////////////
        // Case: string ie. 's3' or 's3:*'
        ////////////////////////////////////
        if (typeof permission === "string") {
            const perm = permission.indexOf(":") === -1 ? `${permission}:*` : permission;
            role.addToPolicy(buildPolicy(perm, ["*"]));
        }
        ////////////////////////////////////
        // Case: iam.PolicyStatement
        ////////////////////////////////////
        else if ((0, Construct_1.isCDKConstructOf)(permission, "aws-cdk-lib.aws_iam.PolicyStatement")) {
            role.addToPolicy(permission);
        }
        ////////////////////////////////////
        // Case: SST construct
        ////////////////////////////////////
        else if (permission instanceof index_1.Api) {
            const httpApi = permission.httpApi;
            const { account, region } = index_1.Stack.of(httpApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${httpApi.httpApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.ApiGatewayV1Api) {
            const restApi = permission.restApi;
            const { account, region } = index_1.Stack.of(restApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${restApi.restApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.WebSocketApi) {
            const webSocketApi = permission.webSocketApi;
            const { account, region } = index_1.Stack.of(webSocketApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${webSocketApi.apiId}/*`,
            ]));
            role.addToPolicy(buildPolicy("execute-api:ManageConnections", [
                permission._connectionsArn,
            ]));
        }
        else if (permission instanceof index_1.AppSyncApi) {
            const graphqlApi = permission.graphqlApi;
            const { account, region } = index_1.Stack.of(graphqlApi);
            role.addToPolicy(buildPolicy("appsync:GraphQL", [
                `arn:aws:appsync:${region}:${account}:apis/${graphqlApi.apiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.Table) {
            const tableArn = permission.dynamodbTable.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission instanceof index_1.Topic) {
            role.addToPolicy(buildPolicy("sns:*", [permission.snsTopic.topicArn]));
        }
        else if (permission instanceof index_1.Queue) {
            role.addToPolicy(buildPolicy("sqs:*", [permission.sqsQueue.queueArn]));
        }
        else if (permission instanceof index_1.EventBus) {
            role.addToPolicy(buildPolicy("events:*", [permission.eventBridgeEventBus.eventBusArn]));
        }
        else if (permission instanceof index_1.KinesisStream) {
            role.addToPolicy(buildPolicy("kinesis:*", [permission.kinesisStream.streamArn]));
        }
        else if (permission instanceof index_1.Bucket) {
            const bucketArn = permission.s3Bucket.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission instanceof index_1.RDS) {
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            if (permission.rdsServerlessCluster.secret) {
                role.addToPolicy(buildPolicy(["secretsmanager:GetSecretValue", "secretsmanager:DescribeSecret"], [permission.rdsServerlessCluster.secret.secretArn]));
            }
        }
        else if (permission instanceof index_1.Function) {
            role.addToPolicy(buildPolicy("lambda:*", [permission.functionArn]));
        }
        ////////////////////////////////////
        // Case: CDK constructs
        ////////////////////////////////////
        else if (permission.tableArn && permission.tableName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const tableArn = permission.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission.topicArn && permission.topicName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sns:*", [permission.topicArn]));
        }
        else if (permission.queueArn && permission.queueName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sqs:*", [permission.queueArn]));
        }
        else if (permission.eventBusArn &&
            permission.eventBusName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("events:*", [permission.eventBusArn]));
        }
        else if (permission.streamArn &&
            permission.streamName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("kinesis:*", [permission.streamArn]));
        }
        else if (permission.deliveryStreamArn &&
            permission.deliveryStreamName) {
            role.addToPolicy(buildPolicy("firehose:*", [permission.deliveryStreamArn]));
        }
        else if (permission.bucketArn &&
            permission.bucketName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const bucketArn = permission.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission.clusterArn) {
            // For ServerlessCluster, we need to grant:
            // - permisssions to access the Data API;
            // - permisssions to access the Secret Manager (required by Data API).
            // No need to grant the permissions for IAM database authentication
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            const secret = permission.secret;
            if (secret) {
                role.addToPolicy(buildPolicy(["secretsmanager:GetSecretValue", "secretsmanager:DescribeSecret"], [secret.secretArn]));
            }
        }
        ////////////////////////////////////
        // Case: grant method
        ////////////////////////////////////
        else if (Array.isArray(permission) &&
            permission.length === 2 &&
            (0, Construct_1.isCDKConstruct)(permission[0]) &&
            typeof permission[1] === "string") {
            const construct = permission[0];
            const methodName = permission[1];
            if (typeof construct[methodName] !== "function")
                throw new Error(`The specified grant method is incorrect.
          Check the available methods that prefixed with grants on the Construct`);
            construct[methodName](role);
        }
        else {
            logger.debug("permission object", permission);
            throw new Error(`The specified permissions are not supported.`);
        }
    });
}
exports.attachPermissionsToRole = attachPermissionsToRole;
function buildPolicy(actions, resources) {
    return new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: typeof actions === "string" ? [actions] : actions,
        resources,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3Blcm1pc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHckQseURBQTJDO0FBQzNDLGlEQUF3RDtBQUN4RCxvQ0Fja0I7QUFDbEIsNENBQWdFO0FBRWhFLE1BQU0sTUFBTSxHQUFHLElBQUEscUJBQWMsRUFBQyxXQUFXLENBQUMsQ0FBQztBQVMzQyxJQUFZLGNBRVg7QUFGRCxXQUFZLGNBQWM7SUFDeEIsMkJBQVMsQ0FBQTtBQUNYLENBQUMsRUFGVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQUV6QjtBQUVELFNBQWdCLHVCQUF1QixDQUNyQyxJQUFjLEVBQ2QsV0FBd0I7SUFFeEIsZ0JBQWdCO0lBQ2hCLEVBQUU7SUFDRix5Q0FBeUM7SUFDekMsdUNBQXVDO0lBQ3ZDLHVDQUF1QztJQUN2QyxzQkFBc0I7SUFDdEIsd0NBQXdDO0lBQ3hDLDZDQUE2QztJQUM3QyxNQUFNO0lBQ04sc0JBQXNCO0lBQ3RCLDhCQUE4QjtJQUM5Qix5QkFBeUI7SUFDekIsZ0NBQWdDO0lBQ2hDLG1CQUFtQjtJQUNuQiwrRUFBK0U7SUFDL0UsU0FBUztJQUNULE9BQU87SUFDUCxNQUFNO0lBRU4sb0NBQW9DO0lBQ3BDLG1DQUFtQztJQUNuQyxvQ0FBb0M7SUFDcEMsSUFBSSxPQUFPLFdBQVcsS0FBSyxRQUFRLEVBQUU7UUFDbkMsSUFBSSxXQUFXLEtBQUssY0FBYyxDQUFDLEdBQUcsRUFBRTtZQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztTQUNqRTtRQUNELE9BQU87S0FDUjtJQUVELElBQUksQ0FBQyxLQUFL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Q0FBQyxLQUFLO1FBQ3hCLE9BQU8sRUFBRSxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDMUQsU0FBUztLQUNWLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnQqL1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3QsIElDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgeyBnZXRDaGlsZExvZ2dlciB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9jb3JlXCI7XG5pbXBvcnQge1xuICBBcGksXG4gIFJEUyxcbiAgVGFibGUsXG4gIFRvcGljLFxuICBRdWV1ZSxcbiAgQnVja2V0LFxuICBFdmVudEJ1cyxcbiAgRnVuY3Rpb24sXG4gIEFwcFN5bmNBcGksXG4gIFdlYlNvY2tldEFwaSxcbiAgS2luZXNpc1N0cmVhbSxcbiAgQXBpR2F0ZXdheVYxQXBpLFxuICBTdGFjayxcbn0gZnJvbSBcIi4uL2luZGV4XCI7XG5pbXBvcnQgeyBpc0NES0NvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3RPZiB9IGZyb20gXCIuLi9Db25zdHJ1Y3RcIjtcblxuY29uc3QgbG9nZ2VyID0gZ2V0Q2hpbGRMb2dnZXIoXCJyZXNvdXJjZXNcIik7XG5cbmV4cG9ydCB0eXBlIFBlcm1pc3Npb25zID0gUGVybWlzc2lvblR5cGUgfCBQZXJtaXNzaW9uW107XG50eXBlIFBlcm1pc3Npb24gPVxuICB8IHN0cmluZ1xuICB8IElDb25zdHJ1Y3RcbiAgfCBbSUNvbnN0cnVjdCwgc3RyaW5nXVxuICB8IGlhbS5Qb2xpY3lTdGF0ZW1lbnQ7XG5cbmV4cG9ydCBlbnVtIFBlcm1pc3Npb25UeXBlIHtcbiAgQUxMID0gXCIqXCIsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZShcbiAgcm9sZTogaWFtLlJvbGUsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuKTogdm9pZCB7XG4gIC8vIEZvdXIgcGF0dGVybnNcbiAgLy9cbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoUGVybWlzc2lvblR5cGUuQUxMKTtcbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoWyAnc25zJywgJ3NxcycgXSk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFsgZXZlbnQsIHF1ZXVlIF0pO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbXG4gIC8vICAgWyBldmVudC5zbnNUb3BpYywgJ2dyYW50UHVibGlzaCcgXSxcbiAgLy8gICBbIHF1ZXVlLnNxc1F1ZXVlLCAnZ3JhbnRTZW5kTWVzc2FnZXMnIF0sXG4gIC8vIF0pO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbXG4gIC8vICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAvLyAgICAgYWN0aW9uczogW1wiczM6KlwiXSxcbiAgLy8gICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgLy8gICAgIHJlc291cmNlczogW1xuICAvLyAgICAgICBidWNrZXQuYnVja2V0QXJuICsgXCIvcHJpdmF0ZS8ke2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTpzdWJ9LypcIixcbiAgLy8gICAgIF0sXG4gIC8vICAgfSlcbiAgLy8gXSk7XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIENhc2U6ICdhZG1pbicgcGVybWlzc2lvbnMgPT4gJyonXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICBpZiAodHlwZW9mIHBlcm1pc3Npb25zID09PSBcInN0cmluZ1wiKSB7XG4gICAgaWYgKHBlcm1pc3Npb25zID09PSBQZXJtaXNzaW9uVHlwZS5BTEwpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3kocGVybWlzc2lvbnMsIFtcIipcIl0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3BlY2lmaWVkIHBlcm1pc3Npb25zIGFyZSBub3Qgc3VwcG9ydGVkLmApO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIUFycmF5LmlzQXJyYXkocGVybWlzc2lvbnMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBzcGVjaWZpZWQgcGVybWlzc2lvbnMgYXJlIG5vdCBzdXBwb3J0ZWQuIFRoZXkgYXJlIGV4cGVjdGVkIHRvIGJlIFBlcm1pc3Npb25UeXBlLkFMTCBvciBhbiBhcnJheS5gXG4gICAgKTtcbiAgfVxuXG4gIC8vIEhhbmRsZSBhcnJheSBvZiBwZXJtaXNzaW9uc1xuICBwZXJtaXNzaW9ucy5mb3JFYWNoKChwZXJtaXNzaW9uOiBQZXJtaXNzaW9uKSA9PiB7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ2FzZTogc3RyaW5nIGllLiAnczMnIG9yICdzMzoqJ1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGlmICh0eXBlb2YgcGVybWlzc2lvbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgY29uc3QgcGVybSA9XG4gICAgICAgIHBlcm1pc3Npb24uaW5kZXhPZihcIjpcIikgPT09IC0xID8gYCR7cGVybWlzc2lvbn06KmAgOiBwZXJtaXNzaW9uO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShwZXJtLCBbXCIqXCJdKSk7XG4gICAgfVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IGlhbS5Qb2xpY3lTdGF0ZW1lbnRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChcbiAgICAgIGlzQ0RLQ29uc3RydWN0T2YoXG4gICAgICAgIHBlcm1pc3Npb24gYXMgQ29uc3RydWN0LFxuICAgICAgICBcImF3cy1jZGstbGliLmF3c19pYW0uUG9saWN5U3RhdGVtZW50XCJcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3kocGVybWlzc2lvbiBhcyBpYW0uUG9saWN5U3RhdGVtZW50KTtcbiAgICB9XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ2FzZTogU1NUIGNvbnN0cnVjdFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBBcGkpIHtcbiAgICAgIGNvbnN0IGh0dHBBcGkgPSBwZXJtaXNzaW9uLmh0dHBBcGk7XG4gICAgICBjb25zdCB7IGFjY291bnQsIHJlZ2lvbiB9ID0gU3RhY2sub2YoaHR0cEFwaSk7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImV4ZWN1dGUtYXBpOkludm9rZVwiLCBbXG4gICAgICAgICAgYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHtyZWdpb259OiR7YWNjb3VudH06JHtodHRwQXBpLmh0dHBBcGlJZH0vKmAsXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEFwaUdhdGV3YXlWMUFwaSkge1xuICAgICAgY29uc3QgcmVzdEFwaSA9IHBlcm1pc3Npb24ucmVzdEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZihyZXN0QXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke3Jlc3RBcGkucmVzdEFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgV2ViU29ja2V0QXBpKSB7XG4gICAgICBjb25zdCB3ZWJTb2NrZXRBcGkgPSBwZXJtaXNzaW9uLndlYlNvY2tldEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZih3ZWJTb2NrZXRBcGkpO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJleGVjdXRlLWFwaTpJbnZva2VcIiwgW1xuICAgICAgICAgIGBhcm46YXdzOmV4ZWN1dGUtYXBpOiR7cmVnaW9ufToke2FjY291bnR9OiR7d2ViU29ja2V0QXBpLmFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImV4ZWN1dGUtYXBpOk1hbmFnZUNvbm5lY3Rpb25zXCIsIFtcbiAgICAgICAgICBwZXJtaXNzaW9uLl9jb25uZWN0aW9uc0FybixcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQXBwU3luY0FwaSkge1xuICAgICAgY29uc3QgZ3JhcGhxbEFwaSA9IHBlcm1pc3Npb24uZ3JhcGhxbEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZihncmFwaHFsQXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiYXBwc3luYzpHcmFwaFFMXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czphcHBzeW5jOiR7cmVnaW9ufToke2FjY291bnR9OmFwaXMvJHtncmFwaHFsQXBpLmFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgVGFibGUpIHtcbiAgICAgIGNvbnN0IHRhYmxlQXJuID0gcGVybWlzc2lvbi5keW5hbW9kYlRhYmxlLnRhYmxlQXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImR5bmFtb2RiOipcIiwgW3RhYmxlQXJuLCBgJHt0YWJsZUFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgVG9waWMpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzbnM6KlwiLCBbcGVybWlzc2lvbi5zbnNUb3BpYy50b3BpY0Fybl0pKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBRdWV1ZSkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNxczoqXCIsIFtwZXJtaXNzaW9uLnNxc1F1ZXVlLnF1ZXVlQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEV2ZW50QnVzKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImV2ZW50czoqXCIsIFtwZXJtaXNzaW9uLmV2ZW50QnJpZGdlRXZlbnRCdXMuZXZlbnRCdXNBcm5dKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBLaW5lc2lzU3RyZWFtKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImtpbmVzaXM6KlwiLCBbcGVybWlzc2lvbi5raW5lc2lzU3RyZWFtLnN0cmVhbUFybl0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEJ1Y2tldCkge1xuICAgICAgY29uc3QgYnVja2V0QXJuID0gcGVybWlzc2lvbi5zM0J1Y2tldC5idWNrZXRBcm47XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwiczM6KlwiLCBbYnVja2V0QXJuLCBgJHtidWNrZXRBcm59LypgXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFJEUykge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInJkcy1kYXRhOipcIiwgW3Blcm1pc3Npb24uY2x1c3RlckFybl0pKTtcbiAgICAgIGlmIChwZXJtaXNzaW9uLnJkc1NlcnZlcmxlc3NDbHVzdGVyLnNlY3JldCkge1xuICAgICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICAgIGJ1aWxkUG9saWN5KFtcInNlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlXCIsIFwic2VjcmV0c21hbmFnZXI6RGVzY3JpYmVTZWNyZXRcIl0sIFtwZXJtaXNzaW9uLnJkc1NlcnZlcmxlc3NDbHVzdGVyLnNlY3JldC5zZWNyZXRBcm5dKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwibGFtYmRhOipcIiwgW3Blcm1pc3Npb24uZnVuY3Rpb25Bcm5dKSk7XG4gICAgfVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IENESyBjb25zdHJ1Y3RzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgZWxzZSBpZiAoKHBlcm1pc3Npb24gYXMgYW55KS50YWJsZUFybiAmJiAocGVybWlzc2lvbiBhcyBhbnkpLnRhYmxlTmFtZSkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICBjb25zdCB0YWJsZUFybiA9IHBlcm1pc3Npb24udGFibGVBcm47XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwiZHluYW1vZGI6KlwiLCBbdGFibGVBcm4sIGAke3RhYmxlQXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKChwZXJtaXNzaW9uIGFzIGFueSkudG9waWNBcm4gJiYgKHBlcm1pc3Npb24gYXMgYW55KS50b3BpY05hbWUpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNuczoqXCIsIFtwZXJtaXNzaW9uLnRvcGljQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAoKHBlcm1pc3Npb24gYXMgYW55KS5xdWV1ZUFybiAmJiAocGVybWlzc2lvbiBhcyBhbnkpLnF1ZXVlTmFtZSkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwic3FzOipcIiwgW3Blcm1pc3Npb24ucXVldWVBcm5dKSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuZXZlbnRCdXNBcm4gJiZcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuZXZlbnRCdXNOYW1lXG4gICAgKSB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFdlIGRvIG5vdCB3YW50IHRvIGltcG9ydCB0aGUgY2RrIG1vZHVsZXMsIGp1c3QgY2FzdCB0byBhbnlcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJldmVudHM6KlwiLCBbcGVybWlzc2lvbi5ldmVudEJ1c0Fybl0pKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgKHBlcm1pc3Npb24gYXMgYW55KS5zdHJlYW1Bcm4gJiZcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuc3RyZWFtTmFtZVxuICAgICkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwia2luZXNpczoqXCIsIFtwZXJtaXNzaW9uLnN0cmVhbUFybl0pKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgKHBlcm1pc3Npb24gYXMgYW55KS5kZWxpdmVyeVN0cmVhbUFybiAmJlxuICAgICAgKHBlcm1pc3Npb24gYXMgYW55KS5kZWxpdmVyeVN0cmVhbU5hbWVcbiAgICApIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZmlyZWhvc2U6KlwiLCBbKHBlcm1pc3Npb24gYXMgYW55KS5kZWxpdmVyeVN0cmVhbUFybl0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLmJ1Y2tldEFybiAmJlxuICAgICAgKHBlcm1pc3Npb24gYXMgYW55KS5idWNrZXROYW1lXG4gICAgKSB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFdlIGRvIG5vdCB3YW50IHRvIGltcG9ydCB0aGUgY2RrIG1vZHVsZXMsIGp1c3QgY2FzdCB0byBhbnlcbiAgICAgIGNvbnN0IGJ1Y2tldEFybiA9IHBlcm1pc3Npb24uYnVja2V0QXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInMzOipcIiwgW2J1Y2tldEFybiwgYCR7YnVja2V0QXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKChwZXJtaXNzaW9uIGFzIGFueSkuY2x1c3RlckFybikge1xuICAgICAgLy8gRm9yIFNlcnZlcmxlc3NDbHVzdGVyLCB3ZSBuZWVkIHRvIGdyYW50OlxuICAgICAgLy8gLSBwZXJtaXNzc2lvbnMgdG8gYWNjZXNzIHRoZSBEYXRhIEFQSTtcbiAgICAgIC8vIC0gcGVybWlzc3Npb25zIHRvIGFjY2VzcyB0aGUgU2VjcmV0IE1hbmFnZXIgKHJlcXVpcmVkIGJ5IERhdGEgQVBJKS5cbiAgICAgIC8vIE5vIG5lZWQgdG8gZ3JhbnQgdGhlIHBlcm1pc3Npb25zIGZvciBJQU0gZGF0YWJhc2UgYXV0aGVudGljYXRpb25cbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJyZHMtZGF0YToqXCIsIFsocGVybWlzc2lvbiBhcyBhbnkpLmNsdXN0ZXJBcm5dKSk7XG4gICAgICBjb25zdCBzZWNyZXQgPSAocGVybWlzc2lvbiBhcyBhbnkpLnNlY3JldDtcbiAgICAgIGlmIChzZWNyZXQpIHtcbiAgICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgICBidWlsZFBvbGljeShbXCJzZWNyZXRzbWFuYWdlcjpHZXRTZWNyZXRWYWx1ZVwiLCBcInNlY3JldHNtYW5hZ2VyOkRlc2NyaWJlU2VjcmV0XCJdLCBbc2VjcmV0LnNlY3JldEFybl0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IGdyYW50IG1ldGhvZFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGVsc2UgaWYgKFxuICAgICAgQXJyYXkuaXNBcnJheShwZXJtaXNzaW9uKSAmJlxuICAgICAgcGVybWlzc2lvbi5sZW5ndGggPT09IDIgJiZcbiAgICAgIGlzQ0RLQ29uc3RydWN0KHBlcm1pc3Npb25bMF0pICYmXG4gICAgICB0eXBlb2YgcGVybWlzc2lvblsxXSA9PT0gXCJzdHJpbmdcIlxuICAgICkge1xuICAgICAgY29uc3QgY29uc3RydWN0ID0gcGVybWlzc2lvblswXSBhcyBDb25zdHJ1Y3Q7XG4gICAgICBjb25zdCBtZXRob2ROYW1lID0gcGVybWlzc2lvblsxXSBhcyBrZXlvZiBDb25zdHJ1Y3Q7XG4gICAgICBpZiAodHlwZW9mIGNvbnN0cnVjdFttZXRob2ROYW1lXSAhPT0gXCJmdW5jdGlvblwiKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRoZSBzcGVjaWZpZWQgZ3JhbnQgbWV0aG9kIGlzIGluY29ycmVjdC5cbiAgICAgICAgICBDaGVjayB0aGUgYXZhaWxhYmxlIG1ldGhvZHMgdGhhdCBwcmVmaXhlZCB3aXRoIGdyYW50cyBvbiB0aGUgQ29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgKGNvbnN0cnVjdFttZXRob2ROYW1lXSBhcyB7IChjb25zdHJ1Y3Q6IENvbnN0cnVjdCk6IHZvaWQgfSkocm9sZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcInBlcm1pc3Npb24gb2JqZWN0XCIsIHBlcm1pc3Npb24pO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3BlY2lmaWVkIHBlcm1pc3Npb25zIGFyZSBub3Qgc3VwcG9ydGVkLmApO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkUG9saWN5KGFjdGlvbnM6IHN0cmluZyB8IHN0cmluZ1tdLCByZXNvdXJjZXM6IHN0cmluZ1tdKTogaWFtLlBvbGljeVN0YXRlbWVudCB7XG4gIHJldHVybiBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgIGFjdGlvbnM6IHR5cGVvZiBhY3Rpb25zID09PSBcInN0cmluZ1wiID8gW2FjdGlvbnNdIDogYWN0aW9ucyxcbiAgICByZXNvdXJjZXMsXG4gIH0pO1xufVxuIl19