"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppSyncApi = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const graphql_1 = require("graphql");
const merge_1 = require("@graphql-tools/merge");
const load_files_1 = require("@graphql-tools/load-files");
const constructs_1 = require("constructs");
const appsync = __importStar(require("@aws-cdk/aws-appsync-alpha"));
const Table_1 = require("./Table");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class AppSyncApi extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { graphqlApi, dataSources, resolvers, defaultFunctionProps } = props || {};
        this.functionsByDsKey = {};
        this.dataSourcesByDsKey = {};
        this.resolversByResKey = {};
        this.dsKeysByResKey = {};
        this.permissionsAttachedForAllFunctions = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Api
        ////////////////////
        if ((0, Construct_1.isCDKConstruct)(graphqlApi)) {
            this.graphqlApi = graphqlApi;
        }
        else {
            const graphqlApiProps = (graphqlApi || {});
            // build schema
            let mainSchema;
            if (typeof graphqlApiProps.schema === "string") {
                mainSchema = appsync.Schema.fromAsset(graphqlApiProps.schema);
            }
            else if (Array.isArray(graphqlApiProps.schema)) {
                if (graphqlApiProps.schema.length > 0) {
                    // merge schema files
                    const mergedSchema = (0, merge_1.mergeTypeDefs)((0, load_files_1.loadFilesSync)(graphqlApiProps.schema));
                    const filePath = path.join(root.buildDir, `appsyncapi-${id}-${this.node.addr}.graphql`);
                    fs.writeFileSync(filePath, (0, graphql_1.print)(mergedSchema));
                    mainSchema = appsync.Schema.fromAsset(filePath);
                }
            }
            else {
                mainSchema = graphqlApiProps.schema;
            }
            this.graphqlApi = new appsync.GraphqlApi(this, "Api", Object.assign(Object.assign({ name: root.logicalPrefixedName(id), xrayEnabled: true }, graphqlApiProps), { 
                // handle schema is "string"
                schema: mainSchema }));
        }
        ///////////////////////////
        // Configure data sources
        ///////////////////////////
        if (dataSources) {
            Object.keys(dataSources).forEach((key) => this.addDataSource(this, key, dataSources[key]));
        }
        ///////////////////////////
        // Configure resolvers
        ///////////////////////////
        if (resolvers) {
            Object.keys(resolvers).forEach((key) => this.addResolver(this, key, resolvers[key]));
        }
    }
    get url() {
        return this.graphqlApi.graphqlUrl;
    }
    addDataSources(scope, dataSources) {
        Object.keys(dataSources).forEach((key) => {
            // add data source
            const fn = this.addDataSource(scope, key, dataSources[key]);
            // attached existing permissions
            if (fn) {
                this.permissionsAttachedForAllFunctions.forEach((permissions) => fn.attachPermissions(permissions));
            }
        });
    }
    addResolvers(scope, resolvers) {
        Object.keys(resolvers).forEach((key) => {
            // add resolver
            const fn = this.addResolver(scope, key, resolvers[key]);
            // attached existing permissions
            if (fn) {
                this.permissionsAttachedForAllFunctions.forEach((permissions) => fn.attachPermissions(permissions));
            }
        });
    }
    getConstructMetadata() {
        return {
            type: "AppSync",
            data: {
                url: this.graphqlApi.graphqlUrl,
                appSyncApiId: this.graphqlApi.apiId,
                dataSources: Object.entries(this.dataSourcesByDsKey).map(([key]) => ({
                    name: key,
                    fn: (0, Construct_1.getFunctionRef)(this.functionsByDsKey[key]),
                })),
            },
        };
    }
    addDataSource(scope, dsKey, dsValue) {
        let dataSource;
        let lambda;
        // Lambda ds
        if (dsValue.function) {
            dsValue = dsValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${dsKey}`, dsValue.function, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${dsKey} data source`);
            dataSource = this.graphqlApi.addLambdaDataSource(dsKey, lambda, dsValue.options);
        }
        // DynamoDb ds
        else if (dsValue.table) {
            dsValue = dsValue;
            const table = dsValue.table instanceof Table_1.Table
                ? dsValue.table.dynamodbTable
                : dsValue.table;
            dataSource = this.graphqlApi.addDynamoDbDataSource(dsKey, table, dsValue.options);
        }
        // Rds ds
        else if (dsValue.serverlessCluster) {
            dsValue = dsValue;
            dataSource = this.graphqlApi.addRdsDataSource(dsKey, dsValue.serverlessCluster, dsValue.secretStore, dsValue.databaseName, dsValue.options);
        }
        // Http ds
        else if (dsValue.endpoint) {
            dsValue = dsValue;
            dataSource = this.graphqlApi.addHttpDataSource(dsKey, dsValue.endpoint, dsValue.options);
        }
        // Lambda function
        else {
            dsValue = dsValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${dsKey}`, dsValue, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${dsKey} data source`);
            dataSource = this.graphqlApi.addLambdaDataSource(dsKey, lambda);
        }
        this.dataSourcesByDsKey[dsKey] = dataSource;
        if (lambda) {
            this.functionsByDsKey[dsKey] = lambda;
        }
        return lambda;
    }
    addResolver(scope, resKey, resValue) {
        // Normalize resKey
        resKey = this.normalizeResolverKey(resKey);
        // Get type and field
        const resolverKeyParts = resKey.split(" ");
        if (resolverKeyParts.length !== 2) {
            throw new Error(`Invalid resolver ${resKey}`);
        }
        const [typeName, fieldName] = resolverKeyParts;
        if (fieldName.length === 0) {
            throw new Error(`Invalid field defined for "${resKey}"`);
        }
        ///////////////////
        // Create data source if not created before
        ///////////////////
        let lambda;
        let dataSource;
        let dataSourceKey;
        let resolverProps;
        // DataSource key
        if (typeof resValue === "string" &&
            Object.keys(this.dataSourcesByDsKey).includes(resValue)) {
            dataSourceKey = resValue;
            dataSource = this.dataSourcesByDsKey[resValue];
            resolverProps = {};
        }
        // DataSource key not exist (string does not have a dot, assume it is referencing a data store)
        else if (typeof resValue === "string" && resValue.indexOf(".") === -1) {
            throw new Error(`Failed to create resolver "${resKey}". Data source "${resValue}" does not exist.`);
        }
        // Lambda resolver
        else if (this.isLambdaResolverProps(resValue)) {
            resValue = resValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${typeName}_${fieldName}`, resValue.function, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${resKey} resolver`);
            dataSourceKey = this.buildDataSourceKey(typeName, fieldName);
            dataSource = this.graphqlApi.addLambdaDataSource(dataSourceKey, lambda);
            resolverProps = resValue.resolverProps || {};
        }
        // DataSource resolver
        else if (this.isDataSourceResolverProps(resValue)) {
            resValue = resValue;
            dataSourceKey = resValue.dataSource;
            dataSource = this.dataSourcesByDsKey[dataSourceKey];
            resolverProps = resValue.resolverProps || {};
        }
        // Lambda function
        else {
            resValue = resValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${typeName}_${fieldName}`, resValue, this.defaultFunctionProps, `Cannot define defaultFunctionProps when a Function is passed in to the "${resKey} resolver`);
            dataSourceKey = this.buildDataSourceKey(typeName, fieldName);
            dataSource = this.graphqlApi.addLambdaDataSource(dataSourceKey, lambda);
            resolverProps = {};
        }
        // Store new data source created
        if (lambda) {
            this.dataSourcesByDsKey[dataSourceKey] = dataSource;
            this.functionsByDsKey[dataSourceKey] = lambda;
        }
        this.dsKeysByResKey[resKey] = dataSourceKey;
        ///////////////////
        // Create resolver
        ///////////////////
        const resolver = this.graphqlApi.createResolver(Object.assign({ dataSource,
            typeName,
            fieldName }, resolverProps));
        this.resolversByResKey[resKey] = resolver;
        return lambda;
    }
    isLambdaResolverProps(object) {
        return object.function !== undefined;
    }
    isDataSourceResolverProps(object) {
        return object.dataSource !== undefined;
    }
    normalizeResolverKey(resolverKey) {
        // remove extra spaces in the key
        return resolverKey.split(/\s+/).join(" ");
    }
    buildDataSourceKey(typeName, fieldName) {
        return `LambdaDS_${typeName}_${fieldName}`;
    }
    getFunction(key) {
        let fn = this.functionsByDsKey[key];
        if (!fn) {
            const resKey = this.normalizeResolverKey(key);
            const dsKey = this.dsKeysByResKey[resKey];
            fn = this.functionsByDsKey[dsKey];
        }
        return fn;
    }
    getDataSource(key) {
        let ds = this.dataSourcesByDsKey[key];
        if (!ds) {
            const resKey = this.normalizeResolverKey(key);
            const dsKey = this.dsKeysByResKey[resKey];
            ds = this.dataSourcesByDsKey[dsKey];
        }
        return ds;
    }
    getResolver(key) {
        const resKey = this.normalizeResolverKey(key);
        return this.resolversByResKey[resKey];
    }
    attachPermissions(permissions) {
        Object.values(this.functionsByDsKey).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllFunctions.push(permissions);
    }
    attachPermissionsToDataSource(key, permissions) {
        const fn = this.getFunction(key);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Function does not exist for key "${key}".`);
        }
        fn.attachPermissions(permissions);
    }
}
exports.AppSyncApi = AppSyncApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwU3luY0FwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBTeW5jQXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQixxQ0FBZ0M7QUFDaEMsZ0RBQXFEO0FBQ3JELDBEQUEwRDtBQUUxRCwyQ0FBdUM7QUFFdkMsb0VBQXNEO0FBS3RELG1DQUFnQztBQUNoQywyQ0FBMkU7QUFDM0UseUNBQStFO0FBOEQvRSxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLFVBQVcsU0FBUSxzQkFBUztJQVd2QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXVCO1FBQy9ELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLEdBQ2hFLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsa0NBQWtDLEdBQUcsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUVqRCxvQkFBb0I7UUFDcEIsYUFBYTtRQUNiLG9CQUFvQjtRQUVwQixJQUFJLElBQUEsMEJBQWMsRUFBQyxVQUFVLENBQUMsRUFBRTtZQUM5QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQWdDLENBQUM7U0FDcEQ7YUFBTTtZQUNM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QztRQUV0QyxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ1AsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUMsRUFBRSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQztRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVNLFdBQVcsQ0FBQyxHQUFXO1FBQzVCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QyxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRU0saUJBQWlCLENBQUMsV0FBd0I7UUFDL0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUNsRCxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQ2xDLENBQUM7UUFDRixJQUFJLENBQUMsa0NBQWtDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFTSw2QkFBNkIsQ0FDbEMsR0FBVyxFQUNYLFdBQXdCO1FBRXhCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNQLE1BQU0sSUFBSSxLQUFLLENBQ2Isa0VBQWtFLEdBQUcsSUFBSSxDQUMxRSxDQUFDO1NBQ0g7UUFFRCxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEMsQ0FBQztDQUNGO0FBeFlELGdDQXdZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgcHJpbnQgfSBmcm9tIFwiZ3JhcGhxbFwiO1xuaW1wb3J0IHsgbWVyZ2VUeXBlRGVmcyB9IGZyb20gXCJAZ3JhcGhxbC10b29scy9tZXJnZVwiO1xuaW1wb3J0IHsgbG9hZEZpbGVzU3luYyB9IGZyb20gXCJAZ3JhcGhxbC10b29scy9sb2FkLWZpbGVzXCI7XG5cbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyByZHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yZHNcIjtcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcHBzeW5jLWFscGhhXCI7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiXCI7XG5pbXBvcnQgKiBhcyBzZWNyZXRzbWFuYWdlciBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNlY3JldHNtYW5hZ2VyXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgVGFibGUgfSBmcm9tIFwiLi9UYWJsZVwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpUHJvcHMge1xuICByZWFkb25seSBncmFwaHFsQXBpPzogYXBwc3luYy5JR3JhcGhxbEFwaSB8IEFwcFN5bmNBcGlDZGtHcmFwaHFsUHJvcHM7XG4gIHJlYWRvbmx5IGRhdGFTb3VyY2VzPzoge1xuICAgIFtrZXk6IHN0cmluZ106XG4gICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgfCBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wc1xuICAgICAgfCBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzO1xuICB9O1xuICByZWFkb25seSByZXNvbHZlcnM/OiB7XG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBwU3luY0FwaVJlc29sdmVyUHJvcHM7XG4gIH07XG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzIHtcbiAgcmVhZG9ubHkgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgb3B0aW9ucz86IGFwcHN5bmMuRGF0YVNvdXJjZU9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaUR5bmFtb0RiRGF0YVNvdXJjZVByb3BzIHtcbiAgcmVhZG9ubHkgdGFibGU6IFRhYmxlIHwgZHluYW1vZGIuVGFibGU7XG4gIHJlYWRvbmx5IG9wdGlvbnM/OiBhcHBzeW5jLkRhdGFTb3VyY2VPcHRpb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlSZHNEYXRhU291cmNlUHJvcHMge1xuICByZWFkb25seSBzZXJ2ZXJsZXNzQ2x1c3RlcjogcmRzLklTZXJ2ZXJsZXNzQ2x1c3RlcjtcbiAgcmVhZG9ubHkgc2VjcmV0U3RvcmU6IHNlY3JldHNtYW5hZ2VyLklTZWNyZXQ7XG4gIHJlYWRvbmx5IGRhdGFiYXNlTmFtZT86IHN0cmluZztcbiAgcmVhZG9ubHkgb3B0aW9ucz86IGFwcHN5bmMuRGF0YVNvdXJjZU9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaUh0dHBEYXRhU291cmNlUHJvcHMge1xuICByZWFkb25seSBlbmRwb2ludDogc3RyaW5nO1xuICByZWFkb25seSBvcHRpb25zPzogYXBwc3luYy5IdHRwRGF0YVNvdXJjZU9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaVJlc29sdmVyUHJvcHMge1xuICByZWFkb25seSBkYXRhU291cmNlPzogc3RyaW5nO1xuICByZWFkb25seSBmdW5jdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcmVzb2x2ZXJQcm9wcz86IEFwcFN5bmNBcGlDZGtSZXNvbHZlclByb3BzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlDZGtHcmFwaHFsUHJvcHNcbiAgZXh0ZW5kcyBPbWl0PGFwcHN5bmMuR3JhcGhxbEFwaVByb3BzLCBcIm5hbWVcIiB8IFwic2NoZW1hXCI+IHtcbiAgcmVhZG9ubHkgbmFtZT86IHN0cmluZztcbiAgcmVhZG9ubHkgc2NoZW1hPzogc3RyaW5nIHwgc3RyaW5nW10gfCBhcHBzeW5jLlNjaGVtYTtcbn1cblxuZXhwb3J0IHR5cGUgQXBwU3luY0FwaUNka1Jlc29sdmVyUHJvcHMgPSBPbWl0PFxuICBhcHBzeW5jLkJhc2VSZXNvbHZlclByb3BzLFxuICBcImZpZWxkTmFtZVwiIHwgXCJ0eXBlTmFtZVwiXG4+O1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBBcHBTeW5jQXBpIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGdyYXBocWxBcGk6IGFwcHN5bmMuR3JhcGhxbEFwaTtcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbnNCeURzS2V5OiB7IFtrZXk6IHN0cmluZ106IEZuIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNvdXJjZXNCeURzS2V5OiB7XG4gICAgW2tleTogc3RyaW5nXTogYXBwc3luYy5CYXNlRGF0YVNvdXJjZTtcbiAgfTtcbiAgcHJpdmF0ZSByZWFkb25seSBkc0tleXNCeVJlc0tleTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNvbHZlcnNCeVJlc0tleTogeyBba2V5OiBzdHJpbmddOiBhcHBzeW5jLlJlc29sdmVyIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbEZ1bmN0aW9uczogUGVybWlzc2lvbnNbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBBcHBTeW5jQXBpUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgeyBncmFwaHFsQXBpLCBkYXRhU291cmNlcywgcmVzb2x2ZXJzLCBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB9ID1cbiAgICAgIHByb3BzIHx8IHt9O1xuICAgIHRoaXMuZnVuY3Rpb25zQnlEc0tleSA9IHt9O1xuICAgIHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5ID0ge307XG4gICAgdGhpcy5yZXNvbHZlcnNCeVJlc0tleSA9IHt9O1xuICAgIHRoaXMuZHNLZXlzQnlSZXNLZXkgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxGdW5jdGlvbnMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBBcGlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KGdyYXBocWxBcGkpKSB7XG4gICAgICB0aGlzLmdyYXBocWxBcGkgPSBncmFwaHFsQXBpIGFzIGFwcHN5bmMuR3JhcGhxbEFwaTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZ3JhcGhxbEFwaVByb3BzID0gKGdyYXBocWxBcGkgfHwge30pIGFzIEFwcFN5bmNBcGlDZGtHcmFwaHFsUHJvcHM7XG5cbiAgICAgIC8vIGJ1aWxkIHNjaGVtYVxuICAgICAgbGV0IG1haW5TY2hlbWE6IGFwcHN5bmMuU2NoZW1hIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKHR5cGVvZiBncmFwaHFsQXBpUHJvcHMuc2NoZW1hID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIG1haW5TY2hlbWEgPSBhcHBzeW5jLlNjaGVtYS5mcm9tQXNzZXQoZ3JhcGhxbEFwaVByb3BzLnNjaGVtYSk7XG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZ3JhcGhxbEFwaVByb3BzLnNjaGVtYSkpIHtcbiAgICAgICAgaWYgKGdyYXBocWxBcGlQcm9wcy5zY2hlbWEubGVuZ3RoID4gMCkge1xuICAgICAgICAgIC8vIG1lcmdlIHNjaGVtYSBmaWxlc1xuICAgICAgICAgIGNvbnN0IG1lcmdlZFNjaGVtYSA9IG1lcmdlVHlwZURlZnMoXG4gICAgICAgICAgICBsb2FkRmlsZXNTeW5jKGdyYXBocWxBcGlQcm9wcy5zY2hlbWEpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgICAgIHJvb3QuYnVpbGREaXIsXG4gICAgICAgICAgICBgYXBwc3luY2FwaS0ke2lkfS0ke3RoaXMubm9kZS5hZGRyfS5ncmFwaHFsYFxuICAgICAgICAgICk7XG4gICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgcHJpbnQobWVyZ2VkU2NoZW1hKSk7XG4gICAgICAgICAgbWFpblNjaGVtYSA9IGFwcHN5bmMuU2NoZW1hLmZyb21Bc3NldChmaWxlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1haW5TY2hlbWEgPSBncmFwaHFsQXBpUHJvcHMuc2NoZW1hO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmdyYXBocWxBcGkgPSBuZXcgYXBwc3luYy5HcmFwaHFsQXBpKHRoaXMsIFwiQXBpXCIsIHtcbiAgICAgICAgbmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgeHJheUVuYWJsZWQ6IHRydWUsXG4gICAgICAgIC4uLmdyYXBocWxBcGlQcm9wcyxcblxuICAgICAgICAvLyBoYW5kbGUgc2NoZW1hIGlzIFwic3RyaW5nXCJcbiAgICAgICAgc2NoZW1hOiBtYWluU2NoZW1hLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIGRhdGEgc291cmNlc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGRhdGFTb3VyY2VzKSB7XG4gICAgICBPYmplY3Qua2V5cyhkYXRhU291cmNlcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+XG4gICAgICAgIHRoaXMuYWRkRGF0YVNvdXJjZSh0aGlzLCBrZXksIGRhdGFTb3VyY2VzW2tleV0pXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSByZXNvbHZlcnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChyZXNvbHZlcnMpIHtcbiAgICAgIE9iamVjdC5rZXlzKHJlc29sdmVycykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+XG4gICAgICAgIHRoaXMuYWRkUmVzb2x2ZXIodGhpcywga2V5LCByZXNvbHZlcnNba2V5XSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5ncmFwaHFsQXBpLmdyYXBocWxVcmw7XG4gIH1cblxuICBwdWJsaWMgYWRkRGF0YVNvdXJjZXMoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBkYXRhU291cmNlczoge1xuICAgICAgW2tleTogc3RyaW5nXTpcbiAgICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgICAgfCBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzXG4gICAgICAgIHwgQXBwU3luY0FwaUR5bmFtb0RiRGF0YVNvdXJjZVByb3BzXG4gICAgICAgIHwgQXBwU3luY0FwaVJkc0RhdGFTb3VyY2VQcm9wc1xuICAgICAgICB8IEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMoZGF0YVNvdXJjZXMpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAvLyBhZGQgZGF0YSBzb3VyY2VcbiAgICAgIGNvbnN0IGZuID0gdGhpcy5hZGREYXRhU291cmNlKHNjb3BlLCBrZXksIGRhdGFTb3VyY2VzW2tleV0pO1xuXG4gICAgICAvLyBhdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgICAgaWYgKGZuKSB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbEZ1bmN0aW9ucy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRSZXNvbHZlcnMoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICByZXNvbHZlcnM6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEFwcFN5bmNBcGlSZXNvbHZlclByb3BzO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMocmVzb2x2ZXJzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgLy8gYWRkIHJlc29sdmVyXG4gICAgICBjb25zdCBmbiA9IHRoaXMuYWRkUmVzb2x2ZXIoc2NvcGUsIGtleSwgcmVzb2x2ZXJzW2tleV0pO1xuXG4gICAgICAvLyBhdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgICAgaWYgKGZuKSB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbEZ1bmN0aW9ucy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJBcHBTeW5jXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHVybDogdGhpcy5ncmFwaHFsQXBpLmdyYXBocWxVcmwsXG4gICAgICAgIGFwcFN5bmNBcGlJZDogdGhpcy5ncmFwaHFsQXBpLmFwaUlkLFxuICAgICAgICBkYXRhU291cmNlczogT2JqZWN0LmVudHJpZXModGhpcy5kYXRhU291cmNlc0J5RHNLZXkpLm1hcCgoW2tleV0pID0+ICh7XG4gICAgICAgICAgbmFtZToga2V5LFxuICAgICAgICAgIGZuOiBnZXRGdW5jdGlvblJlZih0aGlzLmZ1bmN0aW9uc0J5RHNLZXlba2V5XSksXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRGF0YVNvdXJjZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGRzS2V5OiBzdHJpbmcsXG4gICAgZHNWYWx1ZTpcbiAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICB8IEFwcFN5bmNBcGlMYW1iZGFEYXRhU291cmNlUHJvcHNcbiAgICAgIHwgQXBwU3luY0FwaUR5bmFtb0RiRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlSZHNEYXRhU291cmNlUHJvcHNcbiAgICAgIHwgQXBwU3luY0FwaUh0dHBEYXRhU291cmNlUHJvcHNcbiAgKTogRm4gfCB1bmRlZmluZWQge1xuICAgIGxldCBkYXRhU291cmNlO1xuICAgIGxldCBsYW1iZGE7XG5cbiAgICAvLyBMYW1iZGEgZHNcbiAgICBpZiAoKGRzVmFsdWUgYXMgQXBwU3luY0FwaUxhbWJkYURhdGFTb3VyY2VQcm9wcykuZnVuY3Rpb24pIHtcbiAgICAgIGRzVmFsdWUgPSBkc1ZhbHVlIGFzIEFwcFN5bmNBcGlMYW1iZGFEYXRhU291cmNlUHJvcHM7XG4gICAgICBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGBMYW1iZGFfJHtkc0tleX1gLFxuICAgICAgICBkc1ZhbHVlLmZ1bmN0aW9uLFxuICAgICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgICBgQ2Fubm90IGRlZmluZSBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB3aGVuIGEgRnVuY3Rpb24gaXMgcGFzc2VkIGluIHRvIHRoZSBcIiR7ZHNLZXl9IGRhdGEgc291cmNlYFxuICAgICAgKTtcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmdyYXBocWxBcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShcbiAgICAgICAgZHNLZXksXG4gICAgICAgIGxhbWJkYSxcbiAgICAgICAgZHNWYWx1ZS5vcHRpb25zXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBEeW5hbW9EYiBkc1xuICAgIGVsc2UgaWYgKChkc1ZhbHVlIGFzIEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wcykudGFibGUpIHtcbiAgICAgIGRzVmFsdWUgPSBkc1ZhbHVlIGFzIEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wcztcbiAgICAgIGNvbnN0IHRhYmxlID1cbiAgICAgICAgZHNWYWx1ZS50YWJsZSBpbnN0YW5jZW9mIFRhYmxlXG4gICAgICAgICAgPyBkc1ZhbHVlLnRhYmxlLmR5bmFtb2RiVGFibGVcbiAgICAgICAgICA6IGRzVmFsdWUudGFibGU7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5ncmFwaHFsQXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZShcbiAgICAgICAgZHNLZXksXG4gICAgICAgIHRhYmxlLFxuICAgICAgICBkc1ZhbHVlLm9wdGlvbnNcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIFJkcyBkc1xuICAgIGVsc2UgaWYgKChkc1ZhbHVlIGFzIEFwcFN5bmNBcGlSZHNEYXRhU291cmNlUHJvcHMpLnNlcnZlcmxlc3NDbHVzdGVyKSB7XG4gICAgICBkc1ZhbHVlID0gZHNWYWx1ZSBhcyBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZ3JhcGhxbEFwaS5hZGRSZHNEYXRhU291cmNlKFxuICAgICAgICBkc0tleSxcbiAgICAgICAgZHNWYWx1ZS5zZXJ2ZXJsZXNzQ2x1c3RlcixcbiAgICAgICAgZHNWYWx1ZS5zZWNyZXRTdG9yZSxcbiAgICAgICAgZHNWYWx1ZS5kYXRhYmFzZU5hbWUsXG4gICAgICAgIGRzVmFsdWUub3B0aW9uc1xuICAgICAgKTtcbiAgICB9XG4gICAgLy8gSHR0cCBkc1xuICAgIGVsc2UgaWYgKChkc1ZhbHVlIGFzIEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzKS5lbmRwb2ludCkge1xuICAgICAgZHNWYWx1ZSA9IGRzVmFsdWUgYXMgQXBwU3luY0FwaUh0dHBEYXRhU291cmNlUHJvcHM7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5ncmFwaHFsQXBpLmFkZEh0dHBEYXRhU291cmNlKFxuICAgICAgICBkc0tleSxcbiAgICAgICAgZHNWYWx1ZS5lbmRwb2ludCxcbiAgICAgICAgZHNWYWx1ZS5vcHRpb25zXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBMYW1iZGEgZnVuY3Rpb25cbiAgICBlbHNlIHtcbiAgICAgIGRzVmFsdWUgPSBkc1ZhbHVlIGFzIEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgICAgIGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgYExhbWJkYV8ke2RzS2V5fWAsXG4gICAgICAgIGRzVmFsdWUsXG4gICAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICAgIGBDYW5ub3QgZGVmaW5lIGRlZmF1bHRGdW5jdGlvblByb3BzIHdoZW4gYSBGdW5jdGlvbiBpcyBwYXNzZWQgaW4gdG8gdGhlIFwiJHtkc0tleX0gZGF0YSBzb3VyY2VgXG4gICAgICApO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZ3JhcGhxbEFwaS5hZGRMYW1iZGFEYXRhU291cmNlKGRzS2V5LCBsYW1iZGEpO1xuICAgIH1cbiAgICB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleVtkc0tleV0gPSBkYXRhU291cmNlO1xuICAgIGlmIChsYW1iZGEpIHtcbiAgICAgIHRoaXMuZnVuY3Rpb25zQnlEc0tleVtkc0tleV0gPSBsYW1iZGE7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxhbWJkYTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVzb2x2ZXIoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICByZXNLZXk6IHN0cmluZyxcbiAgICByZXNWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBwU3luY0FwaVJlc29sdmVyUHJvcHNcbiAgKTogRm4gfCB1bmRlZmluZWQge1xuICAgIC8vIE5vcm1hbGl6ZSByZXNLZXlcbiAgICByZXNLZXkgPSB0aGlzLm5vcm1hbGl6ZVJlc29sdmVyS2V5KHJlc0tleSk7XG5cbiAgICAvLyBHZXQgdHlwZSBhbmQgZmllbGRcbiAgICBjb25zdCByZXNvbHZlcktleVBhcnRzID0gcmVzS2V5LnNwbGl0KFwiIFwiKTtcbiAgICBpZiAocmVzb2x2ZXJLZXlQYXJ0cy5sZW5ndGggIT09IDIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByZXNvbHZlciAke3Jlc0tleX1gKTtcbiAgICB9XG4gICAgY29uc3QgW3R5cGVOYW1lLCBmaWVsZE5hbWVdID0gcmVzb2x2ZXJLZXlQYXJ0cztcbiAgICBpZiAoZmllbGROYW1lLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZpZWxkIGRlZmluZWQgZm9yIFwiJHtyZXNLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGRhdGEgc291cmNlIGlmIG5vdCBjcmVhdGVkIGJlZm9yZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBsZXQgbGFtYmRhO1xuICAgIGxldCBkYXRhU291cmNlO1xuICAgIGxldCBkYXRhU291cmNlS2V5O1xuICAgIGxldCByZXNvbHZlclByb3BzO1xuXG4gICAgLy8gRGF0YVNvdXJjZSBrZXlcbiAgICBpZiAoXG4gICAgICB0eXBlb2YgcmVzVmFsdWUgPT09IFwic3RyaW5nXCIgJiZcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5KS5pbmNsdWRlcyhyZXNWYWx1ZSlcbiAgICApIHtcbiAgICAgIGRhdGFTb3VyY2VLZXkgPSByZXNWYWx1ZTtcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleVtyZXNWYWx1ZV07XG4gICAgICByZXNvbHZlclByb3BzID0ge307XG4gICAgfVxuICAgIC8vIERhdGFTb3VyY2Uga2V5IG5vdCBleGlzdCAoc3RyaW5nIGRvZXMgbm90IGhhdmUgYSBkb3QsIGFzc3VtZSBpdCBpcyByZWZlcmVuY2luZyBhIGRhdGEgc3RvcmUpXG4gICAgZWxzZSBpZiAodHlwZW9mIHJlc1ZhbHVlID09PSBcInN0cmluZ1wiICYmIHJlc1ZhbHVlLmluZGV4T2YoXCIuXCIpID09PSAtMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGNyZWF0ZSByZXNvbHZlciBcIiR7cmVzS2V5fVwiLiBEYXRhIHNvdXJjZSBcIiR7cmVzVmFsdWV9XCIgZG9lcyBub3QgZXhpc3QuYFxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gTGFtYmRhIHJlc29sdmVyXG4gICAgZWxzZSBpZiAodGhpcy5pc0xhbWJkYVJlc29sdmVyUHJvcHMocmVzVmFsdWUgYXMgQXBwU3luY0FwaVJlc29sdmVyUHJvcHMpKSB7XG4gICAgICByZXNWYWx1ZSA9IHJlc1ZhbHVlIGFzIEFwcFN5bmNBcGlSZXNvbHZlclByb3BzO1xuICAgICAgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgTGFtYmRhXyR7dHlwZU5hbWV9XyR7ZmllbGROYW1lfWAsXG4gICAgICAgIHJlc1ZhbHVlLmZ1bmN0aW9uIGFzIEZ1bmN0aW9uRGVmaW5pdGlvbixcbiAgICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgICAgYENhbm5vdCBkZWZpbmUgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgd2hlbiBhIEZ1bmN0aW9uIGlzIHBhc3NlZCBpbiB0byB0aGUgXCIke3Jlc0tleX0gcmVzb2x2ZXJgXG4gICAgICApO1xuICAgICAgZGF0YVNvdXJjZUtleSA9IHRoaXMuYnVpbGREYXRhU291cmNlS2V5KHR5cGVOYW1lLCBmaWVsZE5hbWUpO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZ3JhcGhxbEFwaS5hZGRMYW1iZGFEYXRhU291cmNlKGRhdGFTb3VyY2VLZXksIGxhbWJkYSk7XG4gICAgICByZXNvbHZlclByb3BzID0gcmVzVmFsdWUucmVzb2x2ZXJQcm9wcyB8fCB7fTtcbiAgICB9XG4gICAgLy8gRGF0YVNvdXJjZSByZXNvbHZlclxuICAgIGVsc2UgaWYgKFxuICAgICAgdGhpcy5pc0RhdGFTb3VyY2VSZXNvbHZlclByb3BzKHJlc1ZhbHVlIGFzIEFwcFN5bmNBcGlSZXNvbHZlclByb3BzKVxuICAgICkge1xuICAgICAgcmVzVmFsdWUgPSByZXNWYWx1ZSBhcyBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcztcbiAgICAgIGRhdGFTb3VyY2VLZXkgPSByZXNWYWx1ZS5kYXRhU291cmNlIGFzIHN0cmluZztcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleVtkYXRhU291cmNlS2V5XTtcbiAgICAgIHJlc29sdmVyUHJvcHMgPSByZXNWYWx1ZS5yZXNvbHZlclByb3BzIHx8IHt9O1xuICAgIH1cbiAgICAvLyBMYW1iZGEgZnVuY3Rpb25cbiAgICBlbHNlIHtcbiAgICAgIHJlc1ZhbHVlID0gcmVzVmFsdWUgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgICAgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgTGFtYmRhXyR7dHlwZU5hbWV9XyR7ZmllbGROYW1lfWAsXG4gICAgICAgIHJlc1ZhbHVlLFxuICAgICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgICBgQ2Fubm90IGRlZmluZSBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB3aGVuIGEgRnVuY3Rpb24gaXMgcGFzc2VkIGluIHRvIHRoZSBcIiR7cmVzS2V5fSByZXNvbHZlcmBcbiAgICAgICk7XG4gICAgICBkYXRhU291cmNlS2V5ID0gdGhpcy5idWlsZERhdGFTb3VyY2VLZXkodHlwZU5hbWUsIGZpZWxkTmFtZSk7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5ncmFwaHFsQXBpLmFkZExhbWJkYURhdGFTb3VyY2UoZGF0YVNvdXJjZUtleSwgbGFtYmRhKTtcbiAgICAgIHJlc29sdmVyUHJvcHMgPSB7fTtcbiAgICB9XG5cbiAgICAvLyBTdG9yZSBuZXcgZGF0YSBzb3VyY2UgY3JlYXRlZFxuICAgIGlmIChsYW1iZGEpIHtcbiAgICAgIHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5W2RhdGFTb3VyY2VLZXldID0gZGF0YVNvdXJjZTtcbiAgICAgIHRoaXMuZnVuY3Rpb25zQnlEc0tleVtkYXRhU291cmNlS2V5XSA9IGxhbWJkYTtcbiAgICB9XG4gICAgdGhpcy5kc0tleXNCeVJlc0tleVtyZXNLZXldID0gZGF0YVNvdXJjZUtleTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgcmVzb2x2ZXJcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgcmVzb2x2ZXIgPSB0aGlzLmdyYXBocWxBcGkuY3JlYXRlUmVzb2x2ZXIoe1xuICAgICAgZGF0YVNvdXJjZSxcbiAgICAgIHR5cGVOYW1lLFxuICAgICAgZmllbGROYW1lLFxuICAgICAgLi4ucmVzb2x2ZXJQcm9wcyxcbiAgICB9KTtcbiAgICB0aGlzLnJlc29sdmVyc0J5UmVzS2V5W3Jlc0tleV0gPSByZXNvbHZlcjtcblxuICAgIHJldHVybiBsYW1iZGE7XG4gIH1cblxuICBwcml2YXRlIGlzTGFtYmRhUmVzb2x2ZXJQcm9wcyhvYmplY3Q6IEFwcFN5bmNBcGlSZXNvbHZlclByb3BzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iamVjdC5mdW5jdGlvbiAhPT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0RhdGFTb3VyY2VSZXNvbHZlclByb3BzKG9iamVjdDogQXBwU3luY0FwaVJlc29sdmVyUHJvcHMpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb2JqZWN0LmRhdGFTb3VyY2UgIT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgbm9ybWFsaXplUmVzb2x2ZXJLZXkocmVzb2x2ZXJLZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gcmVtb3ZlIGV4dHJhIHNwYWNlcyBpbiB0aGUga2V5XG4gICAgcmV0dXJuIHJlc29sdmVyS2V5LnNwbGl0KC9cXHMrLykuam9pbihcIiBcIik7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRGF0YVNvdXJjZUtleSh0eXBlTmFtZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBMYW1iZGFEU18ke3R5cGVOYW1lfV8ke2ZpZWxkTmFtZX1gO1xuICB9XG5cbiAgcHVibGljIGdldEZ1bmN0aW9uKGtleTogc3RyaW5nKTogRm4gfCB1bmRlZmluZWQge1xuICAgIGxldCBmbiA9IHRoaXMuZnVuY3Rpb25zQnlEc0tleVtrZXldO1xuXG4gICAgaWYgKCFmbikge1xuICAgICAgY29uc3QgcmVzS2V5ID0gdGhpcy5ub3JtYWxpemVSZXNvbHZlcktleShrZXkpO1xuICAgICAgY29uc3QgZHNLZXkgPSB0aGlzLmRzS2V5c0J5UmVzS2V5W3Jlc0tleV07XG4gICAgICBmbiA9IHRoaXMuZnVuY3Rpb25zQnlEc0tleVtkc0tleV07XG4gICAgfVxuICAgIHJldHVybiBmbjtcbiAgfVxuXG4gIHB1YmxpYyBnZXREYXRhU291cmNlKGtleTogc3RyaW5nKTogYXBwc3luYy5CYXNlRGF0YVNvdXJjZSB8IHVuZGVmaW5lZCB7XG4gICAgbGV0IGRzID0gdGhpcy5kYXRhU291cmNlc0J5RHNLZXlba2V5XTtcblxuICAgIGlmICghZHMpIHtcbiAgICAgIGNvbnN0IHJlc0tleSA9IHRoaXMubm9ybWFsaXplUmVzb2x2ZXJLZXkoa2V5KTtcbiAgICAgIGNvbnN0IGRzS2V5ID0gdGhpcy5kc0tleXNCeVJlc0tleVtyZXNLZXldO1xuICAgICAgZHMgPSB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleVtkc0tleV07XG4gICAgfVxuICAgIHJldHVybiBkcztcbiAgfVxuXG4gIHB1YmxpYyBnZXRSZXNvbHZlcihrZXk6IHN0cmluZyk6IGFwcHN5bmMuUmVzb2x2ZXIgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHJlc0tleSA9IHRoaXMubm9ybWFsaXplUmVzb2x2ZXJLZXkoa2V5KTtcbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlcnNCeVJlc0tleVtyZXNLZXldO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnNCeURzS2V5KS5mb3JFYWNoKChmbikgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsRnVuY3Rpb25zLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9EYXRhU291cmNlKFxuICAgIGtleTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZ2V0RnVuY3Rpb24oa2V5KTtcbiAgICBpZiAoIWZuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gYXR0YWNoIHBlcm1pc3Npb25zLiBGdW5jdGlvbiBkb2VzIG5vdCBleGlzdCBmb3Iga2V5IFwiJHtrZXl9XCIuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cbn1cbiJdfQ==