"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsSite = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cross_spawn_1 = __importDefault(require("cross-spawn"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const sqs = __importStar(require("aws-cdk-lib/aws-sqs"));
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const s3Assets = __importStar(require("aws-cdk-lib/aws-s3-assets"));
const cloudfront = __importStar(require("aws-cdk-lib/aws-cloudfront"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
const lambda_layer_awscli_1 = require("aws-cdk-lib/lambda-layer-awscli");
const origins = __importStar(require("aws-cdk-lib/aws-cloudfront-origins"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const route53Patterns = __importStar(require("aws-cdk-lib/aws-route53-patterns"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Construct_1 = require("./Construct");
const BaseSite_1 = require("./BaseSite");
const permission_1 = require("./util/permission");
const builder_1 = require("./util/builder");
const crossRegionHelper = __importStar(require("./nextjs-site/cross-region-helper"));
class NextjsSite extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        // Local development or skip build => stub asset
        this.isPlaceholder =
            (root.local || root.skipBuild) && !props.disablePlaceholder;
        const buildDir = root.buildDir;
        const fileSizeLimit = root.isJestTest()
            ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: "jestFileSizeLimitOverride" not exposed in props
                props.jestFileSizeLimitOverride || 200
            : 200;
        this.props = props;
        this.awsCliLayer = new lambda_layer_awscli_1.AwsCliLayer(this, "AwsCliLayer");
        this.registerSiteEnvironment();
        // Build app
        if (this.isPlaceholder) {
            this.buildOutDir = null;
            this.assets = this.zipAppStubAssets();
            this.routesManifest = null;
        }
        else {
            this.buildOutDir = root.isJestTest()
                ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    // @ts-ignore: "jestBuildOutputPath" not exposed in props
                    props.jestBuildOutputPath || this.buildApp()
                : this.buildApp();
            this.assets = this.zipAppAssets(fileSizeLimit, buildDir);
            this.routesManifest = this.readRoutesManifest();
        }
        // Create Bucket
        this.s3Bucket = this.createS3Bucket();
        // Handle Incremental Static Regeneration
        this.sqsRegenerationQueue = this.createRegenerationQueue();
        this.regenerationFunction = this.createRegenerationFunction();
        // Create Lambda@Edge functions (always created in us-east-1)
        this.edgeLambdaRole = this.createEdgeFunctionRole();
        this.mainFunctionVersion = this.createEdgeFunction("Main", "default-lambda");
        this.apiFunctionVersion = this.createEdgeFunction("Api", "api-lambda");
        this.imageFunctionVersion = this.createEdgeFunction("Image", "image-lambda");
        // Create Custom Domain
        this.validateCustomDomainSettings();
        this.hostedZone = this.lookupHostedZone();
        this.acmCertificate = this.createCertificate();
        // Create S3 Deployment
        const s3deployCR = this.createS3Deployment();
        // Create CloudFront
        this.cfDistribution = this.createCloudFrontDistribution();
        this.cfDistribution.node.addDependency(s3deployCR);
        // Invalidate CloudFront
        const invalidationCR = this.createCloudFrontInvalidation();
        invalidationCR.node.addDependency(this.cfDistribution);
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
    }
    get url() {
        return `https://${this.cfDistribution.distributionDomainName}`;
    }
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get distributionId() {
        return this.cfDistribution.distributionId;
    }
    get distributionDomain() {
        return this.cfDistribution.distributionDomainName;
    }
    attachPermissions(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.edgeLambdaRole, permissions);
    }
    getConstructMetadata() {
        return {
            type: "NextSite",
            data: {
                distributionId: this.cfDistribution.distributionId,
                customDomainUrl: this.customDomainUrl,
            },
        };
    }
    zipAppAssets(fileSizeLimit, buildDir) {
        // validate buildOutput exists
        const siteOutputPath = path.resolve(path.join(this.buildOutDir, "assets"));
        if (!fs.existsSync(siteOutputPath)) {
            throw new Error(`No build output found at "${siteOutputPath}" for the "${this.node.id}" NextjsSite.`);
        }
        // create zip files
        const script = path.join(__dirname, "../assets/BaseSite/archiver.js");
        const zipPath = path.resolve(path.join(buildDir, `NextjsSite-${this.node.id}-${this.node.addr}`));
        // clear zip path to ensure no partX.zip remain from previous build
        fs.removeSync(zipPath);
        const result = cross_spawn_1.default.sync("node", [script, siteOutputPath, zipPath, `${fileSizeLimit}`], {
            stdio: "inherit",
        });
        if (result.status !== 0) {
            console.error(`There was a problem generating the "${this.node.id}" NextjsSite package.`);
            process.exit(1);
        }
        // create assets
        const assets = [];
        for (let partId = 0;; partId++) {
            const zipFilePath = path.join(zipPath, `part${partId}.zip`);
            if (!fs.existsSync(zipFilePath)) {
                break;
            }
            assets.push(new s3Assets.Asset(this, `Asset${partId}`, {
                path: zipFilePath,
            }));
        }
        return assets;
    }
    zipAppStubAssets() {
        return [
            new s3Assets.Asset(this, "Asset", {
                path: path.resolve(__dirname, "../assets/NextjsSite/site-stub"),
            }),
        ];
    }
    createEdgeFunction(name, handlerPath) {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        const hasRealCode = typeof this.buildOutDir === "string" &&
            fs.pathExistsSync(path.join(this.buildOutDir, handlerPath, "index.js"));
        // Create function asset
        const assetPath = hasRealCode && this.buildOutDir
            ? path.join(this.buildOutDir, handlerPath)
            : path.join(__dirname, "../assets/NextjsSite/edge-lambda-stub");
        const asset = new s3Assets.Asset(this, `${name}FunctionAsset`, {
            path: assetPath,
        });
        // Create function based on region
        const root = this.node.root;
        return root.region === "us-east-1"
            ? this.createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode)
            : this.createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode);
    }
    createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode) {
        const { defaultFunctionProps: fnProps } = this.props;
        // Create function
        const fn = new lambda.Function(this, `${name}Function`, {
            description: `${name} handler for Next.js`,
            handler: "index-wrapper.handler",
            currentVersionOptions: {
                removalPolicy: cdk.RemovalPolicy.DESTROY,
            },
            logRetention: logs.RetentionDays.THREE_DAYS,
            code: lambda.Code.fromAsset(assetPath),
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 512,
            timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 10),
            role: this.edgeLambdaRole,
        });
        // Create alias
        fn.currentVersion.addAlias("live");
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            fn.node.addDependency(updaterCR);
        }
        return fn.currentVersion;
    }
    createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode) {
        const { defaultFunctionProps: fnProps } = this.props;
        // If app region is NOT us-east-1, create a Function in us-east-1
        // using a Custom Resource
        // Create a S3 bucket in us-east-1 to store Lambda code. Create
        // 1 bucket for all Edge functions.
        const bucketCR = crossRegionHelper.getOrCreateBucket(this);
        const bucketName = bucketCR.getAttString("BucketName");
        // Create a Lambda function in us-east-1
        const functionCR = crossRegionHelper.createFunction(this, name, this.edgeLambdaRole, bucketName, {
            Description: `handler for Next.js`,
            Handler: "index-wrapper.handler",
            Code: {
                S3Bucket: asset.s3BucketName,
                S3Key: asset.s3ObjectKey,
            },
            Runtime: lambda.Runtime.NODEJS_12_X.name,
            MemorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 512,
            Timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 10).toSeconds(),
            Role: this.edgeLambdaRole.roleArn,
        });
        const functionArn = functionCR.getAttString("FunctionArn");
        // Create a Lambda function version in us-east-1
        const versionCR = crossRegionHelper.createVersion(this, name, functionArn);
        const versionId = versionCR.getAttString("Version");
        crossRegionHelper.updateVersionLogicalId(functionCR, versionCR);
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            functionCR.node.addDependency(updaterCR);
        }
        return lambda.Version.fromVersionArn(this, `${name}FunctionVersion`, `${functionArn}:${versionId}`);
    }
    createEdgeFunctionRole() {
        const { defaultFunctionProps: fnProps } = this.props;
        // Create function role
        const role = new iam.Role(this, `EdgeLambdaRole`, {
            assumedBy: new iam.CompositePrincipal(new iam.ServicePrincipal("lambda.amazonaws.com"), new iam.ServicePrincipal("edgelambda.amazonaws.com")),
            managedPolicies: [
                iam.ManagedPolicy.fromManagedPolicyArn(this, "EdgeLambdaPolicy", "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"),
            ],
        });
        // Attach permission
        this.s3Bucket.grantReadWrite(role);
        this.sqsRegenerationQueue.grantSendMessages(role);
        this.regenerationFunction.grantInvoke(role);
        if (fnProps === null || fnProps === void 0 ? void 0 : fnProps.permissions) {
            (0, permission_1.attachPermissionsToRole)(role, fnProps.permissions);
        }
        return role;
    }
    createRegenerationQueue() {
        const { sqsRegenerationQueue } = this.props;
        return new sqs.Queue(this, "RegenerationQueue", Object.assign(Object.assign({}, (sqsRegenerationQueue || {})), { 
            // We call the queue the same name as the bucket so that we can easily
            // reference it from within the lambda@edge, given we can't use env vars
            // in a lambda@edge
            queueName: `${this.s3Bucket.bucketName}.fifo`, fifo: true, removalPolicy: cdk.RemovalPolicy.DESTROY }));
    }
    createRegenerationFunction() {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        let code;
        let updaterCR;
        if (this.buildOutDir &&
            fs.pathExistsSync(path.join(this.buildOutDir, "regeneration-lambda", "index.js"))) {
            const asset = new s3Assets.Asset(this, `RegenerationFunctionAsset`, {
                path: path.join(this.buildOutDir, "regeneration-lambda"),
            });
            code = lambda.Code.fromAsset(path.join(this.buildOutDir, "regeneration-lambda"));
            updaterCR = this.createLambdaCodeReplacer("Regeneration", asset);
        }
        else {
            code = lambda.Code.fromInline("  ");
        }
        // Create function
        const { defaultFunctionProps: fnProps } = this.props;
        const fn = new lambda.Function(this, "RegenerationFunction", {
            handler: "index-wrapper.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 1024,
            timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 30),
            code,
        });
        fn.addEventSource(new lambdaEventSources.SqsEventSource(this.sqsRegenerationQueue));
        // Grant permissions
        this.s3Bucket.grantReadWrite(fn);
        // Deploy after the code is updated
        if (updaterCR) {
            fn.node.addDependency(updaterCR);
        }
        return fn;
    }
    createLambdaCodeReplacer(name, asset) {
        // Note: Source code for the Lambda functions have "{{ ENV_KEY }}" in them.
        //       They need to be replaced with real values before the Lambda
        //       functions get deployed.
        var _a;
        const providerId = "LambdaCodeReplacerProvider";
        const resId = `${name}LambdaCodeReplacer`;
        const stack = cdk.Stack.of(this);
        let provider = stack.node.tryFindChild(providerId);
        // Create provider if not already created
        if (!provider) {
            provider = new lambda.Function(stack, providerId, {
                code: lambda.Code.fromAsset(path.join(__dirname, "../assets/NextjsSite/custom-resource")),
                layers: [this.awsCliLayer],
                runtime: lambda.Runtime.PYTHON_3_7,
                handler: "lambda-code-updater.handler",
                timeout: cdk.Duration.minutes(15),
                memorySize: 1024,
            });
        }
        // Allow provider to perform search/replace on the asset
        (_a = provider.role) === null || _a === void 0 ? void 0 : _a.addToPrincipalPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["s3:*"],
            resources: [`arn:aws:s3:::${asset.s3BucketName}/${asset.s3ObjectKey}`],
        }));
        // Create custom resource
        const resource = new cdk.CustomResource(this, resId, {
            serviceToken: provider.functionArn,
            resourceType: "Custom::SSTLambdaCodeUpdater",
            properties: {
                Source: {
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                },
                ReplaceValues: this.getLambdaContentReplaceValues(),
            },
        });
        return resource;
    }
    buildApp() {
        const { path: sitePath } = this.props;
        // validate site path exists
        if (!fs.existsSync(sitePath)) {
            throw new Error(`No path found at "${path.resolve(sitePath)}" for the "${this.node.id}" NextjsSite.`);
        }
        // Build command
        // Note: probably could pass JSON string also, but this felt safer.
        const root = this.node.root;
        const pathHash = (0, builder_1.getHandlerHash)(sitePath);
        const buildOutput = path.join(root.buildDir, pathHash);
        const configBuffer = Buffer.from(JSON.stringify({
            cwd: path.resolve(sitePath),
            args: ["build"],
        }));
        // Run build
        console.log(chalk_1.default.grey(`Building Next.js site ${sitePath}`));
        const result = cross_spawn_1.default.sync("node", [
            path.join(__dirname, "../assets/NextjsSite/build/build.js"),
            "--path",
            path.resolve(sitePath),
            "--output",
            path.resolve(buildOutput),
            "--config",
            configBuffer.toString("base64"),
        ], {
            cwd: sitePath,
            stdio: "inherit",
            env: Object.assign(Object.assign({}, process.env), (0, BaseSite_1.getBuildCmdEnvironment)(this.props.environment)),
        });
        if (result.status !== 0) {
            console.error(`There was a problem building the "${this.node.id}" NextjsSite.`);
            process.exit(1);
        }
        return buildOutput;
    }
    createS3Bucket() {
        const { s3Bucket } = this.props;
        return new s3.Bucket(this, "S3Bucket", Object.assign({ publicReadAccess: true, autoDeleteObjects: true, removalPolicy: cdk.RemovalPolicy.DESTROY }, (s3Bucket || {})));
    }
    createS3Deployment() {
        // Create a Lambda function that will be doing the uploading
        const uploader = new lambda.Function(this, "S3Uploader", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-upload.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        this.s3Bucket.grantReadWrite(uploader);
        this.assets.forEach((asset) => asset.grantRead(uploader));
        // Create the custom resource function
        const handler = new lambda.Function(this, "S3Handler", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-handler.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            environment: {
                UPLOADER_FUNCTION_NAME: uploader.functionName,
            },
        });
        this.s3Bucket.grantReadWrite(handler);
        uploader.grantInvoke(handler);
        // Create custom resource
        const fileOptions = [
            {
                exclude: "*",
                include: "public/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static-pages/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/data/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/static/*",
                cacheControl: "public,max-age=31536000,immutable",
            },
        ];
        return new cdk.CustomResource(this, "S3Deployment", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTBucketDeployment",
            properties: {
                Sources: this.assets.map((asset) => ({
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                })),
                DestinationBucketName: this.s3Bucket.bucketName,
                FileOptions: (fileOptions || []).map(({ exclude, include, cacheControl }) => {
                    return [
                        "--exclude",
                        exclude,
                        "--include",
                        include,
                        "--cache-control",
                        cacheControl,
                    ];
                }),
                ReplaceValues: this.getS3ContentReplaceValues(),
            },
        });
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCloudFrontDistribution() {
        var _a, _b, _c, _d;
        const { cfCachePolicies, cfDistribution, customDomain } = this.props;
        const cfDistributionProps = cfDistribution || {};
        // Validate input
        if (cfDistributionProps.certificate) {
            throw new Error(`Do not configure the "cfDistribution.certificate". Use the "customDomain" to configure the NextjsSite domain certificate.`);
        }
        if (cfDistributionProps.domainNames) {
            throw new Error(`Do not configure the "cfDistribution.domainNames". Use the "customDomain" to configure the NextjsSite domain.`);
        }
        // Build domainNames
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === "string") {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
        }
        // Build behavior
        const origin = new origins.S3Origin(this.s3Bucket);
        const viewerProtocolPolicy = cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS;
        if (this.isPlaceholder) {
            return new cloudfront.Distribution(this, "Distribution", {
                defaultRootObject: "index.html",
                errorResponses: (0, BaseSite_1.buildErrorResponsesForRedirectToIndex)("index.html"),
                domainNames,
                certificate: this.acmCertificate,
                defaultBehavior: {
                    origin,
                    viewerProtocolPolicy,
                },
            });
        }
        // Build Edge functions
        const edgeLambdas = [
            {
                includeBody: true,
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                functionVersion: this.mainFunctionVersion,
            },
            {
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_RESPONSE,
                functionVersion: this.mainFunctionVersion,
            },
        ];
        // Build cache policy
        const staticCachePolicy = (_a = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.staticCachePolicy) !== null && _a !== void 0 ? _a : this.createCloudFrontStaticCachePolicy();
        const imageCachePolicy = (_b = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.imageCachePolicy) !== null && _b !== void 0 ? _b : this.createCloudFrontImageCachePolicy();
        const lambdaCachePolicy = (_c = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.lambdaCachePolicy) !== null && _c !== void 0 ? _c : this.createCloudFrontLambdaCachePolicy();
        // Create Distribution
        return new cloudfront.Distribution(this, "Distribution", Object.assign(Object.assign({ 
            // these values can be overwritten by cfDistributionProps
            defaultRootObject: "" }, cfDistributionProps), { 
            // these values can NOT be overwritten by cfDistributionProps
            domainNames, certificate: this.acmCertificate, defaultBehavior: Object.assign(Object.assign({ viewerProtocolPolicy,
                origin, allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS, cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS, compress: true, cachePolicy: lambdaCachePolicy }, (cfDistributionProps.defaultBehavior || {})), { 
                // concatenate edgeLambdas
                edgeLambdas: [
                    ...edgeLambdas,
                    ...(((_d = cfDistributionProps.defaultBehavior) === null || _d === void 0 ? void 0 : _d.edgeLambdas) || []),
                ] }), additionalBehaviors: Object.assign({ [this.pathPattern("_next/image*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: imageCachePolicy,
                    originRequestPolicy: new cloudfront.OriginRequestPolicy(this, "ImageOriginRequest", {
                        queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.all(),
                    }),
                    edgeLambdas: [
                        {
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.imageFunctionVersion,
                        },
                    ],
                }, [this.pathPattern("_next/data/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas,
                }, [this.pathPattern("_next/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("static/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("api/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas: [
                        {
                            includeBody: true,
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.apiFunctionVersion,
                        },
                    ],
                } }, (cfDistributionProps.additionalBehaviors || {})) }));
    }
    createCloudFrontStaticCachePolicy() {
        return new cloudfront.CachePolicy(this, "StaticsCache", NextjsSite.staticCachePolicyProps);
    }
    createCloudFrontImageCachePolicy() {
        return new cloudfront.CachePolicy(this, "ImageCache", NextjsSite.imageCachePolicyProps);
    }
    createCloudFrontLambdaCachePolicy() {
        return new cloudfront.CachePolicy(this, "LambdaCache", NextjsSite.lambdaCachePolicyProps);
    }
    createCloudFrontInvalidation() {
        // Create a Lambda function that will be doing the invalidation
        const invalidator = new lambda.Function(this, "CloudFrontInvalidator", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "cf-invalidate.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        // Grant permissions to invalidate CF Distribution
        invalidator.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "cloudfront:GetInvalidation",
                "cloudfront:CreateInvalidation",
            ],
            resources: ["*"],
        }));
        // need the BuildId field so this CR gets updated on each deploy
        let buildId;
        if (this.isPlaceholder) {
            buildId = "live";
        }
        else {
            const buildIdFile = path.resolve(this.buildOutDir, "assets", "BUILD_ID");
            buildId = fs.readFileSync(buildIdFile).toString();
        }
        // Create custom resource
        const waitForInvalidation = this.props.waitForInvalidation === false ? false : true;
        return new cdk.CustomResource(this, "CloudFrontInvalidation", {
            serviceToken: invalidator.functionArn,
            resourceType: "Custom::SSTCloudFrontInvalidation",
            properties: {
                BuildId: buildId,
                DistributionId: this.cfDistribution.distributionId,
                DistributionPaths: ["/*"],
                WaitForInvalidation: waitForInvalidation,
            },
        });
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!customDomain.certificate) {
                throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
            }
            if (customDomain.domainAlias) {
                throw new Error(`Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.`);
            }
            if (customDomain.hostedZone) {
                throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
            }
        }
    }
    lookupHostedZone() {
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain,
            });
        }
        else if ((0, Construct_1.isCDKConstruct)(customDomain.hostedZone)) {
            hostedZone = customDomain.hostedZone;
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.hostedZone,
            });
        }
        else if (typeof customDomain.domainName === "string") {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.hostedZone) {
            if (typeof customDomain === "string") {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
            else if (customDomain.certificate) {
                acmCertificate = customDomain.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain.domainName,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== "string") {
                acmCertificate = customDomain.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === "string") {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        const recordProps = {
            recordName,
            zone: this.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.cfDistribution)),
        };
        new route53.ARecord(this, "AliasRecord", recordProps);
        new route53.AaaaRecord(this, "AliasRecordAAAA", recordProps);
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, "Redirect", {
                zone: this.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
    /////////////////////
    // Helper Functions
    /////////////////////
    pathPattern(pattern) {
        const { basePath } = this.routesManifest || {};
        return basePath && basePath.length > 0
            ? `${basePath.slice(1)}/${pattern}`
            : pattern;
    }
    readRoutesManifest() {
        return fs.readJSONSync(path.join(this.buildOutDir, "default-lambda/routes-manifest.json"));
    }
    getS3ContentReplaceValues() {
        const replaceValues = [];
        Object.entries(this.props.environment || {})
            .filter(([, value]) => cdk.Token.isUnresolved(value))
            .forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
        });
        return replaceValues;
    }
    getLambdaContentReplaceValues() {
        const replaceValues = [];
        // The Next.js app can have environment variables like
        // `process.env.API_URL` in the JS code. `process.env.API_URL` might or
        // might not get resolved on `next build` if it is used in
        // server-side functions, ie. getServerSideProps().
        // Because Lambda@Edge does not support environment variables, we will
        // use the trick of replacing "{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}" with
        // a JSON encoded string of all environment key-value pairs. This string
        // will then get decoded at run time.
        const lambdaEnvs = {};
        Object.entries(this.props.environment || {}).forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
            lambdaEnvs[key] = value;
        });
        replaceValues.push({
            files: "**/*.js",
            search: '"{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}"',
            replace: JSON.stringify(lambdaEnvs),
        });
        return replaceValues;
    }
    registerSiteEnvironment() {
        const environmentOutputs = {};
        for (const [key, value] of Object.entries(this.props.environment || {})) {
            const outputId = `SstSiteEnv_${key}`;
            const output = new cdk.CfnOutput(this, outputId, { value });
            environmentOutputs[key] = cdk.Stack.of(this).getLogicalId(output);
        }
        const root = this.node.root;
        root.registerSiteEnvironment({
            id: this.node.id,
            path: this.props.path,
            stack: cdk.Stack.of(this).node.id,
            environmentOutputs,
        });
    }
}
exports.NextjsSite = NextjsSite;
NextjsSite.staticCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: cdk.Duration.days(30),
    maxTtl: cdk.Duration.days(30),
    minTtl: cdk.Duration.days(30),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Static Default Cache Policy",
};
NextjsSite.imageCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.allowList("Accept"),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: cdk.Duration.days(1),
    maxTtl: cdk.Duration.days(365),
    minTtl: cdk.Duration.days(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Image Default Cache Policy",
};
NextjsSite.lambdaCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.all(),
    defaultTtl: cdk.Duration.seconds(0),
    maxTtl: cdk.Duration.days(365),
    minTtl: cdk.Duration.seconds(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Lambda Default Cache Policy",
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzU2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNTaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0RBQTBCO0FBQzFCLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0IsOERBQWdDO0FBRWhDLDJDQUF1QztBQUN2QyxpREFBbUM7QUFDbkMsdURBQXlDO0FBQ3pDLHlEQUEyQztBQUMzQyx5REFBMkM7QUFDM0MsMkRBQTZDO0FBQzdDLCtEQUFpRDtBQUNqRCxpRUFBbUQ7QUFDbkQsb0VBQXNEO0FBQ3RELHVFQUF5RDtBQUN6RCx3RUFBMEQ7QUFDMUQseUVBQThEO0FBQzlELDRFQUE4RDtBQUM5RCxnRkFBa0U7QUFDbEUsa0ZBQW9FO0FBQ3BFLHlGQUEyRTtBQUkzRSwyQ0FBMkQ7QUFDM0QseUNBT29CO0FBQ3BCLGtEQUF5RTtBQUN6RSw0Q0FBZ0Q7QUFDaEQscUZBQXVFO0FBOEJ2RSxNQUFhLFVBQVcsU0FBUSxzQkFBUztJQXNEdkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsYUFBYTtZQUNoQixDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBQzlELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDL0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNyQyxDQUFDLENBQUMsNkRBQTZEO2dCQUM3RCwrREFBK0Q7Z0JBQy9ELEtBQUssQ0FBQyx5QkFBeUIsSUFBSSxHQUFHO1lBQ3hDLENB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aGFsa1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgc3Bhd24gZnJvbSBcImNyb3NzLXNwYXduXCI7XG5cbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBzMyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXMzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIHNxcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNxc1wiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxvZ3NcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCAqIGFzIHMzQXNzZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczMtYXNzZXRzXCI7XG5pbXBvcnQgKiBhcyBjbG91ZGZyb250IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2xvdWRmcm9udFwiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgeyBBd3NDbGlMYXllciB9IGZyb20gXCJhd3MtY2RrLWxpYi9sYW1iZGEtbGF5ZXItYXdzY2xpXCI7XG5pbXBvcnQgKiBhcyBvcmlnaW5zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2xvdWRmcm9udC1vcmlnaW5zXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzVGFyZ2V0cyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTMtdGFyZ2V0c1wiO1xuaW1wb3J0ICogYXMgcm91dGU1M1BhdHRlcm5zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1My1wYXR0ZXJuc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhRXZlbnRTb3VyY2VzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB0eXBlIHsgUm91dGVzTWFuaWZlc3QgfSBmcm9tIFwiQHNscy1uZXh0L2xhbWJkYS1hdC1lZGdlXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHtcbiAgQmFzZVNpdGVEb21haW5Qcm9wcyxcbiAgQmFzZVNpdGVSZXBsYWNlUHJvcHMsXG4gIEJhc2VTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHMsXG4gIEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyxcbiAgZ2V0QnVpbGRDbWRFbnZpcm9ubWVudCxcbiAgYnVpbGRFcnJvclJlc3BvbnNlc0ZvclJlZGlyZWN0VG9JbmRleCxcbn0gZnJvbSBcIi4vQmFzZVNpdGVcIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zLCBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgZ2V0SGFuZGxlckhhc2ggfSBmcm9tIFwiLi91dGlsL2J1aWxkZXJcIjtcbmltcG9ydCAqIGFzIGNyb3NzUmVnaW9uSGVscGVyIGZyb20gXCIuL25leHRqcy1zaXRlL2Nyb3NzLXJlZ2lvbi1oZWxwZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNTaXRlUHJvcHMge1xuICBwYXRoOiBzdHJpbmc7XG4gIHMzQnVja2V0PzogczMuQnVja2V0UHJvcHM7XG4gIHNxc1JlZ2VuZXJhdGlvblF1ZXVlPzogc3FzLlF1ZXVlUHJvcHM7XG4gIGN1c3RvbURvbWFpbj86IHN0cmluZyB8IE5leHRqc1NpdGVEb21haW5Qcm9wcztcbiAgY2ZDYWNoZVBvbGljaWVzPzogTmV4dGpzU2l0ZUNhY2hlUG9saWN5UHJvcHM7XG4gIGNmRGlzdHJpYnV0aW9uPzogTmV4dGpzU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzO1xuICBlbnZpcm9ubWVudD86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gIGRlZmF1bHRGdW5jdGlvblByb3BzPzogTmV4dGpzU2l0ZUZ1bmN0aW9uUHJvcHM7XG4gIGRpc2FibGVQbGFjZWhvbGRlcj86IGJvb2xlYW47XG4gIHdhaXRGb3JJbnZhbGlkYXRpb24/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc1NpdGVGdW5jdGlvblByb3BzIHtcbiAgdGltZW91dD86IG51bWJlcjtcbiAgbWVtb3J5U2l6ZT86IG51bWJlcjtcbiAgcGVybWlzc2lvbnM/OiBQZXJtaXNzaW9ucztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNTaXRlQ2FjaGVQb2xpY3lQcm9wcyB7XG4gIHN0YXRpY0NhY2hlUG9saWN5PzogY2xvdWRmcm9udC5JQ2FjaGVQb2xpY3k7XG4gIGltYWdlQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbiAgbGFtYmRhQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbn1cblxuZXhwb3J0IHR5cGUgTmV4dGpzU2l0ZURvbWFpblByb3BzID0gQmFzZVNpdGVEb21haW5Qcm9wcztcbmV4cG9ydCB0eXBlIE5leHRqc1NpdGVDZGtEaXN0cmlidXRpb25Qcm9wcyA9IEJhc2VTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHM7XG5cbmV4cG9ydCBjbGFzcyBOZXh0anNTaXRlIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHN0YXRpYyBzdGF0aWNDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3Iubm9uZSgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlSGVhZGVyQmVoYXZpb3Iubm9uZSgpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3Iubm9uZSgpLFxuICAgIGRlZmF1bHRUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBtYXhUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBtaW5UdGw6IGNkay5EdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0Jyb3RsaTogdHJ1ZSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0d6aXA6IHRydWUsXG4gICAgY29tbWVudDogXCJTU1QgTmV4dGpzU2l0ZSBTdGF0aWMgRGVmYXVsdCBDYWNoZSBQb2xpY3lcIixcbiAgfTtcblxuICBwdWJsaWMgc3RhdGljIGltYWdlQ2FjaGVQb2xpY3lQcm9wczogY2xvdWRmcm9udC5DYWNoZVBvbGljeVByb3BzID0ge1xuICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlSGVhZGVyQmVoYXZpb3IuYWxsb3dMaXN0KFwiQWNjZXB0XCIpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3Iubm9uZSgpLFxuICAgIGRlZmF1bHRUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDEpLFxuICAgIG1heFR0bDogY2RrLkR1cmF0aW9uLmRheXMoMzY1KSxcbiAgICBtaW5UdGw6IGNkay5EdXJhdGlvbi5kYXlzKDApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiBcIlNTVCBOZXh0anNTaXRlIEltYWdlIERlZmF1bHQgQ2FjaGUgUG9saWN5XCIsXG4gIH07XG5cbiAgcHVibGljIHN0YXRpYyBsYW1iZGFDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5ub25lKCksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5hbGwoKSxcbiAgICBkZWZhdWx0VHRsOiBjZGsuRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICBtYXhUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDM2NSksXG4gICAgbWluVHRsOiBjZGsuRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0Jyb3RsaTogdHJ1ZSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0d6aXA6IHRydWUsXG4gICAgY29tbWVudDogXCJTU1QgTmV4dGpzU2l0ZSBMYW1iZGEgRGVmYXVsdCBDYWNoZSBQb2xpY3lcIixcbiAgfTtcblxuICBwdWJsaWMgcmVhZG9ubHkgczNCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgcHVibGljIHJlYWRvbmx5IHNxc1JlZ2VuZXJhdGlvblF1ZXVlOiBzcXMuUXVldWU7XG4gIHB1YmxpYyByZWFkb25seSBjZkRpc3RyaWJ1dGlvbjogY2xvdWRmcm9udC5EaXN0cmlidXRpb247XG4gIHB1YmxpYyByZWFkb25seSBob3N0ZWRab25lPzogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgcHVibGljIHJlYWRvbmx5IGFjbUNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogTmV4dGpzU2l0ZVByb3BzO1xuICBwcml2YXRlIHJlYWRvbmx5IGlzUGxhY2Vob2xkZXI6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZG9ubHkgYnVpbGRPdXREaXI6IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXNzZXRzOiBzM0Fzc2V0cy5Bc3NldFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IGF3c0NsaUxheWVyOiBBd3NDbGlMYXllcjtcbiAgcHJpdmF0ZSByZWFkb25seSByb3V0ZXNNYW5pZmVzdDogUm91dGVzTWFuaWZlc3QgfCBudWxsO1xuICBwcml2YXRlIHJlYWRvbmx5IGVkZ2VMYW1iZGFSb2xlOiBpYW0uUm9sZTtcbiAgcHJpdmF0ZSByZWFkb25seSBtYWluRnVuY3Rpb25WZXJzaW9uOiBsYW1iZGEuSVZlcnNpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgYXBpRnVuY3Rpb25WZXJzaW9uOiBsYW1iZGEuSVZlcnNpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgaW1hZ2VGdW5jdGlvblZlcnNpb246IGxhbWJkYS5JVmVyc2lvbjtcbiAgcHJpdmF0ZSByZWFkb25seSByZWdlbmVyYXRpb25GdW5jdGlvbjogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBOZXh0anNTaXRlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgLy8gTG9jYWwgZGV2ZWxvcG1lbnQgb3Igc2tpcCBidWlsZCA9PiBzdHViIGFzc2V0XG4gICAgdGhpcy5pc1BsYWNlaG9sZGVyID1cbiAgICAgIChyb290LmxvY2FsIHx8IHJvb3Quc2tpcEJ1aWxkKSAmJiAhcHJvcHMuZGlzYWJsZVBsYWNlaG9sZGVyO1xuICAgIGNvbnN0IGJ1aWxkRGlyID0gcm9vdC5idWlsZERpcjtcbiAgICBjb25zdCBmaWxlU2l6ZUxpbWl0ID0gcm9vdC5pc0plc3RUZXN0KClcbiAgICAgID8gLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuICAgICAgICAvLyBAdHMtaWdub3JlOiBcImplc3RGaWxlU2l6ZUxpbWl0T3ZlcnJpZGVcIiBub3QgZXhwb3NlZCBpbiBwcm9wc1xuICAgICAgICBwcm9wcy5qZXN0RmlsZVNpemVMaW1pdE92ZXJyaWRlIHx8IDIwMFxuICAgICAgOiAyMDA7XG5cbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG4gICAgdGhpcy5hd3NDbGlMYXllciA9IG5ldyBBd3NDbGlMYXllcih0aGlzLCBcIkF3c0NsaUxheWVyXCIpO1xuICAgIHRoaXMucmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoKTtcblxuICAgIC8vIEJ1aWxkIGFwcFxuICAgIGlmICh0aGlzLmlzUGxhY2Vob2xkZXIpIHtcbiAgICAgIHRoaXMuYnVpbGRPdXREaXIgPSBudWxsO1xuICAgICAgdGhpcy5hc3NldHMgPSB0aGlzLnppcEFwcFN0dWJBc3NldHMoKTtcbiAgICAgIHRoaXMucm91dGVzTWFuaWZlc3QgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1aWxkT3V0RGlyID0gcm9vdC5pc0plc3RUZXN0KClcbiAgICAgICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZTogXCJqZXN0QnVpbGRPdXRwdXRQYXRoXCIgbm90IGV4cG9zZWQgaW4gcHJvcHNcbiAgICAgICAgICBwcm9wcy5qZXN0QnVpbGRPdXRwdXRQYXRoIHx8IHRoaXMuYnVpbGRBcHAoKVxuICAgICAgICA6IHRoaXMuYnVpbGRBcHAoKTtcbiAgICAgIHRoaXMuYXNzZXRzID0gdGhpcy56aXBBcHBBc3NldHMoZmlsZVNpemVMaW1pdCwgYnVpbGREaXIpO1xuICAgICAgdGhpcy5yb3V0ZXNNYW5pZmVzdCA9IHRoaXMucmVhZFJvdXRlc01hbmlmZXN0KCk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEJ1Y2tldFxuICAgIHRoaXMuczNCdWNrZXQgPSB0aGlzLmNyZWF0ZVMzQnVja2V0KCk7XG5cbiAgICAvLyBIYW5kbGUgSW5jcmVtZW50YWwgU3RhdGljIFJlZ2VuZXJhdGlvblxuICAgIHRoaXMuc3FzUmVnZW5lcmF0aW9uUXVldWUgPSB0aGlzLmNyZWF0ZVJlZ2VuZXJhdGlvblF1ZXVlKCk7XG4gICAgdGhpcy5yZWdlbmVyYXRpb25GdW5jdGlvbiA9IHRoaXMuY3JlYXRlUmVnZW5lcmF0aW9uRnVuY3Rpb24oKTtcblxuICAgIC8vIENyZWF0ZSBMYW1iZGFARWRnZSBmdW5jdGlvbnMgKGFsd2F5cyBjcmVhdGVkIGluIHVzLWVhc3QtMSlcbiAgICB0aGlzLmVkZ2VMYW1iZGFSb2xlID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb25Sb2xlKCk7XG4gICAgdGhpcy5tYWluRnVuY3Rpb25WZXJzaW9uID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb24oXG4gICAgICBcIk1haW5cIixcbiAgICAgIFwiZGVmYXVsdC1sYW1iZGFcIlxuICAgICk7XG4gICAgdGhpcy5hcGlGdW5jdGlvblZlcnNpb24gPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvbihcIkFwaVwiLCBcImFwaS1sYW1iZGFcIik7XG4gICAgdGhpcy5pbWFnZUZ1bmN0aW9uVmVyc2lvbiA9IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uKFxuICAgICAgXCJJbWFnZVwiLFxuICAgICAgXCJpbWFnZS1sYW1iZGFcIlxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgQ3VzdG9tIERvbWFpblxuICAgIHRoaXMudmFsaWRhdGVDdXN0b21Eb21haW5TZXR0aW5ncygpO1xuICAgIHRoaXMuaG9zdGVkWm9uZSA9IHRoaXMubG9va3VwSG9zdGVkWm9uZSgpO1xuICAgIHRoaXMuYWNtQ2VydGlmaWNhdGUgPSB0aGlzLmNyZWF0ZUNlcnRpZmljYXRlKCk7XG5cbiAgICAvLyBDcmVhdGUgUzMgRGVwbG95bWVudFxuICAgIGNvbnN0IHMzZGVwbG95Q1IgPSB0aGlzLmNyZWF0ZVMzRGVwbG95bWVudCgpO1xuXG4gICAgLy8gQ3JlYXRlIENsb3VkRnJvbnRcbiAgICB0aGlzLmNmRGlzdHJpYnV0aW9uID0gdGhpcy5jcmVhdGVDbG91ZEZyb250RGlzdHJpYnV0aW9uKCk7XG4gICAgdGhpcy5jZkRpc3RyaWJ1dGlvbi5ub2RlLmFkZERlcGVuZGVuY3koczNkZXBsb3lDUik7XG5cbiAgICAvLyBJbnZhbGlkYXRlIENsb3VkRnJvbnRcbiAgICBjb25zdCBpbnZhbGlkYXRpb25DUiA9IHRoaXMuY3JlYXRlQ2xvdWRGcm9udEludmFsaWRhdGlvbigpO1xuICAgIGludmFsaWRhdGlvbkNSLm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzLmNmRGlzdHJpYnV0aW9uKTtcblxuICAgIC8vIENvbm5lY3QgQ3VzdG9tIERvbWFpbiB0byBDbG91ZEZyb250IERpc3RyaWJ1dGlvblxuICAgIHRoaXMuY3JlYXRlUm91dGU1M1JlY29yZHMoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBodHRwczovLyR7dGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25Eb21haW5OYW1lfWA7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGN1c3RvbURvbWFpblVybCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbn1gO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYGh0dHBzOi8vJHtjdXN0b21Eb21haW4uZG9tYWluTmFtZX1gO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgYnVja2V0QXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuczNCdWNrZXQuYnVja2V0QXJuO1xuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuczNCdWNrZXQuYnVja2V0TmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGlzdHJpYnV0aW9uSWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25JZDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGlzdHJpYnV0aW9uRG9tYWluKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2ZEaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uRG9tYWluTmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSh0aGlzLmVkZ2VMYW1iZGFSb2xlLCBwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiTmV4dFNpdGVcIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZGlzdHJpYnV0aW9uSWQ6IHRoaXMuY2ZEaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uSWQsXG4gICAgICAgIGN1c3RvbURvbWFpblVybDogdGhpcy5jdXN0b21Eb21haW5VcmwsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHppcEFwcEFzc2V0cyhcbiAgICBmaWxlU2l6ZUxpbWl0OiBudW1iZXIsXG4gICAgYnVpbGREaXI6IHN0cmluZ1xuICApOiBzM0Fzc2V0cy5Bc3NldFtdIHtcbiAgICAvLyB2YWxpZGF0ZSBidWlsZE91dHB1dCBleGlzdHNcbiAgICBjb25zdCBzaXRlT3V0cHV0UGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciEsIFwiYXNzZXRzXCIpKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2l0ZU91dHB1dFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBObyBidWlsZCBvdXRwdXQgZm91bmQgYXQgXCIke3NpdGVPdXRwdXRQYXRofVwiIGZvciB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBOZXh0anNTaXRlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY3JlYXRlIHppcCBmaWxlc1xuICAgIGNvbnN0IHNjcmlwdCA9IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2FyY2hpdmVyLmpzXCIpO1xuICAgIGNvbnN0IHppcFBhdGggPSBwYXRoLnJlc29sdmUoXG4gICAgICBwYXRoLmpvaW4oYnVpbGREaXIsIGBOZXh0anNTaXRlLSR7dGhpcy5ub2RlLmlkfS0ke3RoaXMubm9kZS5hZGRyfWApXG4gICAgKTtcbiAgICAvLyBjbGVhciB6aXAgcGF0aCB0byBlbnN1cmUgbm8gcGFydFguemlwIHJlbWFpbiBmcm9tIHByZXZpb3VzIGJ1aWxkXG4gICAgZnMucmVtb3ZlU3luYyh6aXBQYXRoKTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IHNwYXduLnN5bmMoXG4gICAgICBcIm5vZGVcIixcbiAgICAgIFtzY3JpcHQsIHNpdGVPdXRwdXRQYXRoLCB6aXBQYXRoLCBgJHtmaWxlU2l6ZUxpbWl0fWBdLFxuICAgICAge1xuICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICB9XG4gICAgKTtcbiAgICBpZiAocmVzdWx0LnN0YXR1cyAhPT0gMCkge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYFRoZXJlIHdhcyBhIHByb2JsZW0gZ2VuZXJhdGluZyB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBOZXh0anNTaXRlIHBhY2thZ2UuYFxuICAgICAgKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgYXNzZXRzXG4gICAgY29uc3QgYXNzZXRzID0gW107XG4gICAgZm9yIChsZXQgcGFydElkID0gMDsgOyBwYXJ0SWQrKykge1xuICAgICAgY29uc3QgemlwRmlsZVBhdGggPSBwYXRoLmpvaW4oemlwUGF0aCwgYHBhcnQke3BhcnRJZH0uemlwYCk7XG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoemlwRmlsZVBhdGgpKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBhc3NldHMucHVzaChcbiAgICAgICAgbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIGBBc3NldCR7cGFydElkfWAsIHtcbiAgICAgICAgICBwYXRoOiB6aXBGaWxlUGF0aCxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBhc3NldHM7XG4gIH1cblxuICBwcml2YXRlIHppcEFwcFN0dWJBc3NldHMoKTogczNBc3NldHMuQXNzZXRbXSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIG5ldyBzM0Fzc2V0cy5Bc3NldCh0aGlzLCBcIkFzc2V0XCIsIHtcbiAgICAgICAgcGF0aDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvTmV4dGpzU2l0ZS9zaXRlLXN0dWJcIiksXG4gICAgICB9KSxcbiAgICBdO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb24oXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGhhbmRsZXJQYXRoOiBzdHJpbmdcbiAgKTogbGFtYmRhLklWZXJzaW9uIHtcbiAgICAvLyBVc2UgcmVhbCBjb2RlIGlmOlxuICAgIC8vIC0gTmV4dC5qcyBhcHAgd2FzIGJ1aWxkOyBBTkRcbiAgICAvLyAtIHRoZSBMYW1iZGEgY29kZSBkaXJlY3RvcnkgaXMgbm90IGVtcHR5XG4gICAgY29uc3QgaGFzUmVhbENvZGUgPVxuICAgICAgdHlwZW9mIHRoaXMuYnVpbGRPdXREaXIgPT09IFwic3RyaW5nXCIgJiZcbiAgICAgIGZzLnBhdGhFeGlzdHNTeW5jKHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBoYW5kbGVyUGF0aCwgXCJpbmRleC5qc1wiKSk7XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb24gYXNzZXRcbiAgICBjb25zdCBhc3NldFBhdGggPVxuICAgICAgaGFzUmVhbENvZGUgJiYgdGhpcy5idWlsZE91dERpclxuICAgICAgICA/IHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBoYW5kbGVyUGF0aClcbiAgICAgICAgOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL2VkZ2UtbGFtYmRhLXN0dWJcIik7XG4gICAgY29uc3QgYXNzZXQgPSBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYCR7bmFtZX1GdW5jdGlvbkFzc2V0YCwge1xuICAgICAgcGF0aDogYXNzZXRQYXRoLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uIGJhc2VkIG9uIHJlZ2lvblxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcmV0dXJuIHJvb3QucmVnaW9uID09PSBcInVzLWVhc3QtMVwiXG4gICAgICA/IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uSW5VRTEobmFtZSwgYXNzZXRQYXRoLCBhc3NldCwgaGFzUmVhbENvZGUpXG4gICAgICA6IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uSW5Ob25VRTEobmFtZSwgYXNzZXRQYXRoLCBhc3NldCwgaGFzUmVhbENvZGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb25JblVFMShcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXNzZXRQYXRoOiBzdHJpbmcsXG4gICAgYXNzZXQ6IHMzQXNzZXRzLkFzc2V0LFxuICAgIGhhc1JlYWxDb2RlOiBib29sZWFuXG4gICk6IGxhbWJkYS5JVmVyc2lvbiB7XG4gICAgY29uc3QgeyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogZm5Qcm9wcyB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBgJHtuYW1lfUZ1bmN0aW9uYCwge1xuICAgICAgZGVzY3JpcHRpb246IGAke25hbWV9IGhhbmRsZXIgZm9yIE5leHQuanNgLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC13cmFwcGVyLmhhbmRsZXJcIixcbiAgICAgIGN1cnJlbnRWZXJzaW9uT3B0aW9uczoge1xuICAgICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgfSxcbiAgICAgIGxvZ1JldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLlRIUkVFX0RBWVMsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoKSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgbWVtb3J5U2l6ZTogZm5Qcm9wcz8ubWVtb3J5U2l6ZSB8fCA1MTIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyhmblByb3BzPy50aW1lb3V0IHx8IDEwKSxcbiAgICAgIHJvbGU6IHRoaXMuZWRnZUxhbWJkYVJvbGUsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgYWxpYXNcbiAgICBmbi5jdXJyZW50VmVyc2lvbi5hZGRBbGlhcyhcImxpdmVcIik7XG5cbiAgICAvLyBEZXBsb3kgYWZ0ZXIgdGhlIGNvZGUgaXMgdXBkYXRlZFxuICAgIGlmIChoYXNSZWFsQ29kZSkge1xuICAgICAgY29uc3QgdXBkYXRlckNSID0gdGhpcy5jcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIobmFtZSwgYXNzZXQpO1xuICAgICAgZm4ubm9kZS5hZGREZXBlbmRlbmN5KHVwZGF0ZXJDUik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZuLmN1cnJlbnRWZXJzaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb25Jbk5vblVFMShcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXNzZXRQYXRoOiBzdHJpbmcsXG4gICAgYXNzZXQ6IHMzQXNzZXRzLkFzc2V0LFxuICAgIGhhc1JlYWxDb2RlOiBib29sZWFuXG4gICk6IGxhbWJkYS5JVmVyc2lvbiB7XG4gICAgY29uc3QgeyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogZm5Qcm9wcyB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIElmIGFwcCByZWdpb24gaXMgTk9UIHVzLWVhc3QtMSwgY3JlYXRlIGEgRnVuY3Rpb24gaW4gdXMtZWFzdC0xXG4gICAgLy8gdXNpbmcgYSBDdXN0b20gUmVzb3VyY2VcblxuICAgIC8vIENyZWF0ZSBhIFMzIGJ1Y2tldCBpbiB1cy1lYXN0LTEgdG8gc3RvcmUgTGFtYmRhIGNvZGUuIENyZWF0ZVxuICAgIC8vIDEgYnVja2V0IGZvciBhbGwgRWRnZSBmdW5jdGlvbnMuXG4gICAgY29uc3QgYnVja2V0Q1IgPSBjcm9zc1JlZ2lvbkhlbHBlci5nZXRPckNyZWF0ZUJ1Y2tldCh0aGlzKTtcbiAgICBjb25zdCBidWNrZXROYW1lID0gYnVja2V0Q1IuZ2V0QXR0U3RyaW5nKFwiQnVja2V0TmFtZVwiKTtcblxuICAgIC8vIENyZWF0ZSBhIExhbWJkYSBmdW5jdGlvbiBpbiB1cy1lYXN0LTFcbiAgICBjb25zdCBmdW5jdGlvbkNSID0gY3Jvc3NSZWdpb25IZWxwZXIuY3JlYXRlRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgbmFtZSxcbiAgICAgIHRoaXMuZWRnZUxhbWJkYVJvbGUsXG4gICAgICBidWNrZXROYW1lLFxuICAgICAge1xuICAgICAgICBEZXNjcmlwdGlvbjogYGhhbmRsZXIgZm9yIE5leHQuanNgLFxuICAgICAgICBIYW5kbGVyOiBcImluZGV4LXdyYXBwZXIuaGFuZGxlclwiLFxuICAgICAgICBDb2RlOiB7XG4gICAgICAgICAgUzNCdWNrZXQ6IGFzc2V0LnMzQnVja2V0TmFtZSxcbiAgICAgICAgICBTM0tleTogYXNzZXQuczNPYmplY3RLZXksXG4gICAgICAgIH0sXG4gICAgICAgIFJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLm5hbWUsXG4gICAgICAgIE1lbW9yeVNpemU6IGZuUHJvcHM/Lm1lbW9yeVNpemUgfHwgNTEyLFxuICAgICAgICBUaW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyhmblByb3BzPy50aW1lb3V0IHx8IDEwKS50b1NlY29uZHMoKSxcbiAgICAgICAgUm9sZTogdGhpcy5lZGdlTGFtYmRhUm9sZS5yb2xlQXJuLFxuICAgICAgfVxuICAgICk7XG4gICAgY29uc3QgZnVuY3Rpb25Bcm4gPSBmdW5jdGlvbkNSLmdldEF0dFN0cmluZyhcIkZ1bmN0aW9uQXJuXCIpO1xuXG4gICAgLy8gQ3JlYXRlIGEgTGFtYmRhIGZ1bmN0aW9uIHZlcnNpb24gaW4gdXMtZWFzdC0xXG4gICAgY29uc3QgdmVyc2lvbkNSID0gY3Jvc3NSZWdpb25IZWxwZXIuY3JlYXRlVmVyc2lvbih0aGlzLCBuYW1lLCBmdW5jdGlvbkFybik7XG4gICAgY29uc3QgdmVyc2lvbklkID0gdmVyc2lvbkNSLmdldEF0dFN0cmluZyhcIlZlcnNpb25cIik7XG4gICAgY3Jvc3NSZWdpb25IZWxwZXIudXBkYXRlVmVyc2lvbkxvZ2ljYWxJZChmdW5jdGlvbkNSLCB2ZXJzaW9uQ1IpO1xuXG4gICAgLy8gRGVwbG95IGFmdGVyIHRoZSBjb2RlIGlzIHVwZGF0ZWRcbiAgICBpZiAoaGFzUmVhbENvZGUpIHtcbiAgICAgIGNvbnN0IHVwZGF0ZXJDUiA9IHRoaXMuY3JlYXRlTGFtYmRhQ29kZVJlcGxhY2VyKG5hbWUsIGFzc2V0KTtcbiAgICAgIGZ1bmN0aW9uQ1Iubm9kZS5hZGREZXBlbmRlbmN5KHVwZGF0ZXJDUik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxhbWJkYS5WZXJzaW9uLmZyb21WZXJzaW9uQXJuKFxuICAgICAgdGhpcyxcbiAgICAgIGAke25hbWV9RnVuY3Rpb25WZXJzaW9uYCxcbiAgICAgIGAke2Z1bmN0aW9uQXJufToke3ZlcnNpb25JZH1gXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRnZUZ1bmN0aW9uUm9sZSgpOiBpYW0uUm9sZSB7XG4gICAgY29uc3QgeyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogZm5Qcm9wcyB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvbiByb2xlXG4gICAgY29uc3Qgcm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBgRWRnZUxhbWJkYVJvbGVgLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uQ29tcG9zaXRlUHJpbmNpcGFsKFxuICAgICAgICBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJsYW1iZGEuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgICAgbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiZWRnZWxhbWJkYS5hbWF6b25hd3MuY29tXCIpXG4gICAgICApLFxuICAgICAgbWFuYWdlZFBvbGljaWVzOiBbXG4gICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21NYW5hZ2VkUG9saWN5QXJuKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgXCJFZGdlTGFtYmRhUG9saWN5XCIsXG4gICAgICAgICAgXCJhcm46YXdzOmlhbTo6YXdzOnBvbGljeS9zZXJ2aWNlLXJvbGUvQVdTTGFtYmRhQmFzaWNFeGVjdXRpb25Sb2xlXCJcbiAgICAgICAgKSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICAvLyBBdHRhY2ggcGVybWlzc2lvblxuICAgIHRoaXMuczNCdWNrZXQuZ3JhbnRSZWFkV3JpdGUocm9sZSk7XG4gICAgdGhpcy5zcXNSZWdlbmVyYXRpb25RdWV1ZS5ncmFudFNlbmRNZXNzYWdlcyhyb2xlKTtcbiAgICB0aGlzLnJlZ2VuZXJhdGlvbkZ1bmN0aW9uLmdyYW50SW52b2tlKHJvbGUpO1xuICAgIGlmIChmblByb3BzPy5wZXJtaXNzaW9ucykge1xuICAgICAgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUocm9sZSwgZm5Qcm9wcy5wZXJtaXNzaW9ucyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJvbGU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVJlZ2VuZXJhdGlvblF1ZXVlKCk6IHNxcy5RdWV1ZSB7XG4gICAgY29uc3QgeyBzcXNSZWdlbmVyYXRpb25RdWV1ZSB9ID0gdGhpcy5wcm9wcztcblxuICAgIHJldHVybiBuZXcgc3FzLlF1ZXVlKHRoaXMsIFwiUmVnZW5lcmF0aW9uUXVldWVcIiwge1xuICAgICAgLi4uKHNxc1JlZ2VuZXJhdGlvblF1ZXVlIHx8IHt9KSxcbiAgICAgIC8vIFdlIGNhbGwgdGhlIHF1ZXVlIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGJ1Y2tldCBzbyB0aGF0IHdlIGNhbiBlYXNpbHlcbiAgICAgIC8vIHJlZmVyZW5jZSBpdCBmcm9tIHdpdGhpbiB0aGUgbGFtYmRhQGVkZ2UsIGdpdmVuIHdlIGNhbid0IHVzZSBlbnYgdmFyc1xuICAgICAgLy8gaW4gYSBsYW1iZGFAZWRnZVxuICAgICAgcXVldWVOYW1lOiBgJHt0aGlzLnMzQnVja2V0LmJ1Y2tldE5hbWV9LmZpZm9gLFxuICAgICAgZmlmbzogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVJlZ2VuZXJhdGlvbkZ1bmN0aW9uKCk6IGxhbWJkYS5GdW5jdGlvbiB7XG4gICAgLy8gVXNlIHJlYWwgY29kZSBpZjpcbiAgICAvLyAtIE5leHQuanMgYXBwIHdhcyBidWlsZDsgQU5EXG4gICAgLy8gLSB0aGUgTGFtYmRhIGNvZGUgZGlyZWN0b3J5IGlzIG5vdCBlbXB0eVxuICAgIGxldCBjb2RlO1xuICAgIGxldCB1cGRhdGVyQ1I7XG4gICAgaWYgKFxuICAgICAgdGhpcy5idWlsZE91dERpciAmJlxuICAgICAgZnMucGF0aEV4aXN0c1N5bmMoXG4gICAgICAgIHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBcInJlZ2VuZXJhdGlvbi1sYW1iZGFcIiwgXCJpbmRleC5qc1wiKVxuICAgICAgKVxuICAgICkge1xuICAgICAgY29uc3QgYXNzZXQgPSBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYFJlZ2VuZXJhdGlvbkZ1bmN0aW9uQXNzZXRgLCB7XG4gICAgICAgIHBhdGg6IHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBcInJlZ2VuZXJhdGlvbi1sYW1iZGFcIiksXG4gICAgICB9KTtcbiAgICAgIGNvZGUgPSBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBcInJlZ2VuZXJhdGlvbi1sYW1iZGFcIilcbiAgICAgICk7XG4gICAgICB1cGRhdGVyQ1IgPSB0aGlzLmNyZWF0ZUxhbWJkYUNvZGVSZXBsYWNlcihcIlJlZ2VuZXJhdGlvblwiLCBhc3NldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGUgPSBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKFwiICBcIik7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uXG4gICAgY29uc3QgeyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogZm5Qcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBmbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJSZWdlbmVyYXRpb25GdW5jdGlvblwiLCB7XG4gICAgICBoYW5kbGVyOiBcImluZGV4LXdyYXBwZXIuaGFuZGxlclwiLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gsXG4gICAgICBtZW1vcnlTaXplOiBmblByb3BzPy5tZW1vcnlTaXplIHx8IDEwMjQsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyhmblByb3BzPy50aW1lb3V0IHx8IDMwKSxcbiAgICAgIGNvZGUsXG4gICAgfSk7XG5cbiAgICBmbi5hZGRFdmVudFNvdXJjZShcbiAgICAgIG5ldyBsYW1iZGFFdmVudFNvdXJjZXMuU3FzRXZlbnRTb3VyY2UodGhpcy5zcXNSZWdlbmVyYXRpb25RdWV1ZSlcbiAgICApO1xuXG4gICAgLy8gR3JhbnQgcGVybWlzc2lvbnNcbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKGZuKTtcblxuICAgIC8vIERlcGxveSBhZnRlciB0aGUgY29kZSBpcyB1cGRhdGVkXG4gICAgaWYgKHVwZGF0ZXJDUikge1xuICAgICAgZm4ubm9kZS5hZGREZXBlbmRlbmN5KHVwZGF0ZXJDUik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGFzc2V0OiBzM0Fzc2V0cy5Bc3NldFxuICApOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAgIC8vIE5vdGU6IFNvdXJjZSBjb2RlIGZvciB0aGUgTGFtYmRhIGZ1bmN0aW9ucyBoYXZlIFwie3sgRU5WX0tFWSB9fVwiIGluIHRoZW0uXG4gICAgLy8gICAgICAgVGhleSBuZWVkIHRvIGJlIHJlcGxhY2VkIHdpdGggcmVhbCB2YWx1ZXMgYmVmb3JlIHRoZSBMYW1iZGFcbiAgICAvLyAgICAgICBmdW5jdGlvbnMgZ2V0IGRlcGxveWVkLlxuXG4gICAgY29uc3QgcHJvdmlkZXJJZCA9IFwiTGFtYmRhQ29kZVJlcGxhY2VyUHJvdmlkZXJcIjtcbiAgICBjb25zdCByZXNJZCA9IGAke25hbWV9TGFtYmRhQ29kZVJlcGxhY2VyYDtcbiAgICBjb25zdCBzdGFjayA9IGNkay5TdGFjay5vZih0aGlzKTtcbiAgICBsZXQgcHJvdmlkZXIgPSBzdGFjay5ub2RlLnRyeUZpbmRDaGlsZChwcm92aWRlcklkKSBhcyBsYW1iZGEuRnVuY3Rpb247XG5cbiAgICAvLyBDcmVhdGUgcHJvdmlkZXIgaWYgbm90IGFscmVhZHkgY3JlYXRlZFxuICAgIGlmICghcHJvdmlkZXIpIHtcbiAgICAgIHByb3ZpZGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgcHJvdmlkZXJJZCwge1xuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvTmV4dGpzU2l0ZS9jdXN0b20tcmVzb3VyY2VcIilcbiAgICAgICAgKSxcbiAgICAgICAgbGF5ZXJzOiBbdGhpcy5hd3NDbGlMYXllcl0sXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzcsXG4gICAgICAgIGhhbmRsZXI6IFwibGFtYmRhLWNvZGUtdXBkYXRlci5oYW5kbGVyXCIsXG4gICAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEFsbG93IHByb3ZpZGVyIHRvIHBlcmZvcm0gc2VhcmNoL3JlcGxhY2Ugb24gdGhlIGFzc2V0XG4gICAgcHJvdmlkZXIucm9sZT8uYWRkVG9QcmluY2lwYWxQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wiczM6KlwiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbYGFybjphd3M6czM6Ojoke2Fzc2V0LnMzQnVja2V0TmFtZX0vJHthc3NldC5zM09iamVjdEtleX1gXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSBjdXN0b20gcmVzb3VyY2VcbiAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgcmVzSWQsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogcHJvdmlkZXIuZnVuY3Rpb25Bcm4sXG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RMYW1iZGFDb2RlVXBkYXRlclwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBTb3VyY2U6IHtcbiAgICAgICAgICBCdWNrZXROYW1lOiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgICAgT2JqZWN0S2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgICAgfSxcbiAgICAgICAgUmVwbGFjZVZhbHVlczogdGhpcy5nZXRMYW1iZGFDb250ZW50UmVwbGFjZVZhbHVlcygpLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiByZXNvdXJjZTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRBcHAoKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IHBhdGg6IHNpdGVQYXRoIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gdmFsaWRhdGUgc2l0ZSBwYXRoIGV4aXN0c1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhzaXRlUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIHBhdGggZm91bmQgYXQgXCIke3BhdGgucmVzb2x2ZShzaXRlUGF0aCl9XCIgZm9yIHRoZSBcIiR7XG4gICAgICAgICAgdGhpcy5ub2RlLmlkXG4gICAgICAgIH1cIiBOZXh0anNTaXRlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgY29tbWFuZFxuICAgIC8vIE5vdGU6IHByb2JhYmx5IGNvdWxkIHBhc3MgSlNPTiBzdHJpbmcgYWxzbywgYnV0IHRoaXMgZmVsdCBzYWZlci5cbiAgICBjb25zdCByb290ID0gdGhpcy5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHBhdGhIYXNoID0gZ2V0SGFuZGxlckhhc2goc2l0ZVBhdGgpO1xuICAgIGNvbnN0IGJ1aWxkT3V0cHV0ID0gcGF0aC5qb2luKHJvb3QuYnVpbGREaXIsIHBhdGhIYXNoKTtcbiAgICBjb25zdCBjb25maWdCdWZmZXIgPSBCdWZmZXIuZnJvbShcbiAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgY3dkOiBwYXRoLnJlc29sdmUoc2l0ZVBhdGgpLFxuICAgICAgICBhcmdzOiBbXCJidWlsZFwiXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIC8vIFJ1biBidWlsZFxuICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZXkoYEJ1aWxkaW5nIE5leHQuanMgc2l0ZSAke3NpdGVQYXRofWApKTtcbiAgICBjb25zdCByZXN1bHQgPSBzcGF3bi5zeW5jKFxuICAgICAgXCJub2RlXCIsXG4gICAgICBbXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL05leHRqc1NpdGUvYnVpbGQvYnVpbGQuanNcIiksXG4gICAgICAgIFwiLS1wYXRoXCIsXG4gICAgICAgIHBhdGgucmVzb2x2ZShzaXRlUGF0aCksXG4gICAgICAgIFwiLS1vdXRwdXRcIixcbiAgICAgICAgcGF0aC5yZXNvbHZlKGJ1aWxkT3V0cHV0KSxcbiAgICAgICAgXCItLWNvbmZpZ1wiLFxuICAgICAgICBjb25maWdCdWZmZXIudG9TdHJpbmcoXCJiYXNlNjRcIiksXG4gICAgICBdLFxuICAgICAge1xuICAgICAgICBjd2Q6IHNpdGVQYXRoLFxuICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICAgIGVudjoge1xuICAgICAgICAgIC4uLnByb2Nlc3MuZW52LFxuICAgICAgICAgIC4uLmdldEJ1aWxkQ21kRW52aXJvbm1lbnQodGhpcy5wcm9wcy5lbnZpcm9ubWVudCksXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgICBpZiAocmVzdWx0LnN0YXR1cyAhPT0gMCkge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYFRoZXJlIHdhcyBhIHByb2JsZW0gYnVpbGRpbmcgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgTmV4dGpzU2l0ZS5gXG4gICAgICApO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cblxuICAgIHJldHVybiBidWlsZE91dHB1dDtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUzNCdWNrZXQoKTogczMuQnVja2V0IHtcbiAgICBjb25zdCB7IHMzQnVja2V0IH0gPSB0aGlzLnByb3BzO1xuXG4gICAgcmV0dXJuIG5ldyBzMy5CdWNrZXQodGhpcywgXCJTM0J1Y2tldFwiLCB7XG4gICAgICBwdWJsaWNSZWFkQWNjZXNzOiB0cnVlLFxuICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgLi4uKHMzQnVja2V0IHx8IHt9KSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUzNEZXBsb3ltZW50KCk6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gICAgLy8gQ3JlYXRlIGEgTGFtYmRhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBkb2luZyB0aGUgdXBsb2FkaW5nXG4gICAgY29uc3QgdXBsb2FkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUzNVcGxvYWRlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtdXBsb2FkLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG4gICAgdGhpcy5zM0J1Y2tldC5ncmFudFJlYWRXcml0ZSh1cGxvYWRlcik7XG4gICAgdGhpcy5hc3NldHMuZm9yRWFjaCgoYXNzZXQpID0+IGFzc2V0LmdyYW50UmVhZCh1cGxvYWRlcikpO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBjdXN0b20gcmVzb3VyY2UgZnVuY3Rpb25cbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlMzSGFuZGxlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtaGFuZGxlci5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVVBMT0FERVJfRlVOQ1RJT05fTkFNRTogdXBsb2FkZXIuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKGhhbmRsZXIpO1xuICAgIHVwbG9hZGVyLmdyYW50SW52b2tlKGhhbmRsZXIpO1xuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIGNvbnN0IGZpbGVPcHRpb25zID0gW1xuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJwdWJsaWMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MzE1MzYwMDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJzdGF0aWMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MzE1MzYwMDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJzdGF0aWMtcGFnZXMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MCxzLW1heGFnZT0yNjc4NDAwLG11c3QtcmV2YWxpZGF0ZVwiLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgZXhjbHVkZTogXCIqXCIsXG4gICAgICAgIGluY2x1ZGU6IFwiX25leHQvZGF0YS8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0wLHMtbWF4YWdlPTI2Nzg0MDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJfbmV4dC9zdGF0aWMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MzE1MzYwMDAsaW1tdXRhYmxlXCIsXG4gICAgICB9LFxuICAgIF07XG4gICAgcmV0dXJuIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJTM0RlcGxveW1lbnRcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUQnVja2V0RGVwbG95bWVudFwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBTb3VyY2VzOiB0aGlzLmFzc2V0cy5tYXAoKGFzc2V0KSA9PiAoe1xuICAgICAgICAgIEJ1Y2tldE5hbWU6IGFzc2V0LnMzQnVja2V0TmFtZSxcbiAgICAgICAgICBPYmplY3RLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9KSksXG4gICAgICAgIERlc3RpbmF0aW9uQnVja2V0TmFtZTogdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBGaWxlT3B0aW9uczogKGZpbGVPcHRpb25zIHx8IFtdKS5tYXAoXG4gICAgICAgICAgKHsgZXhjbHVkZSwgaW5jbHVkZSwgY2FjaGVDb250cm9sIH0pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgIFwiLS1leGNsdWRlXCIsXG4gICAgICAgICAgICAgIGV4Y2x1ZGUsXG4gICAgICAgICAgICAgIFwiLS1pbmNsdWRlXCIsXG4gICAgICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgICAgIFwiLS1jYWNoZS1jb250cm9sXCIsXG4gICAgICAgICAgICAgIGNhY2hlQ29udHJvbCxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfVxuICAgICAgICApLFxuICAgICAgICBSZXBsYWNlVmFsdWVzOiB0aGlzLmdldFMzQ29udGVudFJlcGxhY2VWYWx1ZXMoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ2xvdWRGcm9udCBEaXN0cmlidXRpb25cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250RGlzdHJpYnV0aW9uKCk6IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uIHtcbiAgICBjb25zdCB7IGNmQ2FjaGVQb2xpY2llcywgY2ZEaXN0cmlidXRpb24sIGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBjZkRpc3RyaWJ1dGlvblByb3BzID0gY2ZEaXN0cmlidXRpb24gfHwge307XG5cbiAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmNlcnRpZmljYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmNlcnRpZmljYXRlXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIE5leHRqc1NpdGUgZG9tYWluIGNlcnRpZmljYXRlLmBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChjZkRpc3RyaWJ1dGlvblByb3BzLmRvbWFpbk5hbWVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmRvbWFpbk5hbWVzXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIE5leHRqc1NpdGUgZG9tYWluLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgZG9tYWluTmFtZXNcbiAgICBjb25zdCBkb21haW5OYW1lcyA9IFtdO1xuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICAvLyBubyBkb21haW5cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGRvbWFpbk5hbWVzLnB1c2goY3VzdG9tRG9tYWluKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9tYWluTmFtZXMucHVzaChjdXN0b21Eb21haW4uZG9tYWluTmFtZSk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgYmVoYXZpb3JcbiAgICBjb25zdCBvcmlnaW4gPSBuZXcgb3JpZ2lucy5TM09yaWdpbih0aGlzLnMzQnVja2V0KTtcbiAgICBjb25zdCB2aWV3ZXJQcm90b2NvbFBvbGljeSA9XG4gICAgICBjbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTO1xuXG4gICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlcikge1xuICAgICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCBcIkRpc3RyaWJ1dGlvblwiLCB7XG4gICAgICAgIGRlZmF1bHRSb290T2JqZWN0OiBcImluZGV4Lmh0bWxcIixcbiAgICAgICAgZXJyb3JSZXNwb25zZXM6IGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgoXCJpbmRleC5odG1sXCIpLFxuICAgICAgICBkb21haW5OYW1lcyxcbiAgICAgICAgY2VydGlmaWNhdGU6IHRoaXMuYWNtQ2VydGlmaWNhdGUsXG4gICAgICAgIGRlZmF1bHRCZWhhdmlvcjoge1xuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEJ1aWxkIEVkZ2UgZnVuY3Rpb25zXG4gICAgY29uc3QgZWRnZUxhbWJkYXM6IGNsb3VkZnJvbnQuRWRnZUxhbWJkYVtdID0gW1xuICAgICAge1xuICAgICAgICBpbmNsdWRlQm9keTogdHJ1ZSxcbiAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5tYWluRnVuY3Rpb25WZXJzaW9uLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFU1BPTlNFLFxuICAgICAgICBmdW5jdGlvblZlcnNpb246IHRoaXMubWFpbkZ1bmN0aW9uVmVyc2lvbixcbiAgICAgIH0sXG4gICAgXTtcblxuICAgIC8vIEJ1aWxkIGNhY2hlIHBvbGljeVxuICAgIGNvbnN0IHN0YXRpY0NhY2hlUG9saWN5ID1cbiAgICAgIGNmQ2FjaGVQb2xpY2llcz8uc3RhdGljQ2FjaGVQb2xpY3kgPz9cbiAgICAgIHRoaXMuY3JlYXRlQ2xvdWRGcm9udFN0YXRpY0NhY2hlUG9saWN5KCk7XG4gICAgY29uc3QgaW1hZ2VDYWNoZVBvbGljeSA9XG4gICAgICBjZkNhY2hlUG9saWNpZXM/LmltYWdlQ2FjaGVQb2xpY3kgPz9cbiAgICAgIHRoaXMuY3JlYXRlQ2xvdWRGcm9udEltYWdlQ2FjaGVQb2xpY3koKTtcbiAgICBjb25zdCBsYW1iZGFDYWNoZVBvbGljeSA9XG4gICAgICBjZkNhY2hlUG9saWNpZXM/LmxhbWJkYUNhY2hlUG9saWN5ID8/XG4gICAgICB0aGlzLmNyZWF0ZUNsb3VkRnJvbnRMYW1iZGFDYWNoZVBvbGljeSgpO1xuXG4gICAgLy8gQ3JlYXRlIERpc3RyaWJ1dGlvblxuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5EaXN0cmlidXRpb24odGhpcywgXCJEaXN0cmlidXRpb25cIiwge1xuICAgICAgLy8gdGhlc2UgdmFsdWVzIGNhbiBiZSBvdmVyd3JpdHRlbiBieSBjZkRpc3RyaWJ1dGlvblByb3BzXG4gICAgICBkZWZhdWx0Um9vdE9iamVjdDogXCJcIixcbiAgICAgIC8vIE92ZXJyaWRlIHByb3BzLlxuICAgICAgLi4uY2ZEaXN0cmlidXRpb25Qcm9wcyxcbiAgICAgIC8vIHRoZXNlIHZhbHVlcyBjYW4gTk9UIGJlIG92ZXJ3cml0dGVuIGJ5IGNmRGlzdHJpYnV0aW9uUHJvcHNcbiAgICAgIGRvbWFpbk5hbWVzLFxuICAgICAgY2VydGlmaWNhdGU6IHRoaXMuYWNtQ2VydGlmaWNhdGUsXG4gICAgICBkZWZhdWx0QmVoYXZpb3I6IHtcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgIG9yaWdpbixcbiAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICBjYWNoZVBvbGljeTogbGFtYmRhQ2FjaGVQb2xpY3ksXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmRlZmF1bHRCZWhhdmlvciB8fCB7fSksXG4gICAgICAgIC8vIGNvbmNhdGVuYXRlIGVkZ2VMYW1iZGFzXG4gICAgICAgIGVkZ2VMYW1iZGFzOiBbXG4gICAgICAgICAgLi4uZWRnZUxhbWJkYXMsXG4gICAgICAgICAgLi4uKGNmRGlzdHJpYnV0aW9uUHJvcHMuZGVmYXVsdEJlaGF2aW9yPy5lZGdlTGFtYmRhcyB8fCBbXSksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgYWRkaXRpb25hbEJlaGF2aW9yczoge1xuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0L2ltYWdlKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBpbWFnZUNhY2hlUG9saWN5LFxuICAgICAgICAgIG9yaWdpblJlcXVlc3RQb2xpY3k6IG5ldyBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RQb2xpY3koXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgXCJJbWFnZU9yaWdpblJlcXVlc3RcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcXVlcnlTdHJpbmdCZWhhdmlvcjpcbiAgICAgICAgICAgICAgICBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgICAgICAgICAgfVxuICAgICAgICAgICksXG4gICAgICAgICAgZWRnZUxhbWJkYXM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5pbWFnZUZ1bmN0aW9uVmVyc2lvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgW3RoaXMucGF0aFBhdHRlcm4oXCJfbmV4dC9kYXRhLypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IGxhbWJkYUNhY2hlUG9saWN5LFxuICAgICAgICAgIGVkZ2VMYW1iZGFzLFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0LypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IHN0YXRpY0NhY2hlUG9saWN5LFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcInN0YXRpYy8qXCIpXToge1xuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBzdGF0aWNDYWNoZVBvbGljeSxcbiAgICAgICAgfSxcbiAgICAgICAgW3RoaXMucGF0aFBhdHRlcm4oXCJhcGkvKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBsYW1iZGFDYWNoZVBvbGljeSxcbiAgICAgICAgICBlZGdlTGFtYmRhczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpbmNsdWRlQm9keTogdHJ1ZSxcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5hcGlGdW5jdGlvblZlcnNpb24sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmFkZGl0aW9uYWxCZWhhdmlvcnMgfHwge30pLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udFN0YXRpY0NhY2hlUG9saWN5KCk6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3kge1xuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5DYWNoZVBvbGljeShcbiAgICAgIHRoaXMsXG4gICAgICBcIlN0YXRpY3NDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5zdGF0aWNDYWNoZVBvbGljeVByb3BzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udEltYWdlQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiSW1hZ2VDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5pbWFnZUNhY2hlUG9saWN5UHJvcHNcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250TGFtYmRhQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiTGFtYmRhQ2FjaGVcIixcbiAgICAgIE5leHRqc1NpdGUubGFtYmRhQ2FjaGVQb2xpY3lQcm9wc1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNsb3VkRnJvbnRJbnZhbGlkYXRpb24oKTogY2RrLkN1c3RvbVJlc291cmNlIHtcbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGRvaW5nIHRoZSBpbnZhbGlkYXRpb25cbiAgICBjb25zdCBpbnZhbGlkYXRvciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJDbG91ZEZyb250SW52YWxpZGF0b3JcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9CYXNlU2l0ZS9jdXN0b20tcmVzb3VyY2VcIilcbiAgICAgICksXG4gICAgICBsYXllcnM6IFt0aGlzLmF3c0NsaUxheWVyXSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzcsXG4gICAgICBoYW5kbGVyOiBcImNmLWludmFsaWRhdGUuaGFuZGxlclwiLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICB9KTtcblxuICAgIC8vIEdyYW50IHBlcm1pc3Npb25zIHRvIGludmFsaWRhdGUgQ0YgRGlzdHJpYnV0aW9uXG4gICAgaW52YWxpZGF0b3IuYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcImNsb3VkZnJvbnQ6R2V0SW52YWxpZGF0aW9uXCIsXG4gICAgICAgICAgXCJjbG91ZGZyb250OkNyZWF0ZUludmFsaWRhdGlvblwiLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBuZWVkIHRoZSBCdWlsZElkIGZpZWxkIHNvIHRoaXMgQ1IgZ2V0cyB1cGRhdGVkIG9uIGVhY2ggZGVwbG95XG4gICAgbGV0IGJ1aWxkSWQ6IHN0cmluZztcbiAgICBpZiAodGhpcy5pc1BsYWNlaG9sZGVyKSB7XG4gICAgICBidWlsZElkID0gXCJsaXZlXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGJ1aWxkSWRGaWxlID0gcGF0aC5yZXNvbHZlKHRoaXMuYnVpbGRPdXREaXIhLCBcImFzc2V0c1wiLCBcIkJVSUxEX0lEXCIpO1xuICAgICAgYnVpbGRJZCA9IGZzLnJlYWRGaWxlU3luYyhidWlsZElkRmlsZSkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gICAgY29uc3Qgd2FpdEZvckludmFsaWRhdGlvbiA9XG4gICAgICB0aGlzLnByb3BzLndhaXRGb3JJbnZhbGlkYXRpb24gPT09IGZhbHNlID8gZmFsc2UgOiB0cnVlO1xuICAgIHJldHVybiBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiQ2xvdWRGcm9udEludmFsaWRhdGlvblwiLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGludmFsaWRhdG9yLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUQ2xvdWRGcm9udEludmFsaWRhdGlvblwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBCdWlsZElkOiBidWlsZElkLFxuICAgICAgICBEaXN0cmlidXRpb25JZDogdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25JZCxcbiAgICAgICAgRGlzdHJpYnV0aW9uUGF0aHM6IFtcIi8qXCJdLFxuICAgICAgICBXYWl0Rm9ySW52YWxpZGF0aW9uOiB3YWl0Rm9ySW52YWxpZGF0aW9uLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBDdXN0b20gRG9tYWluXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIHByb3RlY3RlZCB2YWxpZGF0ZUN1c3RvbURvbWFpblNldHRpbmdzKCkge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChjdXN0b21Eb21haW4uaXNFeHRlcm5hbERvbWFpbiA9PT0gdHJ1ZSkge1xuICAgICAgaWYgKCFjdXN0b21Eb21haW4uY2VydGlmaWNhdGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBBIHZhbGlkIGNlcnRpZmljYXRlIGlzIHJlcXVpcmVkIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgc2V0IHRvIFwidHJ1ZVwiLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4uZG9tYWluQWxpYXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBEb21haW4gYWxpYXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGRvbWFpbnMgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My4gRG8gbm90IHNldCB0aGUgXCJjdXN0b21Eb21haW4uZG9tYWluQWxpYXNcIiB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIGVuYWJsZWQuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgSG9zdGVkIHpvbmVzIGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgZm9yIGRvbWFpbnMgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My4gRG8gbm90IHNldCB0aGUgXCJjdXN0b21Eb21haW4uaG9zdGVkWm9uZVwiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGxvb2t1cEhvc3RlZFpvbmUoKTogcm91dGU1My5JSG9zdGVkWm9uZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBTa2lwIGlmIGN1c3RvbURvbWFpbiBpcyBub3QgY29uZmlndXJlZFxuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGhvc3RlZFpvbmU7XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbixcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoaXNDREtDb25zdHJ1Y3QoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpKSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIC8vIFNraXAgaWYgZG9tYWluIGlzIG5vdCBhIFJvdXRlNTMgZG9tYWluXG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmlzRXh0ZXJuYWxEb21haW4gPT09IHRydWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaG9zdGVkWm9uZSA9IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lO1xuICAgIH1cblxuICAgIHJldHVybiBob3N0ZWRab25lO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDZXJ0aWZpY2F0ZSgpOiBhY20uSUNlcnRpZmljYXRlIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGFjbUNlcnRpZmljYXRlO1xuXG4gICAgLy8gSG9zdGVkWm9uZSBpcyBzZXQgZm9yIFJvdXRlIDUzIGRvbWFpbnNcbiAgICBpZiAodGhpcy5ob3N0ZWRab25lKSB7XG4gICAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IG5ldyBhY20uRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUodGhpcywgXCJDZXJ0aWZpY2F0ZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLFxuICAgICAgICAgIGhvc3RlZFpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChjdXN0b21Eb21haW4uY2VydGlmaWNhdGUpIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IG5ldyBhY20uRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUodGhpcywgXCJDZXJ0aWZpY2F0ZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUsXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICAgIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIEhvc3RlZFpvbmUgaXMgTk9UIHNldCBmb3Igbm9uLVJvdXRlIDUzIGRvbWFpbnNcbiAgICBlbHNlIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhY21DZXJ0aWZpY2F0ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVSb3V0ZTUzUmVjb3JkcygpOiB2b2lkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmICghY3VzdG9tRG9tYWluIHx8ICF0aGlzLmhvc3RlZFpvbmUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgcmVjb3JkTmFtZTtcbiAgICBsZXQgZG9tYWluQWxpYXM7XG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJlY29yZE5hbWUgPSBjdXN0b21Eb21haW47XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlY29yZE5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcbiAgICAgIGRvbWFpbkFsaWFzID0gY3VzdG9tRG9tYWluLmRvbWFpbkFsaWFzO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBETlMgcmVjb3JkXG4gICAgY29uc3QgcmVjb3JkUHJvcHMgPSB7XG4gICAgICByZWNvcmROYW1lLFxuICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgdGFyZ2V0OiByb3V0ZTUzLlJlY29yZFRhcmdldC5mcm9tQWxpYXMoXG4gICAgICAgIG5ldyByb3V0ZTUzVGFyZ2V0cy5DbG91ZEZyb250VGFyZ2V0KHRoaXMuY2ZEaXN0cmlidXRpb24pXG4gICAgICApLFxuICAgIH07XG4gICAgbmV3IHJvdXRlNTMuQVJlY29yZCh0aGlzLCBcIkFsaWFzUmVjb3JkXCIsIHJlY29yZFByb3BzKTtcbiAgICBuZXcgcm91dGU1My5BYWFhUmVjb3JkKHRoaXMsIFwiQWxpYXNSZWNvcmRBQUFBXCIsIHJlY29yZFByb3BzKTtcblxuICAgIC8vIENyZWF0ZSBBbGlhcyByZWRpcmVjdCByZWNvcmRcbiAgICBpZiAoZG9tYWluQWxpYXMpIHtcbiAgICAgIG5ldyByb3V0ZTUzUGF0dGVybnMuSHR0cHNSZWRpcmVjdCh0aGlzLCBcIlJlZGlyZWN0XCIsIHtcbiAgICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICByZWNvcmROYW1lczogW2RvbWFpbkFsaWFzXSxcbiAgICAgICAgdGFyZ2V0RG9tYWluOiByZWNvcmROYW1lLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEhlbHBlciBGdW5jdGlvbnNcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBwYXRoUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgYmFzZVBhdGggfSA9IHRoaXMucm91dGVzTWFuaWZlc3QgfHwge307XG4gICAgcmV0dXJuIGJhc2VQYXRoICYmIGJhc2VQYXRoLmxlbmd0aCA+IDBcbiAgICAgID8gYCR7YmFzZVBhdGguc2xpY2UoMSl9LyR7cGF0dGVybn1gXG4gICAgICA6IHBhdHRlcm47XG4gIH1cblxuICBwcml2YXRlIHJlYWRSb3V0ZXNNYW5pZmVzdCgpOiBSb3V0ZXNNYW5pZmVzdCB7XG4gICAgcmV0dXJuIGZzLnJlYWRKU09OU3luYyhcbiAgICAgIHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyISwgXCJkZWZhdWx0LWxhbWJkYS9yb3V0ZXMtbWFuaWZlc3QuanNvblwiKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFMzQ29udGVudFJlcGxhY2VWYWx1ZXMoKTogQmFzZVNpdGVSZXBsYWNlUHJvcHNbXSB7XG4gICAgY29uc3QgcmVwbGFjZVZhbHVlczogQmFzZVNpdGVSZXBsYWNlUHJvcHNbXSA9IFtdO1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSlcbiAgICAgIC5maWx0ZXIoKFssIHZhbHVlXSkgPT4gY2RrLlRva2VuLmlzVW5yZXNvbHZlZCh2YWx1ZSkpXG4gICAgICAuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gYHt7ICR7a2V5fSB9fWA7XG4gICAgICAgIHJlcGxhY2VWYWx1ZXMucHVzaChcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCIqKi8qLmh0bWxcIixcbiAgICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGZpbGVzOiBcIioqLyouanNcIixcbiAgICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGZpbGVzOiBcIioqLyouanNvblwiLFxuICAgICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIHJldHVybiByZXBsYWNlVmFsdWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMYW1iZGFDb250ZW50UmVwbGFjZVZhbHVlcygpOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdIHtcbiAgICBjb25zdCByZXBsYWNlVmFsdWVzOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdID0gW107XG5cbiAgICAvLyBUaGUgTmV4dC5qcyBhcHAgY2FuIGhhdmUgZW52aXJvbm1lbnQgdmFyaWFibGVzIGxpa2VcbiAgICAvLyBgcHJvY2Vzcy5lbnYuQVBJX1VSTGAgaW4gdGhlIEpTIGNvZGUuIGBwcm9jZXNzLmVudi5BUElfVVJMYCBtaWdodCBvclxuICAgIC8vIG1pZ2h0IG5vdCBnZXQgcmVzb2x2ZWQgb24gYG5leHQgYnVpbGRgIGlmIGl0IGlzIHVzZWQgaW5cbiAgICAvLyBzZXJ2ZXItc2lkZSBmdW5jdGlvbnMsIGllLiBnZXRTZXJ2ZXJTaWRlUHJvcHMoKS5cbiAgICAvLyBCZWNhdXNlIExhbWJkYUBFZGdlIGRvZXMgbm90IHN1cHBvcnQgZW52aXJvbm1lbnQgdmFyaWFibGVzLCB3ZSB3aWxsXG4gICAgLy8gdXNlIHRoZSB0cmljayBvZiByZXBsYWNpbmcgXCJ7eyBfU1NUX05FWFRKU19TSVRFX0VOVklST05NRU5UXyB9fVwiIHdpdGhcbiAgICAvLyBhIEpTT04gZW5jb2RlZCBzdHJpbmcgb2YgYWxsIGVudmlyb25tZW50IGtleS12YWx1ZSBwYWlycy4gVGhpcyBzdHJpbmdcbiAgICAvLyB3aWxsIHRoZW4gZ2V0IGRlY29kZWQgYXQgcnVuIHRpbWUuXG4gICAgY29uc3QgbGFtYmRhRW52czogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBjb25zdCB0b2tlbiA9IGB7eyAke2tleX0gfX1gO1xuICAgICAgcmVwbGFjZVZhbHVlcy5wdXNoKFxuICAgICAgICB7XG4gICAgICAgICAgZmlsZXM6IFwiKiovKi5odG1sXCIsXG4gICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZpbGVzOiBcIioqLyouanNcIixcbiAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgZmlsZXM6IFwiKiovKi5qc29uXCIsXG4gICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIGxhbWJkYUVudnNba2V5XSA9IHZhbHVlO1xuICAgIH0pO1xuXG4gICAgcmVwbGFjZVZhbHVlcy5wdXNoKHtcbiAgICAgIGZpbGVzOiBcIioqLyouanNcIixcbiAgICAgIHNlYXJjaDogJ1wie3sgX1NTVF9ORVhUSlNfU0lURV9FTlZJUk9OTUVOVF8gfX1cIicsXG4gICAgICByZXBsYWNlOiBKU09OLnN0cmluZ2lmeShsYW1iZGFFbnZzKSxcbiAgICB9KTtcblxuICAgIHJldHVybiByZXBsYWNlVmFsdWVzO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlclNpdGVFbnZpcm9ubWVudCgpIHtcbiAgICBjb25zdCBlbnZpcm9ubWVudE91dHB1dHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnByb3BzLmVudmlyb25tZW50IHx8IHt9KSkge1xuICAgICAgY29uc3Qgb3V0cHV0SWQgPSBgU3N0U2l0ZUVudl8ke2tleX1gO1xuICAgICAgY29uc3Qgb3V0cHV0ID0gbmV3IGNkay5DZm5PdXRwdXQodGhpcywgb3V0cHV0SWQsIHsgdmFsdWUgfSk7XG4gICAgICBlbnZpcm9ubWVudE91dHB1dHNba2V5XSA9IGNkay5TdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQob3V0cHV0KTtcbiAgICB9XG5cbiAgICBjb25zdCByb290ID0gdGhpcy5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIHJvb3QucmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoe1xuICAgICAgaWQ6IHRoaXMubm9kZS5pZCxcbiAgICAgIHBhdGg6IHRoaXMucHJvcHMucGF0aCxcbiAgICAgIHN0YWNrOiBjZGsuU3RhY2sub2YodGhpcykubm9kZS5pZCxcbiAgICAgIGVudmlyb25tZW50T3V0cHV0cyxcbiAgICB9IGFzIEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyk7XG4gIH1cbn1cbiJdfQ==