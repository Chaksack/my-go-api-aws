"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApiGatewayV1Api = void 0;
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
const apig = __importStar(require("aws-cdk-lib/aws-apigateway"));
const apigV1AccessLog = __importStar(require("./util/apiGatewayV1AccessLog"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const allowedMethods = [
    "ANY",
    "GET",
    "PUT",
    "POST",
    "HEAD",
    "PATCH",
    "DELETE",
    "OPTIONS",
];
/////////////////////
// Construct
/////////////////////
class ApiGatewayV1Api extends constructs_1.Construct {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e, _f, _g;
        super(scope, id);
        const root = scope.node.root;
        const { restApi, routes, cors, accessLog, customDomain, importedPaths, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, } = props || {};
        this.functions = {};
        this.importedResources = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        ////////////////////
        // Create Api
        ////////////////////
        if ((0, Construct_1.isCDKConstruct)(restApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when the "restApi" is imported`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when the "restApi" is imported`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when the "restApi" is imported`);
            }
            this.restApi = restApi;
            // Create an API Gateway deployment resource to trigger a deployment
            this._deployment = new apig.Deployment(this, "Deployment", {
                api: this.restApi,
            });
            const cfnDeployment = this._deployment.node
                .defaultChild;
            cfnDeployment.stageName = root.stage;
            if (importedPaths) {
                this.importResources(importedPaths);
            }
        }
        else {
            const restApiProps = (restApi || {});
            // Validate input
            if (importedPaths !== undefined) {
                throw new Error(`Cannot import route paths when creating a new API.`);
            }
            if (customDomain !== undefined && restApiProps.domainName !== undefined) {
                throw new Error(`Use either the "customDomain" or the "restApi.domainName" to configure the Api domain. Do not use both.`);
            }
            if (cors !== undefined &&
                restApiProps.defaultCorsPreflightOptions !== undefined) {
                throw new Error(`Use either the "cors" or the "restApi.defaultCorsPreflightOptions" to configure the Api's CORS config. Do not use both.`);
            }
            if (accessLog !== undefined &&
                ((_a = restApiProps.deployOptions) === null || _a === void 0 ? void 0 : _a.accessLogDestination) !== undefined) {
                throw new Error(`Use either the "accessLog" or the "restApi.deployOptions.accessLogDestination" to configure the Api's access log. Do not use both.`);
            }
            if (accessLog !== undefined &&
                ((_b = restApiProps.deployOptions) === null || _b === void 0 ? void 0 : _b.accessLogFormat) !== undefined) {
                throw new Error(`Use either the "accessLog" or the "restApi.deployOptions.accessLogFormat" to configure the Api's access log. Do not use both.`);
            }
            const stageName = ((_c = restApiProps.deployOptions) === null || _c === void 0 ? void 0 : _c.stageName) || this.node.root.stage;
            const accessLogData = apigV1AccessLog.buildAccessLogData(this, accessLog);
            this.accessLogGroup = accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.logGroup;
            this.restApi = new apig.RestApi(this, "Api", Object.assign(Object.assign({ restApiName: root.logicalPrefixedName(id) }, restApiProps), { domainName: restApiProps.domainName, defaultCorsPreflightOptions: restApiProps.defaultCorsPreflightOptions ||
                    this.buildCorsConfig(cors), deployOptions: Object.assign(Object.assign({}, (restApiProps.deployOptions || {})), { accessLogDestination: ((_d = restApiProps.deployOptions) === null || _d === void 0 ? void 0 : _d.accessLogDestination) ||
                        (accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.destination), accessLogFormat: ((_e = restApiProps.deployOptions) === null || _e === void 0 ? void 0 : _e.accessLogFormat) ||
                        (accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.format), 
                    // default to the name of the sage
                    stageName: stageName, 
                    // default to true
                    tracingEnabled: ((_f = restApiProps.deployOptions) === null || _f === void 0 ? void 0 : _f.tracingEnabled) === undefined
                        ? true
                        : (_g = restApiProps.deployOptions) === null || _g === void 0 ? void 0 : _g.tracingEnabled }) }));
            this.createCustomDomain(customDomain);
            this.createGatewayResponseForCors(cors);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        if (routes) {
            Object.keys(routes).forEach((routeKey) => this.addRoute(this, routeKey, routes[routeKey]));
        }
    }
    get url() {
        return this.restApi.url;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.functions);
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    getConstructMetadata() {
        return {
            type: "ApiGatewayV1Api",
            data: {
                customDomainUrl: this._customDomainUrl,
                url: this.restApi.url,
                restApiId: this.restApi.restApiId,
                routes: Object.entries(this.functions).map(([key, data]) => {
                    return {
                        route: key,
                        fn: (0, Construct_1.getFunctionRef)(data),
                    };
                }),
            },
        };
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    buildCorsConfig(cors) {
        // Case: cors is false
        if (cors === false) {
            return undefined;
        }
        // Case: cors is true or undefined
        return {
            allowOrigins: apig.Cors.ALL_ORIGINS,
        };
    }
    createGatewayResponseForCors(cors) {
        if (!cors) {
            return;
        }
        this.restApi.addGatewayResponse("GatewayResponseDefault4XX", {
            type: apig.ResponseType.DEFAULT_4XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
                "Access-Control-Allow-Headers": "'*'",
            },
        });
        this.restApi.addGatewayResponse("GatewayResponseDefault5XX", {
            type: apig.ResponseType.DEFAULT_5XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
                "Access-Control-Allow-Headers": "'*'",
            },
        });
    }
    createCustomDomain(customDomain) {
        // Case: customDomain is not set
        if (customDomain === undefined) {
            return;
        }
        // To be implemented: to allow more flexible use cases, SST should support 3 more use cases:
        //  1. Allow user passing in `hostedZone` object. The use case is when there are multiple
        //     HostedZones with the same domain, but one is public, and one is private.
        //  2. Allow user passing in `certificate` object. The use case is for user to create wildcard
        //     certificate or using an imported certificate.
        //  3. Allow user passing in `apigDomainName` object. The use case is a user creates multiple API
        //     endpoints, and is mapping them under the same custom domain. `sst.Api` needs to expose the
        //     `apigDomainName` construct created in the first Api, and lets user pass it in when creating
        //     the second Api.
        let domainName, hostedZone, hostedZoneDomain, certificate, apigDomainName, basePath, endpointType, mtls, securityPolicy;
        /////////////////////
        // Parse input
        /////////////////////
        // Case: customDomain is a string
        if (typeof customDomain === "string") {
            // validate: customDomain is a TOKEN string
            // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
            if (cdk.Token.isUnresolved(customDomain)) {
                throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
            }
            domainName = customDomain;
            this.assertDomainNameIsLowerCase(domainName);
            hostedZoneDomain = customDomain.split(".").slice(1).join(".");
        }
        // Case: customDomain.domainName not exists
        else if (!customDomain.domainName) {
            throw new Error(`Missing "domainName" in Api's customDomain setting`);
        }
        // Case: customDomain.domainName is a string
        else if (typeof customDomain.domainName === "string") {
            domainName = customDomain.domainName;
            // parse customDomain.domainName
            if (cdk.Token.isUnresolved(customDomain.domainName)) {
                // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
                // is because "hostedZone" cannot be parsed from a TOKEN value.
                if (!customDomain.hostedZone) {
                    throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
                }
                domainName = customDomain.domainName;
            }
            else {
                domainName = customDomain.domainName;
                this.assertDomainNameIsLowerCase(domainName);
            }
            // parse customDomain.hostedZone
            if (!customDomain.hostedZone) {
                hostedZoneDomain = domainName.split(".").slice(1).join(".");
            }
            else if (typeof customDomain.hostedZone === "string") {
                hostedZoneDomain = customDomain.hostedZone;
            }
            else {
                hostedZone = customDomain.hostedZone;
            }
            certificate = customDomain.certificate;
            basePath = customDomain.path;
            endpointType = customDomain.endpointType;
            mtls = customDomain.mtls;
            securityPolicy = customDomain.securityPolicy;
        }
        // Case: customDomain.domainName is a construct
        else {
            apigDomainName = customDomain.domainName;
            // customDomain.domainName is imported
            if (apigDomainName && customDomain.hostedZone) {
                throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.certificate) {
                throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.endpointType) {
                throw new Error(`Cannot configure the "endpointType" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.mtls) {
                throw new Error(`Cannot configure the "mtls" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.securityPolicy) {
                throw new Error(`Cannot configure the "securityPolicy" when the "domainName" is a construct`);
            }
            basePath = customDomain.path;
        }
        /////////////////////
        // Find hosted zone
        /////////////////////
        if (!apigDomainName && !hostedZone) {
            // Look up hosted zone
            if (!hostedZone && hostedZoneDomain) {
                hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                    domainName: hostedZoneDomain,
                });
            }
        }
        /////////////////////
        // Create certificate
        /////////////////////
        if (!apigDomainName && !certificate) {
            if (endpointType === apig.EndpointType.EDGE) {
                certificate = new acm.DnsValidatedCertificate(this, "CrossRegionCertificate", {
                    domainName: domainName,
                    hostedZone: hostedZone,
                    region: "us-east-1",
                });
            }
            else {
                certificate = new acm.Certificate(this, "Certificate", {
                    domainName: domainName,
                    validation: acm.CertificateValidation.fromDns(hostedZone),
                });
            }
            this.acmCertificate = certificate;
        }
        /////////////////////
        // Create API Gateway domain name
        /////////////////////
        if (!apigDomainName && domainName) {
            // Create custom domain in API Gateway
            apigDomainName = new apig.DomainName(this, "DomainName", {
                domainName,
                certificate: certificate,
                endpointType,
                mtls,
                securityPolicy,
            });
            this.apiGatewayDomain = apigDomainName;
            // Create DNS record
            this.createARecords(hostedZone, domainName, apigDomainName);
        }
        /////////////////////
        // Create base mapping
        /////////////////////
        if (apigDomainName) {
            new apig.BasePathMapping(this, "BasePath", {
                domainName: apigDomainName,
                restApi: this.restApi,
                basePath,
            });
        }
        // Note: We only know the full custom domain if domainName is a string.
        //       _customDomainUrl will be undefined if apigDomainName is imported.
        if (domainName && !cdk.Token.isUnresolved(domainName)) {
            this._customDomainUrl = basePath
                ? `https://${domainName}/${basePath}/`
                : `https://${domainName}`;
        }
    }
    createARecords(hostedZone, domainName, apigDomain) {
        // create DNS record
        const recordProps = {
            recordName: domainName,
            zone: hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayDomain(apigDomain)),
        };
        const records = [
            new route53.ARecord(this, "AliasRecord", recordProps),
            new route53.AaaaRecord(this, "AliasRecordAAAA", recordProps),
        ];
        // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
        //       construct will append ".${hostedZoneName}" to the end of the domain.
        //       This is because the construct tries to check if the record name
        //       ends with the domain name. If not, it will append the domain name.
        //       So, we need remove this behavior.
        if (cdk.Token.isUnresolved(domainName)) {
            records.forEach((record) => {
                const cfnRecord = record.node.defaultChild;
                cfnRecord.name = domainName;
            });
        }
    }
    importResources(resources) {
        Object.keys(resources).forEach((path) => {
            const resource = apig.Resource.fromResourceAttributes(this, `Resource_${path}`, {
                path,
                resourceId: resources[path],
                restApi: this.restApi,
            });
            this.importedResources[path] = resource;
        });
    }
    getResourceForPath(path) {
        // Lookup exact match imported resource
        if (this.importedResources[path]) {
            return this.importedResources[path];
        }
        // Lookup parents matching imported resource first
        const parts = path.split("/");
        for (let i = parts.length; i >= 1; i--) {
            const partialPath = parts.slice(0, i).join("/");
            if (this.importedResources[partialPath]) {
                return this.importedResources[partialPath].resourceForPath(parts.slice(i).join("/"));
            }
        }
        // Not child of imported resources, create off the root
        return this.restApi.root.resourceForPath(path);
    }
    addRoute(scope, routeKey, routeValue) {
        // Normalize routeProps
        const routeProps = (this.isInstanceOfApiRouteProps(routeValue)
            ? routeValue
            : {
                function: routeValue,
            });
        // Normalize routeKey
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.functions[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Get path and method
        ///////////////////
        const routeKeyParts = routeKey.split(" ");
        if (routeKeyParts.length !== 2) {
            throw new Error(`Invalid route ${routeKey}`);
        }
        const methodStr = routeKeyParts[0].toUpperCase();
        const path = routeKeyParts[1];
        const method = allowedMethods.find((per) => per === methodStr);
        if (!method) {
            throw new Error(`Invalid method defined for "${routeKey}"`);
        }
        if (path.length === 0) {
            throw new Error(`Invalid path defined for "${routeKey}"`);
        }
        ///////////////////
        // Create Resources
        ///////////////////
        let resource;
        if (path.endsWith("/{proxy+}")) {
            const parentResource = this.getResourceForPath(path.split("/").slice(0, -1).join("/"));
            resource = parentResource.addProxy({ anyMethod: false });
        }
        else {
            resource = this.getResourceForPath(path);
        }
        ///////////////////
        // Create Method
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${methodStr}_${path}`, routeProps.function, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        const integration = new apig.LambdaIntegration(lambda, routeProps.integrationOptions);
        const methodOptions = this.buildRouteMethodOptions(routeProps.methodOptions);
        const apigMethod = resource.addMethod(method, integration, methodOptions);
        // Add an environment variable to determine if the function is an Api route.
        // If it is, when "sst start" is not connected, we want to return an 500
        // status code and a descriptive error message.
        const root = scope.node.root;
        if (root.local) {
            lambda.addEnvironment("SST_DEBUG_IS_API_ROUTE", "1", {
                removeInEdge: true,
            });
        }
        ///////////////////
        // Handle manually created Deployment resource (ie. imported REST API)
        ///////////////////
        if (this._deployment) {
            this._deployment.addToLogicalId({ route: { routeKey, routeValue } });
            this._deployment.node.addDependency(apigMethod);
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        return lambda;
    }
    buildRouteMethodOptions(options) {
        // Merge method options
        const methodOptions = Object.assign({ authorizationType: this.defaultAuthorizationType }, (options || {}));
        // Set authorization info
        if (methodOptions.authorizationType !== apig.AuthorizationType.NONE &&
            methodOptions.authorizationType !== apig.AuthorizationType.IAM) {
            methodOptions.authorizer =
                methodOptions.authorizer || this.defaultAuthorizer;
            methodOptions.authorizationScopes =
                methodOptions.authorizationScopes || this.defaultAuthorizationScopes;
        }
        return methodOptions;
    }
    isInstanceOfApiRouteProps(object) {
        return object.function !== undefined;
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    assertDomainNameIsLowerCase(domainName) {
        if (domainName !== domainName.toLowerCase()) {
            throw new Error(`The domain name needs to be in lowercase`);
        }
    }
}
exports.ApiGatewayV1Api = ApiGatewayV1Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpR2F0ZXdheVYxQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaUdhdGV3YXlWMUFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2QyxpREFBbUM7QUFFbkMsaUVBQW1EO0FBQ25ELGdGQUFrRTtBQUNsRSx3RUFBMEQ7QUFDMUQsaUVBQW1EO0FBQ25ELDhFQUFnRTtBQUdoRSwyQ0FBMkU7QUFDM0UseUNBQStFO0FBRy9FLE1BQU0sY0FBYyxHQUFHO0lBQ3JCLEtBQUs7SUFDTCxLQUFLO0lBQ0wsS0FBSztJQUNMLE1BQU07SUFDTixNQUFNO0lBQ04sT0FBTztJQUNQLFFBQVE7SUFDUixTQUFTO0NBQ1YsQ0FBQztBQXdDRixxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLGVBQWdCLFNBQVEsc0JBQVM7SUFlNUMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUE0Qjs7UUFDcEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLEVBQ0osT0FBTyxFQUNQLE1BQU0sRUFDTixJQUFJLEVBQ0osU0FBUyxFQUNULFlBQVksRUFDWixhQUFhLEVBQ2Isb0JBQW9CLEVBQ3BCLGlCQUFpQixFQUNqQix3QkFBd0IsRUFDeEIsMEJBQTBCLEdBQzNCLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQywrQkFBK0IsR0FBRyxFQUFFLENBQUM7UUFDMUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO1FBQ2pELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztRQUMzQyxJQUFJLENBQUMsd0JBQXdCLEdBQUcsd0JBQXdCLENBQUM7UUFDekQsSUFBSSxDQUFDLDBCQUEwQixHQUFHLDBCQUEwQixDQUFDO1FBRTdELG9CQUFvQjtRQUNwQixhQUFhO1FBQ2Isb0JBQW9CO1FBRXBCLElBQUksSUFBQSwwQkFBYyxFQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzNCLElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtnQkFDdEIsTUFBTSxJQUFJLEtBQUssQ0FDYiw0REFBNEQsQ0FDN0QsQ0FBQzthQUNIO1lBQ0QsSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFO2dCQUMzQixNQUFNLElBQUksS0FBSyxDQUNiLGlFQUFpRSxDQUNsRSxDQUFDO2FBQ0g7WUFDRCxJQUFJLFlBQVksS0FBSyxTQUFTLEVBQUU7Z0JBQzlCLE1BQU0sSUFBSSxLQUFLLENBQ2Isb0VBQW9FLENBQ3JFLENBQUM7YUFDSDtZQUNELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBdUIsQ0FBQztZQUV2QyxvRUFBb0U7WUFDcEUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRTtnQkFDekQsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPO2FBQ2xCLENBQUMsQ0FBQztZQUNILE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSTtpQkFDeEMsWUFBa0MsQ0FBQztZQUN0QyxhQUFhLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFFckMsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7YUFDckM7U0FDRjthQUFNO1lBQ0wsTUFBTSxZQUFZLEdBQUcsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFzQixDQUFDO1lBRTFELGlCQUFpQjtZQUNqQixJQUFJLGFBQWEsS0FBSyxTQUFTLEVBQUU7Z0JBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsb0RBQW9ELENBQUMsQ0FBQzthQUN2RTtZQUNELElBQUksWUFBWSxLQUFLLFNBQVMsSUFBSSxZQUFZLENBQUMsVUFBVSxLQUFLLFNBQVMsRUFBRTtnQkFDdkUsTUFBTSxJQUFJLEtBQUssQ0FDYix5R0FBeUcsQ0FDMUcsQ0FBQzthQUNIO1lBQ0QsSUFDRSxJQUFJLEtBQUssU0FBUztnQkFDbEIsWUFBWSxDQUFDLDJCQUEyQixLQUFLLFNBQVMsRUFDdEQ7Z0JBQ0EsTUFBTSxJQUFJLEtBQUssQ0FDYix5SEFBeUgsQ0FDMUgsQ0FBQzthQUNIO1lBQ0QsSUFDRSxTQUFTLEtBQUssU0FBUztnQkFDdkIsQ0FBQSxNQUFBLFlBQVksQ0FBQyxhQUFhLDBDQUFFLG9CQUFvQixNQUFLLFNBQVMsRUFDOUQ7Z0JBQ0EsTUFBTSxJQUFJLEtBQUssQ0FDYixvSUFBb0ksQ0FDckksQ0FBQzthQUNIO1lBQ0QsSUFDRSxTQUFTLEtBQUssU0FBUztnQkFDdkIsQ0FBQSxNQUFBLFlBQVksQ0FBQyxhQUFhLDBDQUFFLGVBQWUsTUFBSyxTQUFTLEVBQ3pEO2dCQUNBLE1BQU0sSUFBSSxLQUFLLENBQ2IsK0hBQStILENBQ2hJLENBQUM7YUFDSDtZQUVELE1BQU0sU0FBUyxHQUNiLENBQUEsTUFBQSxZQUFZLENBQUMsYUFBYSwwQ0FBRSxTQUFTLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFZLENBQUMsS0FBSyxDQUFDO1lBRXpFLE1BQU0sYUFBYSxHQUFHLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFMUUsSUFBSSxDQUFDLGNBQWMsR0FBRyxhQUFhLGFBQWIsYUFBYSx1QkFBYixhQUFhLENBQUUsUUFBUSxDQUFDO1lBRTlDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLGdDQUN6QyxXQUFXLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxJQUN0QyxZQUFZLEtBQ2YsVUFBVSxFQUFFLFlBQVksQ0FBQyxVQUFVLEVBQ25DLDJCQUEyQixFQUN6QixZQUFZLENBQUMsMkJBQTJCO29CQUN4QyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUM1QixhQUFhLGtDQUNSLENBQUMsWUFBWSxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUMsS0FDckMsb0JBQW9CLEVBQ2xCLENBQUEsTUFBQSxZQUFZLENBQUMsYUFBYSwwQ0FBRSxvQkFBb0I7eUJBQ2hELGFBQWEsYUFBYixhQUFhLHVCQUFiLGFBQWEsQ0FBRSxXQUFXLENBQUEsRUFDNUIsZUFBZSxFQUNiLENBQUEsTUFBQSxZQUFZLENBQUMsYUFBYSwwQ0FBRSxlQUFlO3lCQUMzQyxhQUFhLGFBQWIsYUFBYSx1QkFBYixhQUFhLENBQUUsTUFBTSxDQUFBO29CQUV2QixrQ0FBa0M7b0JBQ2xDLFNBQVMsRUFBRSxTQUFTO29CQUVwQixrQkFBa0I7b0JBQ2xCLGNBQWMsRUFDWixDQUFBLE1BQUEsWUFBWSxDQUFDLGFBQWEsMENBQUUsY0FBYyxNQUFLLFNBQVM7d0JBQ3RELENBQUMsQ0FBQyxJQUFJO3dCQUNOLENBQUMsQ0FBQyxNQUFBLFlBQVksQ0FBQyxhQUFhLDBDQUFFLGNBQWMsT0FFbEQsQ0FBQztZQUVILElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsNEJBQTRCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekM7UUFFRCwyQkFBMkI7UUFDM0IsbUJBQW1CO1FBQ25CLDJCQUEyQjtRQUUzQixJQUFJLE1BQU0sRUFBRTtZQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQy9DLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FDaEQsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVELElBQVcsR0FBRztRQUNaLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQVcsZUFBZTtRQUN4QixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBVyxNQUFNO1FBQ2YsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRU0sU0FBUyxDQUNkLEtBQWdCLEVBQ2hCLE1BRUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUMvQyxZQUFZO1lBQ1osTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBRTVELGdDQUFnQztZQUNoQyxJQUFJLENBQUMsK0JBQStCLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FDM0QsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUNsQyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sV0FBVyxDQUFDLFFBQWdCO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRU0saUJBQWlCLENBQUMsV0FBd0I7UUFDL0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDM0MsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUNsQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU0sb0JBQW9CO1FBQ3pCLE9BQU87WUFDTCxJQUFJLEVBQUUsaUJBQTBCO1lBQ2hDLElBQUksRUFBRTtnQkFDSixlQUFlLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtnQkFDdEMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRztnQkFDckIsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUztnQkFDakMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7b0JBQ3pELE9BQU87d0JBQ0wsS0FBSyxFQUFFLEdBQUc7d0JBQ1YsRUFBRSxFQUFFLElBQUEsMEJBQWMsRUFBQyxJQUFJLENBQUM7cUJBQ3pCLENBQUM7Z0JBQ0osQ0FBQyxDQUFDO2FBQ0g7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVNLHdCQUF3QixDQUM3QixRQUFnQixFQUNoQixXQUF3QjtRQUV4QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUNiLHdDQUF3QyxRQUFRLG1CQUFtQixDQUNwRSxDQUFDO1NBQ0g7UUFFRCxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxJQUFjO1FBQ3BDLHNCQUFzQjtRQUN0QixJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7WUFDbEIsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFFRCxrQ0FBa0M7UUFDbEMsT0FBTztZQUNMLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVc7U0FDaEIsQ0FBQztJQUN4QixDQUFDO0lBRU8sNEJBQTRCLENBQUMsSUFBYztRQUNqRCxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQywyQkFBMkIsRUFBRTtZQUMzRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXO1lBQ25DLGVBQWUsRUFBRTtnQkFDZiw2QkFBNkIsRUFBRSxLQUFLO2dCQUNwQyw4QkFBOEIsRUFBRSxLQUFLO2FBQ3RDO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQywyQkFBMkIsRUFBRTtZQUMzRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXO1lBQ25DLGVBQWUsRUFBRTtnQkFDZiw2QkFBNkIsRUFBRSxLQUFLO2dCQUNwQyw4QkFBOEIsRUFBRSxLQUFLO2FBQ3RDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLGtCQUFrQixDQUN4QixZQUF3RDtRQUV4RCxnQ0FBZ0M7UUFDaEMsSUFBSSxZQUFZLEtBQUssU0FBUyxFQUFFO1lBQzlCLE9BQU87U0FDUjtRQUVELDRGQUE0RjtRQUM1Rix5RkFBeUY7UUFDekYsK0VBQStFO1FBQy9FLDhGQUE4RjtRQUM5RixvREFBb0Q7UUFDcEQsaUdBQWlHO1FBQ2pHLGlHQUFpRztRQUNqRyxrR0FBa0c7UUFDbEcsc0JBQXNCO1FBRXRCLElBQUksVUFBVSxFQUNaLFVBQVUsRUFDVixnQkFBZ0IsRUFDaEIsV0FBVyxFQUNYLGNBQWMsRUFDZCxRQUFRLEVBQ1IsWUFBWSxFQUNaLElBQUksRUFDSixjQUFjLENBQUM7UUFFakIscUJBQXFCO1FBQ3JCLGNBQWM7UUFDZCxxQkFBcUI7UUFFckIsaUNBQWlDO1FBQ2pDLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxFQUFFO1lBQ3BDLDJDQUEyQztZQUMzQyx3RUFBd0U7WUFDeEUsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFDeEMsTUFBTSxJQUFJLEtBQUssQ0FDYiw0RkFBNEYsQ0FDN0YsQ0FBQzthQUNIO1lBRUQsVUFBVSxHQUFHLFlBQVksQ0FBQztZQUMxQixJQUFJLENBQUMsMkJBQTJCLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDN0MsZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQy9EO1FBRUQsMkNBQTJDO2FBQ3RDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFO1lBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsb0RBQW9ELENBQUMsQ0FBQztTQUN2RTtRQUVELDRDQUE0QzthQUN2QyxJQUFJLE9BQU8sWUFBWSxDQUFDLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDcEQsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7WUFFckMsZ0NBQWdDO1lBQ2hDLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUNuRCw0RUFBNEU7Z0JBQzVFLCtEQUErRDtnQkFDL0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUU7b0JBQzVCLE1BQU0sSUFBSSxLQUFLLENBQ2IsNEZBQTRGLENBQzdGLENBQUM7aUJBQ0g7Z0JBQ0QsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7YUFDdEM7aUJBQU07Z0JBQ0wsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7Z0JBQ3JDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUM5QztZQUVELGdDQUFnQztZQUNoQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRTtnQkFDNUIsZ0JBQWdCLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzdEO2lCQUFNLElBQUksT0FBTyxZQUFZLENBQUMsVUFBVSxLQUFLLFFBQVEsRUFBRTtnQkFDdEQsZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQzthQUM1QztpQkFBTTtnQkFDTCxVQUFVLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQzthQUN0QztZQUVELFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO1lBQ3ZDLFFBQVEsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDO1lBQzdCLFlBQVksR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDO1lBQ3pDLElBQUksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDO1lBQ3pCLGNBQWMsR0FBRyxZQUFZLENBQUMsY0FBYyxDQUFDO1NBQzlDO1FBRUQsK0NBQStDO2FBQzFDO1lBQ0gsY0FBYyxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7WUFFekMsc0NBQXNDO1lBQ3RDLElBQUksY0FBYyxJQUFJLFlBQVksQ0FBQyxVQUFVLEVBQUU7Z0JBQzdDLE1BQU0sSUFBSSxLQUFLLENBQ2Isd0VBQXdFLENBQ3pFLENBQUM7YUFDSDtZQUNELElBQUksY0FBYyxJQUFJLFlBQVksQ0FBQyxXQUFXLEVBQUU7Z0JBQzlDLE1BQU0sSUFBSSxLQUFLLENBQ2IseUVBQXlFLENBQzFFLENBQUM7YUFDSDtZQUNELElBQUksY0FBYyxJQUFJLFlBQVksQ0FBQyxZQUFZLEVBQUU7Z0JBQy9DLE1BQU0sSUFBSSxLQUFLLENBQ2IsMEVBQTBFLENBQzNFLENBQUM7YUFDSDtZQUNELElBQUksY0FBYyxJQUFJLFlBQVksQ0FBQyxJQUFJLEVBQUU7Z0JBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQ2Isa0VBQWtFLENBQ25FLENBQUM7YUFDSDtZQUNELElBQUksY0FBYyxJQUFJLFlBQVksQ0FBQyxjQUFjLEVBQUU7Z0JBQ2pELE1BQU0sSUFBSSxLQUFLLENBQ2IsNEVBQTRFLENBQzdFLENBQUM7YUFDSDtZQUVELFFBQVEsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDO1NBQzlCO1FBRUQscUJBQXFCO1FBQ3JCLG1CQUFtQjtRQUNuQixxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGNBQWMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNsQyxzQkFBc0I7WUFDdEIsSUFBSSxDQUFDLFVBQVUsSUFBSSxnQkFBZ0IsRUFBRTtnQkFDbkMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7b0JBQzdELFVBQVUsRUFBRSxnQkFBZ0I7aUJBQzdCLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFFRCxxQkFBcUI7UUFDckIscUJBQXFCO1FBQ3JCLHFCQUFxQjtRQUNyQixJQUFJLENBQUMsY0FBYyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ25DLElBQUksWUFBWSxLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFO2dCQUMzQyxXQUFXLEdBQUcsSUFBSSxHQUFHLENBQUMsdUJBQXVCLENBQzNDLElBQUksRUFDSix3QkFBd0IsRUFDeEI7b0JBQ0UsVUFBVSxFQUFFLFVBQW9CO29CQUNoQyxVQUFVLEVBQUUsVUFBaUM7b0JBQzdDLE1BQU0sRUFBRSxXQUFXO2lCQUNwQixDQUNGLENBQUM7YUFDSDtpQkFBTTtnQkFDTCxXQUFXLEdBQUcsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUU7b0JBQ3JELFVBQVUsRUFBRSxVQUFvQjtvQkFDaEMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO2lCQUMxRCxDQUFDLENBQUM7YUFDSjtZQUNELElBQUksQ0FBQyxjQUFjLEdBQUcsV0FBVyxDQUFDO1NBQ25DO1FBRUQscUJBQXFCO1FBQ3JCLGlDQUFpQztRQUNqQyxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGNBQWMsSUFBSSxVQUFVLEVBQUU7WUFDakMsc0NBQXNDO1lBQ3RDLGNBQWMsR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRTtnQkFDdkQsVUFBVTtnQkFDVixXQUFXLEVBQUUsV0FBK0I7Z0JBQzVDLFlBQVk7Z0JBQ1osSUFBSTtnQkFDSixjQUFjO2FBQ2YsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGNBQWMsQ0FBQztZQUV2QyxvQkFBb0I7WUFDcEIsSUFBSSxDQUFDLGNBQWMsQ0FDakIsVUFBaUMsRUFDakMsVUFBVSxFQUNWLGNBQWMsQ0FDZixDQUFDO1NBQ0g7UUFFRCxxQkFBcUI7UUFDckIsc0JBQXNCO1FBQ3RCLHFCQUFxQjtRQUNyQixJQUFJLGNBQWMsRUFBRTtZQUNsQixJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtnQkFDekMsVUFBVSxFQUFFLGNBQWM7Z0JBQzFCLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztnQkFDckIsUUFBUTthQUNULENBQUMsQ0FBQztTQUNKO1FBRUQsdUVBQXVFO1FBQ3ZFLDBFQUEwRTtRQUMxRSxJQUFJLFVBQVUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3JELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRO2dCQUM5QixDQUFDLENBQUMsV0FBVyxVQUFVLElBQUksUUFBUSxHQUFHO2dCQUN0QyxDQUFDLENBQUMsV0FBVyxVQUFVLEVBQUUsQ0FBQztTQUM3QjtJQUNILENBQUM7SUFFTyxjQUFjLENBQ3BCLFVBQStCLEVBQy9CLFVBQWtCLEVBQ2xCLFVBQTRCO1FBRTVCLG9CQUFvQjtRQUNwQixNQUFNLFdBQVcsR0FBRztZQUNsQixVQUFVLEVBQUUsVUFBVTtZQUN0QixJQUFJLEVBQUUsVUFBaUM7WUFDdkMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUNwQyxJQUFJLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FDaEQ7U0FDRixDQUFDO1FBQ0YsTUFBTSxPQUFPLEdBQUc7WUFDZCxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxXQUFXLENBQUM7WUFDckQsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxXQUFXLENBQUM7U0FDN0QsQ0FBQztRQUNGLDRFQUE0RTtRQUM1RSw2RUFBNkU7UUFDN0Usd0VBQXdFO1FBQ3hFLDJFQUEyRTtRQUMzRSwwQ0FBMEM7UUFDMUMsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUN0QyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7Z0JBQ3pCLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBb0MsQ0FBQztnQkFDbkUsU0FBUyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFTyxlQUFlLENBQUMsU0FBcUM7UUFDM0QsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUN0QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUNuRCxJQUFJLEVBQ0osWUFBWSxJQUFJLEVBQUUsRUFDbEI7Z0JBQ0UsSUFBSTtnQkFDSixVQUFVLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQztnQkFDM0IsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2FBQ3RCLENBQ0YsQ0FBQztZQUNGLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sa0JBQWtCLENBQUMsSUFBWTtRQUNyQyx1Q0FBdUM7UUFDdkMsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDaEMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDckM7UUFFRCxrREFBa0Q7UUFDbEQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixLQUFLLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QyxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEQsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ3ZDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDLGVBQWUsQ0FDeEQsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQ3pCLENBQUM7YUFDSDtTQUNGO1FBRUQsdURBQXVEO1FBQ3ZELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTyxRQUFRLENBQ2QsS0FBZ0IsRUFDaEIsUUFBZ0IsRUFDaEIsVUFBMEQ7UUFFMUQsdUJBQXVCO1FBQ3ZCLE1BQU0sVUFBVSxHQUFHLENBQ2pCLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxVQUF1QyxDQUFDO1lBQ3JFLENBQUMsQ0FBQyxVQUFVO1lBQ1osQ0FBQyxDQUFDO2dCQUNFLFFBQVEsRUFBRSxVQUFnQzthQUMzQyxDQUN1QixDQUFDO1FBRS9CLHFCQUFxQjtRQUNyQixRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM1QixNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixRQUFRLEdBQUcsQ0FBQyxDQUFDO1NBQzdEO1FBRUQsbUJBQW1CO1FBQ25CLHNCQUFzQjtRQUN0QixtQkFBbUI7UUFDbkIsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQyxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLFFBQVEsRUFBRSxDQUFDLENBQUM7U0FDOUM7UUFDRCxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDakQsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsUUFBUSxHQUFHLENBQUMsQ0FBQztTQUM3RDtRQUNELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsUUFBUSxHQUFHLENBQUMsQ0FBQztTQUMzRDtRQUVELG1CQUFtQjtRQUNuQixtQkFBbUI7UUFDbkIsbUJBQW1CO1FBQ25CLElBQUksUUFBUSxDQUFDO1FBQ2IsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQzlCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FDNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUN2QyxDQUFDO1lBQ0YsUUFBUSxHQUFHLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUMxRDthQUFNO1lBQ0wsUUFBUSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQztRQUVELG1CQUFtQjtRQUNuQixnQkFBZ0I7UUFDaEIsbUJBQW1CO1FBQ25CLE1BQU0sTUFBTSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUM5QixLQUFLLEVBQ0wsVUFBVSxTQUFTLElBQUksSUFBSSxFQUFFLEVBQzdCLFVBQVUsQ0FBQyxRQUFRLEVBQ25CLElBQUksQ0FBQyxvQkFBb0IsRUFDekIsOE5BQThOLENBQy9OLENBQUM7UUFDRixNQUFNLFdBQVcsR0FBRyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FDNUMsTUFBTSxFQUNOLFVBQVUsQ0FBQyxrQkFBa0IsQ0FDOUIsQ0FBQztRQUNGLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FDaEQsVUFBVSxDQUFDLGFBQWEsQ0FDekIsQ0FBQztRQUNGLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUUxRSw0RUFBNEU7UUFDNUUsd0VBQXdFO1FBQ3hFLCtDQUErQztRQUMvQyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxNQUFNLENBQUMsY0FBYyxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtnQkFDbkQsWUFBWSxFQUFFLElBQUk7YUFDbkIsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxtQkFBbUI7UUFDbkIsc0VBQXNFO1FBQ3RFLG1CQUFtQjtRQUNuQixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3JFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUNqRDtRQUVELG1CQUFtQjtRQUNuQixpQkFBaUI7UUFDakIsbUJBQW1CO1FBQ25CLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBRWxDLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFTyx1QkFBdUIsQ0FDN0IsT0FBNEI7UUFFNUIsdUJBQXVCO1FBQ3ZCLE1BQU0sYUFBYSxtQkFDakIsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLHdCQUF3QixJQUM3QyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FDbkIsQ0FBQztRQUVGLHlCQUF5QjtRQUN6QixJQUNFLGFBQWEsQ0FBQyxpQkFBaUIsS0FBSyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSTtZQUMvRCxhQUFhLENBQUMsaUJBQWlCLEtBQUssSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFDOUQ7WUFDQSxhQUFhLENBQUMsVUFBVTtnQkFDdEIsYUFBYSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUM7WUFDckQsYUFBYSxDQUFDLG1CQUFtQjtnQkFDL0IsYUFBYSxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQywwQkFBMEIsQ0FBQztTQUN4RTtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyx5QkFBeUIsQ0FDL0IsTUFBaUM7UUFFakMsT0FBTyxNQUFNLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQztJQUN2QyxDQUFDO0lBRU8saUJBQWlCLENBQUMsUUFBZ0I7UUFDeEMsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sMkJBQTJCLENBQUMsVUFBa0I7UUFDcEQsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUM3RDtJQUNILENBQUM7Q0FDRjtBQXBwQkQsMENBb3BCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCAqIGFzIGFwaWcgZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5XCI7XG5pbXBvcnQgKiBhcyBhcGlnVjFBY2Nlc3NMb2cgZnJvbSBcIi4vdXRpbC9hcGlHYXRld2F5VjFBY2Nlc3NMb2dcIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBnZXRGdW5jdGlvblJlZiwgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuXG5jb25zdCBhbGxvd2VkTWV0aG9kcyA9IFtcbiAgXCJBTllcIixcbiAgXCJHRVRcIixcbiAgXCJQVVRcIixcbiAgXCJQT1NUXCIsXG4gIFwiSEVBRFwiLFxuICBcIlBBVENIXCIsXG4gIFwiREVMRVRFXCIsXG4gIFwiT1BUSU9OU1wiLFxuXTtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBBcGlHYXRld2F5VjFBcGlQcm9wcyB7XG4gIHJlYWRvbmx5IHJlc3RBcGk/OiBhcGlnLklSZXN0QXBpIHwgYXBpZy5SZXN0QXBpUHJvcHM7XG4gIHJlYWRvbmx5IHJvdXRlcz86IHtcbiAgICBba2V5OiBzdHJpbmddOiBGdW5jdGlvbkRlZmluaXRpb24gfCBBcGlHYXRld2F5VjFBcGlSb3V0ZVByb3BzO1xuICB9O1xuICByZWFkb25seSBjb3JzPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgYWNjZXNzTG9nPzogYm9vbGVhbiB8IHN0cmluZyB8IEFwaUdhdGV3YXlWMUFwaUFjY2Nlc3NMb2dQcm9wcztcbiAgcmVhZG9ubHkgY3VzdG9tRG9tYWluPzogc3RyaW5nIHwgQXBpR2F0ZXdheVYxQXBpQ3VzdG9tRG9tYWluUHJvcHM7XG4gIHJlYWRvbmx5IGltcG9ydGVkUGF0aHM/OiB7IFtwYXRoOiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemVyPzogYXBpZy5JQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlPzogYXBpZy5BdXRob3JpemF0aW9uVHlwZTtcbiAgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM/OiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcGlHYXRld2F5VjFBcGlSb3V0ZVByb3BzIHtcbiAgcmVhZG9ubHkgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgbWV0aG9kT3B0aW9ucz86IGFwaWcuTWV0aG9kT3B0aW9ucztcbiAgcmVhZG9ubHkgaW50ZWdyYXRpb25PcHRpb25zPzogYXBpZy5MYW1iZGFJbnRlZ3JhdGlvbk9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpR2F0ZXdheVYxQXBpQ3VzdG9tRG9tYWluUHJvcHMge1xuICByZWFkb25seSBkb21haW5OYW1lOiBzdHJpbmcgfCBhcGlnLklEb21haW5OYW1lO1xuICByZWFkb25seSBob3N0ZWRab25lPzogc3RyaW5nIHwgcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgcmVhZG9ubHkgY2VydGlmaWNhdGU/OiBhY20uSUNlcnRpZmljYXRlO1xuICByZWFkb25seSBwYXRoPzogc3RyaW5nO1xuICByZWFkb25seSBlbmRwb2ludFR5cGU/OiBhcGlnLkVuZHBvaW50VHlwZTtcbiAgcmVhZG9ubHkgbXRscz86IGFwaWcuTVRMU0NvbmZpZztcbiAgcmVhZG9ubHkgc2VjdXJpdHlQb2xpY3k/OiBhcGlnLlNlY3VyaXR5UG9saWN5O1xufVxuXG5leHBvcnQgdHlwZSBBcGlHYXRld2F5VjFBcGlBY2NjZXNzTG9nUHJvcHMgPSBhcGlnVjFBY2Nlc3NMb2cuQWNjZXNzTG9nUHJvcHM7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGNsYXNzIEFwaUdhdGV3YXlWMUFwaSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSByZXN0QXBpOiBhcGlnLlJlc3RBcGk7XG4gIHB1YmxpYyBhY2Nlc3NMb2dHcm91cD86IGxvZ3MuTG9nR3JvdXA7XG4gIHB1YmxpYyBhcGlHYXRld2F5RG9tYWluPzogYXBpZy5Eb21haW5OYW1lO1xuICBwdWJsaWMgYWNtQ2VydGlmaWNhdGU/OiBhY20uQ2VydGlmaWNhdGUgfCBhY20uRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGU7XG4gIHByaXZhdGUgX2RlcGxveW1lbnQ/OiBhcGlnLkRlcGxveW1lbnQ7XG4gIHByaXZhdGUgX2N1c3RvbURvbWFpblVybD86IHN0cmluZztcbiAgcHJpdmF0ZSBpbXBvcnRlZFJlc291cmNlczogeyBbcGF0aDogc3RyaW5nXTogYXBpZy5JUmVzb3VyY2UgfTtcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbnM6IHsgW2tleTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXV0aG9yaXplcj86IGFwaWcuSUF1dGhvcml6ZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlPzogYXBpZy5BdXRob3JpemF0aW9uVHlwZTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogQXBpR2F0ZXdheVYxQXBpUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qge1xuICAgICAgcmVzdEFwaSxcbiAgICAgIHJvdXRlcyxcbiAgICAgIGNvcnMsXG4gICAgICBhY2Nlc3NMb2csXG4gICAgICBjdXN0b21Eb21haW4sXG4gICAgICBpbXBvcnRlZFBhdGhzLFxuICAgICAgZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICBkZWZhdWx0QXV0aG9yaXplcixcbiAgICAgIGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSxcbiAgICAgIGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzLFxuICAgIH0gPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLmZ1bmN0aW9ucyA9IHt9O1xuICAgIHRoaXMuaW1wb3J0ZWRSZXNvdXJjZXMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG4gICAgdGhpcy5kZWZhdWx0QXV0aG9yaXplciA9IGRlZmF1bHRBdXRob3JpemVyO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlID0gZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXMgPSBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEFwaVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoaXNDREtDb25zdHJ1Y3QocmVzdEFwaSkpIHtcbiAgICAgIGlmIChjb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNvcnNcIiB3aGVuIHRoZSBcInJlc3RBcGlcIiBpcyBpbXBvcnRlZGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiYWNjZXNzTG9nXCIgd2hlbiB0aGUgXCJyZXN0QXBpXCIgaXMgaW1wb3J0ZWRgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImN1c3RvbURvbWFpblwiIHdoZW4gdGhlIFwicmVzdEFwaVwiIGlzIGltcG9ydGVkYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5yZXN0QXBpID0gcmVzdEFwaSBhcyBhcGlnLlJlc3RBcGk7XG5cbiAgICAgIC8vIENyZWF0ZSBhbiBBUEkgR2F0ZXdheSBkZXBsb3ltZW50IHJlc291cmNlIHRvIHRyaWdnZXIgYSBkZXBsb3ltZW50XG4gICAgICB0aGlzLl9kZXBsb3ltZW50ID0gbmV3IGFwaWcuRGVwbG95bWVudCh0aGlzLCBcIkRlcGxveW1lbnRcIiwge1xuICAgICAgICBhcGk6IHRoaXMucmVzdEFwaSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgY2ZuRGVwbG95bWVudCA9IHRoaXMuX2RlcGxveW1lbnQubm9kZVxuICAgICAgICAuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuRGVwbG95bWVudDtcbiAgICAgIGNmbkRlcGxveW1lbnQuc3RhZ2VOYW1lID0gcm9vdC5zdGFnZTtcblxuICAgICAgaWYgKGltcG9ydGVkUGF0aHMpIHtcbiAgICAgICAgdGhpcy5pbXBvcnRSZXNvdXJjZXMoaW1wb3J0ZWRQYXRocyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJlc3RBcGlQcm9wcyA9IChyZXN0QXBpIHx8IHt9KSBhcyBhcGlnLlJlc3RBcGlQcm9wcztcblxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGlmIChpbXBvcnRlZFBhdGhzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgaW1wb3J0IHJvdXRlIHBhdGhzIHdoZW4gY3JlYXRpbmcgYSBuZXcgQVBJLmApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkICYmIHJlc3RBcGlQcm9wcy5kb21haW5OYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBVc2UgZWl0aGVyIHRoZSBcImN1c3RvbURvbWFpblwiIG9yIHRoZSBcInJlc3RBcGkuZG9tYWluTmFtZVwiIHRvIGNvbmZpZ3VyZSB0aGUgQXBpIGRvbWFpbi4gRG8gbm90IHVzZSBib3RoLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgY29ycyAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgIHJlc3RBcGlQcm9wcy5kZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnMgIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJjb3JzXCIgb3IgdGhlIFwicmVzdEFwaS5kZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnNcIiB0byBjb25maWd1cmUgdGhlIEFwaSdzIENPUlMgY29uZmlnLiBEbyBub3QgdXNlIGJvdGguYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uYWNjZXNzTG9nRGVzdGluYXRpb24gIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJhY2Nlc3NMb2dcIiBvciB0aGUgXCJyZXN0QXBpLmRlcGxveU9wdGlvbnMuYWNjZXNzTG9nRGVzdGluYXRpb25cIiB0byBjb25maWd1cmUgdGhlIEFwaSdzIGFjY2VzcyBsb2cuIERvIG5vdCB1c2UgYm90aC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGFjY2Vzc0xvZyAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgIHJlc3RBcGlQcm9wcy5kZXBsb3lPcHRpb25zPy5hY2Nlc3NMb2dGb3JtYXQgIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJhY2Nlc3NMb2dcIiBvciB0aGUgXCJyZXN0QXBpLmRlcGxveU9wdGlvbnMuYWNjZXNzTG9nRm9ybWF0XCIgdG8gY29uZmlndXJlIHRoZSBBcGkncyBhY2Nlc3MgbG9nLiBEbyBub3QgdXNlIGJvdGguYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdGFnZU5hbWUgPVxuICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uc3RhZ2VOYW1lIHx8ICh0aGlzLm5vZGUucm9vdCBhcyBBcHApLnN0YWdlO1xuXG4gICAgICBjb25zdCBhY2Nlc3NMb2dEYXRhID0gYXBpZ1YxQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YSh0aGlzLCBhY2Nlc3NMb2cpO1xuXG4gICAgICB0aGlzLmFjY2Vzc0xvZ0dyb3VwID0gYWNjZXNzTG9nRGF0YT8ubG9nR3JvdXA7XG5cbiAgICAgIHRoaXMucmVzdEFwaSA9IG5ldyBhcGlnLlJlc3RBcGkodGhpcywgXCJBcGlcIiwge1xuICAgICAgICByZXN0QXBpTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4ucmVzdEFwaVByb3BzLFxuICAgICAgICBkb21haW5OYW1lOiByZXN0QXBpUHJvcHMuZG9tYWluTmFtZSxcbiAgICAgICAgZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zOlxuICAgICAgICAgIHJlc3RBcGlQcm9wcy5kZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnMgfHxcbiAgICAgICAgICB0aGlzLmJ1aWxkQ29yc0NvbmZpZyhjb3JzKSxcbiAgICAgICAgZGVwbG95T3B0aW9uczoge1xuICAgICAgICAgIC4uLihyZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucyB8fCB7fSksXG4gICAgICAgICAgYWNjZXNzTG9nRGVzdGluYXRpb246XG4gICAgICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uYWNjZXNzTG9nRGVzdGluYXRpb24gfHxcbiAgICAgICAgICAgIGFjY2Vzc0xvZ0RhdGE/LmRlc3RpbmF0aW9uLFxuICAgICAgICAgIGFjY2Vzc0xvZ0Zvcm1hdDpcbiAgICAgICAgICAgIHJlc3RBcGlQcm9wcy5kZXBsb3lPcHRpb25zPy5hY2Nlc3NMb2dGb3JtYXQgfHxcbiAgICAgICAgICAgIGFjY2Vzc0xvZ0RhdGE/LmZvcm1hdCxcblxuICAgICAgICAgIC8vIGRlZmF1bHQgdG8gdGhlIG5hbWUgb2YgdGhlIHNhZ2VcbiAgICAgICAgICBzdGFnZU5hbWU6IHN0YWdlTmFtZSxcblxuICAgICAgICAgIC8vIGRlZmF1bHQgdG8gdHJ1ZVxuICAgICAgICAgIHRyYWNpbmdFbmFibGVkOlxuICAgICAgICAgICAgcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LnRyYWNpbmdFbmFibGVkID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgPyB0cnVlXG4gICAgICAgICAgICAgIDogcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LnRyYWNpbmdFbmFibGVkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY3JlYXRlQ3VzdG9tRG9tYWluKGN1c3RvbURvbWFpbik7XG4gICAgICB0aGlzLmNyZWF0ZUdhdGV3YXlSZXNwb25zZUZvckNvcnMoY29ycyk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIHJvdXRlc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKHJvdXRlcykge1xuICAgICAgT2JqZWN0LmtleXMocm91dGVzKS5mb3JFYWNoKChyb3V0ZUtleTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZFJvdXRlKHRoaXMsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0IHVybCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJlc3RBcGkudXJsO1xuICB9XG5cbiAgcHVibGljIGdldCBjdXN0b21Eb21haW5VcmwoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fY3VzdG9tRG9tYWluVXJsO1xuICB9XG5cbiAgcHVibGljIGdldCByb3V0ZXMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmZ1bmN0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYWRkUm91dGVzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcm91dGVzOiB7XG4gICAgICBba2V5OiBzdHJpbmddOiBGdW5jdGlvbkRlZmluaXRpb24gfCBBcGlHYXRld2F5VjFBcGlSb3V0ZVByb3BzO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMocm91dGVzKS5mb3JFYWNoKChyb3V0ZUtleTogc3RyaW5nKSA9PiB7XG4gICAgICAvLyBhZGQgcm91dGVcbiAgICAgIGNvbnN0IGZuID0gdGhpcy5hZGRSb3V0ZShzY29wZSwgcm91dGVLZXksIHJvdXRlc1tyb3V0ZUtleV0pO1xuXG4gICAgICAvLyBhdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PlxuICAgICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RnVuY3Rpb24ocm91dGVLZXk6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSldO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiQXBpR2F0ZXdheVYxQXBpXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGN1c3RvbURvbWFpblVybDogdGhpcy5fY3VzdG9tRG9tYWluVXJsLFxuICAgICAgICB1cmw6IHRoaXMucmVzdEFwaS51cmwsXG4gICAgICAgIHJlc3RBcGlJZDogdGhpcy5yZXN0QXBpLnJlc3RBcGlJZCxcbiAgICAgICAgcm91dGVzOiBPYmplY3QuZW50cmllcyh0aGlzLmZ1bmN0aW9ucykubWFwKChba2V5LCBkYXRhXSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByb3V0ZToga2V5LFxuICAgICAgICAgICAgZm46IGdldEZ1bmN0aW9uUmVmKGRhdGEpLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9Sb3V0ZShcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZ2V0RnVuY3Rpb24ocm91dGVLZXkpO1xuICAgIGlmICghZm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBhdHRhY2ggcGVybWlzc2lvbnMuIFJvdXRlIFwiJHtyb3V0ZUtleX1cIiBkb2VzIG5vdCBleGlzdC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDb3JzQ29uZmlnKGNvcnM/OiBib29sZWFuKTogYXBpZy5Db3JzT3B0aW9ucyB8IHVuZGVmaW5lZCB7XG4gICAgLy8gQ2FzZTogY29ycyBpcyBmYWxzZVxuICAgIGlmIChjb3JzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjb3JzIGlzIHRydWUgb3IgdW5kZWZpbmVkXG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93T3JpZ2luczogYXBpZy5Db3JzLkFMTF9PUklHSU5TLFxuICAgIH0gYXMgYXBpZy5Db3JzT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlR2F0ZXdheVJlc3BvbnNlRm9yQ29ycyhjb3JzPzogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICghY29ycykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucmVzdEFwaS5hZGRHYXRld2F5UmVzcG9uc2UoXCJHYXRld2F5UmVzcG9uc2VEZWZhdWx0NFhYXCIsIHtcbiAgICAgIHR5cGU6IGFwaWcuUmVzcG9uc2VUeXBlLkRFRkFVTFRfNFhYLFxuICAgICAgcmVzcG9uc2VIZWFkZXJzOiB7XG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiJyonXCIsXG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiOiBcIicqJ1wiLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMucmVzdEFwaS5hZGRHYXRld2F5UmVzcG9uc2UoXCJHYXRld2F5UmVzcG9uc2VEZWZhdWx0NVhYXCIsIHtcbiAgICAgIHR5cGU6IGFwaWcuUmVzcG9uc2VUeXBlLkRFRkFVTFRfNVhYLFxuICAgICAgcmVzcG9uc2VIZWFkZXJzOiB7XG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiJyonXCIsXG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiOiBcIicqJ1wiLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tRG9tYWluKFxuICAgIGN1c3RvbURvbWFpbj86IHN0cmluZyB8IEFwaUdhdGV3YXlWMUFwaUN1c3RvbURvbWFpblByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbiBpcyBub3Qgc2V0XG4gICAgaWYgKGN1c3RvbURvbWFpbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVG8gYmUgaW1wbGVtZW50ZWQ6IHRvIGFsbG93IG1vcmUgZmxleGlibGUgdXNlIGNhc2VzLCBTU1Qgc2hvdWxkIHN1cHBvcnQgMyBtb3JlIHVzZSBjYXNlczpcbiAgICAvLyAgMS4gQWxsb3cgdXNlciBwYXNzaW5nIGluIGBob3N0ZWRab25lYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyB3aGVuIHRoZXJlIGFyZSBtdWx0aXBsZVxuICAgIC8vICAgICBIb3N0ZWRab25lcyB3aXRoIHRoZSBzYW1lIGRvbWFpbiwgYnV0IG9uZSBpcyBwdWJsaWMsIGFuZCBvbmUgaXMgcHJpdmF0ZS5cbiAgICAvLyAgMi4gQWxsb3cgdXNlciBwYXNzaW5nIGluIGBjZXJ0aWZpY2F0ZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgZm9yIHVzZXIgdG8gY3JlYXRlIHdpbGRjYXJkXG4gICAgLy8gICAgIGNlcnRpZmljYXRlIG9yIHVzaW5nIGFuIGltcG9ydGVkIGNlcnRpZmljYXRlLlxuICAgIC8vICAzLiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGFwaWdEb21haW5OYW1lYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBhIHVzZXIgY3JlYXRlcyBtdWx0aXBsZSBBUElcbiAgICAvLyAgICAgZW5kcG9pbnRzLCBhbmQgaXMgbWFwcGluZyB0aGVtIHVuZGVyIHRoZSBzYW1lIGN1c3RvbSBkb21haW4uIGBzc3QuQXBpYCBuZWVkcyB0byBleHBvc2UgdGhlXG4gICAgLy8gICAgIGBhcGlnRG9tYWluTmFtZWAgY29uc3RydWN0IGNyZWF0ZWQgaW4gdGhlIGZpcnN0IEFwaSwgYW5kIGxldHMgdXNlciBwYXNzIGl0IGluIHdoZW4gY3JlYXRpbmdcbiAgICAvLyAgICAgdGhlIHNlY29uZCBBcGkuXG5cbiAgICBsZXQgZG9tYWluTmFtZSxcbiAgICAgIGhvc3RlZFpvbmUsXG4gICAgICBob3N0ZWRab25lRG9tYWluLFxuICAgICAgY2VydGlmaWNhdGUsXG4gICAgICBhcGlnRG9tYWluTmFtZSxcbiAgICAgIGJhc2VQYXRoLFxuICAgICAgZW5kcG9pbnRUeXBlLFxuICAgICAgbXRscyxcbiAgICAgIHNlY3VyaXR5UG9saWN5O1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUGFyc2UgaW5wdXRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbiBpcyBhIHN0cmluZ1xuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAvLyB2YWxpZGF0ZTogY3VzdG9tRG9tYWluIGlzIGEgVE9LRU4gc3RyaW5nXG4gICAgICAvLyBpZS4gaW1wb3J0ZWQgU1NNIHZhbHVlOiBzc20uU3RyaW5nUGFyYW1ldGVyLnZhbHVlRm9yU3RyaW5nUGFyYW1ldGVyKClcbiAgICAgIGlmIChjZGsuVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbikpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBZb3UgYWxzbyBuZWVkIHRvIHNwZWNpZnkgdGhlIFwiaG9zdGVkWm9uZVwiIGlmIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBwYXNzZWQgaW4gYXMgYSByZWZlcmVuY2UuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluO1xuICAgICAgdGhpcy5hc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZSk7XG4gICAgICBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLnNwbGl0KFwiLlwiKS5zbGljZSgxKS5qb2luKFwiLlwiKTtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBub3QgZXhpc3RzXG4gICAgZWxzZSBpZiAoIWN1c3RvbURvbWFpbi5kb21haW5OYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkb21haW5OYW1lXCIgaW4gQXBpJ3MgY3VzdG9tRG9tYWluIHNldHRpbmdgKTtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBhIHN0cmluZ1xuICAgIGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuXG4gICAgICAvLyBwYXJzZSBjdXN0b21Eb21haW4uZG9tYWluTmFtZVxuICAgICAgaWYgKGNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpKSB7XG4gICAgICAgIC8vIElmIGN1c3RvbURvbWFpbiBpcyBhIFRPS0VOIHN0cmluZywgXCJob3N0ZWRab25lXCIgaGFzIHRvIGJlIHBhc3NlZCBpbi4gVGhpc1xuICAgICAgICAvLyBpcyBiZWNhdXNlIFwiaG9zdGVkWm9uZVwiIGNhbm5vdCBiZSBwYXJzZWQgZnJvbSBhIFRPS0VOIHZhbHVlLlxuICAgICAgICBpZiAoIWN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFlvdSBhbHNvIG5lZWQgdG8gc3BlY2lmeSB0aGUgXCJob3N0ZWRab25lXCIgaWYgdGhlIFwiZG9tYWluTmFtZVwiIGlzIHBhc3NlZCBpbiBhcyBhIHJlZmVyZW5jZS5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICAgIHRoaXMuYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWUpO1xuICAgICAgfVxuXG4gICAgICAvLyBwYXJzZSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZVxuICAgICAgaWYgKCFjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICBob3N0ZWRab25lRG9tYWluID0gZG9tYWluTmFtZS5zcGxpdChcIi5cIikuc2xpY2UoMSkuam9pbihcIi5cIik7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgICB9XG5cbiAgICAgIGNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgICAgYmFzZVBhdGggPSBjdXN0b21Eb21haW4ucGF0aDtcbiAgICAgIGVuZHBvaW50VHlwZSA9IGN1c3RvbURvbWFpbi5lbmRwb2ludFR5cGU7XG4gICAgICBtdGxzID0gY3VzdG9tRG9tYWluLm10bHM7XG4gICAgICBzZWN1cml0eVBvbGljeSA9IGN1c3RvbURvbWFpbi5zZWN1cml0eVBvbGljeTtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBhIGNvbnN0cnVjdFxuICAgIGVsc2Uge1xuICAgICAgYXBpZ0RvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcblxuICAgICAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgaXMgaW1wb3J0ZWRcbiAgICAgIGlmIChhcGlnRG9tYWluTmFtZSAmJiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaG9zdGVkWm9uZVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2VydGlmaWNhdGVcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcGlnRG9tYWluTmFtZSAmJiBjdXN0b21Eb21haW4uZW5kcG9pbnRUeXBlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJlbmRwb2ludFR5cGVcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcGlnRG9tYWluTmFtZSAmJiBjdXN0b21Eb21haW4ubXRscykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwibXRsc1wiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5zZWN1cml0eVBvbGljeSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwic2VjdXJpdHlQb2xpY3lcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgYmFzZVBhdGggPSBjdXN0b21Eb21haW4ucGF0aDtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBGaW5kIGhvc3RlZCB6b25lXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKCFhcGlnRG9tYWluTmFtZSAmJiAhaG9zdGVkWm9uZSkge1xuICAgICAgLy8gTG9vayB1cCBob3N0ZWQgem9uZVxuICAgICAgaWYgKCFob3N0ZWRab25lICYmIGhvc3RlZFpvbmVEb21haW4pIHtcbiAgICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogaG9zdGVkWm9uZURvbWFpbixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGNlcnRpZmljYXRlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKCFhcGlnRG9tYWluTmFtZSAmJiAhY2VydGlmaWNhdGUpIHtcbiAgICAgIGlmIChlbmRwb2ludFR5cGUgPT09IGFwaWcuRW5kcG9pbnRUeXBlLkVER0UpIHtcbiAgICAgICAgY2VydGlmaWNhdGUgPSBuZXcgYWNtLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgXCJDcm9zc1JlZ2lvbkNlcnRpZmljYXRlXCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZG9tYWluTmFtZTogZG9tYWluTmFtZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBob3N0ZWRab25lOiBob3N0ZWRab25lIGFzIHJvdXRlNTMuSUhvc3RlZFpvbmUsXG4gICAgICAgICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2VydGlmaWNhdGUgPSBuZXcgYWNtLkNlcnRpZmljYXRlKHRoaXMsIFwiQ2VydGlmaWNhdGVcIiwge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGRvbWFpbk5hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgIHZhbGlkYXRpb246IGFjbS5DZXJ0aWZpY2F0ZVZhbGlkYXRpb24uZnJvbURucyhob3N0ZWRab25lKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLmFjbUNlcnRpZmljYXRlID0gY2VydGlmaWNhdGU7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEFQSSBHYXRld2F5IGRvbWFpbiBuYW1lXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKCFhcGlnRG9tYWluTmFtZSAmJiBkb21haW5OYW1lKSB7XG4gICAgICAvLyBDcmVhdGUgY3VzdG9tIGRvbWFpbiBpbiBBUEkgR2F0ZXdheVxuICAgICAgYXBpZ0RvbWFpbk5hbWUgPSBuZXcgYXBpZy5Eb21haW5OYW1lKHRoaXMsIFwiRG9tYWluTmFtZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWUsXG4gICAgICAgIGNlcnRpZmljYXRlOiBjZXJ0aWZpY2F0ZSBhcyBhY20uSUNlcnRpZmljYXRlLFxuICAgICAgICBlbmRwb2ludFR5cGUsXG4gICAgICAgIG10bHMsXG4gICAgICAgIHNlY3VyaXR5UG9saWN5LFxuICAgICAgfSk7XG4gICAgICB0aGlzLmFwaUdhdGV3YXlEb21haW4gPSBhcGlnRG9tYWluTmFtZTtcblxuICAgICAgLy8gQ3JlYXRlIEROUyByZWNvcmRcbiAgICAgIHRoaXMuY3JlYXRlQVJlY29yZHMoXG4gICAgICAgIGhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgICAgICAgZG9tYWluTmFtZSxcbiAgICAgICAgYXBpZ0RvbWFpbk5hbWVcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGJhc2UgbWFwcGluZ1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGlmIChhcGlnRG9tYWluTmFtZSkge1xuICAgICAgbmV3IGFwaWcuQmFzZVBhdGhNYXBwaW5nKHRoaXMsIFwiQmFzZVBhdGhcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBhcGlnRG9tYWluTmFtZSxcbiAgICAgICAgcmVzdEFwaTogdGhpcy5yZXN0QXBpLFxuICAgICAgICBiYXNlUGF0aCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIE5vdGU6IFdlIG9ubHkga25vdyB0aGUgZnVsbCBjdXN0b20gZG9tYWluIGlmIGRvbWFpbk5hbWUgaXMgYSBzdHJpbmcuXG4gICAgLy8gICAgICAgX2N1c3RvbURvbWFpblVybCB3aWxsIGJlIHVuZGVmaW5lZCBpZiBhcGlnRG9tYWluTmFtZSBpcyBpbXBvcnRlZC5cbiAgICBpZiAoZG9tYWluTmFtZSAmJiAhY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgICAgdGhpcy5fY3VzdG9tRG9tYWluVXJsID0gYmFzZVBhdGhcbiAgICAgICAgPyBgaHR0cHM6Ly8ke2RvbWFpbk5hbWV9LyR7YmFzZVBhdGh9L2BcbiAgICAgICAgOiBgaHR0cHM6Ly8ke2RvbWFpbk5hbWV9YDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUFSZWNvcmRzKFxuICAgIGhvc3RlZFpvbmU6IHJvdXRlNTMuSUhvc3RlZFpvbmUsXG4gICAgZG9tYWluTmFtZTogc3RyaW5nLFxuICAgIGFwaWdEb21haW46IGFwaWcuSURvbWFpbk5hbWVcbiAgKSB7XG4gICAgLy8gY3JlYXRlIEROUyByZWNvcmRcbiAgICBjb25zdCByZWNvcmRQcm9wcyA9IHtcbiAgICAgIHJlY29yZE5hbWU6IGRvbWFpbk5hbWUsXG4gICAgICB6b25lOiBob3N0ZWRab25lIGFzIHJvdXRlNTMuSUhvc3RlZFpvbmUsXG4gICAgICB0YXJnZXQ6IHJvdXRlNTMuUmVjb3JkVGFyZ2V0LmZyb21BbGlhcyhcbiAgICAgICAgbmV3IHJvdXRlNTNUYXJnZXRzLkFwaUdhdGV3YXlEb21haW4oYXBpZ0RvbWFpbilcbiAgICAgICksXG4gICAgfTtcbiAgICBjb25zdCByZWNvcmRzID0gW1xuICAgICAgbmV3IHJvdXRlNTMuQVJlY29yZCh0aGlzLCBcIkFsaWFzUmVjb3JkXCIsIHJlY29yZFByb3BzKSxcbiAgICAgIG5ldyByb3V0ZTUzLkFhYWFSZWNvcmQodGhpcywgXCJBbGlhc1JlY29yZEFBQUFcIiwgcmVjb3JkUHJvcHMpLFxuICAgIF07XG4gICAgLy8gbm90ZTogSWYgZG9tYWluTmFtZSBpcyBhIFRPS0VOIHN0cmluZyBpZS4gJHtUT0tFTi4ufSwgdGhlIHJvdXRlNTMuQVJlY29yZFxuICAgIC8vICAgICAgIGNvbnN0cnVjdCB3aWxsIGFwcGVuZCBcIi4ke2hvc3RlZFpvbmVOYW1lfVwiIHRvIHRoZSBlbmQgb2YgdGhlIGRvbWFpbi5cbiAgICAvLyAgICAgICBUaGlzIGlzIGJlY2F1c2UgdGhlIGNvbnN0cnVjdCB0cmllcyB0byBjaGVjayBpZiB0aGUgcmVjb3JkIG5hbWVcbiAgICAvLyAgICAgICBlbmRzIHdpdGggdGhlIGRvbWFpbiBuYW1lLiBJZiBub3QsIGl0IHdpbGwgYXBwZW5kIHRoZSBkb21haW4gbmFtZS5cbiAgICAvLyAgICAgICBTbywgd2UgbmVlZCByZW1vdmUgdGhpcyBiZWhhdmlvci5cbiAgICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgICAgcmVjb3Jkcy5mb3JFYWNoKChyZWNvcmQpID0+IHtcbiAgICAgICAgY29uc3QgY2ZuUmVjb3JkID0gcmVjb3JkLm5vZGUuZGVmYXVsdENoaWxkIGFzIHJvdXRlNTMuQ2ZuUmVjb3JkU2V0O1xuICAgICAgICBjZm5SZWNvcmQubmFtZSA9IGRvbWFpbk5hbWU7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGltcG9ydFJlc291cmNlcyhyZXNvdXJjZXM6IHsgW3BhdGg6IHN0cmluZ106IHN0cmluZyB9KTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMocmVzb3VyY2VzKS5mb3JFYWNoKChwYXRoKSA9PiB7XG4gICAgICBjb25zdCByZXNvdXJjZSA9IGFwaWcuUmVzb3VyY2UuZnJvbVJlc291cmNlQXR0cmlidXRlcyhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYFJlc291cmNlXyR7cGF0aH1gLFxuICAgICAgICB7XG4gICAgICAgICAgcGF0aCxcbiAgICAgICAgICByZXNvdXJjZUlkOiByZXNvdXJjZXNbcGF0aF0sXG4gICAgICAgICAgcmVzdEFwaTogdGhpcy5yZXN0QXBpLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgdGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXRoXSA9IHJlc291cmNlO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZXNvdXJjZUZvclBhdGgocGF0aDogc3RyaW5nKTogYXBpZy5JUmVzb3VyY2Uge1xuICAgIC8vIExvb2t1cCBleGFjdCBtYXRjaCBpbXBvcnRlZCByZXNvdXJjZVxuICAgIGlmICh0aGlzLmltcG9ydGVkUmVzb3VyY2VzW3BhdGhdKSB7XG4gICAgICByZXR1cm4gdGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXRoXTtcbiAgICB9XG5cbiAgICAvLyBMb29rdXAgcGFyZW50cyBtYXRjaGluZyBpbXBvcnRlZCByZXNvdXJjZSBmaXJzdFxuICAgIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdChcIi9cIik7XG4gICAgZm9yIChsZXQgaSA9IHBhcnRzLmxlbmd0aDsgaSA+PSAxOyBpLS0pIHtcbiAgICAgIGNvbnN0IHBhcnRpYWxQYXRoID0gcGFydHMuc2xpY2UoMCwgaSkuam9pbihcIi9cIik7XG4gICAgICBpZiAodGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXJ0aWFsUGF0aF0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1wb3J0ZWRSZXNvdXJjZXNbcGFydGlhbFBhdGhdLnJlc291cmNlRm9yUGF0aChcbiAgICAgICAgICBwYXJ0cy5zbGljZShpKS5qb2luKFwiL1wiKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdCBjaGlsZCBvZiBpbXBvcnRlZCByZXNvdXJjZXMsIGNyZWF0ZSBvZmYgdGhlIHJvb3RcbiAgICByZXR1cm4gdGhpcy5yZXN0QXBpLnJvb3QucmVzb3VyY2VGb3JQYXRoKHBhdGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSb3V0ZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wc1xuICApOiBGbiB7XG4gICAgLy8gTm9ybWFsaXplIHJvdXRlUHJvcHNcbiAgICBjb25zdCByb3V0ZVByb3BzID0gKFxuICAgICAgdGhpcy5pc0luc3RhbmNlT2ZBcGlSb3V0ZVByb3BzKHJvdXRlVmFsdWUgYXMgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcylcbiAgICAgICAgPyByb3V0ZVZhbHVlXG4gICAgICAgIDoge1xuICAgICAgICAgICAgZnVuY3Rpb246IHJvdXRlVmFsdWUgYXMgRnVuY3Rpb25EZWZpbml0aW9uLFxuICAgICAgICAgIH1cbiAgICApIGFzIEFwaUdhdGV3YXlWMUFwaVJvdXRlUHJvcHM7XG5cbiAgICAvLyBOb3JtYWxpemUgcm91dGVLZXlcbiAgICByb3V0ZUtleSA9IHRoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpO1xuICAgIGlmICh0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSByb3V0ZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEdldCBwYXRoIGFuZCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3Qgcm91dGVLZXlQYXJ0cyA9IHJvdXRlS2V5LnNwbGl0KFwiIFwiKTtcbiAgICBpZiAocm91dGVLZXlQYXJ0cy5sZW5ndGggIT09IDIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByb3V0ZSAke3JvdXRlS2V5fWApO1xuICAgIH1cbiAgICBjb25zdCBtZXRob2RTdHIgPSByb3V0ZUtleVBhcnRzWzBdLnRvVXBwZXJDYXNlKCk7XG4gICAgY29uc3QgcGF0aCA9IHJvdXRlS2V5UGFydHNbMV07XG4gICAgY29uc3QgbWV0aG9kID0gYWxsb3dlZE1ldGhvZHMuZmluZCgocGVyKSA9PiBwZXIgPT09IG1ldGhvZFN0cik7XG4gICAgaWYgKCFtZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBtZXRob2QgZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBhdGggZGVmaW5lZCBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBSZXNvdXJjZXNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgbGV0IHJlc291cmNlO1xuICAgIGlmIChwYXRoLmVuZHNXaXRoKFwiL3twcm94eSt9XCIpKSB7XG4gICAgICBjb25zdCBwYXJlbnRSZXNvdXJjZSA9IHRoaXMuZ2V0UmVzb3VyY2VGb3JQYXRoKFxuICAgICAgICBwYXRoLnNwbGl0KFwiL1wiKS5zbGljZSgwLCAtMSkuam9pbihcIi9cIilcbiAgICAgICk7XG4gICAgICByZXNvdXJjZSA9IHBhcmVudFJlc291cmNlLmFkZFByb3h5KHsgYW55TWV0aG9kOiBmYWxzZSB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzb3VyY2UgPSB0aGlzLmdldFJlc291cmNlRm9yUGF0aChwYXRoKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIE1ldGhvZFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYExhbWJkYV8ke21ldGhvZFN0cn1fJHtwYXRofWAsXG4gICAgICByb3V0ZVByb3BzLmZ1bmN0aW9uLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHJvdXRlcyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgQXBpIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIGNvbnN0IGludGVncmF0aW9uID0gbmV3IGFwaWcuTGFtYmRhSW50ZWdyYXRpb24oXG4gICAgICBsYW1iZGEsXG4gICAgICByb3V0ZVByb3BzLmludGVncmF0aW9uT3B0aW9uc1xuICAgICk7XG4gICAgY29uc3QgbWV0aG9kT3B0aW9ucyA9IHRoaXMuYnVpbGRSb3V0ZU1ldGhvZE9wdGlvbnMoXG4gICAgICByb3V0ZVByb3BzLm1ldGhvZE9wdGlvbnNcbiAgICApO1xuICAgIGNvbnN0IGFwaWdNZXRob2QgPSByZXNvdXJjZS5hZGRNZXRob2QobWV0aG9kLCBpbnRlZ3JhdGlvbiwgbWV0aG9kT3B0aW9ucyk7XG5cbiAgICAvLyBBZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBmdW5jdGlvbiBpcyBhbiBBcGkgcm91dGUuXG4gICAgLy8gSWYgaXQgaXMsIHdoZW4gXCJzc3Qgc3RhcnRcIiBpcyBub3QgY29ubmVjdGVkLCB3ZSB3YW50IHRvIHJldHVybiBhbiA1MDBcbiAgICAvLyBzdGF0dXMgY29kZSBhbmQgYSBkZXNjcmlwdGl2ZSBlcnJvciBtZXNzYWdlLlxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGlmIChyb290LmxvY2FsKSB7XG4gICAgICBsYW1iZGEuYWRkRW52aXJvbm1lbnQoXCJTU1RfREVCVUdfSVNfQVBJX1JPVVRFXCIsIFwiMVwiLCB7XG4gICAgICAgIHJlbW92ZUluRWRnZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBIYW5kbGUgbWFudWFsbHkgY3JlYXRlZCBEZXBsb3ltZW50IHJlc291cmNlIChpZS4gaW1wb3J0ZWQgUkVTVCBBUEkpXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGlmICh0aGlzLl9kZXBsb3ltZW50KSB7XG4gICAgICB0aGlzLl9kZXBsb3ltZW50LmFkZFRvTG9naWNhbElkKHsgcm91dGU6IHsgcm91dGVLZXksIHJvdXRlVmFsdWUgfSB9KTtcbiAgICAgIHRoaXMuX2RlcGxveW1lbnQubm9kZS5hZGREZXBlbmRlbmN5KGFwaWdNZXRob2QpO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICB0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0gPSBsYW1iZGE7XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJvdXRlTWV0aG9kT3B0aW9ucyhcbiAgICBvcHRpb25zPzogYXBpZy5NZXRob2RPcHRpb25zXG4gICk6IGFwaWcuTWV0aG9kT3B0aW9ucyB7XG4gICAgLy8gTWVyZ2UgbWV0aG9kIG9wdGlvbnNcbiAgICBjb25zdCBtZXRob2RPcHRpb25zID0ge1xuICAgICAgYXV0aG9yaXphdGlvblR5cGU6IHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlLFxuICAgICAgLi4uKG9wdGlvbnMgfHwge30pLFxuICAgIH07XG5cbiAgICAvLyBTZXQgYXV0aG9yaXphdGlvbiBpbmZvXG4gICAgaWYgKFxuICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemF0aW9uVHlwZSAhPT0gYXBpZy5BdXRob3JpemF0aW9uVHlwZS5OT05FICYmXG4gICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25UeXBlICE9PSBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTVxuICAgICkge1xuICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemVyID1cbiAgICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemVyIHx8IHRoaXMuZGVmYXVsdEF1dGhvcml6ZXI7XG4gICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25TY29wZXMgPVxuICAgICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25TY29wZXMgfHwgdGhpcy5kZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcbiAgICB9XG5cbiAgICByZXR1cm4gbWV0aG9kT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgaXNJbnN0YW5jZU9mQXBpUm91dGVQcm9wcyhcbiAgICBvYmplY3Q6IEFwaUdhdGV3YXlWMUFwaVJvdXRlUHJvcHNcbiAgKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iamVjdC5mdW5jdGlvbiAhPT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcm91dGVLZXkuc3BsaXQoL1xccysvKS5qb2luKFwiIFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChkb21haW5OYW1lICE9PSBkb21haW5OYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGRvbWFpbiBuYW1lIG5lZWRzIHRvIGJlIGluIGxvd2VyY2FzZWApO1xuICAgIH1cbiAgfVxufVxuIl19