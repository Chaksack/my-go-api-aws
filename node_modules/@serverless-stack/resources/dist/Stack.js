"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Stack = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cdk = __importStar(require("aws-cdk-lib"));
const regionInfo = __importStar(require("aws-cdk-lib/region-info"));
const Function_1 = require("./Function");
const Construct_1 = require("./Construct");
class Stack extends cdk.Stack {
    constructor(scope, id, props) {
        const root = scope.node.root;
        const stackId = root.logicalPrefixedName(id);
        Stack.checkForPropsIsConstruct(id, props);
        Stack.checkForEnvInProps(id, props);
        super(scope, stackId, Object.assign(Object.assign({}, props), { env: {
                account: process.env.CDK_DEFAULT_ACCOUNT,
                region: root.region,
            } }));
        this.stage = root.stage;
        this.defaultFunctionProps = root.defaultFunctionProps.map((dfp) => typeof dfp === "function" ? dfp(this) : dfp);
        this.metadata = this.createMetadataResource();
    }
    setDefaultFunctionProps(props) {
        const fns = this.getAllFunctions();
        if (fns.length > 0)
            throw new Error("Default function props for the stack must be set before any functions have been added. Use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' instead to add more default properties.");
        this.defaultFunctionProps.push(props);
    }
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    getAllFunctions() {
        return this.doGetAllFunctions(this);
    }
    doGetAllFunctions(construct) {
        const results = [];
        for (const child of construct.node.children) {
            if (child instanceof Function_1.Function)
                results.push(child);
            results.push(...this.doGetAllFunctions(child));
        }
        return results;
    }
    addOutputs(outputs) {
        Object.keys(outputs).forEach((key) => {
            const value = outputs[key];
            if (value === undefined) {
                throw new Error(`The stack output "${key}" is undefined`);
            }
            else if (typeof value === "string") {
                new cdk.CfnOutput(this, key, { value });
            }
            else {
                new cdk.CfnOutput(this, key, value);
            }
        });
    }
    addConstructsMetadata(metadata) {
        this.metadata.addMetadata("sst:constructs", metadata);
    }
    createMetadataResource() {
        // Add a placeholder resource to ensure stacks with just an imported construct
        // has at least 1 resource, so the deployment succeeds.
        // For example: users often create a stack and use it to import a VPC. The
        //              stack does not have any resources.
        //
        // Note that the "AWS::CDK::Metadata" resource does not exist in GovCloud
        // and a few other regions. In this case, we will use the "AWS::SSM::Parameter"
        // resource. It does not matter what resource type we use. All we are interested
        // in is the Metadata.
        const props = this.isCDKMetadataResourceSupported()
            ? {
                type: "AWS::CDK::Metadata",
            }
            : {
                type: "AWS::SSM::Parameter",
                properties: {
                    Type: "String",
                    Name: `/sst/${this.stackName}`,
                    Value: "metadata-placeholder",
                    Description: "Parameter added by SST for storing stack metadata",
                },
            };
        const res = new cdk.CfnResource(this, "SSTMetadata", props);
        // Add version metadata
        const packageJson = fs.readJsonSync(path.join(__dirname, "..", "package.json"));
        res.addMetadata("sst:version", packageJson.version);
        return res;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForPropsIsConstruct(id, props) {
        // If a construct is passed in as stack props, let's detect it and throw a
        // friendlier error.
        if (props && (0, Construct_1.isConstruct)(props)) {
            throw new Error(`Expected an associative array as the stack props while initializing "${id}" stack. Received a construct instead.`);
        }
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForEnvInProps(id, props) {
        if (props && props.env) {
            let envS = "";
            try {
                envS = " (" + JSON.stringify(props.env) + ")";
            }
            catch (e) {
                // Ignore
            }
            throw new Error(`Do not set the "env" prop while initializing "${id}" stack${envS}. Use the "AWS_PROFILE" environment variable and "--region" CLI option instead.`);
        }
    }
    isCDKMetadataResourceSupported() {
        const app = this.node.root;
        // CDK Metadata resource currently not supported in the region
        if (!regionInfo.RegionInfo.get(app.region).cdkMetadataResourceAvailable) {
            return false;
        }
        // CDK Metadata resource used to not supported in the region
        // Note that b/c we cannot change the resource type of a given logical id,
        //           so if it used to not support, we will continue to mark it not
        //           supportd.
        if (['us-gov-east-1',
            'us-gov-west-1',
            'us-iso-east-1',
            'us-isob-east-1',
            'ap-northeast-3',
        ].includes(app.region)) {
            return false;
        }
        return true;
    }
}
exports.Stack = Stack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvU3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFDN0IsNkNBQStCO0FBRS9CLGlEQUFtQztBQUVuQyxvRUFBc0Q7QUFDdEQseUNBQTJEO0FBRTNELDJDQUEwQztBQUsxQyxNQUFhLEtBQU0sU0FBUSxHQUFHLENBQUMsS0FBSztJQUtsQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtCO1FBQzFELE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUU3QyxLQUFLLENBQUMsd0JBQXdCLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFcEMsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLGtDQUNmLEtBQUssS0FDUixHQUFHLEVBQUU7Z0JBQ0gsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO2dCQUN4QyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07YUFDcEIsSUFDRCxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FDaEUsT0FBTyxHQUFHLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FDNUMsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixF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QUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUVsQyw4REFBOEQ7UUFDOUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyw0QkFBNEIsRUFBRTtZQUN2RSxPQUFPLEtBQUssQ0FBQTtTQUNiO1FBRUQsNERBQTREO1FBQzVELDBFQUEwRTtRQUMxRSwwRUFBMEU7UUFDMUUsc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxlQUFlO1lBQ2xCLGVBQWU7WUFDZixlQUFlO1lBQ2YsZ0JBQWdCO1lBQ2hCLGdCQUFnQjtTQUNqQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDdEIsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGO0FBNUtELHNCQTRLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgQ29uc3RydWN0LCBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgcmVnaW9uSW5mbyBmcm9tIFwiYXdzLWNkay1saWIvcmVnaW9uLWluZm9cIjtcbmltcG9ydCB7IEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uIGFzIEZuIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgaXNDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbmV4cG9ydCB0eXBlIFN0YWNrUHJvcHMgPSBjZGsuU3RhY2tQcm9wcztcblxuZXhwb3J0IGNsYXNzIFN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgcHVibGljIHJlYWRvbmx5IHN0YWdlOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wczogRnVuY3Rpb25Qcm9wc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IG1ldGFkYXRhOiBjZGsuQ2ZuUmVzb3VyY2U7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qgc3RhY2tJZCA9IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCk7XG5cbiAgICBTdGFjay5jaGVja0ZvclByb3BzSXNDb25zdHJ1Y3QoaWQsIHByb3BzKTtcbiAgICBTdGFjay5jaGVja0ZvckVudkluUHJvcHMoaWQsIHByb3BzKTtcblxuICAgIHN1cGVyKHNjb3BlLCBzdGFja0lkLCB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIGVudjoge1xuICAgICAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgICAgICByZWdpb246IHJvb3QucmVnaW9uLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc3RhZ2UgPSByb290LnN0YWdlO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSByb290LmRlZmF1bHRGdW5jdGlvblByb3BzLm1hcCgoZGZwKSA9PlxuICAgICAgdHlwZW9mIGRmcCA9PT0gXCJmdW5jdGlvblwiID8gZGZwKHRoaXMpIDogZGZwXG4gICAgKTtcblxuICAgIHRoaXMubWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhUmVzb3VyY2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXREZWZhdWx0RnVuY3Rpb25Qcm9wcyhwcm9wczogRnVuY3Rpb25Qcm9wcyk6IHZvaWQge1xuICAgIGNvbnN0IGZucyA9IHRoaXMuZ2V0QWxsRnVuY3Rpb25zKCk7XG4gICAgaWYgKGZucy5sZW5ndGggPiAwKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIkRlZmF1bHQgZnVuY3Rpb24gcHJvcHMgZm9yIHRoZSBzdGFjayBtdXN0IGJlIHNldCBiZWZvcmUgYW55IGZ1bmN0aW9ucyBoYXZlIGJlZW4gYWRkZWQuIFVzZSAnYWRkRGVmYXVsdEZ1bmN0aW9uRW52JyBvciAnYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMnIGluc3RlYWQgdG8gYWRkIG1vcmUgZGVmYXVsdCBwcm9wZXJ0aWVzLlwiXG4gICAgICApO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaChwcm9wcyk7XG4gIH1cblxuICBwdWJsaWMgYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIHBlcm1pc3Npb25zLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZERlZmF1bHRGdW5jdGlvbkVudihlbnZpcm9ubWVudDogUmVjb3JkPHN0cmluZywgc3RyaW5nPikge1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaCh7XG4gICAgICBlbnZpcm9ubWVudCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhZGREZWZhdWx0RnVuY3Rpb25MYXllcnMobGF5ZXJzOiBsYW1iZGEuSUxheWVyVmVyc2lvbltdKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGxheWVycyxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRBbGxGdW5jdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZG9HZXRBbGxGdW5jdGlvbnModGhpcyk7XG4gIH1cblxuICBwcml2YXRlIGRvR2V0QWxsRnVuY3Rpb25zKGNvbnN0cnVjdDogSUNvbnN0cnVjdCkge1xuICAgIGNvbnN0IHJlc3VsdHM6IEZuW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIGNvbnN0cnVjdC5ub2RlLmNoaWxkcmVuKSB7XG4gICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBGbikgcmVzdWx0cy5wdXNoKGNoaWxkKTtcbiAgICAgIHJlc3VsdHMucHVzaCguLi50aGlzLmRvR2V0QWxsRnVuY3Rpb25zKGNoaWxkKSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgcHVibGljIGFkZE91dHB1dHMob3V0cHV0czoge1xuICAgIFtrZXk6IHN0cmluZ106IHN0cmluZyB8IGNkay5DZm5PdXRwdXRQcm9wcztcbiAgfSk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKG91dHB1dHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBvdXRwdXRzW2tleV07XG4gICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzdGFjayBvdXRwdXQgXCIke2tleX1cIiBpcyB1bmRlZmluZWRgKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIGtleSwgeyB2YWx1ZSB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIGtleSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZENvbnN0cnVjdHNNZXRhZGF0YShtZXRhZGF0YTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5tZXRhZGF0YS5hZGRNZXRhZGF0YShcInNzdDpjb25zdHJ1Y3RzXCIsIG1ldGFkYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWV0YWRhdGFSZXNvdXJjZSgpOiBjZGsuQ2ZuUmVzb3VyY2Uge1xuICAgIC8vIEFkZCBhIHBsYWNlaG9sZGVyIHJlc291cmNlIHRvIGVuc3VyZSBzdGFja3Mgd2l0aCBqdXN0IGFuIGltcG9ydGVkIGNvbnN0cnVjdFxuICAgIC8vIGhhcyBhdCBsZWFzdCAxIHJlc291cmNlLCBzbyB0aGUgZGVwbG95bWVudCBzdWNjZWVkcy5cbiAgICAvLyBGb3IgZXhhbXBsZTogdXNlcnMgb2Z0ZW4gY3JlYXRlIGEgc3RhY2sgYW5kIHVzZSBpdCB0byBpbXBvcnQgYSBWUEMuIFRoZVxuICAgIC8vICAgICAgICAgICAgICBzdGFjayBkb2VzIG5vdCBoYXZlIGFueSByZXNvdXJjZXMuXG4gICAgLy9cbiAgICAvLyBOb3RlIHRoYXQgdGhlIFwiQVdTOjpDREs6Ok1ldGFkYXRhXCIgcmVzb3VyY2UgZG9lcyBub3QgZXhpc3QgaW4gR292Q2xvdWRcbiAgICAvLyBhbmQgYSBmZXcgb3RoZXIgcmVnaW9ucy4gSW4gdGhpcyBjYXNlLCB3ZSB3aWxsIHVzZSB0aGUgXCJBV1M6OlNTTTo6UGFyYW1ldGVyXCJcbiAgICAvLyByZXNvdXJjZS4gSXQgZG9lcyBub3QgbWF0dGVyIHdoYXQgcmVzb3VyY2UgdHlwZSB3ZSB1c2UuIEFsbCB3ZSBhcmUgaW50ZXJlc3RlZFxuICAgIC8vIGluIGlzIHRoZSBNZXRhZGF0YS5cbiAgICBjb25zdCBwcm9wcyA9IHRoaXMuaXNDREtNZXRhZGF0YVJlc291cmNlU3VwcG9ydGVkKClcbiAgICAgID8ge1xuICAgICAgICB0eXBlOiBcIkFXUzo6Q0RLOjpNZXRhZGF0YVwiLFxuICAgICAgfVxuICAgICAgOiB7XG4gICAgICAgIHR5cGU6IFwiQVdTOjpTU006OlBhcmFtZXRlclwiLFxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgVHlwZTogXCJTdHJpbmdcIixcbiAgICAgICAgICBOYW1lOiBgL3NzdC8ke3RoaXMuc3RhY2tOYW1lfWAsXG4gICAgICAgICAgVmFsdWU6IFwibWV0YWRhdGEtcGxhY2Vob2xkZXJcIixcbiAgICAgICAgICBEZXNjcmlwdGlvbjogXCJQYXJhbWV0ZXIgYWRkZWQgYnkgU1NUIGZvciBzdG9yaW5nIHN0YWNrIG1ldGFkYXRhXCIsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIGNvbnN0IHJlcyA9IG5ldyBjZGsuQ2ZuUmVzb3VyY2UodGhpcywgXCJTU1RNZXRhZGF0YVwiLCBwcm9wcyk7XG4gICAgXG4gICAgLy8gQWRkIHZlcnNpb24gbWV0YWRhdGFcbiAgICBjb25zdCBwYWNrYWdlSnNvbiA9IGZzLnJlYWRKc29uU3luYyhcbiAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi5cIiwgXCJwYWNrYWdlLmpzb25cIilcbiAgICApO1xuICAgIHJlcy5hZGRNZXRhZGF0YShcInNzdDp2ZXJzaW9uXCIsIHBhY2thZ2VKc29uLnZlcnNpb24pO1xuXG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHByaXZhdGUgc3RhdGljIGNoZWNrRm9yUHJvcHNJc0NvbnN0cnVjdChpZDogc3RyaW5nLCBwcm9wcz86IGFueSkge1xuICAgIC8vIElmIGEgY29uc3RydWN0IGlzIHBhc3NlZCBpbiBhcyBzdGFjayBwcm9wcywgbGV0J3MgZGV0ZWN0IGl0IGFuZCB0aHJvdyBhXG4gICAgLy8gZnJpZW5kbGllciBlcnJvci5cbiAgICBpZiAocHJvcHMgJiYgaXNDb25zdHJ1Y3QocHJvcHMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBFeHBlY3RlZCBhbiBhc3NvY2lhdGl2ZSBhcnJheSBhcyB0aGUgc3RhY2sgcHJvcHMgd2hpbGUgaW5pdGlhbGl6aW5nIFwiJHtpZH1cIiBzdGFjay4gUmVjZWl2ZWQgYSBjb25zdHJ1Y3QgaW5zdGVhZC5gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHByaXZhdGUgc3RhdGljIGNoZWNrRm9yRW52SW5Qcm9wcyhpZDogc3RyaW5nLCBwcm9wcz86IGFueSkge1xuICAgIGlmIChwcm9wcyAmJiBwcm9wcy5lbnYpIHtcbiAgICAgIGxldCBlbnZTID0gXCJcIjtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgZW52UyA9IFwiIChcIiArIEpTT04uc3RyaW5naWZ5KHByb3BzLmVudikgKyBcIilcIjtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gSWdub3JlXG4gICAgICB9XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBzZXQgdGhlIFwiZW52XCIgcHJvcCB3aGlsZSBpbml0aWFsaXppbmcgXCIke2lkfVwiIHN0YWNrJHtlbnZTfS4gVXNlIHRoZSBcIkFXU19QUk9GSUxFXCIgZW52aXJvbm1lbnQgdmFyaWFibGUgYW5kIFwiLS1yZWdpb25cIiBDTEkgb3B0aW9uIGluc3RlYWQuYFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzQ0RLTWV0YWRhdGFSZXNvdXJjZVN1cHBvcnRlZCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBhcHAgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG5cbiAgICAvLyBDREsgTWV0YWRhdGEgcmVzb3VyY2UgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQgaW4gdGhlIHJlZ2lvblxuICAgIGlmICghcmVnaW9uSW5mby5SZWdpb25JbmZvLmdldChhcHAucmVnaW9uKS5jZGtNZXRhZGF0YVJlc291cmNlQXZhaWxhYmxlKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICAvLyBDREsgTWV0YWRhdGEgcmVzb3VyY2UgdXNlZCB0byBub3Qgc3VwcG9ydGVkIGluIHRoZSByZWdpb25cbiAgICAvLyBOb3RlIHRoYXQgYi9jIHdlIGNhbm5vdCBjaGFuZ2UgdGhlIHJlc291cmNlIHR5cGUgb2YgYSBnaXZlbiBsb2dpY2FsIGlkLFxuICAgIC8vICAgICAgICAgICBzbyBpZiBpdCB1c2VkIHRvIG5vdCBzdXBwb3J0LCB3ZSB3aWxsIGNvbnRpbnVlIHRvIG1hcmsgaXQgbm90XG4gICAgLy8gICAgICAgICAgIHN1cHBvcnRkLlxuICAgIGlmIChbJ3VzLWdvdi1lYXN0LTEnLFxuICAgICAgJ3VzLWdvdi13ZXN0LTEnLFxuICAgICAgJ3VzLWlzby1lYXN0LTEnLFxuICAgICAgJ3VzLWlzb2ItZWFzdC0xJyxcbiAgICAgICdhcC1ub3J0aGVhc3QtMycsXG4gICAgXS5pbmNsdWRlcyhhcHAucmVnaW9uKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG4iXX0=