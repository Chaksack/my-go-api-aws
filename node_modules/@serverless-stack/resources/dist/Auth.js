"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Auth = void 0;
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const cognito = __importStar(require("aws-cdk-lib/aws-cognito"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const permission_1 = require("./util/permission");
const AuthUserPoolTriggerOperationMapping = {
    createAuthChallenge: cognito.UserPoolOperation.CREATE_AUTH_CHALLENGE,
    customEmailSender: cognito.UserPoolOperation.CUSTOM_EMAIL_SENDER,
    customMessage: cognito.UserPoolOperation.CUSTOM_MESSAGE,
    customSmsSender: cognito.UserPoolOperation.CUSTOM_SMS_SENDER,
    defineAuthChallenge: cognito.UserPoolOperation.DEFINE_AUTH_CHALLENGE,
    postAuthentication: cognito.UserPoolOperation.POST_AUTHENTICATION,
    postConfirmation: cognito.UserPoolOperation.POST_CONFIRMATION,
    preAuthentication: cognito.UserPoolOperation.PRE_AUTHENTICATION,
    preSignUp: cognito.UserPoolOperation.PRE_SIGN_UP,
    preTokenGeneration: cognito.UserPoolOperation.PRE_TOKEN_GENERATION,
    userMigration: cognito.UserPoolOperation.USER_MIGRATION,
    verifyAuthChallengeResponse: cognito.UserPoolOperation.VERIFY_AUTH_CHALLENGE_RESPONSE,
};
class Auth extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Handle deprecated props
        this.checkDeprecatedProps(props);
        const app = scope.node.root;
        const { cognito: cognitoProps, auth0, amazon, apple, facebook, google, twitter, identityPool, } = props;
        this.functions = {};
        this.permissionsAttachedForAllTriggers = [];
        ////////////////////
        // Handle Cognito Identity Providers (ie. User Pool)
        ////////////////////
        const cognitoIdentityProviders = [];
        if (cognitoProps) {
            let isUserPoolImported = false;
            // Create User Pool
            if (typeof cognitoProps === "boolean") {
                this.cognitoUserPool = new cognito.UserPool(this, "UserPool", {
                    userPoolName: app.logicalPrefixedName(id),
                    selfSignUpEnabled: true,
                    signInCaseSensitive: false,
                });
            }
            else if ((0, Construct_1.isCDKConstruct)(cognitoProps.userPool)) {
                isUserPoolImported = true;
                this.cognitoUserPool = cognitoProps.userPool;
                this.addTriggers(cognitoProps);
            }
            else {
                // validate `lambdaTriggers` is not specified
                if (cognitoProps.userPool && cognitoProps.userPool.lambdaTriggers) {
                    throw new Error(`Cannot configure the "cognito.userPool.lambdaTriggers" in the Auth construct. Use the "cognito.triggers" instead.`);
                }
                this.cognitoUserPool = new cognito.UserPool(this, "UserPool", Object.assign({ userPoolName: app.logicalPrefixedName(id), selfSignUpEnabled: true, signInCaseSensitive: false }, (cognitoProps.userPool || {})));
                this.addTriggers(cognitoProps);
            }
            // Create User Pool Client
            if (typeof cognitoProps === "boolean") {
                this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", {
                    userPool: this.cognitoUserPool,
                });
            }
            else if ((0, Construct_1.isCDKConstruct)(cognitoProps.userPoolClient)) {
                if (!isUserPoolImported) {
                    throw new Error(`Cannot import the "userPoolClient" when the "userPool" is not imported.`);
                }
                this.cognitoUserPoolClient = cognitoProps.userPoolClient;
            }
            else {
                this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", Object.assign({ userPool: this.cognitoUserPool }, (cognitoProps.userPoolClient || {})));
            }
            // Set cognito providers
            const urlSuffix = cdk.Stack.of(scope).urlSuffix;
            cognitoIdentityProviders.push({
                providerName: `cognito-idp.${app.region}.${urlSuffix}/${this.cognitoUserPool.userPoolId}`,
                clientId: this.cognitoUserPoolClient.userPoolClientId,
            });
        }
        ////////////////////
        // Handle OpenId Connect Providers (ie. Auth0)
        ////////////////////
        const openIdConnectProviderArns = [];
        if (auth0) {
            if (!auth0.domain) {
                throw new Error(`No Auth0 domain defined for the "${id}" Auth`);
            }
            if (!auth0.clientId) {
                throw new Error(`No Auth0 clientId defined for the "${id}" Auth`);
            }
            const provider = new iam.OpenIdConnectProvider(this, "Auth0Provider", {
                url: auth0.domain.startsWith("https://")
                    ? auth0.domain
                    : `https://${auth0.domain}`,
                clientIds: [auth0.clientId],
            });
            openIdConnectProviderArns.push(provider.openIdConnectProviderArn);
        }
        ////////////////////
        // Handle Social Identity Providers
        ////////////////////
        const supportedLoginProviders = {};
        if (amazon) {
            if (!amazon.appId) {
                throw new Error(`No Amazon appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["www.amazon.com"] = amazon.appId;
        }
        if (facebook) {
            if (!facebook.appId) {
                throw new Error(`No Facebook appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["graph.facebook.com"] = facebook.appId;
        }
        if (google) {
            if (!google.clientId) {
                throw new Error(`No Google appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["accounts.google.com"] = google.clientId;
        }
        if (twitter) {
            if (!twitter.consumerKey) {
                throw new Error(`No Twitter consumer key defined for the "${id}" Auth`);
            }
            if (!twitter.consumerSecret) {
                throw new Error(`No Twitter consumer secret defined for the "${id}" Auth`);
            }
            supportedLoginProviders["api.twitter.com"] = `${twitter.consumerKey};${twitter.consumerSecret}`;
        }
        if (apple) {
            if (!apple.servicesId) {
                throw new Error(`No Apple servicesId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["appleid.apple.com"] = apple.servicesId;
        }
        ////////////////////
        // Create Identity Pool
        ////////////////////
        // Create Cognito Identity Pool
        this.cognitoCfnIdentityPool = new cognito.CfnIdentityPool(this, "IdentityPool", Object.assign({ identityPoolName: app.logicalPrefixedName(id), allowUnauthenticatedIdentities: true, cognitoIdentityProviders,
            supportedLoginProviders,
            openIdConnectProviderArns }, (identityPool || {})));
        this.iamAuthRole = this.createAuthRole(this.cognitoCfnIdentityPool);
        this.iamUnauthRole = this.createUnauthRole(this.cognitoCfnIdentityPool);
        // Attach roles to Identity Pool
        new cognito.CfnIdentityPoolRoleAttachment(this, "IdentityPoolRoleAttachment", {
            identityPoolId: this.cognitoCfnIdentityPool.ref,
            roles: {
                authenticated: this.iamAuthRole.roleArn,
                unauthenticated: this.iamUnauthRole.roleArn,
            },
        });
    }
    get cognitoIdentityPoolId() {
        return this.cognitoCfnIdentityPool.ref;
    }
    attachPermissionsForAuthUsers(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.iamAuthRole, permissions);
    }
    attachPermissionsForUnauthUsers(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.iamUnauthRole, permissions);
    }
    attachPermissionsForTriggers(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllTriggers.push(permissions);
    }
    attachPermissionsForTrigger(triggerKey, permissions) {
        const fn = this.getFunction(triggerKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Trigger "${triggerKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getFunction(triggerKey) {
        return this.functions[triggerKey];
    }
    getConstructMetadata() {
        var _a;
        return {
            type: "Auth",
            data: {
                identityPoolId: this.cognitoCfnIdentityPool.ref,
                userPoolId: (_a = this.cognitoUserPool) === null || _a === void 0 ? void 0 : _a.userPoolId,
                triggers: Object.entries(this.functions).map(([name, fun]) => ({
                    name,
                    fn: (0, Construct_1.getFunctionRef)(fun),
                })),
            },
        };
    }
    checkDeprecatedProps(props) {
        var _a;
        if (props.cognitoUserPool) {
            throw new Error(`The "cognitoUserPool" property is deprecated. Use the "cognito.userPool" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
        }
        if (props.cognitoUserPoolClient) {
            throw new Error(`The "cognitoUserPoolClient" property is deprecated. Use the "cognito.userPoolClient" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
        }
        if (props.cognito) {
            if (props.cognito !== true && ((_a = props.cognito) === null || _a === void 0 ? void 0 : _a.signInAliases)) {
                throw new Error(`The "cognito.signInAliases" property is deprecated. Use the "cognito.userPool.signInAliases" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
            }
        }
    }
    addTriggers(cognitoProps) {
        const { triggers, defaultFunctionProps } = cognitoProps;
        if (!triggers || Object.keys(triggers).length === 0) {
            return;
        }
        // Validate cognito user pool is not imported
        // ie. imported IUserPool does not have the "addTrigger" function
        if (!this.cognitoUserPool.addTrigger) {
            throw new Error(`Cannot add triggers when the "userPool" is imported.`);
        }
        // Create Trigger functions
        this.defaultFunctionProps = defaultFunctionProps;
        Object.entries(triggers).forEach(([triggerKey, triggerValue]) => this.addTrigger(this, triggerKey, triggerValue));
    }
    addTrigger(scope, triggerKey, triggerValue) {
        // Validate cognito user pool is defined
        if (!this.cognitoUserPool) {
            throw new Error(`Triggers cannot be added. No Cognito UserPool defined for the Auth construct.`);
        }
        // Create Function
        const lambda = Function_1.Function.fromDefinition(scope, triggerKey, triggerValue, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the triggers using FunctionProps, so the Auth construct can apply the "defaultFunctionProps" to them.`);
        // Create trigger
        const operation = AuthUserPoolTriggerOperationMapping[triggerKey];
        this.cognitoUserPool.addTrigger(operation, lambda);
        // Store function
        this.functions[triggerKey] = lambda;
        return lambda;
    }
    createAuthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolAuthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "authenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*",
            ],
            resources: ["*"],
        }));
        return role;
    }
    createUnauthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolUnauthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "unauthenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["mobileanalytics:PutEvents", "cognito-sync:*"],
            resources: ["*"],
        }));
        return role;
    }
}
exports.Auth = Auth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLGlEQUFtQztBQUNuQyx5REFBMkM7QUFDM0MsaUVBQW1EO0FBR25ELDJDQUEyRTtBQUMzRSx5Q0FBK0U7QUFDL0Usa0RBQXlFO0FBRXpFLE1BQU0sbUNBQW1DLEdBQUc7SUFDMUMsbUJBQW1CLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDLHFCQUFxQjtJQUNwRSxpQkFBaUIsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CO0lBQ2hFLGFBQWEsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsY0FBYztJQUN2RCxlQUFlLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQjtJQUM1RCxtQkFBbUIsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMscUJBQXFCO0lBQ3BFLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUI7SUFDakUsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQjtJQUM3RCxpQkFBaUIsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsa0JBQWtCO0lBQy9ELFNBQVMsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsV0FBVztJQUNoRCxrQkFBa0IsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CO0lBQ2xFLGFBQWEsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsY0FBYztJQUN2RCwyQkFBMkIsRUFDekIsT0FBTyxDQUFDLGlCQUFpQixDQUFDLDhCQUE4QjtDQUMzRCxDQUFDO0FBeUVGLE1BQWEsSUFBSyxTQUFRLHNCQUFTO0lBVWpDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBZ0I7UUFDeEQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMs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SSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFO2dCQUNQLDJCQUEyQjtnQkFDM0IsZ0JBQWdCO2dCQUNoQixvQkFBb0I7YUFDckI7WUFDRCxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7U0FDakIsQ0FBQyxDQUNILENBQUM7UUFFRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxZQUFxQztRQUM1RCxNQUFNLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFO1lBQ3hELFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxrQkFBa0IsQ0FDbkMsZ0NBQWdDLEVBQ2hDO2dCQUNFLFlBQVksRUFBRTtvQkFDWixvQ0FBb0MsRUFBRSxZQUFZLENBQUMsR0FBRztpQkFDdkQ7Z0JBQ0Qsd0JBQXdCLEVBQUU7b0JBQ3hCLG9DQUFvQyxFQUFFLGlCQUFpQjtpQkFDeEQ7YUFDRixFQUNELCtCQUErQixDQUNoQztTQUNGLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxXQUFXLENBQ2QsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFLENBQUMsMkJBQTJCLEVBQUUsZ0JBQWdCLENBQUM7WUFDeEQsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO1NBQ2pCLENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUE3WEQsb0JBNlhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgY29nbml0byBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNvZ25pdG9cIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBnZXRGdW5jdGlvblJlZiwgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucywgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuY29uc3QgQXV0aFVzZXJQb29sVHJpZ2dlck9wZXJhdGlvbk1hcHBpbmcgPSB7XG4gIGNyZWF0ZUF1dGhDaGFsbGVuZ2U6IGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uQ1JFQVRFX0FVVEhfQ0hBTExFTkdFLFxuICBjdXN0b21FbWFpbFNlbmRlcjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5DVVNUT01fRU1BSUxfU0VOREVSLFxuICBjdXN0b21NZXNzYWdlOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLkNVU1RPTV9NRVNTQUdFLFxuICBjdXN0b21TbXNTZW5kZXI6IGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uQ1VTVE9NX1NNU19TRU5ERVIsXG4gIGRlZmluZUF1dGhDaGFsbGVuZ2U6IGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uREVGSU5FX0FVVEhfQ0hBTExFTkdFLFxuICBwb3N0QXV0aGVudGljYXRpb246IGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uUE9TVF9BVVRIRU5USUNBVElPTixcbiAgcG9zdENvbmZpcm1hdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QT1NUX0NPTkZJUk1BVElPTixcbiAgcHJlQXV0aGVudGljYXRpb246IGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uUFJFX0FVVEhFTlRJQ0FUSU9OLFxuICBwcmVTaWduVXA6IGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uUFJFX1NJR05fVVAsXG4gIHByZVRva2VuR2VuZXJhdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QUkVfVE9LRU5fR0VORVJBVElPTixcbiAgdXNlck1pZ3JhdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5VU0VSX01JR1JBVElPTixcbiAgdmVyaWZ5QXV0aENoYWxsZW5nZVJlc3BvbnNlOlxuICAgIGNvZ25pdG8uVXNlclBvb2xPcGVyYXRpb24uVkVSSUZZX0FVVEhfQ0hBTExFTkdFX1JFU1BPTlNFLFxufTtcblxuZXhwb3J0IGludGVyZmFjZSBBdXRoUHJvcHMge1xuICByZWFkb25seSBjb2duaXRvPzogYm9vbGVhbiB8IEF1dGhDb2duaXRvUHJvcHM7XG4gIHJlYWRvbmx5IGF1dGgwPzogQXV0aEF1dGgwUHJvcHM7XG4gIHJlYWRvbmx5IGFtYXpvbj86IEF1dGhBbWF6b25Qcm9wcztcbiAgcmVhZG9ubHkgYXBwbGU/OiBBdXRoQXBwbGVQcm9wcztcbiAgcmVhZG9ubHkgZmFjZWJvb2s/OiBBdXRoRmFjZWJvb2tQcm9wcztcbiAgcmVhZG9ubHkgZ29vZ2xlPzogQXV0aEdvb2dsZVByb3BzO1xuICByZWFkb25seSB0d2l0dGVyPzogQXV0aFR3aXR0ZXJQcm9wcztcbiAgcmVhZG9ubHkgaWRlbnRpdHlQb29sPzogQXV0aENka0NmbklkZW50aXR5UG9vbFByb3BzO1xuICAvLyBkZXByZWNhdGVkXG4gIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbD86IGNvZ25pdG8uSVVzZXJQb29sO1xuICByZWFkb25seSBjb2duaXRvVXNlclBvb2xDbGllbnQ/OiBjb2duaXRvLklVc2VyUG9vbENsaWVudDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQ29nbml0b1Byb3BzIHtcbiAgcmVhZG9ubHkgdXNlclBvb2w/OiBjb2duaXRvLlVzZXJQb29sUHJvcHMgfCBjb2duaXRvLklVc2VyUG9vbDtcbiAgcmVhZG9ubHkgdXNlclBvb2xDbGllbnQ/OlxuICAgIHwgY29nbml0by5Vc2VyUG9vbENsaWVudE9wdGlvbnNcbiAgICB8IGNvZ25pdG8uSVVzZXJQb29sQ2xpZW50O1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHJlYWRvbmx5IHRyaWdnZXJzPzogQXV0aFVzZXJQb29sVHJpZ2dlcnM7XG4gIC8vIGRlcHJlY2F0ZWRcbiAgcmVhZG9ubHkgc2lnbkluQWxpYXNlcz86IGNvZ25pdG8uU2lnbkluQWxpYXNlcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoVXNlclBvb2xUcmlnZ2VycyB7XG4gIHJlYWRvbmx5IGNyZWF0ZUF1dGhDaGFsbGVuZ2U/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IGN1c3RvbUVtYWlsU2VuZGVyPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBjdXN0b21NZXNzYWdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBjdXN0b21TbXNTZW5kZXI/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IGRlZmluZUF1dGhDaGFsbGVuZ2U/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHBvc3RBdXRoZW50aWNhdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcG9zdENvbmZpcm1hdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcHJlQXV0aGVudGljYXRpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHByZVNpZ25VcD86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcHJlVG9rZW5HZW5lcmF0aW9uPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSB1c2VyTWlncmF0aW9uPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSB2ZXJpZnlBdXRoQ2hhbGxlbmdlUmVzcG9uc2U/OiBGdW5jdGlvbkRlZmluaXRpb247XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEF1dGgwUHJvcHMge1xuICByZWFkb25seSBkb21haW46IHN0cmluZztcbiAgcmVhZG9ubHkgY2xpZW50SWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQW1hem9uUHJvcHMge1xuICByZWFkb25seSBhcHBJZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhBcHBsZVByb3BzIHtcbiAgcmVhZG9ubHkgc2VydmljZXNJZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhGYWNlYm9va1Byb3BzIHtcbiAgcmVhZG9ubHkgYXBwSWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoR29vZ2xlUHJvcHMge1xuICByZWFkb25seSBjbGllbnRJZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhUd2l0dGVyUHJvcHMge1xuICByZWFkb25seSBjb25zdW1lcktleTogc3RyaW5nO1xuICByZWFkb25seSBjb25zdW1lclNlY3JldDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhDZGtDZm5JZGVudGl0eVBvb2xQcm9wc1xuICBleHRlbmRzIE9taXQ8Y29nbml0by5DZm5JZGVudGl0eVBvb2xQcm9wcywgXCJhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXNcIj4ge1xuICByZWFkb25seSBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgQXV0aCBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBjb2duaXRvVXNlclBvb2w/OiBjb2duaXRvLklVc2VyUG9vbDtcbiAgcHVibGljIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbENsaWVudD86IGNvZ25pdG8uSVVzZXJQb29sQ2xpZW50O1xuICBwdWJsaWMgcmVhZG9ubHkgY29nbml0b0NmbklkZW50aXR5UG9vbDogY29nbml0by5DZm5JZGVudGl0eVBvb2w7XG4gIHB1YmxpYyByZWFkb25seSBpYW1BdXRoUm9sZTogaWFtLlJvbGU7XG4gIHB1YmxpYyByZWFkb25seSBpYW1VbmF1dGhSb2xlOiBpYW0uUm9sZTtcbiAgcHJpdmF0ZSBmdW5jdGlvbnM6IHsgW2tleTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHByaXZhdGUgcGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRyaWdnZXJzOiBQZXJtaXNzaW9uc1tdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBdXRoUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgLy8gSGFuZGxlIGRlcHJlY2F0ZWQgcHJvcHNcbiAgICB0aGlzLmNoZWNrRGVwcmVjYXRlZFByb3BzKHByb3BzKTtcblxuICAgIGNvbnN0IGFwcCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qge1xuICAgICAgY29nbml0bzogY29nbml0b1Byb3BzLFxuICAgICAgYXV0aDAsXG4gICAgICBhbWF6b24sXG4gICAgICBhcHBsZSxcbiAgICAgIGZhY2Vib29rLFxuICAgICAgZ29vZ2xlLFxuICAgICAgdHdpdHRlcixcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUcmlnZ2VycyA9IFtdO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBIYW5kbGUgQ29nbml0byBJZGVudGl0eSBQcm92aWRlcnMgKGllLiBVc2VyIFBvb2wpXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBjb2duaXRvSWRlbnRpdHlQcm92aWRlcnMgPSBbXTtcblxuICAgIGlmIChjb2duaXRvUHJvcHMpIHtcbiAgICAgIGxldCBpc1VzZXJQb29sSW1wb3J0ZWQgPSBmYWxzZTtcblxuICAgICAgLy8gQ3JlYXRlIFVzZXIgUG9vbFxuICAgICAgaWYgKHR5cGVvZiBjb2duaXRvUHJvcHMgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gbmV3IGNvZ25pdG8uVXNlclBvb2wodGhpcywgXCJVc2VyUG9vbFwiLCB7XG4gICAgICAgICAgdXNlclBvb2xOYW1lOiBhcHAubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgc2lnbkluQ2FzZVNlbnNpdGl2ZTogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChpc0NES0NvbnN0cnVjdChjb2duaXRvUHJvcHMudXNlclBvb2wpKSB7XG4gICAgICAgIGlzVXNlclBvb2xJbXBvcnRlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gY29nbml0b1Byb3BzLnVzZXJQb29sO1xuICAgICAgICB0aGlzLmFkZFRyaWdnZXJzKGNvZ25pdG9Qcm9wcyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB2YWxpZGF0ZSBgbGFtYmRhVHJpZ2dlcnNgIGlzIG5vdCBzcGVjaWZpZWRcbiAgICAgICAgaWYgKGNvZ25pdG9Qcm9wcy51c2VyUG9vbCAmJiBjb2duaXRvUHJvcHMudXNlclBvb2wubGFtYmRhVHJpZ2dlcnMpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjb2duaXRvLnVzZXJQb29sLmxhbWJkYVRyaWdnZXJzXCIgaW4gdGhlIEF1dGggY29uc3RydWN0LiBVc2UgdGhlIFwiY29nbml0by50cmlnZ2Vyc1wiIGluc3RlYWQuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvZ25pdG9Vc2VyUG9vbCA9IG5ldyBjb2duaXRvLlVzZXJQb29sKHRoaXMsIFwiVXNlclBvb2xcIiwge1xuICAgICAgICAgIHVzZXJQb29sTmFtZTogYXBwLmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAgIHNlbGZTaWduVXBFbmFibGVkOiB0cnVlLFxuICAgICAgICAgIHNpZ25JbkNhc2VTZW5zaXRpdmU6IGZhbHNlLFxuICAgICAgICAgIC4uLihjb2duaXRvUHJvcHMudXNlclBvb2wgfHwge30pLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hZGRUcmlnZ2Vycyhjb2duaXRvUHJvcHMpO1xuICAgICAgfVxuXG4gICAgICAvLyBDcmVhdGUgVXNlciBQb29sIENsaWVudFxuICAgICAgaWYgKHR5cGVvZiBjb2duaXRvUHJvcHMgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50ID0gbmV3IGNvZ25pdG8uVXNlclBvb2xDbGllbnQoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIlVzZXJQb29sQ2xpZW50XCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlclBvb2w6IHRoaXMuY29nbml0b1VzZXJQb29sLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNDREtDb25zdHJ1Y3QoY29nbml0b1Byb3BzLnVzZXJQb29sQ2xpZW50KSkge1xuICAgICAgICBpZiAoIWlzVXNlclBvb2xJbXBvcnRlZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBDYW5ub3QgaW1wb3J0IHRoZSBcInVzZXJQb29sQ2xpZW50XCIgd2hlbiB0aGUgXCJ1c2VyUG9vbFwiIGlzIG5vdCBpbXBvcnRlZC5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvZ25pdG9Vc2VyUG9vbENsaWVudCA9IGNvZ25pdG9Qcm9wcy51c2VyUG9vbENsaWVudDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50ID0gbmV3IGNvZ25pdG8uVXNlclBvb2xDbGllbnQoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIlVzZXJQb29sQ2xpZW50XCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlclBvb2w6IHRoaXMuY29nbml0b1VzZXJQb29sLFxuICAgICAgICAgICAgLi4uKGNvZ25pdG9Qcm9wcy51c2VyUG9vbENsaWVudCB8fCB7fSksXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBTZXQgY29nbml0byBwcm92aWRlcnNcbiAgICAgIGNvbnN0IHVybFN1ZmZpeCA9IGNkay5TdGFjay5vZihzY29wZSkudXJsU3VmZml4O1xuICAgICAgY29nbml0b0lkZW50aXR5UHJvdmlkZXJzLnB1c2goe1xuICAgICAgICBwcm92aWRlck5hbWU6IGBjb2duaXRvLWlkcC4ke2FwcC5yZWdpb259LiR7dXJsU3VmZml4fS8ke3RoaXMuY29nbml0b1VzZXJQb29sLnVzZXJQb29sSWR9YCxcbiAgICAgICAgY2xpZW50SWQ6IHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEhhbmRsZSBPcGVuSWQgQ29ubmVjdCBQcm92aWRlcnMgKGllLiBBdXRoMClcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMgPSBbXTtcblxuICAgIGlmIChhdXRoMCkge1xuICAgICAgaWYgKCFhdXRoMC5kb21haW4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBBdXRoMCBkb21haW4gZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBpZiAoIWF1dGgwLmNsaWVudElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQXV0aDAgY2xpZW50SWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBpYW0uT3BlbklkQ29ubmVjdFByb3ZpZGVyKHRoaXMsIFwiQXV0aDBQcm92aWRlclwiLCB7XG4gICAgICAgIHVybDogYXV0aDAuZG9tYWluLnN0YXJ0c1dpdGgoXCJodHRwczovL1wiKVxuICAgICAgICAgID8gYXV0aDAuZG9tYWluXG4gICAgICAgICAgOiBgaHR0cHM6Ly8ke2F1dGgwLmRvbWFpbn1gLFxuICAgICAgICBjbGllbnRJZHM6IFthdXRoMC5jbGllbnRJZF0sXG4gICAgICB9KTtcbiAgICAgIG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMucHVzaChwcm92aWRlci5vcGVuSWRDb25uZWN0UHJvdmlkZXJBcm4pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gSGFuZGxlIFNvY2lhbCBJZGVudGl0eSBQcm92aWRlcnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICAgIGlmIChhbWF6b24pIHtcbiAgICAgIGlmICghYW1hem9uLmFwcElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQW1hem9uIGFwcElkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJ3d3cuYW1hem9uLmNvbVwiXSA9IGFtYXpvbi5hcHBJZDtcbiAgICB9XG4gICAgaWYgKGZhY2Vib29rKSB7XG4gICAgICBpZiAoIWZhY2Vib29rLmFwcElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gRmFjZWJvb2sgYXBwSWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBzdXBwb3J0ZWRMb2dpblByb3ZpZGVyc1tcImdyYXBoLmZhY2Vib29rLmNvbVwiXSA9IGZhY2Vib29rLmFwcElkO1xuICAgIH1cbiAgICBpZiAoZ29vZ2xlKSB7XG4gICAgICBpZiAoIWdvb2dsZS5jbGllbnRJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIEdvb2dsZSBhcHBJZCBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIEF1dGhgKTtcbiAgICAgIH1cbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW1wiYWNjb3VudHMuZ29vZ2xlLmNvbVwiXSA9IGdvb2dsZS5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKHR3aXR0ZXIpIHtcbiAgICAgIGlmICghdHdpdHRlci5jb25zdW1lcktleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIFR3aXR0ZXIgY29uc3VtZXIga2V5IGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgaWYgKCF0d2l0dGVyLmNvbnN1bWVyU2VjcmV0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTm8gVHdpdHRlciBjb25zdW1lciBzZWNyZXQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXG4gICAgICAgIFwiYXBpLnR3aXR0ZXIuY29tXCJcbiAgICAgIF0gPSBgJHt0d2l0dGVyLmNvbnN1bWVyS2V5fTske3R3aXR0ZXIuY29uc3VtZXJTZWNyZXR9YDtcbiAgICB9XG4gICAgaWYgKGFwcGxlKSB7XG4gICAgICBpZiAoIWFwcGxlLnNlcnZpY2VzSWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBBcHBsZSBzZXJ2aWNlc0lkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJhcHBsZWlkLmFwcGxlLmNvbVwiXSA9IGFwcGxlLnNlcnZpY2VzSWQ7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgSWRlbnRpdHkgUG9vbFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAvLyBDcmVhdGUgQ29nbml0byBJZGVudGl0eSBQb29sXG4gICAgdGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sID0gbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIFwiSWRlbnRpdHlQb29sXCIsXG4gICAgICB7XG4gICAgICAgIGlkZW50aXR5UG9vbE5hbWU6IGFwcC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOiB0cnVlLFxuICAgICAgICBjb2duaXRvSWRlbnRpdHlQcm92aWRlcnMsXG4gICAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzLFxuICAgICAgICBvcGVuSWRDb25uZWN0UHJvdmlkZXJBcm5zLFxuICAgICAgICAuLi4oaWRlbnRpdHlQb29sIHx8IHt9KSxcbiAgICAgIH1cbiAgICApO1xuICAgIHRoaXMuaWFtQXV0aFJvbGUgPSB0aGlzLmNyZWF0ZUF1dGhSb2xlKHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbCk7XG4gICAgdGhpcy5pYW1VbmF1dGhSb2xlID0gdGhpcy5jcmVhdGVVbmF1dGhSb2xlKHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbCk7XG5cbiAgICAvLyBBdHRhY2ggcm9sZXMgdG8gSWRlbnRpdHkgUG9vbFxuICAgIG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50KFxuICAgICAgdGhpcyxcbiAgICAgIFwiSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnRcIixcbiAgICAgIHtcbiAgICAgICAgaWRlbnRpdHlQb29sSWQ6IHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgIHJvbGVzOiB7XG4gICAgICAgICAgYXV0aGVudGljYXRlZDogdGhpcy5pYW1BdXRoUm9sZS5yb2xlQXJuLFxuICAgICAgICAgIHVuYXV0aGVudGljYXRlZDogdGhpcy5pYW1VbmF1dGhSb2xlLnJvbGVBcm4sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY29nbml0b0lkZW50aXR5UG9vbElkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbC5yZWY7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNGb3JBdXRoVXNlcnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUodGhpcy5pYW1BdXRoUm9sZSwgcGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zRm9yVW5hdXRoVXNlcnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUodGhpcy5pYW1VbmF1dGhSb2xlLCBwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNGb3JUcmlnZ2VycyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3QudmFsdWVzKHRoaXMuZnVuY3Rpb25zKS5mb3JFYWNoKChmbikgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsVHJpZ2dlcnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNGb3JUcmlnZ2VyKFxuICAgIHRyaWdnZXJLZXk6IGtleW9mIEF1dGhVc2VyUG9vbFRyaWdnZXJzLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZ2V0RnVuY3Rpb24odHJpZ2dlcktleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gVHJpZ2dlciBcIiR7dHJpZ2dlcktleX1cIiBkb2VzIG5vdCBleGlzdC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbih0cmlnZ2VyS2V5OiBrZXlvZiBBdXRoVXNlclBvb2xUcmlnZ2Vycyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbdHJpZ2dlcktleV07XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiQXV0aFwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICBpZGVudGl0eVBvb2xJZDogdGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgdXNlclBvb2xJZDogdGhpcy5jb2duaXRvVXNlclBvb2w/LnVzZXJQb29sSWQsXG4gICAgICAgIHRyaWdnZXJzOiBPYmplY3QuZW50cmllcyh0aGlzLmZ1bmN0aW9ucykubWFwKChbbmFtZSwgZnVuXSkgPT4gKHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGZuOiBnZXRGdW5jdGlvblJlZihmdW4pLFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRGVwcmVjYXRlZFByb3BzKHByb3BzOiBBdXRoUHJvcHMpOiB2b2lkIHtcbiAgICBpZiAocHJvcHMuY29nbml0b1VzZXJQb29sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCJjb2duaXRvVXNlclBvb2xcIiBwcm9wZXJ0eSBpcyBkZXByZWNhdGVkLiBVc2UgdGhlIFwiY29nbml0by51c2VyUG9vbFwiIGluc3RlYWQuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BdXRoI3VwZ3JhZGluZy10by12MDEyMGBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChwcm9wcy5jb2duaXRvVXNlclBvb2xDbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBcImNvZ25pdG9Vc2VyUG9vbENsaWVudFwiIHByb3BlcnR5IGlzIGRlcHJlY2F0ZWQuIFVzZSB0aGUgXCJjb2duaXRvLnVzZXJQb29sQ2xpZW50XCIgaW5zdGVhZC4gTW9yZSBkZXRhaWxzIG9uIHVwZ3JhZGluZyAtIGh0dHBzOi8vZG9jcy5zZXJ2ZXJsZXNzLXN0YWNrLmNvbS9jb25zdHJ1Y3RzL0F1dGgjdXBncmFkaW5nLXRvLXYwMTIwYFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHByb3BzLmNvZ25pdG8pIHtcbiAgICAgIGlmIChwcm9wcy5jb2duaXRvICE9PSB0cnVlICYmIHByb3BzLmNvZ25pdG8/LnNpZ25JbkFsaWFzZXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUaGUgXCJjb2duaXRvLnNpZ25JbkFsaWFzZXNcIiBwcm9wZXJ0eSBpcyBkZXByZWNhdGVkLiBVc2UgdGhlIFwiY29nbml0by51c2VyUG9vbC5zaWduSW5BbGlhc2VzXCIgaW5zdGVhZC4gTW9yZSBkZXRhaWxzIG9uIHVwZ3JhZGluZyAtIGh0dHBzOi8vZG9jcy5zZXJ2ZXJsZXNzLXN0YWNrLmNvbS9jb25zdHJ1Y3RzL0F1dGgjdXBncmFkaW5nLXRvLXYwMTIwYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkVHJpZ2dlcnMoY29nbml0b1Byb3BzOiBBdXRoQ29nbml0b1Byb3BzKTogdm9pZCB7XG4gICAgY29uc3QgeyB0cmlnZ2VycywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9IGNvZ25pdG9Qcm9wcztcblxuICAgIGlmICghdHJpZ2dlcnMgfHwgT2JqZWN0LmtleXModHJpZ2dlcnMpLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH1cblxuICAgIC8vIFZhbGlkYXRlIGNvZ25pdG8gdXNlciBwb29sIGlzIG5vdCBpbXBvcnRlZFxuICAgIC8vIGllLiBpbXBvcnRlZCBJVXNlclBvb2wgZG9lcyBub3QgaGF2ZSB0aGUgXCJhZGRUcmlnZ2VyXCIgZnVuY3Rpb25cbiAgICBpZiAoISh0aGlzLmNvZ25pdG9Vc2VyUG9vbCBhcyBjb2duaXRvLlVzZXJQb29sKS5hZGRUcmlnZ2VyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBhZGQgdHJpZ2dlcnMgd2hlbiB0aGUgXCJ1c2VyUG9vbFwiIGlzIGltcG9ydGVkLmApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBUcmlnZ2VyIGZ1bmN0aW9uc1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSBkZWZhdWx0RnVuY3Rpb25Qcm9wcztcblxuICAgIE9iamVjdC5lbnRyaWVzKHRyaWdnZXJzKS5mb3JFYWNoKChbdHJpZ2dlcktleSwgdHJpZ2dlclZhbHVlXSkgPT5cbiAgICAgIHRoaXMuYWRkVHJpZ2dlcihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgdHJpZ2dlcktleSBhcyBrZXlvZiBBdXRoVXNlclBvb2xUcmlnZ2VycyxcbiAgICAgICAgdHJpZ2dlclZhbHVlXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVHJpZ2dlcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHRyaWdnZXJLZXk6IGtleW9mIEF1dGhVc2VyUG9vbFRyaWdnZXJzLFxuICAgIHRyaWdnZXJWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uXG4gICk6IEZuIHtcbiAgICAvLyBWYWxpZGF0ZSBjb2duaXRvIHVzZXIgcG9vbCBpcyBkZWZpbmVkXG4gICAgaWYgKCF0aGlzLmNvZ25pdG9Vc2VyUG9vbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVHJpZ2dlcnMgY2Fubm90IGJlIGFkZGVkLiBObyBDb2duaXRvIFVzZXJQb29sIGRlZmluZWQgZm9yIHRoZSBBdXRoIGNvbnN0cnVjdC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBGdW5jdGlvblxuICAgIGNvbnN0IGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICB0cmlnZ2VyS2V5LFxuICAgICAgdHJpZ2dlclZhbHVlLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHRyaWdnZXJzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBBdXRoIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIHRyaWdnZXJcbiAgICBjb25zdCBvcGVyYXRpb24gPSBBdXRoVXNlclBvb2xUcmlnZ2VyT3BlcmF0aW9uTWFwcGluZ1t0cmlnZ2VyS2V5XTtcbiAgICAodGhpcy5jb2duaXRvVXNlclBvb2wgYXMgY29nbml0by5Vc2VyUG9vbCkuYWRkVHJpZ2dlcihvcGVyYXRpb24sIGxhbWJkYSk7XG5cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIHRoaXMuZnVuY3Rpb25zW3RyaWdnZXJLZXldID0gbGFtYmRhO1xuXG4gICAgcmV0dXJuIGxhbWJkYTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQXV0aFJvbGUoaWRlbnRpdHlQb29sOiBjb2duaXRvLkNmbklkZW50aXR5UG9vbCk6IGlhbS5Sb2xlIHtcbiAgICBjb25zdCByb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIFwiSWRlbnRpdHlQb29sQXV0aFJvbGVcIiwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLkZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAge1xuICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkXCI6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBcIkZvckFueVZhbHVlOlN0cmluZ0xpa2VcIjoge1xuICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yXCI6IFwiYXV0aGVudGljYXRlZFwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIFwic3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlcIlxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwibW9iaWxlYW5hbHl0aWNzOlB1dEV2ZW50c1wiLFxuICAgICAgICAgIFwiY29nbml0by1zeW5jOipcIixcbiAgICAgICAgICBcImNvZ25pdG8taWRlbnRpdHk6KlwiLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVW5hdXRoUm9sZShpZGVudGl0eVBvb2w6IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKTogaWFtLlJvbGUge1xuICAgIGNvbnN0IHJvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgXCJJZGVudGl0eVBvb2xVbmF1dGhSb2xlXCIsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5GZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZFwiOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgXCJGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlXCI6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtclwiOiBcInVuYXV0aGVudGljYXRlZFwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIFwic3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlcIlxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wibW9iaWxlYW5hbHl0aWNzOlB1dEV2ZW50c1wiLCBcImNvZ25pdG8tc3luYzoqXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxufVxuIl19