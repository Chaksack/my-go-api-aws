"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Topic = void 0;
const constructs_1 = require("constructs");
const sns = __importStar(require("aws-cdk-lib/aws-sns"));
const snsSubscriptions = __importStar(require("aws-cdk-lib/aws-sns-subscriptions"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const Queue_1 = require("./Queue");
/////////////////////
// Construct
/////////////////////
class Topic extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { snsTopic, subscribers, defaultFunctionProps } = props || {};
        this.subscribers = [];
        this.permissionsAttachedForAllSubscribers = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Topic
        ////////////////////
        if ((0, Construct_1.isCDKConstruct)(snsTopic)) {
            this.snsTopic = snsTopic;
        }
        else {
            const snsTopicProps = (snsTopic || {});
            this.snsTopic = new sns.Topic(this, "Topic", Object.assign({ topicName: root.logicalPrefixedName(id) }, snsTopicProps));
        }
        ///////////////////////////
        // Create Subscribers
        ///////////////////////////
        this.addSubscribers(this, subscribers || []);
    }
    get topicArn() {
        return this.snsTopic.topicArn;
    }
    get topicName() {
        return this.snsTopic.topicName;
    }
    get subscriberFunctions() {
        return this.subscribers.filter((subscriber) => subscriber instanceof Function_1.Function);
    }
    get snsSubscriptions() {
        return this.subscribers.map((sub) => {
            let children;
            // look for sns.Subscription inside Queue.sqsQueue
            if (sub instanceof Queue_1.Queue) {
                children = sub.sqsQueue.node.children;
            }
            // look for sns.Subscription inside Function
            else {
                children = sub.node.children;
            }
            const child = children.find((child) => {
                return (0, Construct_1.isCDKConstructOf)(child, "aws-cdk-lib.aws_sns.Subscription");
            });
            return child;
        });
    }
    addSubscribers(scope, subscribers) {
        subscribers.forEach((subscriber) => this.addSubscriber(scope, subscriber));
    }
    attachPermissions(permissions) {
        this.subscribers
            .filter((subscriber) => subscriber instanceof Function_1.Function)
            .forEach((subscriber) => subscriber.attachPermissions(permissions));
        this.permissionsAttachedForAllSubscribers.push(permissions);
    }
    attachPermissionsToSubscriber(index, permissions) {
        const subscriber = this.subscribers[index];
        if (!(subscriber instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" Topic subscriber because it's not a Lambda function`);
        }
        subscriber.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "Topic",
            data: {
                topicArn: this.snsTopic.topicArn,
                subscribers: this.subscribers.map((s) => (0, Construct_1.getFunctionRef)(s)),
            },
        };
    }
    addSubscriber(scope, subscriber) {
        if (subscriber instanceof Queue_1.Queue ||
            subscriber.queue) {
            subscriber = subscriber;
            this.addQueueSubscriber(scope, subscriber);
        }
        else {
            subscriber = subscriber;
            this.addFunctionSubscriber(scope, subscriber);
        }
    }
    addQueueSubscriber(scope, subscriber) {
        // Parse subscriber props
        let subscriberProps;
        let queue;
        if (subscriber instanceof Queue_1.Queue) {
            subscriber = subscriber;
            queue = subscriber;
        }
        else {
            subscriber = subscriber;
            subscriberProps = subscriber.subscriberProps;
            queue = subscriber.queue;
        }
        this.subscribers.push(queue);
        // Create Subscription
        this.snsTopic.addSubscription(new snsSubscriptions.SqsSubscription(queue.sqsQueue, subscriberProps));
    }
    addFunctionSubscriber(scope, subscriber) {
        // Parse subscriber props
        let subscriberProps;
        let functionDefinition;
        if (subscriber.function) {
            subscriber = subscriber;
            subscriberProps = subscriber.subscriberProps;
            functionDefinition = subscriber.function;
        }
        else {
            subscriber = subscriber;
            functionDefinition = subscriber;
        }
        // Create function
        const i = this.subscribers.length;
        const fn = Function_1.Function.fromDefinition(scope, `Subscriber_${this.node.id}_${i}`, functionDefinition, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the subscribers using FunctionProps, so the Topic construct can apply the "defaultFunctionProps" to them.`);
        this.subscribers.push(fn);
        // Create Subscription
        this.snsTopic.addSubscription(new snsSubscriptions.LambdaSubscription(fn, subscriberProps));
        // Attach existing permissions
        this.permissionsAttachedForAllSubscribers.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.Topic = Topic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVG9waWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvVG9waWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMseURBQTJDO0FBQzNDLG9GQUFzRTtBQUV0RSwyQ0FLcUI7QUFDckIseUNBQStFO0FBQy9FLG1DQUFnQztBQTRCaEMscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxLQUFNLFNBQVEsc0JBQVM7SUFNbEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUMxRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwRSxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsb0NBQW9DLEdBQUcsRUFBRSxDQUFDO1FBQy9DLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUVqRCxvQkFBb0I7UUFDcEIsZUFBZTtRQUNmLG9CQUFvQjtRQUVwQixJQUFJLElBQUEsMEJBQWMsRUFBQyxRQUFRLENBQUMsRUFBRTtZQUM1QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQXFCLENBQUM7U0FDdkM7YUFBTTtZQUNMLE1BQU0sYUFBYSxHQUFHLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBbUIsQ0FBQztZQUN6RCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxrQkFDekMsU0FBUyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsSUFDcEMsYUFBYSxFQUNoQixDQUFDO1NB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QUMxQzthQUFNO1lBQ0wsVUFBVSxHQUFHLFVBQWdDLENBQUM7WUFDOUMsa0JBQWtCLEdBQUcsVUFBVSxDQUFDO1NBQ2pDO1FBRUQsa0JBQWtCO1FBQ2xCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBQ2xDLE1BQU0sRUFBRSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUMxQixLQUFLLEVBQ0wsY0FBYyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFDakMsa0JBQWtCLEVBQ2xCLElBQUksQ0FBQyxvQkFBb0IsRUFDekIscU9BQXFPLENBQ3RPLENBQUM7UUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUxQixzQkFBc0I7UUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQzNCLElBQUksZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUM3RCxDQUFDO1FBRUYsOEJBQThCO1FBQzlCLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUNoRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQ2xDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFwTUQsc0JBb01DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIHNucyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNuc1wiO1xuaW1wb3J0ICogYXMgc25zU3Vic2NyaXB0aW9ucyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNucy1zdWJzY3JpcHRpb25zXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7XG4gIGdldEZ1bmN0aW9uUmVmLFxuICBTU1RDb25zdHJ1Y3QsXG4gIGlzQ0RLQ29uc3RydWN0LFxuICBpc0NES0NvbnN0cnVjdE9mLFxufSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUXVldWUgfSBmcm9tIFwiLi9RdWV1ZVwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBUb3BpY1Byb3BzIHtcbiAgcmVhZG9ubHkgc25zVG9waWM/OiBzbnMuSVRvcGljIHwgc25zLlRvcGljUHJvcHM7XG4gIHJlYWRvbmx5IHN1YnNjcmliZXJzPzogKFxuICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgfCBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzXG4gICAgfCBRdWV1ZVxuICAgIHwgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wc1xuICApW107XG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzIHtcbiAgcmVhZG9ubHkgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgc3Vic2NyaWJlclByb3BzPzogc25zU3Vic2NyaXB0aW9ucy5MYW1iZGFTdWJzY3JpcHRpb25Qcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUb3BpY1F1ZXVlU3Vic2NyaWJlclByb3BzIHtcbiAgcmVhZG9ubHkgcXVldWU6IFF1ZXVlO1xuICByZWFkb25seSBzdWJzY3JpYmVyUHJvcHM/OiBzbnNTdWJzY3JpcHRpb25zLlNxc1N1YnNjcmlwdGlvblByb3BzO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBUb3BpYyBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBzbnNUb3BpYzogc25zLlRvcGljO1xuICBwcml2YXRlIHJlYWRvbmx5IHN1YnNjcmliZXJzOiAoRm4gfCBRdWV1ZSlbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsU3Vic2NyaWJlcnM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogVG9waWNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCB7IHNuc1RvcGljLCBzdWJzY3JpYmVycywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9IHByb3BzIHx8IHt9O1xuICAgIHRoaXMuc3Vic2NyaWJlcnMgPSBbXTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxTdWJzY3JpYmVycyA9IFtdO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSBkZWZhdWx0RnVuY3Rpb25Qcm9wcztcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIFRvcGljXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChzbnNUb3BpYykpIHtcbiAgICAgIHRoaXMuc25zVG9waWMgPSBzbnNUb3BpYyBhcyBzbnMuVG9waWM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNuc1RvcGljUHJvcHMgPSAoc25zVG9waWMgfHwge30pIGFzIHNucy5Ub3BpY1Byb3BzO1xuICAgICAgdGhpcy5zbnNUb3BpYyA9IG5ldyBzbnMuVG9waWModGhpcywgXCJUb3BpY1wiLCB7XG4gICAgICAgIHRvcGljTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4uc25zVG9waWNQcm9wcyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBTdWJzY3JpYmVyc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgdGhpcy5hZGRTdWJzY3JpYmVycyh0aGlzLCBzdWJzY3JpYmVycyB8fCBbXSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRvcGljQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc25zVG9waWMudG9waWNBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRvcGljTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnNuc1RvcGljLnRvcGljTmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3Vic2NyaWJlckZ1bmN0aW9ucygpOiBGbltdIHtcbiAgICByZXR1cm4gdGhpcy5zdWJzY3JpYmVycy5maWx0ZXIoXG4gICAgICAoc3Vic2NyaWJlcikgPT4gc3Vic2NyaWJlciBpbnN0YW5jZW9mIEZuXG4gICAgKSBhcyBGbltdO1xuICB9XG5cbiAgcHVibGljIGdldCBzbnNTdWJzY3JpcHRpb25zKCk6IHNucy5TdWJzY3JpcHRpb25bXSB7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlcnMubWFwKChzdWIpID0+IHtcbiAgICAgIGxldCBjaGlsZHJlbjtcbiAgICAgIC8vIGxvb2sgZm9yIHNucy5TdWJzY3JpcHRpb24gaW5zaWRlIFF1ZXVlLnNxc1F1ZXVlXG4gICAgICBpZiAoc3ViIGluc3RhbmNlb2YgUXVldWUpIHtcbiAgICAgICAgY2hpbGRyZW4gPSBzdWIuc3FzUXVldWUubm9kZS5jaGlsZHJlbjtcbiAgICAgIH1cbiAgICAgIC8vIGxvb2sgZm9yIHNucy5TdWJzY3JpcHRpb24gaW5zaWRlIEZ1bmN0aW9uXG4gICAgICBlbHNlIHtcbiAgICAgICAgY2hpbGRyZW4gPSBzdWIubm9kZS5jaGlsZHJlbjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbi5maW5kKChjaGlsZCkgPT4ge1xuICAgICAgICByZXR1cm4gaXNDREtDb25zdHJ1Y3RPZihcbiAgICAgICAgICBjaGlsZCBhcyBDb25zdHJ1Y3QsXG4gICAgICAgICAgXCJhd3MtY2RrLWxpYi5hd3Nfc25zLlN1YnNjcmlwdGlvblwiXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBjaGlsZCBhcyBzbnMuU3Vic2NyaXB0aW9uO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZFN1YnNjcmliZXJzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgc3Vic2NyaWJlcnM6IChcbiAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICB8IFRvcGljRnVuY3Rpb25TdWJzY3JpYmVyUHJvcHNcbiAgICAgIHwgUXVldWVcbiAgICAgIHwgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wc1xuICAgIClbXVxuICApOiB2b2lkIHtcbiAgICBzdWJzY3JpYmVycy5mb3JFYWNoKChzdWJzY3JpYmVyKSA9PiB0aGlzLmFkZFN1YnNjcmliZXIoc2NvcGUsIHN1YnNjcmliZXIpKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmliZXJzXG4gICAgICAuZmlsdGVyKChzdWJzY3JpYmVyKSA9PiBzdWJzY3JpYmVyIGluc3RhbmNlb2YgRm4pXG4gICAgICAuZm9yRWFjaCgoc3Vic2NyaWJlcikgPT4gc3Vic2NyaWJlci5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucykpO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFN1YnNjcmliZXJzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9TdWJzY3JpYmVyKFxuICAgIGluZGV4OiBudW1iZXIsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IHN1YnNjcmliZXIgPSB0aGlzLnN1YnNjcmliZXJzW2luZGV4XTtcbiAgICBpZiAoIShzdWJzY3JpYmVyIGluc3RhbmNlb2YgRm4pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgYXR0YWNoIHBlcm1pc3Npb25zIHRvIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFRvcGljIHN1YnNjcmliZXIgYmVjYXVzZSBpdCdzIG5vdCBhIExhbWJkYSBmdW5jdGlvbmBcbiAgICAgICk7XG4gICAgfVxuICAgIHN1YnNjcmliZXIuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIlRvcGljXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHRvcGljQXJuOiB0aGlzLnNuc1RvcGljLnRvcGljQXJuLFxuICAgICAgICBzdWJzY3JpYmVyczogdGhpcy5zdWJzY3JpYmVycy5tYXAoKHMpID0+IGdldEZ1bmN0aW9uUmVmKHMpISksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFkZFN1YnNjcmliZXIoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBzdWJzY3JpYmVyOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBUb3BpY1F1ZXVlU3Vic2NyaWJlclByb3BzXG4gICk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIHN1YnNjcmliZXIgaW5zdGFuY2VvZiBRdWV1ZSB8fFxuICAgICAgKHN1YnNjcmliZXIgYXMgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wcykucXVldWVcbiAgICApIHtcbiAgICAgIHN1YnNjcmliZXIgPSBzdWJzY3JpYmVyIGFzIFF1ZXVlIHwgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wcztcbiAgICAgIHRoaXMuYWRkUXVldWVTdWJzY3JpYmVyKHNjb3BlLCBzdWJzY3JpYmVyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3Vic2NyaWJlciA9IHN1YnNjcmliZXIgYXNcbiAgICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgICAgfCBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzO1xuICAgICAgdGhpcy5hZGRGdW5jdGlvblN1YnNjcmliZXIoc2NvcGUsIHN1YnNjcmliZXIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUXVldWVTdWJzY3JpYmVyKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgc3Vic2NyaWJlcjogUXVldWUgfCBUb3BpY1F1ZXVlU3Vic2NyaWJlclByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIFBhcnNlIHN1YnNjcmliZXIgcHJvcHNcbiAgICBsZXQgc3Vic2NyaWJlclByb3BzO1xuICAgIGxldCBxdWV1ZTtcbiAgICBpZiAoc3Vic2NyaWJlciBpbnN0YW5jZW9mIFF1ZXVlKSB7XG4gICAgICBzdWJzY3JpYmVyID0gc3Vic2NyaWJlciBhcyBRdWV1ZTtcbiAgICAgIHF1ZXVlID0gc3Vic2NyaWJlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgc3Vic2NyaWJlciA9IHN1YnNjcmliZXIgYXMgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wcztcbiAgICAgIHN1YnNjcmliZXJQcm9wcyA9IHN1YnNjcmliZXIuc3Vic2NyaWJlclByb3BzO1xuICAgICAgcXVldWUgPSBzdWJzY3JpYmVyLnF1ZXVlO1xuICAgIH1cbiAgICB0aGlzLnN1YnNjcmliZXJzLnB1c2gocXVldWUpO1xuXG4gICAgLy8gQ3JlYXRlIFN1YnNjcmlwdGlvblxuICAgIHRoaXMuc25zVG9waWMuYWRkU3Vic2NyaXB0aW9uKFxuICAgICAgbmV3IHNuc1N1YnNjcmlwdGlvbnMuU3FzU3Vic2NyaXB0aW9uKHF1ZXVlLnNxc1F1ZXVlLCBzdWJzY3JpYmVyUHJvcHMpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRnVuY3Rpb25TdWJzY3JpYmVyKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgc3Vic2NyaWJlcjogRnVuY3Rpb25EZWZpbml0aW9uIHwgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBQYXJzZSBzdWJzY3JpYmVyIHByb3BzXG4gICAgbGV0IHN1YnNjcmliZXJQcm9wcztcbiAgICBsZXQgZnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIGlmICgoc3Vic2NyaWJlciBhcyBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzKS5mdW5jdGlvbikge1xuICAgICAgc3Vic2NyaWJlciA9IHN1YnNjcmliZXIgYXMgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wcztcbiAgICAgIHN1YnNjcmliZXJQcm9wcyA9IHN1YnNjcmliZXIuc3Vic2NyaWJlclByb3BzO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gc3Vic2NyaWJlci5mdW5jdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgc3Vic2NyaWJlciA9IHN1YnNjcmliZXIgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gc3Vic2NyaWJlcjtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb25cbiAgICBjb25zdCBpID0gdGhpcy5zdWJzY3JpYmVycy5sZW5ndGg7XG4gICAgY29uc3QgZm4gPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYFN1YnNjcmliZXJfJHt0aGlzLm5vZGUuaWR9XyR7aX1gLFxuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHN1YnNjcmliZXJzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBUb3BpYyBjb25zdHJ1Y3QgY2FuIGFwcGx5IHRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgdG8gdGhlbS5gXG4gICAgKTtcbiAgICB0aGlzLnN1YnNjcmliZXJzLnB1c2goZm4pO1xuXG4gICAgLy8gQ3JlYXRlIFN1YnNjcmlwdGlvblxuICAgIHRoaXMuc25zVG9waWMuYWRkU3Vic2NyaXB0aW9uKFxuICAgICAgbmV3IHNuc1N1YnNjcmlwdGlvbnMuTGFtYmRhU3Vic2NyaXB0aW9uKGZuLCBzdWJzY3JpYmVyUHJvcHMpXG4gICAgKTtcblxuICAgIC8vIEF0dGFjaCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFN1YnNjcmliZXJzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgfVxufVxuIl19