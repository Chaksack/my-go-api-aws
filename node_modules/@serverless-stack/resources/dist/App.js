"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const core_1 = require("@serverless-stack/core");
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const FunctionalStack_1 = require("./FunctionalStack");
function exitWithMessage(message) {
    console.error(message);
    process.exit(1);
}
class App extends cdk.App {
    constructor(deployProps = {}, props = {}) {
        super(props);
        /**
         * Is the app being deployed locally
         */
        this.local = false;
        /**
         * A list of Lambda functions in the app
         */
        this.lambdaHandlers = [];
        this.siteEnvironments = [];
        this.appPath = process.cwd();
        this.stage = deployProps.stage || "dev";
        this.name = deployProps.name || "my-app";
        this.region =
            deployProps.region || process.env.CDK_DEFAULT_REGION || "us-east-1";
        this.lint = deployProps.lint === false ? false : true;
        this.account = process.env.CDK_DEFAULT_ACCOUNT || "my-account";
        this.typeCheck = deployProps.typeCheck === false ? false : true;
        this.esbuildConfig = deployProps.esbuildConfig;
        this.buildDir = deployProps.buildDir || ".build";
        this.skipBuild = deployProps.skipBuild || false;
        this.defaultFunctionProps = [];
        this.synthCallback = deployProps.synthCallback;
        core_1.State.init(this.appPath);
        if (deployProps.debugEndpoint) {
            this.local = true;
            core_1.State.Function.reset(this.appPath);
            this.debugEndpoint = deployProps.debugEndpoint;
            this.debugBucketArn = deployProps.debugBucketArn;
            this.debugBucketName = deployProps.debugBucketName;
            this.debugStartedAt = deployProps.debugStartedAt;
            this.debugIncreaseTimeout = deployProps.debugIncreaseTimeout;
            if (deployProps.debugBridge) {
                this.debugBridge = deployProps.debugBridge;
            }
        }
    }
    get defaultRemovalPolicy() {
        return this._defaultRemovalPolicy;
    }
    logicalPrefixedName(logicalName) {
        const namePrefix = this.name === "" ? "" : `${this.name}-`;
        return `${this.stage}-${namePrefix}${logicalName}`;
    }
    setDefaultRemovalPolicy(policy) {
        this._defaultRemovalPolicy = policy;
    }
    setDefaultFunctionProps(props) {
        if (this.lambdaHandlers.length > 0)
            throw new Error("Cannot call 'setDefaultFunctionProps' after a stack with functions has been created. Please use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' to add more default properties. Read more about this change here: https://docs.serverless-stack.com/constructs/App#upgrading-to-v0420");
        this.defaultFunctionProps.push(props);
    }
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    synth(options = {}) {
        this.buildConstructsMetadata();
        for (const child of this.node.children) {
            if ((0, Construct_1.isStackConstruct)(child)) {
                // Tag stacks
                cdk.Tags.of(child).add("sst:app", this.name);
                cdk.Tags.of(child).add("sst:stage", this.stage);
                // Set removal policy
                if (this._defaultRemovalPolicy)
                    this.applyRemovalPolicy(child, this._defaultRemovalPolicy);
                // Stack names need to be parameterized with the stage name
                if (!child.stackName.startsWith(`${this.stage}-`) &&
                    !child.stackName.endsWith(`-${this.stage}`) &&
                    child.stackName.indexOf(`-${this.stage}-`) === -1) {
                    throw new Error(`Stack "${child.stackName}" is not parameterized with the stage name. The stack name needs to either start with "$stage-", end in "-$stage", or contain the stage name "-$stage-".`);
                }
            }
        }
        const cloudAssembly = super.synth(options);
        // Run callback after synth has finished
        if (this.synthCallback) {
            this.synthCallback(this.lambdaHandlers, this.siteEnvironments);
        }
        return cloudAssembly;
    }
    isJestTest() {
        // Check the env var set inside test/setup-tests.js
        return process.env.JEST_RESOURCES_TESTS === "enabled";
    }
    registerLambdaHandler(handler) {
        this.lambdaHandlers.push(handler);
    }
    registerSiteEnvironment(environment) {
        this.siteEnvironments.push(environment);
    }
    getInputFilesFromEsbuildMetafile(file) {
        let metaJson;
        try {
            metaJson = fs.readJsonSync(file);
        }
        catch (e) {
            exitWithMessage("There was a problem reading the esbuild metafile.");
        }
        return Object.keys(metaJson.inputs).map((input) => path.resolve(input));
    }
    buildConstructsMetadata() {
        const constructs = this.buildConstructsMetadata_collectConstructs(this);
        const byStack = {};
        const local = [];
        for (const c of constructs) {
            const stack = Stack_1.Stack.of(c);
            const list = byStack[stack.node.id] || [];
            const metadata = c.getConstructMetadata();
            const item = Object.assign({ id: c.node.id, addr: c.node.addr, stack: Stack_1.Stack.of(c).stackName }, metadata);
            local.push(item);
            list.push(Object.assign(Object.assign({}, item), { local: undefined }));
            byStack[stack.node.id] = list;
        }
        // Register constructs
        for (const child of this.node.children) {
            if (child instanceof Stack_1.Stack) {
                const stackName = child.node.id;
                child.addConstructsMetadata(byStack[stackName] || []);
            }
        }
        fs.writeJSONSync(core_1.State.resolve(this.appPath, "constructs.json"), local);
    }
    buildConstructsMetadata_collectConstructs(construct) {
        return [
            (0, Construct_1.isSSTConstruct)(construct) ? construct : undefined,
            ...construct.node.children.flatMap((c) => this.buildConstructsMetadata_collectConstructs(c)),
        ].filter((c) => Boolean(c));
    }
    applyRemovalPolicy(current, policy) {
        if (current instanceof cdk.CfnResource)
            current.applyRemovalPolicy(policy);
        // Had to copy this in to enable deleting objects in bucket
        // https://github.com/aws/aws-cdk/blob/master/packages/%40aws-cdk/aws-s3/lib/bucket.ts#L1910
        if (current instanceof s3.Bucket &&
            !current.node.tryFindChild("AutoDeleteObjectsCustomResource")) {
            const AUTO_DELETE_OBJECTS_RESOURCE_TYPE = "Custom::S3AutoDeleteObjects";
            const provider = cdk.CustomResourceProvider.getOrCreateProvider(current, AUTO_DELETE_OBJECTS_RESOURCE_TYPE, {
                codeDirectory: path.join(require.resolve("aws-cdk-lib/aws-s3"), "../lib/auto-delete-objects-handler"),
                runtime: cdk.CustomResourceProviderRuntime.NODEJS_12_X,
                description: `Lambda function for auto-deleting objects in ${current.bucketName} S3 bucket.`,
            });
            // Use a bucket policy to allow the custom resource to delete
            // objects in the bucket
            current.addToResourcePolicy(new iam.PolicyStatement({
                actions: [
                    // list objects
                    "s3:GetBucket*",
                    "s3:List*",
                    // and then delete them
                    "s3:DeleteObject*",
                ],
                resources: [current.bucketArn, current.arnForObjects("*")],
                principals: [new iam.ArnPrincipal(provider.roleArn)],
            }));
            const customResource = new cdk.CustomResource(current, "AutoDeleteObjectsCustomResource", {
                resourceType: AUTO_DELETE_OBJECTS_RESOURCE_TYPE,
                serviceToken: provider.serviceToken,
                properties: {
                    BucketName: current.bucketName,
                },
            });
            // Ensure bucket policy is deleted AFTER the custom resource otherwise
            // we don't have permissions to list and delete in the bucket.
            // (add a `if` to make TS happy)
            if (current.policy) {
                customResource.node.addDependency(current.policy);
            }
        }
        current.node.children.forEach((resource) => this.applyRemovalPolicy(resource, policy));
    }
    // Functional Stack
    // This is a magical global to avoid having to pass app everywhere.
    // We only every have one instance of app
    stack(fn, props) {
        return (0, FunctionalStack_1.stack)(this, fn, props);
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0IsaURBQW1DO0FBRW5DLHVEQUF5QztBQUN6Qyx5REFBMkM7QUFHM0MsaURBQStDO0FBQy9DLG1DQUFnQztBQUNoQywyQ0FLcUI7QUFLckIsdURBQTJEO0FBRTNELFNBQVMsZUFBZSxDQUFDLE9BQWU7SUFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUM7QUFzREQsTUFBYSxHQUFJLFNBQVEsR0FBRyxDQUFDLEdBQUc7SUE0RDlCLFlBQVksY0FBOEIsRUFBRSxFQUFFLFFBQWtCLEVBQUU7UUFDaEUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBNURmOztXQUVHO1FBQ2EsVUFBSyxHQUFZLEtBQUssQ0FBQztRQXNDdkM7O1dBRUc7UUFDYyxtQkFBYyxHQUEyQixFQUFFLENBQUM7UUFDNUMscUJBQWdCLEdBQXFDLEVBQUUsQ0FBQztRQWdCdkUsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFN0IsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQztRQUN4QyxJQUFJLENBQUMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxNQUFNO1lBQ1QsV0FBVyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLFdBQVcsQ0FBQztRQUN0RSxJQUFJLENBQUMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FB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QUUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUQsVUFBVSxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNyRCxDQUFDLENBQ0gsQ0FBQztZQUVGLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLGNBQWMsQ0FDM0MsT0FBTyxFQUNQLGlDQUFpQyxFQUNqQztnQkFDRSxZQUFZLEVBQUUsaUNBQWlDO2dCQUMvQyxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7Z0JBQ25DLFVBQVUsRUFBRTtvQkFDVixVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVU7aUJBQy9CO2FBQ0YsQ0FDRixDQUFDO1lBRUYsc0VBQXNFO1lBQ3RFLDhEQUE4RDtZQUM5RCxnQ0FBZ0M7WUFDaEMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO2dCQUNsQixjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDbkQ7U0FDRjtRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQ3pDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQzFDLENBQUM7SUFDSixDQUFDO0lBRUQsbUJBQW1CO0lBQ25CLG1FQUFtRTtJQUNuRSx5Q0FBeUM7SUFFekMsS0FBSyxDQUNILEVBQUssRUFDTCxLQUFvQztRQUVwQyxPQUFPLElBQUEsdUJBQUssRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDRjtBQXZURCxrQkF1VEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IElDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgeyBJTGF5ZXJWZXJzaW9uIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIGN4YXBpIGZyb20gXCJhd3MtY2RrLWxpYi9jeC1hcGlcIjtcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSBcIkBzZXJ2ZXJsZXNzLXN0YWNrL2NvcmVcIjtcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcIi4vU3RhY2tcIjtcbmltcG9ydCB7XG4gIFNTVENvbnN0cnVjdCxcbiAgU1NUQ29uc3RydWN0TWV0YWRhdGEsXG4gIGlzU1NUQ29uc3RydWN0LFxuICBpc1N0YWNrQ29uc3RydWN0LFxufSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uSGFuZGxlclByb3BzIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyB9IGZyb20gXCIuL0Jhc2VTaXRlXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgU3RhY2tQcm9wcyB9IGZyb20gXCIuXCI7XG5pbXBvcnQgeyBGdW5jdGlvbmFsU3RhY2ssIHN0YWNrIH0gZnJvbSBcIi4vRnVuY3Rpb25hbFN0YWNrXCI7XG5cbmZ1bmN0aW9uIGV4aXRXaXRoTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpIHtcbiAgY29uc29sZS5lcnJvcihtZXNzYWdlKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG5leHBvcnQgdHlwZSBEZXBsb3lQcm9wcyA9IEFwcERlcGxveVByb3BzO1xuXG4vKipcbiAqIERlcGxveSBwcm9wcyBmb3IgYXBwcy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBcHBEZXBsb3lQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgYXBwIG5hbWUsIHVzZWQgdG8gcHJlZml4IHN0YWNrcy5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byBlbXB0eSBzdHJpbmdcbiAgICovXG4gIHJlYWRvbmx5IG5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBzdGFnZSB0byBkZXBsb3kgdGhpcyBhcHAgdG8uXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRGVmYXVsdHMgdG8gZGV2XG4gICAqL1xuICByZWFkb25seSBzdGFnZT86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHJlZ2lvbiB0byBkZXBsb3kgdGhpcyBhcHAgdG8uXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRGVmYXVsdHMgdG8gdXMtZWFzdC0xXG4gICAqL1xuICByZWFkb25seSByZWdpb24/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgbGludD86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHR5cGVDaGVjaz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGJ1aWxkRGlyPzogc3RyaW5nO1xuICByZWFkb25seSBza2lwQnVpbGQ/OiBib29sZWFuO1xuICByZWFkb25seSBlc2J1aWxkQ29uZmlnPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0VuZHBvaW50Pzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0J1Y2tldEFybj86IHN0cmluZztcbiAgcmVhZG9ubHkgZGVidWdCdWNrZXROYW1lPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z1N0YXJ0ZWRBdD86IG51bWJlcjtcbiAgcmVhZG9ubHkgZGVidWdCcmlkZ2U/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlYnVnSW5jcmVhc2VUaW1lb3V0PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIGNhbGxiYWNrIGFmdGVyIHN5bnRoIGNvbXBsZXRlcywgdXNlZCBieSBgc3N0IHN0YXJ0YC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byB1bmRlZmluZWRcbiAgICovXG4gIHJlYWRvbmx5IHN5bnRoQ2FsbGJhY2s/OiAoXG4gICAgbGFtYmRhSGFuZGxlcnM6IEZ1bmN0aW9uSGFuZGxlclByb3BzW10sXG4gICAgc2l0ZUVudmlyb25tZW50czogQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvW11cbiAgKSA9PiB2b2lkO1xufVxuXG5leHBvcnQgdHlwZSBBcHBQcm9wcyA9IGNkay5BcHBQcm9wcztcblxuZXhwb3J0IGNsYXNzIEFwcCBleHRlbmRzIGNkay5BcHAge1xuICAvKipcbiAgICogSXMgdGhlIGFwcCBiZWluZyBkZXBsb3llZCBsb2NhbGx5XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbG9jYWw6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogVGhlIGFwcCBuYW1lXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhZ2U6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHJlZ2lvbjogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgbGludDogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IGFjY291bnQ6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHR5cGVDaGVjazogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IGJ1aWxkRGlyOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBlc2J1aWxkQ29uZmlnPzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdCcmlkZ2U/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0VuZHBvaW50Pzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdCdWNrZXRBcm4/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0J1Y2tldE5hbWU/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z1N0YXJ0ZWRBdD86IG51bWJlcjtcbiAgcHVibGljIHJlYWRvbmx5IGRlYnVnSW5jcmVhc2VUaW1lb3V0PzogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IGFwcFBhdGg6IHN0cmluZztcblxuICBwdWJsaWMgZGVmYXVsdEZ1bmN0aW9uUHJvcHM6IChcbiAgICB8IEZ1bmN0aW9uUHJvcHNcbiAgICB8ICgoc3RhY2s6IGNkay5TdGFjaykgPT4gRnVuY3Rpb25Qcm9wcylcbiAgKVtdO1xuICBwcml2YXRlIF9kZWZhdWx0UmVtb3ZhbFBvbGljeT86IGNkay5SZW1vdmFsUG9saWN5O1xuICBwdWJsaWMgZ2V0IGRlZmF1bHRSZW1vdmFsUG9saWN5KCkge1xuICAgIHJldHVybiB0aGlzLl9kZWZhdWx0UmVtb3ZhbFBvbGljeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgY2FsbGJhY2sgYWZ0ZXIgc3ludGggY29tcGxldGVzLlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBzeW50aENhbGxiYWNrPzogKFxuICAgIGxhbWJkYUhhbmRsZXJzOiBGdW5jdGlvbkhhbmRsZXJQcm9wc1tdLFxuICAgIHNpdGVFbnZpcm9ubWVudHM6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mb1tdXG4gICkgPT4gdm9pZDtcblxuICAvKipcbiAgICogQSBsaXN0IG9mIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGFwcFxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBsYW1iZGFIYW5kbGVyczogRnVuY3Rpb25IYW5kbGVyUHJvcHNbXSA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IHNpdGVFbnZpcm9ubWVudHM6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mb1tdID0gW107XG5cbiAgLyoqXG4gICAqIFNraXAgYnVpbGRpbmcgRnVuY3Rpb24gY29kZVxuICAgKiBOb3RlIHRoYXQgb24gYHNzdCByZW1vdmVgLCB3ZSBkbyBub3Qgd2FudCB0byBidW5kbGUgdGhlIExhbWJkYSBmdW5jdGlvbnMuXG4gICAqICAgICAgQ0RLIGRpc2FibGVzIGJ1bmRsaW5nIChpZS4gemlwcGluZykgZm9yIGBjZGsgZGVzdHJveWAgY29tbWFuZC5cbiAgICogICAgICBCdXQgU1NUIHJ1bnMgYGNkayBzeW50aGAgZmlyc3QgdGhlbiBtYW51YWxseSByZW1vdmUgZWFjaCBzdGFjay4gSGVuY2VcbiAgICogICAgICB3ZSBjYW5ub3QgcmVseSBvbiBDREsgdG8gZGlzYWJsZSBidW5kbGluZywgYW5kIHdlIGRpc2FibGUgaXQgbWFudWFsbHkuXG4gICAqICAgICAgVGhpcyBhbGxvd3MgdXMgdG8gZGlzYWJsZSBCT1RIIGJ1aWxkaW5nIGFuZCBidW5kbGluZywgd2hlcmUgYXMgQ0RLXG4gICAqICAgICAgd291bGQgb25seSBkaXNhYmxlIHRoZSBsYXR0ZXIuIEZvciBleGFtcGxlLCBgY2RrIGRlc3Ryb3lgIHN0aWxsIHRyeXNcbiAgICogICAgICB0byBpbnN0YWxsIFB5dGhvbiBkZXBlbmRlbmNpZXMgaW4gRG9ja2VyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHNraXBCdWlsZDogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihkZXBsb3lQcm9wczogQXBwRGVwbG95UHJvcHMgPSB7fSwgcHJvcHM6IEFwcFByb3BzID0ge30pIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgdGhpcy5hcHBQYXRoID0gcHJvY2Vzcy5jd2QoKTtcblxuICAgIHRoaXMuc3RhZ2UgPSBkZXBsb3lQcm9wcy5zdGFnZSB8fCBcImRldlwiO1xuICAgIHRoaXMubmFtZSA9IGRlcGxveVByb3BzLm5hbWUgfHwgXCJteS1hcHBcIjtcbiAgICB0aGlzLnJlZ2lvbiA9XG4gICAgICBkZXBsb3lQcm9wcy5yZWdpb24gfHwgcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OIHx8IFwidXMtZWFzdC0xXCI7XG4gICAgdGhpcy5saW50ID0gZGVwbG95UHJvcHMubGludCA9PT0gZmFsc2UgPyBmYWxzZSA6IHRydWU7XG4gICAgdGhpcy5hY2NvdW50ID0gcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfQUNDT1VOVCB8fCBcIm15LWFjY291bnRcIjtcbiAgICB0aGlzLnR5cGVDaGVjayA9IGRlcGxveVByb3BzLnR5cGVDaGVjayA9PT0gZmFsc2UgPyBmYWxzZSA6IHRydWU7XG4gICAgdGhpcy5lc2J1aWxkQ29uZmlnID0gZGVwbG95UHJvcHMuZXNidWlsZENvbmZpZztcbiAgICB0aGlzLmJ1aWxkRGlyID0gZGVwbG95UHJvcHMuYnVpbGREaXIgfHwgXCIuYnVpbGRcIjtcbiAgICB0aGlzLnNraXBCdWlsZCA9IGRlcGxveVByb3BzLnNraXBCdWlsZCB8fCBmYWxzZTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gW107XG4gICAgdGhpcy5zeW50aENhbGxiYWNrID0gZGVwbG95UHJvcHMuc3ludGhDYWxsYmFjaztcblxuICAgIFN0YXRlLmluaXQodGhpcy5hcHBQYXRoKTtcbiAgICBpZiAoZGVwbG95UHJvcHMuZGVidWdFbmRwb2ludCkge1xuICAgICAgdGhpcy5sb2NhbCA9IHRydWU7XG4gICAgICBTdGF0ZS5GdW5jdGlvbi5yZXNldCh0aGlzLmFwcFBhdGgpO1xuICAgICAgdGhpcy5kZWJ1Z0VuZHBvaW50ID0gZGVwbG95UHJvcHMuZGVidWdFbmRwb2ludDtcbiAgICAgIHRoaXMuZGVidWdCdWNrZXRBcm4gPSBkZXBsb3lQcm9wcy5kZWJ1Z0J1Y2tldEFybjtcbiAgICAgIHRoaXMuZGVidWdCdWNrZXROYW1lID0gZGVwbG95UHJvcHMuZGVidWdCdWNrZXROYW1lO1xuICAgICAgdGhpcy5kZWJ1Z1N0YXJ0ZWRBdCA9IGRlcGxveVByb3BzLmRlYnVnU3RhcnRlZEF0O1xuICAgICAgdGhpcy5kZWJ1Z0luY3JlYXNlVGltZW91dCA9IGRlcGxveVByb3BzLmRlYnVnSW5jcmVhc2VUaW1lb3V0O1xuICAgICAgaWYgKGRlcGxveVByb3BzLmRlYnVnQnJpZGdlKSB7XG4gICAgICAgIHRoaXMuZGVidWdCcmlkZ2UgPSBkZXBsb3lQcm9wcy5kZWJ1Z0JyaWRnZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsb2dpY2FsUHJlZml4ZWROYW1lKGxvZ2ljYWxOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IG5hbWVQcmVmaXggPSB0aGlzLm5hbWUgPT09IFwiXCIgPyBcIlwiIDogYCR7dGhpcy5uYW1lfS1gO1xuICAgIHJldHVybiBgJHt0aGlzLnN0YWdlfS0ke25hbWVQcmVmaXh9JHtsb2dpY2FsTmFtZX1gO1xuICB9XG5cbiAgc2V0RGVmYXVsdFJlbW92YWxQb2xpY3kocG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeSkge1xuICAgIHRoaXMuX2RlZmF1bHRSZW1vdmFsUG9saWN5ID0gcG9saWN5O1xuICB9XG5cbiAgc2V0RGVmYXVsdEZ1bmN0aW9uUHJvcHMoXG4gICAgcHJvcHM6IEZ1bmN0aW9uUHJvcHMgfCAoKHN0YWNrOiBjZGsuU3RhY2spID0+IEZ1bmN0aW9uUHJvcHMpXG4gICk6IHZvaWQge1xuICAgIGlmICh0aGlzLmxhbWJkYUhhbmRsZXJzLmxlbmd0aCA+IDApXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiQ2Fubm90IGNhbGwgJ3NldERlZmF1bHRGdW5jdGlvblByb3BzJyBhZnRlciBhIHN0YWNrIHdpdGggZnVuY3Rpb25zIGhhcyBiZWVuIGNyZWF0ZWQuIFBsZWFzZSB1c2UgJ2FkZERlZmF1bHRGdW5jdGlvbkVudicgb3IgJ2FkZERlZmF1bHRGdW5jdGlvblBlcm1pc3Npb25zJyB0byBhZGQgbW9yZSBkZWZhdWx0IHByb3BlcnRpZXMuIFJlYWQgbW9yZSBhYm91dCB0aGlzIGNoYW5nZSBoZXJlOiBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BcHAjdXBncmFkaW5nLXRvLXYwNDIwXCJcbiAgICAgICk7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHByb3BzKTtcbiAgfVxuXG4gIGFkZERlZmF1bHRGdW5jdGlvblBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucykge1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaCh7XG4gICAgICBwZXJtaXNzaW9ucyxcbiAgICB9KTtcbiAgfVxuXG4gIGFkZERlZmF1bHRGdW5jdGlvbkVudihlbnZpcm9ubWVudDogUmVjb3JkPHN0cmluZywgc3RyaW5nPikge1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaCh7XG4gICAgICBlbnZpcm9ubWVudCxcbiAgICB9KTtcbiAgfVxuXG4gIGFkZERlZmF1bHRGdW5jdGlvbkxheWVycyhsYXllcnM6IElMYXllclZlcnNpb25bXSkge1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaCh7XG4gICAgICBsYXllcnMsXG4gICAgfSk7XG4gIH1cblxuICBzeW50aChvcHRpb25zOiBjZGsuU3RhZ2VTeW50aGVzaXNPcHRpb25zID0ge30pOiBjeGFwaS5DbG91ZEFzc2VtYmx5IHtcbiAgICB0aGlzLmJ1aWxkQ29uc3RydWN0c01ldGFkYXRhKCk7XG5cbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMubm9kZS5jaGlsZHJlbikge1xuICAgICAgaWYgKGlzU3RhY2tDb25zdHJ1Y3QoY2hpbGQpKSB7XG4gICAgICAgIC8vIFRhZyBzdGFja3NcbiAgICAgICAgY2RrLlRhZ3Mub2YoY2hpbGQpLmFkZChcInNzdDphcHBcIiwgdGhpcy5uYW1lKTtcbiAgICAgICAgY2RrLlRhZ3Mub2YoY2hpbGQpLmFkZChcInNzdDpzdGFnZVwiLCB0aGlzLnN0YWdlKTtcblxuICAgICAgICAvLyBTZXQgcmVtb3ZhbCBwb2xpY3lcbiAgICAgICAgaWYgKHRoaXMuX2RlZmF1bHRSZW1vdmFsUG9saWN5KVxuICAgICAgICAgIHRoaXMuYXBwbHlSZW1vdmFsUG9saWN5KGNoaWxkLCB0aGlzLl9kZWZhdWx0UmVtb3ZhbFBvbGljeSk7XG5cbiAgICAgICAgLy8gU3RhY2sgbmFtZXMgbmVlZCB0byBiZSBwYXJhbWV0ZXJpemVkIHdpdGggdGhlIHN0YWdlIG5hbWVcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFjaGlsZC5zdGFja05hbWUuc3RhcnRzV2l0aChgJHt0aGlzLnN0YWdlfS1gKSAmJlxuICAgICAgICAgICFjaGlsZC5zdGFja05hbWUuZW5kc1dpdGgoYC0ke3RoaXMuc3RhZ2V9YCkgJiZcbiAgICAgICAgICBjaGlsZC5zdGFja05hbWUuaW5kZXhPZihgLSR7dGhpcy5zdGFnZX0tYCkgPT09IC0xXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBTdGFjayBcIiR7Y2hpbGQuc3RhY2tOYW1lfVwiIGlzIG5vdCBwYXJhbWV0ZXJpemVkIHdpdGggdGhlIHN0YWdlIG5hbWUuIFRoZSBzdGFjayBuYW1lIG5lZWRzIHRvIGVpdGhlciBzdGFydCB3aXRoIFwiJHN0YWdlLVwiLCBlbmQgaW4gXCItJHN0YWdlXCIsIG9yIGNvbnRhaW4gdGhlIHN0YWdlIG5hbWUgXCItJHN0YWdlLVwiLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY2xvdWRBc3NlbWJseSA9IHN1cGVyLnN5bnRoKG9wdGlvbnMpO1xuXG4gICAgLy8gUnVuIGNhbGxiYWNrIGFmdGVyIHN5bnRoIGhhcyBmaW5pc2hlZFxuICAgIGlmICh0aGlzLnN5bnRoQ2FsbGJhY2spIHtcbiAgICAgIHRoaXMuc3ludGhDYWxsYmFjayh0aGlzLmxhbWJkYUhhbmRsZXJzLCB0aGlzLnNpdGVFbnZpcm9ubWVudHMpO1xuICAgIH1cblxuICAgIHJldHVybiBjbG91ZEFzc2VtYmx5O1xuICB9XG5cbiAgaXNKZXN0VGVzdCgpOiBib29sZWFuIHtcbiAgICAvLyBDaGVjayB0aGUgZW52IHZhciBzZXQgaW5zaWRlIHRlc3Qvc2V0dXAtdGVzdHMuanNcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuSkVTVF9SRVNPVVJDRVNfVEVTVFMgPT09IFwiZW5hYmxlZFwiO1xuICB9XG5cbiAgcmVnaXN0ZXJMYW1iZGFIYW5kbGVyKGhhbmRsZXI6IEZ1bmN0aW9uSGFuZGxlclByb3BzKTogdm9pZCB7XG4gICAgdGhpcy5sYW1iZGFIYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xuICB9XG5cbiAgcmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoZW52aXJvbm1lbnQ6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyk6IHZvaWQge1xuICAgIHRoaXMuc2l0ZUVudmlyb25tZW50cy5wdXNoKGVudmlyb25tZW50KTtcbiAgfVxuXG4gIGdldElucHV0RmlsZXNGcm9tRXNidWlsZE1ldGFmaWxlKGZpbGU6IHN0cmluZyk6IEFycmF5PHN0cmluZz4ge1xuICAgIGxldCBtZXRhSnNvbjtcblxuICAgIHRyeSB7XG4gICAgICBtZXRhSnNvbiA9IGZzLnJlYWRKc29uU3luYyhmaWxlKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBleGl0V2l0aE1lc3NhZ2UoXCJUaGVyZSB3YXMgYSBwcm9ibGVtIHJlYWRpbmcgdGhlIGVzYnVpbGQgbWV0YWZpbGUuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiBPYmplY3Qua2V5cyhtZXRhSnNvbi5pbnB1dHMpLm1hcCgoaW5wdXQpID0+IHBhdGgucmVzb2x2ZShpbnB1dCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvbnN0cnVjdHNNZXRhZGF0YSgpOiB2b2lkIHtcbiAgICBjb25zdCBjb25zdHJ1Y3RzID0gdGhpcy5idWlsZENvbnN0cnVjdHNNZXRhZGF0YV9jb2xsZWN0Q29uc3RydWN0cyh0aGlzKTtcbiAgICB0eXBlIENvbnN0cnVjdCA9IFNTVENvbnN0cnVjdE1ldGFkYXRhICYge1xuICAgICAgYWRkcjogc3RyaW5nO1xuICAgICAgaWQ6IHN0cmluZztcbiAgICAgIHN0YWNrOiBzdHJpbmc7XG4gICAgfTtcbiAgICBjb25zdCBieVN0YWNrOiBSZWNvcmQ8c3RyaW5nLCBDb25zdHJ1Y3RbXT4gPSB7fTtcbiAgICBjb25zdCBsb2NhbDogQ29uc3RydWN0W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGMgb2YgY29uc3RydWN0cykge1xuICAgICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZihjKTtcbiAgICAgIGNvbnN0IGxpc3QgPSBieVN0YWNrW3N0YWNrLm5vZGUuaWRdIHx8IFtdO1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSBjLmdldENvbnN0cnVjdE1ldGFkYXRhKCk7XG4gICAgICBjb25zdCBpdGVtOiBDb25zdHJ1Y3QgPSB7XG4gICAgICAgIGlkOiBjLm5vZGUuaWQsXG4gICAgICAgIGFkZHI6IGMubm9kZS5hZGRyLFxuICAgICAgICBzdGFjazogU3RhY2sub2YoYykuc3RhY2tOYW1lLFxuICAgICAgICAuLi5tZXRhZGF0YSxcbiAgICAgIH07XG4gICAgICBsb2NhbC5wdXNoKGl0ZW0pO1xuICAgICAgbGlzdC5wdXNoKHtcbiAgICAgICAgLi4uaXRlbSxcbiAgICAgICAgbG9jYWw6IHVuZGVmaW5lZCxcbiAgICAgIH0pO1xuICAgICAgYnlTdGFja1tzdGFjay5ub2RlLmlkXSA9IGxpc3Q7XG4gICAgfVxuXG4gICAgLy8gUmVnaXN0ZXIgY29uc3RydWN0c1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5ub2RlLmNoaWxkcmVuKSB7XG4gICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBTdGFjaykge1xuICAgICAgICBjb25zdCBzdGFja05hbWUgPSAoY2hpbGQgYXMgU3RhY2spLm5vZGUuaWQ7XG4gICAgICAgIChjaGlsZCBhcyBTdGFjaykuYWRkQ29uc3RydWN0c01ldGFkYXRhKGJ5U3RhY2tbc3RhY2tOYW1lXSB8fCBbXSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZzLndyaXRlSlNPTlN5bmMoU3RhdGUucmVzb2x2ZSh0aGlzLmFwcFBhdGgsIFwiY29uc3RydWN0cy5qc29uXCIpLCBsb2NhbCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQ29uc3RydWN0c01ldGFkYXRhX2NvbGxlY3RDb25zdHJ1Y3RzKFxuICAgIGNvbnN0cnVjdDogSUNvbnN0cnVjdFxuICApOiAoU1NUQ29uc3RydWN0ICYgSUNvbnN0cnVjdClbXSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIGlzU1NUQ29uc3RydWN0KGNvbnN0cnVjdCkgPyBjb25zdHJ1Y3QgOiB1bmRlZmluZWQsXG4gICAgICAuLi5jb25zdHJ1Y3Qubm9kZS5jaGlsZHJlbi5mbGF0TWFwKChjKSA9PlxuICAgICAgICB0aGlzLmJ1aWxkQ29uc3RydWN0c01ldGFkYXRhX2NvbGxlY3RDb25zdHJ1Y3RzKGMpXG4gICAgICApLFxuICAgIF0uZmlsdGVyKChjKTogYyBpcyBTU1RDb25zdHJ1Y3QgJiBJQ29uc3RydWN0ID0+IEJvb2xlYW4oYykpO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseVJlbW92YWxQb2xpY3koY3VycmVudDogSUNvbnN0cnVjdCwgcG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeSkge1xuICAgIGlmIChjdXJyZW50IGluc3RhbmNlb2YgY2RrLkNmblJlc291cmNlKSBjdXJyZW50LmFwcGx5UmVtb3ZhbFBvbGljeShwb2xpY3kpO1xuXG4gICAgLy8gSGFkIHRvIGNvcHkgdGhpcyBpbiB0byBlbmFibGUgZGVsZXRpbmcgb2JqZWN0cyBpbiBidWNrZXRcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXdzL2F3cy1jZGsvYmxvYi9tYXN0ZXIvcGFja2FnZXMvJTQwYXdzLWNkay9hd3MtczMvbGliL2J1Y2tldC50cyNMMTkxMFxuICAgIGlmIChcbiAgICAgIGN1cnJlbnQgaW5zdGFuY2VvZiBzMy5CdWNrZXQgJiZcbiAgICAgICFjdXJyZW50Lm5vZGUudHJ5RmluZENoaWxkKFwiQXV0b0RlbGV0ZU9iamVjdHNDdXN0b21SZXNvdXJjZVwiKVxuICAgICkge1xuICAgICAgY29uc3QgQVVUT19ERUxFVEVfT0JKRUNUU19SRVNPVVJDRV9UWVBFID0gXCJDdXN0b206OlMzQXV0b0RlbGV0ZU9iamVjdHNcIjtcbiAgICAgIGNvbnN0IHByb3ZpZGVyID0gY2RrLkN1c3RvbVJlc291cmNlUHJvdmlkZXIuZ2V0T3JDcmVhdGVQcm92aWRlcihcbiAgICAgICAgY3VycmVudCxcbiAgICAgICAgQVVUT19ERUxFVEVfT0JKRUNUU19SRVNPVVJDRV9UWVBFLFxuICAgICAgICB7XG4gICAgICAgICAgY29kZURpcmVjdG9yeTogcGF0aC5qb2luKFxuICAgICAgICAgICAgcmVxdWlyZS5yZXNvbHZlKFwiYXdzLWNkay1saWIvYXdzLXMzXCIpLFxuICAgICAgICAgICAgXCIuLi9saWIvYXV0by1kZWxldGUtb2JqZWN0cy1oYW5kbGVyXCJcbiAgICAgICAgICApLFxuICAgICAgICAgIHJ1bnRpbWU6IGNkay5DdXN0b21SZXNvdXJjZVByb3ZpZGVyUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYExhbWJkYSBmdW5jdGlvbiBmb3IgYXV0by1kZWxldGluZyBvYmplY3RzIGluICR7Y3VycmVudC5idWNrZXROYW1lfSBTMyBidWNrZXQuYCxcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgLy8gVXNlIGEgYnVja2V0IHBvbGljeSB0byBhbGxvdyB0aGUgY3VzdG9tIHJlc291cmNlIHRvIGRlbGV0ZVxuICAgICAgLy8gb2JqZWN0cyBpbiB0aGUgYnVja2V0XG4gICAgICBjdXJyZW50LmFkZFRvUmVzb3VyY2VQb2xpY3koXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAvLyBsaXN0IG9iamVjdHNcbiAgICAgICAgICAgIFwiczM6R2V0QnVja2V0KlwiLFxuICAgICAgICAgICAgXCJzMzpMaXN0KlwiLFxuICAgICAgICAgICAgLy8gYW5kIHRoZW4gZGVsZXRlIHRoZW1cbiAgICAgICAgICAgIFwiczM6RGVsZXRlT2JqZWN0KlwiLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbY3VycmVudC5idWNrZXRBcm4sIGN1cnJlbnQuYXJuRm9yT2JqZWN0cyhcIipcIildLFxuICAgICAgICAgIHByaW5jaXBhbHM6IFtuZXcgaWFtLkFyblByaW5jaXBhbChwcm92aWRlci5yb2xlQXJuKV0sXG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBjb25zdCBjdXN0b21SZXNvdXJjZSA9IG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UoXG4gICAgICAgIGN1cnJlbnQsXG4gICAgICAgIFwiQXV0b0RlbGV0ZU9iamVjdHNDdXN0b21SZXNvdXJjZVwiLFxuICAgICAgICB7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiBBVVRPX0RFTEVURV9PQkpFQ1RTX1JFU09VUkNFX1RZUEUsXG4gICAgICAgICAgc2VydmljZVRva2VuOiBwcm92aWRlci5zZXJ2aWNlVG9rZW4sXG4gICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgQnVja2V0TmFtZTogY3VycmVudC5idWNrZXROYW1lLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIC8vIEVuc3VyZSBidWNrZXQgcG9saWN5IGlzIGRlbGV0ZWQgQUZURVIgdGhlIGN1c3RvbSByZXNvdXJjZSBvdGhlcndpc2VcbiAgICAgIC8vIHdlIGRvbid0IGhhdmUgcGVybWlzc2lvbnMgdG8gbGlzdCBhbmQgZGVsZXRlIGluIHRoZSBidWNrZXQuXG4gICAgICAvLyAoYWRkIGEgYGlmYCB0byBtYWtlIFRTIGhhcHB5KVxuICAgICAgaWYgKGN1cnJlbnQucG9saWN5KSB7XG4gICAgICAgIGN1c3RvbVJlc291cmNlLm5vZGUuYWRkRGVwZW5kZW5jeShjdXJyZW50LnBvbGljeSk7XG4gICAgICB9XG4gICAgfVxuICAgIGN1cnJlbnQubm9kZS5jaGlsZHJlbi5mb3JFYWNoKChyZXNvdXJjZSkgPT5cbiAgICAgIHRoaXMuYXBwbHlSZW1vdmFsUG9saWN5KHJlc291cmNlLCBwb2xpY3kpXG4gICAgKTtcbiAgfVxuXG4gIC8vIEZ1bmN0aW9uYWwgU3RhY2tcbiAgLy8gVGhpcyBpcyBhIG1hZ2ljYWwgZ2xvYmFsIHRvIGF2b2lkIGhhdmluZyB0byBwYXNzIGFwcCBldmVyeXdoZXJlLlxuICAvLyBXZSBvbmx5IGV2ZXJ5IGhhdmUgb25lIGluc3RhbmNlIG9mIGFwcFxuXG4gIHN0YWNrPFQgZXh0ZW5kcyBGdW5jdGlvbmFsU3RhY2s8YW55Pj4oXG4gICAgZm46IFQsXG4gICAgcHJvcHM/OiBTdGFja1Byb3BzICYgeyBpZD86IHN0cmluZyB9XG4gICk6IFJldHVyblR5cGU8VD4gZXh0ZW5kcyBQcm9taXNlPGFueT4gPyBQcm9taXNlPHZvaWQ+IDogQXBwIHtcbiAgICByZXR1cm4gc3RhY2sodGhpcywgZm4sIHByb3BzKTtcbiAgfVxufVxuIl19