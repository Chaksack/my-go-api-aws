"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KinesisStream = void 0;
const constructs_1 = require("constructs");
const kinesis = __importStar(require("aws-cdk-lib/aws-kinesis"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class KinesisStream extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { kinesisStream, consumers, defaultFunctionProps } = props || {};
        this.functions = {};
        this.permissionsAttachedForAllConsumers = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Stream
        ////////////////////
        if ((0, Construct_1.isCDKConstruct)(kinesisStream)) {
            this.kinesisStream = kinesisStream;
        }
        else {
            const kinesisStreamProps = (kinesisStream || {});
            this.kinesisStream = new kinesis.Stream(this, "Stream", Object.assign({ streamName: root.logicalPrefixedName(id) }, kinesisStreamProps));
        }
        ///////////////////////////
        // Create Consumers
        ///////////////////////////
        if (consumers) {
            Object.keys(consumers).forEach((consumerName) => this.addConsumer(this, consumerName, consumers[consumerName]));
        }
    }
    get streamArn() {
        return this.kinesisStream.streamArn;
    }
    get streamName() {
        return this.kinesisStream.streamName;
    }
    addConsumers(scope, consumers) {
        Object.keys(consumers).forEach((consumerName) => {
            this.addConsumer(scope, consumerName, consumers[consumerName]);
        });
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    attachPermissionsToConsumer(consumerName, permissions) {
        if (!this.functions[consumerName]) {
            throw new Error(`The "${consumerName}" consumer was not found in the "${this.node.id}" KinesisStream.`);
        }
        this.functions[consumerName].attachPermissions(permissions);
    }
    getFunction(consumerName) {
        return this.functions[consumerName];
    }
    getConstructMetadata() {
        return {
            type: "KinesisStream",
            data: {
                streamName: this.kinesisStream.streamName,
                consumers: Object.entries(this.functions).map(([name, fn]) => ({
                    name,
                    fn: (0, Construct_1.getFunctionRef)(fn),
                })),
            },
        };
    }
    addConsumer(scope, consumerName, consumer) {
        // normalize consumer
        let consumerFunction, consumerProps;
        if (consumer.function) {
            consumer = consumer;
            consumerFunction = consumer.function;
            consumerProps = consumer.consumerProps;
        }
        else {
            consumerFunction = consumer;
        }
        consumerProps = Object.assign({ startingPosition: lambda.StartingPosition.LATEST }, (consumerProps || {}));
        // create function
        const fn = Function_1.Function.fromDefinition(scope, consumerName, consumerFunction, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the KinesisStream construct can apply the "defaultFunctionProps" to them.`);
        this.functions[consumerName] = fn;
        // create event source
        const eventSource = new lambdaEventSources.KinesisEventSource(this.kinesisStream, consumerProps);
        fn.addEventSource(eventSource);
        // attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            fn.attachPermissions(permissions);
        });
        return fn;
    }
}
exports.KinesisStream = KinesisStream;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS2luZXNpc1N0cmVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9LaW5lc2lzU3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLGlFQUFtRDtBQUNuRCwrREFBaUQ7QUFDakQseUZBQTJFO0FBRTNFLDJDQUEyRTtBQUMzRSx5Q0FBK0U7QUFvQi9FLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCLE1BQWEsYUFBYyxTQUFRLHNCQUFTO0lBTTFDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBMEI7UUFDbEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDdkUsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLGtDQUFrQyxHQUFHLEVBQUUsQ0FBQztRQUM3QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7UUFFakQsb0JBQW9CO1FBQ3BCLGdCQUFnQjtRQUNoQixvQkFBb0I7UUFFcEIsSUFBSSxJQUFBLDBCQUFjLEVBQUMsYUFBYSxDQUFDLEVBQUU7WUFDakMsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFnQyxDQUFDO1NBQ3ZEO2FBQU07WUFDTCxNQUFNLGtCQUFrQixHQUFHLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBd0IsQ0FBQztZQUN4RSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxrQkFDcEQsVUFBVSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsSUFD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QUMsYUFBYSxJQUFJLEVBQUUsQ0FBQyxDQUN6QixDQUFDO1FBRUYsa0JBQWtCO1FBQ2xCLE1BQU0sRUFBRSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUMxQixLQUFLLEVBQ0wsWUFBWSxFQUNaLGdCQUFnQixFQUNoQixJQUFJLENBQUMsb0JBQW9CLEVBQ3pCLDJPQUEyTyxDQUM1TyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFbEMsc0JBQXNCO1FBQ3RCLE1BQU0sV0FBVyxHQUFHLElBQUksa0JBQWtCLENBQUMsa0JBQWtCLENBQzNELElBQUksQ0FBQyxhQUFhLEVBQ2xCLGFBQWEsQ0FDZCxDQUFDO1FBQ0YsRUFBRSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUUvQixxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzlELEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztDQUNGO0FBM0lELHNDQTJJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBraW5lc2lzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mta2luZXNpc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFFdmVudFNvdXJjZXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBnZXRGdW5jdGlvblJlZiwgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEludGVyZmFjZXNcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgaW50ZXJmYWNlIEtpbmVzaXNTdHJlYW1Qcm9wcyB7XG4gIHJlYWRvbmx5IGtpbmVzaXNTdHJlYW0/OiBraW5lc2lzLklTdHJlYW0gfCBraW5lc2lzLlN0cmVhbVByb3BzO1xuICByZWFkb25seSBjb25zdW1lcnM/OiB7XG4gICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHM7XG4gIH07XG4gIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBLaW5lc2lzU3RyZWFtQ29uc3VtZXJQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IGNvbnN1bWVyUHJvcHM/OiBsYW1iZGFFdmVudFNvdXJjZXMuS2luZXNpc0V2ZW50U291cmNlUHJvcHM7XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGNsYXNzIEtpbmVzaXNTdHJlYW0gZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkga2luZXNpc1N0cmVhbToga2luZXNpcy5JU3RyZWFtO1xuICBwcml2YXRlIGZ1bmN0aW9uczogeyBbY29uc3VtZXJOYW1lOiBzdHJpbmddOiBGbiB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogS2luZXNpc1N0cmVhbVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHsga2luZXNpc1N0cmVhbSwgY29uc3VtZXJzLCBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB9ID0gcHJvcHMgfHwge307XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBTdHJlYW1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KGtpbmVzaXNTdHJlYW0pKSB7XG4gICAgICB0aGlzLmtpbmVzaXNTdHJlYW0gPSBraW5lc2lzU3RyZWFtIGFzIGtpbmVzaXMuSVN0cmVhbTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qga2luZXNpc1N0cmVhbVByb3BzID0gKGtpbmVzaXNTdHJlYW0gfHwge30pIGFzIGtpbmVzaXMuU3RyZWFtUHJvcHM7XG4gICAgICB0aGlzLmtpbmVzaXNTdHJlYW0gPSBuZXcga2luZXNpcy5TdHJlYW0odGhpcywgXCJTdHJlYW1cIiwge1xuICAgICAgICBzdHJlYW1OYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAuLi5raW5lc2lzU3RyZWFtUHJvcHMsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgQ29uc3VtZXJzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY29uc3VtZXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhjb25zdW1lcnMpLmZvckVhY2goKGNvbnN1bWVyTmFtZTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZENvbnN1bWVyKHRoaXMsIGNvbnN1bWVyTmFtZSwgY29uc3VtZXJzW2NvbnN1bWVyTmFtZV0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3RyZWFtQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMua2luZXNpc1N0cmVhbS5zdHJlYW1Bcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IHN0cmVhbU5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5raW5lc2lzU3RyZWFtLnN0cmVhbU5hbWU7XG4gIH1cblxuICBwdWJsaWMgYWRkQ29uc3VtZXJzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgY29uc3VtZXJzOiB7XG4gICAgICBbY29uc3VtZXJOYW1lOiBzdHJpbmddOiBGdW5jdGlvbkRlZmluaXRpb24gfCBLaW5lc2lzU3RyZWFtQ29uc3VtZXJQcm9wcztcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKGNvbnN1bWVycykuZm9yRWFjaCgoY29uc3VtZXJOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuYWRkQ29uc3VtZXIoc2NvcGUsIGNvbnN1bWVyTmFtZSwgY29uc3VtZXJzW2NvbnN1bWVyTmFtZV0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb0NvbnN1bWVyKFxuICAgIGNvbnN1bWVyTmFtZTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBcIiR7Y29uc3VtZXJOYW1lfVwiIGNvbnN1bWVyIHdhcyBub3QgZm91bmQgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgS2luZXNpc1N0cmVhbS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldEZ1bmN0aW9uKGNvbnN1bWVyTmFtZTogc3RyaW5nKTogRm4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIktpbmVzaXNTdHJlYW1cIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RyZWFtTmFtZTogdGhpcy5raW5lc2lzU3RyZWFtLnN0cmVhbU5hbWUsXG4gICAgICAgIGNvbnN1bWVyczogT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbnMpLm1hcCgoW25hbWUsIGZuXSkgPT4gKHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGZuOiBnZXRGdW5jdGlvblJlZihmbiksXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQ29uc3VtZXIoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBjb25zdW1lck5hbWU6IHN0cmluZyxcbiAgICBjb25zdW1lcjogRnVuY3Rpb25EZWZpbml0aW9uIHwgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHNcbiAgKTogRm4ge1xuICAgIC8vIG5vcm1hbGl6ZSBjb25zdW1lclxuICAgIGxldCBjb25zdW1lckZ1bmN0aW9uLCBjb25zdW1lclByb3BzO1xuICAgIGlmICgoY29uc3VtZXIgYXMgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHMpLmZ1bmN0aW9uKSB7XG4gICAgICBjb25zdW1lciA9IGNvbnN1bWVyIGFzIEtpbmVzaXNTdHJlYW1Db25zdW1lclByb3BzO1xuICAgICAgY29uc3VtZXJGdW5jdGlvbiA9IGNvbnN1bWVyLmZ1bmN0aW9uO1xuICAgICAgY29uc3VtZXJQcm9wcyA9IGNvbnN1bWVyLmNvbnN1bWVyUHJvcHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24gPSBjb25zdW1lciBhcyBGdW5jdGlvbkRlZmluaXRpb247XG4gICAgfVxuICAgIGNvbnN1bWVyUHJvcHMgPSB7XG4gICAgICBzdGFydGluZ1Bvc2l0aW9uOiBsYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1QsXG4gICAgICAuLi4oY29uc3VtZXJQcm9wcyB8fCB7fSksXG4gICAgfTtcblxuICAgIC8vIGNyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGZuID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGNvbnN1bWVyTmFtZSxcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24sXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgY29uc3VtZXJzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBLaW5lc2lzU3RyZWFtIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIHRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0gPSBmbjtcblxuICAgIC8vIGNyZWF0ZSBldmVudCBzb3VyY2VcbiAgICBjb25zdCBldmVudFNvdXJjZSA9IG5ldyBsYW1iZGFFdmVudFNvdXJjZXMuS2luZXNpc0V2ZW50U291cmNlKFxuICAgICAgdGhpcy5raW5lc2lzU3RyZWFtLFxuICAgICAgY29uc3VtZXJQcm9wc1xuICAgICk7XG4gICAgZm4uYWRkRXZlbnRTb3VyY2UoZXZlbnRTb3VyY2UpO1xuXG4gICAgLy8gYXR0YWNoIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PiB7XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZm47XG4gIH1cbn1cbiJdfQ==