"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DebugStack = void 0;
const path = __importStar(require("path"));
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const apig = __importStar(require("aws-cdk-lib/aws-apigatewayv2"));
const dynamodb = __importStar(require("aws-cdk-lib/aws-dynamodb"));
class DebugStack extends cdk.Stack {
    constructor(scope, id, props) {
        const app = scope.node.root;
        const stackId = app.logicalPrefixedName(id);
        DebugStack.checkForEnvInProps(id, props);
        super(scope, stackId, Object.assign(Object.assign({}, props), { env: {
                account: app.account,
                region: app.region,
            } }));
        this.stage = app.stage;
        // Create connection table
        this.table = new dynamodb.Table(this, "Table", {
            partitionKey: { name: "pk", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // Create S3 bucket for storing large payloads
        this.bucket = (props === null || props === void 0 ? void 0 : props.payloadBucketArn)
            ? s3.Bucket.fromBucketArn(this, "Bucket", props.payloadBucketArn)
            : new s3.Bucket(this, "Bucket", {
                lifecycleRules: [
                    {
                        expiration: cdk.Duration.days(1),
                        prefix: "payloads/",
                    },
                ],
                encryption: s3.BucketEncryption.S3_MANAGED,
                removalPolicy: cdk.RemovalPolicy.DESTROY,
                autoDeleteObjects: true,
                blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
            });
        // Create API
        this.api = new apig.CfnApi(this, "Api", {
            name: `${this.stackName}-api`,
            protocolType: "WEBSOCKET",
            routeSelectionExpression: "$request.body.action",
        });
        new apig.CfnStage(this, "ApiStage", {
            apiId: this.api.ref,
            autoDeploy: true,
            stageName: this.stage,
        });
        // Create API routes
        const role = (props === null || props === void 0 ? void 0 : props.websocketHandlerRoleArn)
            ? iam.Role.fromRoleArn(this, "HandlerRole", props.websocketHandlerRoleArn)
            : undefined;
        this.addApiRoute("Connect", "$connect", "wsConnect.main", role);
        this.addApiRoute("Disconnect", "$disconnect", "wsDisconnect.main", role);
        this.addApiRoute("Default", "$default", "wsDefault.main", role);
        // Stack Output
        new cdk.CfnOutput(this, "Endpoint", {
            value: `${this.api.attrApiEndpoint}/${this.stage}`,
        });
        new cdk.CfnOutput(this, "BucketArn", {
            value: this.bucket.bucketArn,
        });
        new cdk.CfnOutput(this, "BucketName", {
            value: this.bucket.bucketName,
        });
    }
    addApiRoute(id, routeKey, handler, role) {
        // Create execution policy
        const policyStatement = new iam.PolicyStatement();
        policyStatement.addAllResources();
        policyStatement.addActions("apigateway:*", "dynamodb:*", "execute-api:ManageConnections");
        // Create Lambda
        const lambdaFunc = new lambda.Function(this, id, {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/DebugStack")),
            handler,
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.seconds(10),
            memorySize: 256,
            logRetention: logs.RetentionDays.ONE_WEEK,
            logRetentionRole: role,
            environment: {
                TABLE_NAME: this.table.tableName,
            },
            role,
            initialPolicy: [policyStatement],
        });
        lambdaFunc.addPermission(`${id}Permission`, {
            principal: new iam.ServicePrincipal("apigateway.amazonaws.com"),
        });
        // Create API integrations
        const integration = new apig.CfnIntegration(this, `${id}Integration`, {
            apiId: this.api.ref,
            integrationType: "AWS_PROXY",
            integrationUri: `arn:${this.partition}:apigateway:${this.region}:lambda:path/2015-03-31/functions/${lambdaFunc.functionArn}/invocations`,
        });
        // Create API routes
        new apig.CfnRoute(this, `${id}Route`, {
            apiId: this.api.ref,
            routeKey,
            authorizationType: "NONE",
            target: `integrations/${integration.ref}`,
        });
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForEnvInProps(id, props) {
        if (props && props.env) {
            let envS = "";
            try {
                envS = " (" + JSON.stringify(props.env) + ")";
            }
            catch (e) {
                // Ignore
            }
            throw new Error(`Do not set the "env" prop while initializing "${id}" stack${envS}. Use the "AWS_PROFILE" environment variable and "--region" CLI option instead.`);
        }
    }
}
exports.DebugStack = DebugStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdTdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9EZWJ1Z1N0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBRTdCLGlEQUFtQztBQUNuQyx1REFBeUM7QUFDekMseURBQTJDO0FBQzNDLDJEQUE2QztBQUM3QywrREFBaUQ7QUFDakQsbUVBQXFEO0FBQ3JELG1FQUFxRDtBQWlCckQsTUFBYSxVQUFXLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFNdkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF1QjtRQUMvRCxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQWdCLENBQUM7UUFDeEMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTVDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFekMsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLGtDQUNmLEtBQUssS0FDUixHQUFHLEVBQUU7Z0JBQ0gsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPO2dCQUNwQixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07YUFDbkIsSUFDRCxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1FBRXZCLDBCQUEwQjtRQUMxQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQzdDLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ2pFLFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLGVBQWU7WUFDakQsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMs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U0FDekksQ0FBQyxDQUFDO1FBRUgsb0JBQW9CO1FBQ3BCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRTtZQUNwQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHO1lBQ25CLFFBQVE7WUFDUixpQkFBaUIsRUFBRSxNQUFNO1lBQ3pCLE1BQU0sRUFBRSxnQkFBZ0IsV0FBVyxDQUFDLEdBQUcsRUFBRTtTQUMxQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsOERBQThEO0lBQ3RELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFVLEVBQUUsS0FBVztRQUN2RCxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ3RCLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUVkLElBQUk7Z0JBQ0YsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7YUFDL0M7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixTQUFTO2FBQ1Y7WUFFRCxNQUFNLElBQUksS0FBSyxDQUNiLGlEQUFpRCxFQUFFLFVBQVUsSUFBSSxpRkFBaUYsQ0FDbkosQ0FBQztTQUNIO0lBQ0gsQ0FBQztDQUNGO0FBMUlELGdDQTBJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBzMyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXMzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIGFwaWcgZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCB7IERlYnVnQXBwIH0gZnJvbSBcIi4vRGVidWdBcHBcIjtcblxuLyoqXG4gKiBTdGFjayBwcm9wZXJ0aWVzIGZvciB0aGUgRGVidWdTdGFjay5cbiAqL1xuIGV4cG9ydCBpbnRlcmZhY2UgRGVidWdTdGFja1Byb3BzIGV4dGVuZHMgY2RrLlN0YWNrUHJvcHMge1xuICAvKipcbiAgICogUzMgYnVja2V0IHRvIHN0b3JlIGxhcmdlIHdlYnNvY2tldCBwYXlsb2Fkcy5cbiAgICovXG4gIHBheWxvYWRCdWNrZXRBcm4/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBMYW1iZGEgZnVuY3Rpb24gcHJvcHMgZm9yIFdlYlNvY2tldCByZXF1ZXN0IGhhbmRsZXJzLlxuICAgKi9cbiAgd2Vic29ja2V0SGFuZGxlclJvbGVBcm4/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBEZWJ1Z1N0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgcHVibGljIHJlYWRvbmx5IHN0YWdlOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXBpOiBhcGlnLkNmbkFwaTtcbiAgcHJpdmF0ZSByZWFkb25seSB0YWJsZTogZHluYW1vZGIuVGFibGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgYnVja2V0OiBzMy5JQnVja2V0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogRGVidWdTdGFja1Byb3BzKSB7XG4gICAgY29uc3QgYXBwID0gc2NvcGUubm9kZS5yb290IGFzIERlYnVnQXBwO1xuICAgIGNvbnN0IHN0YWNrSWQgPSBhcHAubG9naWNhbFByZWZpeGVkTmFtZShpZCk7XG5cbiAgICBEZWJ1Z1N0YWNrLmNoZWNrRm9yRW52SW5Qcm9wcyhpZCwgcHJvcHMpO1xuXG4gICAgc3VwZXIoc2NvcGUsIHN0YWNrSWQsIHtcbiAgICAgIC4uLnByb3BzLFxuICAgICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ6IGFwcC5hY2NvdW50LFxuICAgICAgICByZWdpb246IGFwcC5yZWdpb24sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5zdGFnZSA9IGFwcC5zdGFnZTtcblxuICAgIC8vIENyZWF0ZSBjb25uZWN0aW9uIHRhYmxlXG4gICAgdGhpcy50YWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlRhYmxlXCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInBrXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBTMyBidWNrZXQgZm9yIHN0b3JpbmcgbGFyZ2UgcGF5bG9hZHNcbiAgICB0aGlzLmJ1Y2tldCA9IHByb3BzPy5wYXlsb2FkQnVja2V0QXJuXG4gICAgICA/IHMzLkJ1Y2tldC5mcm9tQnVja2V0QXJuKHRoaXMsIFwiQnVja2V0XCIsIHByb3BzLnBheWxvYWRCdWNrZXRBcm4pXG4gICAgICA6IG5ldyBzMy5CdWNrZXQodGhpcywgXCJCdWNrZXRcIiwge1xuICAgICAgICBsaWZlY3ljbGVSdWxlczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGV4cGlyYXRpb246IGNkay5EdXJhdGlvbi5kYXlzKDEpLFxuICAgICAgICAgICAgcHJlZml4OiBcInBheWxvYWRzL1wiLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIGVuY3J5cHRpb246IHMzLkJ1Y2tldEVuY3J5cHRpb24uUzNfTUFOQUdFRCxcbiAgICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsXG4gICAgICAgIGJsb2NrUHVibGljQWNjZXNzOiBzMy5CbG9ja1B1YmxpY0FjY2Vzcy5CTE9DS19BTEwsXG4gICAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBBUElcbiAgICB0aGlzLmFwaSA9IG5ldyBhcGlnLkNmbkFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICBuYW1lOiBgJHt0aGlzLnN0YWNrTmFtZX0tYXBpYCxcbiAgICAgIHByb3RvY29sVHlwZTogXCJXRUJTT0NLRVRcIixcbiAgICAgIHJvdXRlU2VsZWN0aW9uRXhwcmVzc2lvbjogXCIkcmVxdWVzdC5ib2R5LmFjdGlvblwiLFxuICAgIH0pO1xuICAgIG5ldyBhcGlnLkNmblN0YWdlKHRoaXMsIFwiQXBpU3RhZ2VcIiwge1xuICAgICAgYXBpSWQ6IHRoaXMuYXBpLnJlZixcbiAgICAgIGF1dG9EZXBsb3k6IHRydWUsXG4gICAgICBzdGFnZU5hbWU6IHRoaXMuc3RhZ2UsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgQVBJIHJvdXRlc1xuICAgIGNvbnN0IHJvbGUgPSBwcm9wcz8ud2Vic29ja2V0SGFuZGxlclJvbGVBcm5cbiAgICAgID8gaWFtLlJvbGUuZnJvbVJvbGVBcm4odGhpcywgXCJIYW5kbGVyUm9sZVwiLCBwcm9wcy53ZWJzb2NrZXRIYW5kbGVyUm9sZUFybilcbiAgICAgIDogdW5kZWZpbmVkO1xuICAgIHRoaXMuYWRkQXBpUm91dGUoXCJDb25uZWN0XCIsIFwiJGNvbm5lY3RcIiwgXCJ3c0Nvbm5lY3QubWFpblwiLCByb2xlKTtcbiAgICB0aGlzLmFkZEFwaVJvdXRlKFwiRGlzY29ubmVjdFwiLCBcIiRkaXNjb25uZWN0XCIsIFwid3NEaXNjb25uZWN0Lm1haW5cIiwgcm9sZSk7XG4gICAgdGhpcy5hZGRBcGlSb3V0ZShcIkRlZmF1bHRcIiwgXCIkZGVmYXVsdFwiLCBcIndzRGVmYXVsdC5tYWluXCIsIHJvbGUpO1xuXG4gICAgLy8gU3RhY2sgT3V0cHV0XG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJFbmRwb2ludFwiLCB7XG4gICAgICB2YWx1ZTogYCR7dGhpcy5hcGkuYXR0ckFwaUVuZHBvaW50fS8ke3RoaXMuc3RhZ2V9YCxcbiAgICB9KTtcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcIkJ1Y2tldEFyblwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5idWNrZXQuYnVja2V0QXJuLFxuICAgIH0pO1xuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwiQnVja2V0TmFtZVwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5idWNrZXQuYnVja2V0TmFtZSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQXBpUm91dGUoaWQ6IHN0cmluZywgcm91dGVLZXk6IHN0cmluZywgaGFuZGxlcjogc3RyaW5nLCByb2xlPzogaWFtLklSb2xlKSB7XG4gICAgLy8gQ3JlYXRlIGV4ZWN1dGlvbiBwb2xpY3lcbiAgICBjb25zdCBwb2xpY3lTdGF0ZW1lbnQgPSBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCgpO1xuICAgIHBvbGljeVN0YXRlbWVudC5hZGRBbGxSZXNvdXJjZXMoKTtcbiAgICBwb2xpY3lTdGF0ZW1lbnQuYWRkQWN0aW9ucyhcbiAgICAgIFwiYXBpZ2F0ZXdheToqXCIsXG4gICAgICBcImR5bmFtb2RiOipcIixcbiAgICAgIFwiZXhlY3V0ZS1hcGk6TWFuYWdlQ29ubmVjdGlvbnNcIlxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgTGFtYmRhXG4gICAgY29uc3QgbGFtYmRhRnVuYyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgaWQsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9EZWJ1Z1N0YWNrXCIpKSxcbiAgICAgIGhhbmRsZXIsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDEwKSxcbiAgICAgIG1lbW9yeVNpemU6IDI1NixcbiAgICAgIGxvZ1JldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLk9ORV9XRUVLLFxuICAgICAgbG9nUmV0ZW50aW9uUm9sZTogcm9sZSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFRBQkxFX05BTUU6IHRoaXMudGFibGUudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICAgIHJvbGUsXG4gICAgICBpbml0aWFsUG9saWN5OiBbcG9saWN5U3RhdGVtZW50XSxcbiAgICB9KTtcbiAgICBsYW1iZGFGdW5jLmFkZFBlcm1pc3Npb24oYCR7aWR9UGVybWlzc2lvbmAsIHtcbiAgICAgIHByaW5jaXBhbDogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiYXBpZ2F0ZXdheS5hbWF6b25hd3MuY29tXCIpLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIEFQSSBpbnRlZ3JhdGlvbnNcbiAgICBjb25zdCBpbnRlZ3JhdGlvbiA9IG5ldyBhcGlnLkNmbkludGVncmF0aW9uKHRoaXMsIGAke2lkfUludGVncmF0aW9uYCwge1xuICAgICAgYXBpSWQ6IHRoaXMuYXBpLnJlZixcbiAgICAgIGludGVncmF0aW9uVHlwZTogXCJBV1NfUFJPWFlcIixcbiAgICAgIGludGVncmF0aW9uVXJpOiBgYXJuOiR7dGhpcy5wYXJ0aXRpb259OmFwaWdhdGV3YXk6JHt0aGlzLnJlZ2lvbn06bGFtYmRhOnBhdGgvMjAxNS0wMy0zMS9mdW5jdGlvbnMvJHtsYW1iZGFGdW5jLmZ1bmN0aW9uQXJufS9pbnZvY2F0aW9uc2AsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgQVBJIHJvdXRlc1xuICAgIG5ldyBhcGlnLkNmblJvdXRlKHRoaXMsIGAke2lkfVJvdXRlYCwge1xuICAgICAgYXBpSWQ6IHRoaXMuYXBpLnJlZixcbiAgICAgIHJvdXRlS2V5LFxuICAgICAgYXV0aG9yaXphdGlvblR5cGU6IFwiTk9ORVwiLFxuICAgICAgdGFyZ2V0OiBgaW50ZWdyYXRpb25zLyR7aW50ZWdyYXRpb24ucmVmfWAsXG4gICAgfSk7XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBwcml2YXRlIHN0YXRpYyBjaGVja0ZvckVudkluUHJvcHMoaWQ6IHN0cmluZywgcHJvcHM/OiBhbnkpIHtcbiAgICBpZiAocHJvcHMgJiYgcHJvcHMuZW52KSB7XG4gICAgICBsZXQgZW52UyA9IFwiXCI7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGVudlMgPSBcIiAoXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wcy5lbnYpICsgXCIpXCI7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIElnbm9yZVxuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3Qgc2V0IHRoZSBcImVudlwiIHByb3Agd2hpbGUgaW5pdGlhbGl6aW5nIFwiJHtpZH1cIiBzdGFjayR7ZW52U30uIFVzZSB0aGUgXCJBV1NfUFJPRklMRVwiIGVudmlyb25tZW50IHZhcmlhYmxlIGFuZCBcIi0tcmVnaW9uXCIgQ0xJIG9wdGlvbiBpbnN0ZWFkLmBcbiAgICAgICk7XG4gICAgfVxuICB9XG59Il19